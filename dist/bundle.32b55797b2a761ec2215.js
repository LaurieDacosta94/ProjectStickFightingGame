(()=>{"use strict";var e={56:(e,t,a)=>{e.exports=function(e){var t=a.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function a(e){for(var a=-1,n=0;n<t.length;n++)if(t[n].identifier===e){a=n;break}return a}function n(e,n){for(var i={},r=[],s=0;s<e.length;s++){var l=e[s],c=n.base?l[0]+n.base:l[0],d=i[c]||0,f="".concat(c," ").concat(d);i[c]=d+1;var h=a(f),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==h)t[h].references++,t[h].updater(u);else{var m=o(u,n);n.byIndex=s,t.splice(s,0,{identifier:f,updater:m,references:1})}r.push(f)}return r}function o(e,t){var a=t.domAPI(t);return a.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;a.update(e=t)}else a.remove()}}e.exports=function(e,o){var i=n(e=e||[],o=o||{});return function(e){e=e||[];for(var r=0;r<i.length;r++){var s=a(i[r]);t[s].references--}for(var l=n(e,o),c=0;c<i.length;c++){var d=a(i[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}i=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a="",n=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),n&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),n&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a}).join("")},t.i=function(e,a,n,o,i){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(n)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&r[d[0]]||(void 0!==i&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=i),a&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=a):d[2]=a),o&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=o):d[4]="".concat(o)),t.push(d))}},t}},354:e=>{e.exports=function(e){var t=e[1],a=e[3];if(!a)return t;if("function"==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),o="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(n),i="/*# ".concat(o," */");return[t].concat([i]).join("\n")}return[t].join("\n")}},365:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(354),o=a.n(n),i=a(314),r=a.n(i)()(o());r.push([e.id,'* {\n  box-sizing: border-box;\n}\n\nbody {\n  margin: 0;\n  background-color: #0f1115;\n  color: #f0f3f7;\n  font-family: "Segoe UI", Arial, sans-serif;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n}\n\ncanvas {\n  border: 2px solid #2a2d34;\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\n  width: min(90vw, 960px);\n  max-width: 100%;\n  height: auto;\n}\n',"",{version:3,sources:["webpack://./src/styles.css"],names:[],mappings:"AAAA;EACE,sBAAsB;AACxB;;AAEA;EACE,SAAS;EACT,yBAAyB;EACzB,cAAc;EACd,0CAA0C;EAC1C,aAAa;EACb,mBAAmB;EACnB,uBAAuB;EACvB,iBAAiB;AACnB;;AAEA;EACE,yBAAyB;EACzB,6DAA6D;EAC7D,uBAAuB;EACvB,eAAe;EACf,YAAY;AACd",sourcesContent:['* {\r\n  box-sizing: border-box;\r\n}\r\n\r\nbody {\r\n  margin: 0;\r\n  background-color: #0f1115;\r\n  color: #f0f3f7;\r\n  font-family: "Segoe UI", Arial, sans-serif;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  min-height: 100vh;\r\n}\r\n\r\ncanvas {\r\n  border: 2px solid #2a2d34;\r\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\r\n  width: min(90vw, 960px);\r\n  max-width: 100%;\r\n  height: auto;\r\n}\r\n'],sourceRoot:""}]);const s=r},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},659:e=>{var t={};e.exports=function(e,a){var n=function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}t[e]=a}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(a)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(a){!function(e,t,a){var n="";a.supports&&(n+="@supports (".concat(a.supports,") {")),a.media&&(n+="@media ".concat(a.media," {"));var o=void 0!==a.layer;o&&(n+="@layer".concat(a.layer.length>0?" ".concat(a.layer):""," {")),n+=a.css,o&&(n+="}"),a.media&&(n+="}"),a.supports&&(n+="}");var i=a.sourceMap;i&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,a)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={id:n,exports:{}};return e[n](i,i.exports,a),i.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nc=void 0;var n=a(72),o=a.n(n),i=a(825),r=a.n(i),s=a(659),l=a.n(s),c=a(56),d=a.n(c),f=a(540),h=a.n(f),u=a(113),m=a.n(u),g=a(365),p={};p.styleTagTransform=m(),p.setAttributes=d(),p.insert=l().bind(null,"head"),p.domAPI=r(),p.insertStyleElement=h(),o()(g.A,p),g.A&&g.A.locals&&g.A.locals;const y=document.getElementById("game-canvas"),x=y.getContext("2d");if(!x)throw new Error("Canvas 2D context not available.");const b=y.height-60,w=4*y.width,v=b;function k(e){return"number"==typeof e?4*e:e}function M(e){return e.map(e=>({...e,x:k(e.x),width:k(e.width)}))}function S(e){return e.map(e=>({...e,x:k(e.x),width:k(e.width)}))}function C(e){return e.map(e=>{const t={...e};return"number"==typeof t.x&&(t.x=k(t.x)),"number"==typeof t.baseX&&(t.baseX=k(t.baseX)),"number"==typeof t.width&&(t.width=k(t.width)),Array.isArray(t.points)&&(t.points=t.points.map(e=>({...e,x:k(e.x)}))),t})}function T(e){return e.map(e=>({...e,x:k(e.x)}))}function I(e){return e.map(e=>({...e,x:k(e.x),minX:k(e.minX),maxX:k(e.maxX)}))}function A(e){return e.map(e=>({...e,x:k(e.x),radius:"number"==typeof e.radius?4*e.radius:e.radius}))}function R(e,t={}){const a=t.widthRatio??.05,n=w*a,o=.5*w-n/2,i=t.topOffset??18,r=t.depth??26;return[...e,{x:o,width:n,top:v-i,depth:r,highlight:t.highlight,highlightColor:t.highlightColor,topColor:t.topColor,midColor:t.midColor,bottomColor:t.bottomColor,rippleColor:t.rippleColor}]}const P=M([{x:-240,y:v-26,width:520,height:26,type:"street"},{x:320,y:v-26,width:420,height:26,type:"street"},{x:820,y:v-26,width:380,height:26,type:"street"},{x:1220,y:v-26,width:520,height:26,type:"street"},{x:40,y:v-120,width:260,height:18,type:"metro"},{x:360,y:v-180,width:280,height:16,type:"rooftop"},{x:680,y:v-240,width:220,height:16,type:"skybridge"},{x:960,y:v-180,width:320,height:18,type:"rooftop"},{x:1240,y:v-140,width:280,height:16,type:"terrace"},{x:1460,y:v-220,width:200,height:14,type:"balcony"},{x:600,y:v-88,width:260,height:14,type:"median"},{x:980,y:v-96,width:320,height:14,type:"median"}]),D=R(S([{x:580,width:220,top:v-16,depth:18}]),{topOffset:20,depth:28,topColor:"rgba(60, 112, 168, 0.88)",midColor:"rgba(36, 76, 128, 0.92)",bottomColor:"rgba(20, 48, 92, 0.95)",rippleColor:"rgba(190, 220, 255, 0.2)",highlightColor:"rgba(255, 236, 180, 0.25)"}),B=C([{type:"building",x:-120,y:v-360,width:220,height:360},{type:"building",x:220,y:v-420,width:180,height:420},{type:"building",x:520,y:v-360,width:260,height:360},{type:"building",x:860,y:v-440,width:220,height:440},{type:"building",x:1120,y:v-400,width:260,height:400},{type:"building",x:1400,y:v-360,width:200,height:360},{type:"billboard",x:320,y:v-210,width:180,height:90,text:"Neo District"},{type:"billboard",x:1040,y:v-230,width:200,height:96,text:"Rail 7"},{type:"streetlight",x:180,y:v-160},{type:"streetlight",x:760,y:v-160},{type:"streetlight",x:1280,y:v-160},{type:"hovercar",x:560,y:v-120},{type:"hovercar",x:1180,y:v-150}]),O=T([{id:"neo-barrier-west",type:"concreteBarrier",x:260,baseY:v},{id:"neo-barrier-east",type:"concreteBarrier",x:1140,baseY:v},{id:"neo-car-market",type:"streetCar",x:620,baseY:v,facing:-1},{id:"neo-car-docks",type:"streetCar",x:1340,baseY:v,facing:1},{id:"neo-barrels-market",type:"fuelBarrelCluster",x:440,baseY:v-26},{id:"neo-barrels-rail",type:"fuelBarrelCluster",x:920,baseY:v-26}]),E=I([{id:"neo-crate-market",type:"pushCrate",x:480,baseY:v-26,minX:200,maxX:860},{id:"neo-crate-rooftop",type:"pushCrate",x:520,baseY:v-180,minX:380,maxX:620},{id:"neo-barrel-metro",type:"kickBarrel",x:180,baseY:v-120,minX:60,maxX:280},{id:"neo-barrel-skybridge",type:"kickBarrel",x:780,baseY:v-240,minX:700,maxX:880},{id:"neo-trap-median",type:"shockTrap",x:680,baseY:v-88},{id:"neo-trap-gate",type:"shockTrap",x:1260,baseY:v-26}]),W=A([{id:"neo-street-0",type:"point",x:180,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12},{id:"neo-street-1",type:"point",x:760,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12},{id:"neo-street-2",type:"point",x:1280,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12}]),L=M([{x:-280,y:v-24,width:520,height:24,type:"jungleFloor"},{x:320,y:v-24,width:420,height:24,type:"jungleFloor"},{x:820,y:v-30,width:380,height:24,type:"jungleFloor"},{x:1220,y:v-36,width:420,height:26,type:"jungleFloor"},{x:120,y:v-150,width:260,height:18,type:"stone"},{x:460,y:v-210,width:280,height:16,type:"canopy"},{x:780,y:v-190,width:240,height:16,type:"branch"},{x:1120,y:v-250,width:220,height:14,type:"branch"}]),$=R(S([{x:240,width:280,top:v-16,depth:14},{x:940,width:210,top:v-12,depth:12}]),{topOffset:18,depth:24,topColor:"rgba(56, 128, 92, 0.85)",midColor:"rgba(40, 96, 72, 0.88)",bottomColor:"rgba(24, 64, 52, 0.93)",rippleColor:"rgba(200, 255, 214, 0.22)",highlightColor:"rgba(144, 255, 200, 0.22)"}),N=C([{type:"palm",baseX:-60,baseY:v,height:220},{type:"palm",baseX:220,baseY:v-8,height:210},{type:"palm",baseX:520,baseY:v-12,height:240},{type:"palm",baseX:960,baseY:v-10,height:220},{type:"ruin",x:440,y:v-220,width:160,height:190},{type:"ruin",x:1080,y:v-240,width:180,height:210},{type:"vineArch",x:760,y:v-170,width:200,height:140},{type:"glowPlant",x:320,y:v-60},{type:"glowPlant",x:980,y:v-58},{type:"waterfall",x:1180,y:v-60,width:90,height:220}]),j=T([{id:"wilds-timber-west",type:"timberWall",x:260,baseY:v},{id:"wilds-timber-east",type:"timberWall",x:1220,baseY:v},{id:"wilds-spore-cell",type:"plasmaCell",x:520,baseY:v-120,templateOverrides:{bodyColor:"#2e9a63",accentColor:"#8cffc1",stripeColor:"#6bffad",damageHighlight:"#b6ffd6",debrisColor:"#1c5e3a"}},{id:"wilds-cache",type:"sandbagLine",x:880,baseY:v-24,templateOverrides:{bodyColor:"#4b6036",accentColor:"#92b56a",damageHighlight:"#c8e8a4",debrisColor:"#2e4125"}}]),F=I([{id:"wilds-crate-lower",type:"pushCrate",x:360,baseY:v-24,minX:160,maxX:560,templateOverrides:{bodyColor:"#5f7a45",edgeColor:"#2f4022",braceColor:"#9fbd67",highlightColor:"#d9ff8a"}},{id:"wilds-crate-canopy",type:"pushCrate",x:540,baseY:v-210,minX:420,maxX:640,templateOverrides:{bodyColor:"#4e6d3a",edgeColor:"#283b1c",braceColor:"#8fb76a",highlightColor:"#c8ff99"}},{id:"wilds-barrel",type:"kickBarrel",x:200,baseY:v-24,minX:80,maxX:360,templateOverrides:{bodyColor:"#2f8f5d",stripeColor:"#7dff9e",edgeColor:"#174027",topColor:"#44b574"}},{id:"wilds-trap",type:"shockTrap",x:700,baseY:v-24,templateOverrides:{bodyColor:"#1d3b2c",accentColor:"#59ffbd",glowColor:"#86ffd7"}}]),H=A([{id:"wilds-glow-0",type:"point",x:320,y:v-80,radius:220,intensity:.85,color:"#78ffbf",smoothing:6,flicker:.35},{id:"wilds-glow-1",type:"point",x:980,y:v-76,radius:210,intensity:.82,color:"#78ffbf",smoothing:6,flicker:.32},{id:"wilds-falls",type:"point",x:1180,y:v-120,radius:260,intensity:.9,color:"#6ed8ff",smoothing:8,flicker:.25}]),Y=[{x:-260,y:v-20,width:540,height:20,type:"sand"},{x:360,y:v-24,width:340,height:18,type:"sand"},{x:760,y:v-28,width:380,height:20,type:"sand"},{x:1180,y:v-26,width:480,height:22,type:"sand"},{x:120,y:v-140,width:260,height:16,type:"cliff"},{x:520,y:v-200,width:260,height:14,type:"plateau"},{x:900,y:v-180,width:310,height:14,type:"plateau"},{x:1280,y:v-240,width:240,height:12,type:"plateau"}],X=R(S([{x:520,width:180,top:v-18,depth:12}]),{topOffset:22,depth:24,topColor:"rgba(68, 156, 188, 0.85)",midColor:"rgba(40, 124, 168, 0.9)",bottomColor:"rgba(24, 74, 120, 0.95)",rippleColor:"rgba(240, 255, 214, 0.18)",highlightColor:"rgba(255, 204, 128, 0.26)"}),z=C([{type:"dune",baseX:120,baseY:v,width:320,height:120},{type:"dune",baseX:620,baseY:v,width:280,height:100},{type:"dune",baseX:1080,baseY:v,width:340,height:110},{type:"rockSpire",baseX:420,baseY:v,height:260},{type:"rockSpire",baseX:1160,baseY:v,height:230},{type:"campfire",baseX:660,baseY:v-20},{type:"antenna",x:920,y:v-300,height:320}]),q=T([{id:"dune-sandbag-west",type:"sandbagLine",x:280,baseY:v,templateOverrides:{bodyColor:"#c8a070",accentColor:"#edd0a0",damageHighlight:"#ffe8b2",debrisColor:"#8f6d45"}},{id:"dune-sandbag-east",type:"sandbagLine",x:1180,baseY:v,templateOverrides:{bodyColor:"#c8a070",accentColor:"#edd0a0",damageHighlight:"#ffe8b2",debrisColor:"#8f6d45"}},{id:"dune-rover",type:"roverWreck",x:760,baseY:v-24,facing:-1,templateOverrides:{bodyColor:"#d1c296",accentColor:"#fdf4c7",glassColor:"#ffe8a1",damageHighlight:"#fff0c1",debrisColor:"#8f7b4a"}},{id:"dune-cell",type:"plasmaCell",x:540,baseY:v-200,templateOverrides:{bodyColor:"#f07f1f",accentColor:"#ffd9a1",stripeColor:"#ffeab9",damageHighlight:"#fff1cb",debrisColor:"#a95312"}}]),K=I([{id:"dune-crate",type:"pushCrate",x:360,baseY:v-24,minX:180,maxX:520,templateOverrides:{bodyColor:"#bf9a62",edgeColor:"#6f4f2f",braceColor:"#dcb678",highlightColor:"#ffe0a8"}},{id:"dune-barrel",type:"kickBarrel",x:820,baseY:v-28,minX:720,maxX:960,templateOverrides:{bodyColor:"#c7672d",stripeColor:"#ffe49a",edgeColor:"#531f05",topColor:"#e4883d"}},{id:"dune-trap",type:"shockTrap",x:1020,baseY:v-26,templateOverrides:{bodyColor:"#3a2a14",accentColor:"#ffcc6e",glowColor:"#ffe9a6"}}]),U=A([{id:"dune-fire",type:"point",x:660,y:v-36,radius:240,intensity:1.2,color:"#ffb36d",smoothing:6,flicker:.55},{id:"dune-beacon",type:"point",x:920,y:v-200,radius:260,intensity:.9,color:"#8cc9ff",smoothing:8,flicker:.35}]),G=M([{x:-200,y:v-40,width:540,height:18,type:"deck"},{x:340,y:v-40,width:360,height:18,type:"deck"},{x:720,y:v-40,width:400,height:18,type:"deck"},{x:1200,y:v-40,width:420,height:18,type:"deck"},{x:160,y:v-160,width:260,height:14,type:"catwalk"},{x:520,y:v-220,width:320,height:14,type:"catwalk"},{x:920,y:v-200,width:300,height:14,type:"maglev"},{x:1280,y:v-260,width:260,height:12,type:"maglev"}]),J=(R(S([]),{topOffset:24,depth:30,topColor:"rgba(86, 128, 220, 0.82)",midColor:"rgba(70, 104, 210, 0.88)",bottomColor:"rgba(48, 72, 180, 0.94)",rippleColor:"rgba(148, 208, 255, 0.28)",highlightColor:"rgba(160, 220, 255, 0.3)"}),C([{type:"spire",baseX:260,baseY:v,height:300},{type:"spire",baseX:640,baseY:v,height:340},{type:"spire",baseX:1100,baseY:v,height:320},{type:"holoBillboard",x:820,y:v-220,width:200,height:100,text:"SYN-42"},{type:"energyCoil",baseX:520,baseY:v-20,height:180},{type:"energyCoil",baseX:1260,baseY:v-20,height:200},{type:"hovercar",x:420,y:v-160},{type:"hovercar",x:1180,y:v-150}])),V=T([{id:"orbital-barrier-west",type:"sandbagLine",x:320,baseY:v,templateOverrides:{bodyColor:"#3b4b63",accentColor:"#6c82b8",damageHighlight:"#a9c4ff",debrisColor:"#243145"}},{id:"orbital-barrier-east",type:"sandbagLine",x:1260,baseY:v,templateOverrides:{bodyColor:"#3b4b63",accentColor:"#6c82b8",damageHighlight:"#a9c4ff",debrisColor:"#243145"}},{id:"orbital-reactor",type:"plasmaCell",x:760,baseY:v-40,templateOverrides:{bodyColor:"#4a9fff",accentColor:"#c4f5ff",stripeColor:"#9ef7ff",damageHighlight:"#d4fcff"}},{id:"orbital-rover",type:"roverWreck",x:540,baseY:v-220,facing:1,templateOverrides:{bodyColor:"#6f86ff",accentColor:"#dfe6ff",glassColor:"#9ffbff",damageHighlight:"#bcd3ff",debrisColor:"#3e4f9a"}}]),_=I([{id:"orbital-crate-lower",type:"pushCrate",x:360,baseY:v-40,minX:200,maxX:520,templateOverrides:{bodyColor:"#4b5b87",edgeColor:"#1b233a",braceColor:"#7f96e8",highlightColor:"#a8c2ff"}},{id:"orbital-crate-upper",type:"pushCrate",x:1080,baseY:v-200,minX:960,maxX:1180,templateOverrides:{bodyColor:"#566dac",edgeColor:"#243154",braceColor:"#8da4ff",highlightColor:"#c3d1ff"}},{id:"orbital-barrel",type:"kickBarrel",x:680,baseY:v-40,minX:620,maxX:880,templateOverrides:{bodyColor:"#3d7cff",stripeColor:"#8df5ff",edgeColor:"#1c2550",topColor:"#64a1ff"}},{id:"orbital-trap",type:"shockTrap",x:920,baseY:v-40,templateOverrides:{bodyColor:"#1f2850",accentColor:"#86a6ff",glowColor:"#b4ceff"}}]),Q=A([{id:"orbital-coil-0",type:"point",x:520,y:v-120,radius:280,intensity:1.3,color:"#7ce7ff",smoothing:10,flicker:.35},{id:"orbital-coil-1",type:"point",x:1260,y:v-120,radius:280,intensity:1.3,color:"#7ce7ff",smoothing:10,flicker:.35},{id:"orbital-spire",type:"cone",x:260,y:v-320,radius:320,intensity:.9,color:"#55d9ff",direction:0,fov:.4*Math.PI,stretch:.6,smoothing:14}]),Z={neoDistrict:{id:"neoDistrict",name:"Neo District",theme:"urban",width:w,background:{gradientStops:[{offset:0,color:"#111a2c"},{offset:.4,color:"#182439"},{offset:.75,color:"#1f2d44"},{offset:1,color:"#232f49"}],horizonBand:{start:v-140,height:120,topColor:"rgba(46, 86, 126, 0.25)",bottomColor:"rgba(28, 52, 84, 0)"},groundColor:"#1b2231",silhouettes:[{color:"#1a2437",points:[{x:0,y:v-220},{x:k(220),y:v-260},{x:k(420),y:v-210},{x:k(640),y:v-280},{x:k(820),y:v-230},{x:k(1040),y:v-260},{x:k(1220),y:v-210},{x:k(1380),y:v-260},{x:w,y:v-200},{x:w,y:v},{x:0,y:v}]}]},platforms:P,waterZones:D,decor:B,destructibles:O,interactables:E,ambientLights:W,spawn:{player:{x:.5*w},trainingDummy:{x:.75*w},squadOffsets:[-120,40,120],enemies:[.24*w,.68*w]}},verdantWilds:{id:"verdantWilds",name:"Verdant Wilds",theme:"jungle",width:w,background:{gradientStops:[{offset:0,color:"#0b1613"},{offset:.45,color:"#123020"},{offset:.8,color:"#1d4a37"},{offset:1,color:"#1c2d1f"}],horizonBand:{start:v-160,height:140,topColor:"rgba(34, 84, 58, 0.32)",bottomColor:"rgba(18, 42, 31, 0)"},groundColor:"#1c2519",silhouettes:[{color:"#152718",points:[{x:0,y:v-200},{x:k(160),y:v-230},{x:k(360),y:v-210},{x:k(540),y:v-250},{x:k(760),y:v-220},{x:k(980),y:v-240},{x:w,y:v-210},{x:w,y:v},{x:0,y:v}]}]},platforms:L,waterZones:$,decor:N,destructibles:j,interactables:F,ambientLights:H,spawn:{player:{x:.45*w},trainingDummy:{x:.8*w},squadOffsets:[-140,-10,120],enemies:[.2*w,.7*w]}},sunsetDunes:{id:"sunsetDunes",name:"Sunset Dunes",theme:"desert",width:w,background:{gradientStops:[{offset:0,color:"#32140c"},{offset:.45,color:"#5c2814"},{offset:.78,color:"#b35a1c"},{offset:1,color:"#d08b3e"}],horizonBand:{start:v-150,height:120,topColor:"rgba(206, 124, 50, 0.28)",bottomColor:"rgba(128, 68, 24, 0)"},groundColor:"#3c2717",silhouettes:[{color:"#2a1b10",points:[{x:0,y:v-180},{x:k(220),y:v-200},{x:k(480),y:v-190},{x:k(720),y:v-210},{x:k(980),y:v-200},{x:w,y:v-190},{x:w,y:v},{x:0,y:v}]}]},platforms:Y,waterZones:X,decor:z,destructibles:q,interactables:K,ambientLights:U,spawn:{player:{x:.46*w},trainingDummy:{x:.78*w},squadOffsets:[-140,-30,110],enemies:[.22*w,.68*w]}},orbitalSpire:{id:"orbitalSpire",name:"Orbital Spire",theme:"sci-fi",width:w,background:{gradientStops:[{offset:0,color:"#0d0f2a"},{offset:.5,color:"#141a3d"},{offset:.82,color:"#1c2856"},{offset:1,color:"#1e1f2c"}],horizonBand:{start:v-160,height:140,topColor:"rgba(70, 120, 220, 0.22)",bottomColor:"rgba(30, 40, 90, 0)"},groundColor:"#151726",silhouettes:[{color:"#1a2650",points:[{x:0,y:v-240},{x:k(200),y:v-320},{x:k(280),y:v-200},{x:k(520),y:v-340},{x:k(720),y:v-260},{x:k(900),y:v-320},{x:k(1080),y:v-220},{x:k(1280),y:v-340},{x:w,y:v-240},{x:w,y:v},{x:0,y:v}]}]},platforms:G,waterZones:[],decor:J,destructibles:V,interactables:_,ambientLights:Q,spawn:{player:{x:.5*w},trainingDummy:{x:.82*w},squadOffsets:[-130,-20,120],enemies:[.3*w,.7*w]}}},ee=["neoDistrict","verdantWilds","sunsetDunes","orbitalSpire"],te={materials:120,pickups:[]};let ae=1;function ne(){return te.materials}function oe(e){te.materials=Math.max(0,Math.floor(e??0))}function ie(e,t=""){Number.isFinite(e)&&0!==e&&(te.materials=Math.max(0,te.materials+Math.round(e)))}function re({x:e=0,y:t=0,amount:a=10,vx:n=80*(Math.random()-.5),vy:o=-120,ttl:i=6}={}){const r={id:"salvage-"+ae++,x:e,y:t,vx:n,vy:o,amount:Math.max(1,Math.round(a??1)),ttl:i,maxTtl:i,collected:!1};return te.pickups.push(r),r}let se=ee[0]??Object.keys(Z)[0];const le=new Set;let ce=!1;function de(e=se){const t=Z[e];if(t)return t;const a=ee[0]??Object.keys(Z)[0];return se=a,Z[a]}function fe(){const e=de();return"number"==typeof e?.width?e.width:y.width}function he(){const e=de();return Array.isArray(e?.platforms)?e.platforms:[]}function ue(){const e=de();return e?.spawn??{}}function me(){const e=de();for(const t of le)try{t(e)}catch(e){"undefined"!=typeof console&&console.error&&console.error("Environment listener error",e)}"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&window.dispatchEvent(new CustomEvent("environment:changed",{detail:{environment:e,id:e?.id??se}}))}function ge(e){return!(!e||!Z[e]||e===se||(se=e,te.pickups.length=0,me(),0))}function pe(e,t={}){return"function"!=typeof e?()=>{}:(le.add(e),!1!==t.immediate&&e(de()),()=>{le.delete(e)})}const ye={x:.5*y.width,targetX:.5*y.width};function xe(){return.5*y.width}function be(e){const t=xe(),a=fe();return a<=y.width?.5*y.width:Math.min(Math.max(e,t),a-t)}function we(){var e;e=.5*fe(),ye.x=be(e),ye.targetX=ye.x}function ve(){const e=xe(),t=fe(),a=be(ye.x);let n=a-e;return n=t<=y.width?Math.max(0,.5*t-e):Math.min(Math.max(0,n),t-y.width),{x:a,y:0,halfWidth:e,left:n,right:n+y.width,offsetX:n}}pe(()=>{we()}),we();const ke=Object.seal({left:!1,right:!1,jump:!1,down:!1,roll:!1,attackBuffered:!1,throwBuffered:!1,reloadBuffered:!1,interactBuffered:!1,attackDown:!1,throwDown:!1,squadCommandCycleBuffered:!1,squadCommandSelect:null,serverBrowserToggleBuffered:!1,serverBrowserNavigate:0,serverBrowserJoinBuffered:!1,serverBrowserHostBuffered:!1,serverBrowserStopHostBuffered:!1,serverBrowserCopyOfferBuffered:!1,serverBrowserPasteOfferBuffered:!1,serverBrowserAcceptAnswerBuffered:!1,serverBrowserCopyCandidatesBuffered:!1,serverBrowserPasteCandidatesBuffered:!1,buildToggleBuffered:!1,buildCycleBuffered:0,buildConfirmBuffered:!1,buildCancelBuffered:!1,survivalToggleBuffered:!1,sandboxToggleBuffered:!1,coopToggleBuffered:!1,campaignStartBuffered:!1}),Me=Object.seal({screenX:.5*y.width,screenY:.5*y.height,worldX:.5*y.width,worldY:.5*y.height,active:!1,lastUpdate:0});function Se(){const e=ve(),t=e?.offsetX??0,a=e?.y??0;Me.worldX=Me.screenX+t,Me.worldY=Me.screenY+a}function Ce(e){if(!y||!e)return void Se();const t=y.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,o=t.width>0?y.width/t.width:1,i=t.height>0?y.height/t.height:1;Me.screenX=a*o,Me.screenY=n*i,Me.active=a>=0&&a<=t.width&&n>=0&&n<=t.height,Me.lastUpdate="undefined"!=typeof performance?performance.now():Date.now(),Se()}let Te=!1;function Ie(e,t){switch(t.code){case"ArrowLeft":case"KeyA":ke.left=e,t.preventDefault();break;case"ArrowRight":case"KeyD":ke.right=e,t.preventDefault();break;case"ArrowUp":case"KeyW":case"Space":ke.jump=e,t.preventDefault();break;case"ArrowDown":case"KeyS":ke.down=e,t.preventDefault();break;case"Comma":e&&(ke.buildCycleBuffered=-1,t.preventDefault());break;case"Period":e&&(ke.buildCycleBuffered=1,t.preventDefault());break;case"Escape":e&&(ke.buildCancelBuffered=!0,t.preventDefault());case"ShiftLeft":case"ShiftRight":e&&(ke.roll=!0,t.preventDefault());break;case"KeyB":e&&(ke.buildToggleBuffered=!0,t.preventDefault());break;case"KeyY":e&&(ke.survivalToggleBuffered=!0,t.preventDefault());break;case"KeyK":e&&(ke.sandboxToggleBuffered=!0,t.preventDefault());break;case"F9":e&&(ke.coopToggleBuffered=!0,t.preventDefault());break;case"KeyJ":case"KeyF":e?(ke.attackBuffered=!0,ke.attackDown=!0,t.preventDefault()):(ke.attackDown=!1,t.preventDefault());break;case"KeyG":e?(ke.throwBuffered=!0,ke.throwDown=!0,t.preventDefault()):(ke.throwDown=!1,t.preventDefault());break;case"KeyR":e&&(ke.reloadBuffered=!0,t.preventDefault());break;case"KeyE":e&&(ke.interactBuffered=!0,t.preventDefault());break;case"KeyT":e&&(ke.squadCommandCycleBuffered=!0,t.preventDefault());break;case"KeyQ":e&&(ke.campaignStartBuffered=!0,t.preventDefault());break;case"KeyZ":e&&(ke.squadCommandSelect="hold",t.preventDefault());break;case"KeyX":e&&(ke.squadCommandSelect="defend",t.preventDefault());break;case"KeyC":e&&(ke.squadCommandSelect="attack",t.preventDefault());break;case"KeyV":e&&(ke.squadCommandSelect="flank",t.preventDefault());break;case"KeyL":e&&(ke.serverBrowserToggleBuffered=!0,t.preventDefault());break;case"BracketLeft":e&&(ke.serverBrowserNavigate=-1,t.preventDefault());break;case"BracketRight":case"Slash":e&&(ke.serverBrowserNavigate=1,t.preventDefault());break;case"Enter":e&&(ke.serverBrowserJoinBuffered=!0,t.preventDefault());break;case"KeyH":e&&(ke.serverBrowserHostBuffered=!0,t.preventDefault());break;case"KeyU":e&&(ke.serverBrowserStopHostBuffered=!0,t.preventDefault());break;case"KeyO":e&&(ke.serverBrowserCopyOfferBuffered=!0,t.preventDefault());break;case"KeyP":e&&(ke.serverBrowserPasteOfferBuffered=!0,t.preventDefault());break;case"KeyI":e&&(ke.serverBrowserAcceptAnswerBuffered=!0,t.preventDefault());break;case"KeyM":e&&(ke.serverBrowserCopyCandidatesBuffered=!0,t.preventDefault());break;case"KeyN":e&&(ke.serverBrowserPasteCandidatesBuffered=!0,t.preventDefault())}}function Ae(){ke.left=!1,ke.right=!1,ke.jump=!1,ke.down=!1,ke.roll=!1,ke.attackBuffered=!1,ke.throwBuffered=!1,ke.reloadBuffered=!1,ke.interactBuffered=!1,ke.attackDown=!1,ke.throwDown=!1,ke.squadCommandCycleBuffered=!1,ke.squadCommandSelect=null,ke.serverBrowserToggleBuffered=!1,ke.serverBrowserNavigate=0,ke.serverBrowserJoinBuffered=!1,ke.serverBrowserHostBuffered=!1,ke.serverBrowserStopHostBuffered=!1,ke.serverBrowserCopyOfferBuffered=!1,ke.serverBrowserPasteOfferBuffered=!1,ke.serverBrowserAcceptAnswerBuffered=!1,ke.serverBrowserCopyCandidatesBuffered=!1,ke.serverBrowserPasteCandidatesBuffered=!1,ke.campaignStartBuffered=!1}const Re={combatFists:{id:"combatFists",name:"Combat Fists",description:"Baseline martial arts combo with balanced speed and control.",category:"melee-short",attackChain:[{name:"Quick Jab",windup:.05,active:.1,recovery:.12,comboStart:.1,comboWindow:.16,range:74,heightOffset:-46,radius:26,damage:9,knockback:130,launch:0},{name:"Cross Strike",windup:.08,active:.12,recovery:.16,comboStart:.16,comboWindow:.18,range:82,heightOffset:-40,radius:28,damage:14,knockback:190,launch:0},{name:"Rising Kick",windup:.11,active:.15,recovery:.22,comboStart:.22,comboWindow:.22,range:68,heightOffset:-64,radius:30,damage:20,knockback:240,launch:200}]},shockBaton:{id:"shockBaton",name:"Shock Baton",description:"Electrified staff built for crowd control and guard breaks.",category:"melee-mid",attackChain:[{name:"Jab Feint",windup:.06,active:.08,recovery:.14,comboStart:.14,comboWindow:.16,range:68,heightOffset:-30,radius:26,damage:11,knockback:110,launch:0},{name:"Slide Sweep",windup:.1,active:.12,recovery:.2,comboStart:.2,comboWindow:.18,range:86,heightOffset:-12,radius:34,damage:18,knockback:210,launch:40},{name:"Arc Burst",windup:.15,active:.2,recovery:.3,comboStart:.28,comboWindow:.22,range:94,heightOffset:-28,radius:42,damage:30,knockback:340,launch:210}]},strikerPistol:{id:"strikerPistol",name:"Striker Pistol",description:"Semi-auto sidearm. Tap fire for consistent ranged pressure.",category:"ranged-short",attackChain:[],fireInterval:.25,auto:!1,spread:{base:.5,perShot:.35,max:3,recovery:6},projectile:{radius:6,speed:560,damage:16,knockback:95,lifetime:1.05,gravityFactor:.18,color:"#ffca7a"},ammo:{magazine:14,reserve:84,reloadSeconds:1.2},recoil:{horizontal:.35,vertical:1.6,decay:10}},vectorSmg:{id:"vectorSmg",name:"Vector SMG",description:"Rapid PDW prototype tuned for controllable spray.",category:"ranged-mid",attackChain:[],fireInterval:.08,auto:!0,projectile:{radius:5,speed:660,damage:11,knockback:75,lifetime:.9,gravityFactor:.14,color:"#98d8ff"},ammo:{magazine:38,reserve:190,reloadSeconds:2.2},recoil:{horizontal:1.1,vertical:1.8,decay:14},spread:{base:1.2,perShot:.55,max:7.5,recovery:4}},fragGrenade:{id:"fragGrenade",name:"Frag Grenade",description:"Timed explosive. Toss, bounce, and detonate in a wide area.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.6,explosionRadius:125,damage:50,knockback:300,arcVelocity:{vx:280,vy:-420},gravityFactor:.5,bounciness:.45,color:"#ffb347",radius:16,cooldownSeconds:1.3,explosionDuration:.34,selfDamageScale:.45,selfKnockbackScale:.45,effectType:"explosive"}},flashBang:{id:"flashBang",name:"Flashbang",description:"Blinding charge that staggers enemies caught in the burst.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.15,explosionRadius:170,damage:0,knockback:0,arcVelocity:{vx:260,vy:-420},gravityFactor:.45,bounciness:.4,color:"#f9f2c7",radius:14,cooldownSeconds:1.6,explosionDuration:.24,effectType:"flash",stunDuration:2.2,playerStunDuration:1.1}},smokeCanister:{id:"smokeCanister",name:"Smoke Canister",description:"Rapid-deploy screen that slows foes and softens line of sight.",category:"throwable",attackChain:[],throwable:{fuseSeconds:.9,explosionRadius:80,damage:0,knockback:0,arcVelocity:{vx:220,vy:-360},gravityFactor:.52,bounciness:.35,color:"#aeb9c6",radius:18,cooldownSeconds:2.2,explosionDuration:.2,effectType:"smoke",smokeDuration:6,smokeRadius:160,smokeExpansion:1.4,smokeSlowMultiplier:.5,smokeTickDuration:.45}},turretDrone:{id:"turretDrone",name:"Deployable Turret",description:"Drops an auto-targeting sentry that covers a lane with suppressive fire.",category:"gadget",attackChain:[],gadget:{type:"turret",cooldownSeconds:3.8,duration:10,range:280,fireInterval:.48,maxActive:2,height:54,spawnOffset:{x:70,y:0},baseColor:"#6f7bff",headColor:"#d6dcff",projectile:{speed:560,radius:4,damage:11,knockback:90,lifetime:1.25,color:"#9ae9ff"}}},grappleRig:{id:"grappleRig",name:"Grapple Rig",description:"Launch, latch, and zip to an overhead anchor for quick repositioning.",category:"gadget",attackChain:[],gadget:{type:"grapple",cooldownSeconds:1.5,duration:.65,maxLength:340,maxRise:280,travelSpeed:940,pullSpeed:820,color:"#8cf1ff"}},thunderCannon:{id:"thunderCannon",name:"Thunder Cannon",description:"Supply drop-exclusive launcher that fires high-impact bolts.",category:"ranged-heavy",attackChain:[],fireInterval:.6,auto:!1,projectile:{radius:10,speed:640,damage:56,knockback:320,lifetime:1.3,gravityFactor:.15,color:"#ffd76a"},ammo:{magazine:3,reserve:9,reloadSeconds:3.4},recoil:{horizontal:2.4,vertical:5.8,decay:6.5},spread:{base:1.1,perShot:.65,max:5.5,recovery:2.9}},shieldBubble:{id:"shieldBubble",name:"Shield Bubble",description:"Pop a temporary energy shell that soaks damage and keeps you grounded.",category:"gadget",attackChain:[],gadget:{type:"shield",cooldownSeconds:6,duration:6.5,strength:130,radius:100,color:"#7cd6ff"}}},Pe=["combatFists","shockBaton","strikerPistol","fragGrenade","flashBang","smokeCanister","turretDrone","grappleRig","shieldBubble"],De=240,Be=1400,Oe={standing:{headRadius:16,bodyLength:34,legLength:36,armLength:28,strideMultiplier:1,armSwingAmplitude:12,legSwingAmplitude:12},crouching:{headRadius:16,bodyLength:24,legLength:24,armLength:22,strideMultiplier:.6,armSwingAmplitude:6,legSwingAmplitude:6},rolling:{headRadius:16,bodyLength:18,legLength:18,armLength:18,strideMultiplier:0,armSwingAmplitude:0,legSwingAmplitude:0}},Ee=[{id:"hold",label:"Hold",description:"Regroup on you and stay close.",order:0},{id:"defend",label:"Defend",description:"Form a defensive ring and cover your position.",order:1},{id:"attack",label:"Attack",description:"Press the nearest enemy with ranged fire.",order:2},{id:"flank",label:"Flank",description:"Split wide and pressure the enemy from the side.",order:3}];function We(e=1,t=12){const a=e>=0?0:Math.PI,n=Math.cos(a),o=Math.sin(a);return{angle:a,targetAngle:a,vectorX:n,vectorY:o,magnitude:1,anchorX:0,anchorY:0,targetX:n,targetY:o,smoothing:t,active:!1,lastUpdated:0}}function Le(e){return 2*e.headRadius+e.bodyLength+e.legLength}function $e(e,t={}){const a=ue(),n=Array.isArray(a?.enemies)?a.enemies:[],o="number"==typeof e?e:n[0]??.25*fe(),i=a?.enemyY??b-118,r=t.context??"sandbox",s=t.autoRespawn??"survival"!==r,l=t.spawnSide??null,c=t.facing??1;return{id:`grunt-${Math.random().toString(36).slice(2,8)}`,spawnX:o,spawnY:i,x:o,y:i,vx:0,vy:0,radius:22,height:118,facing:c,onGround:!0,state:"patrol",stateTimer:1+Math.random(),patrolRange:{min:o-100,max:o+220},aggressionRange:360,attackRange:86,moveSpeed:160,health:120,maxHealth:120,attackCooldown:0,attackWindup:0,attackActive:0,attackDamage:12,attackKnockback:120,attackLaunch:-80,baseStats:{maxHealth:120,attackDamage:12,moveSpeed:160},flashTimer:0,shakeTimer:0,shakeMagnitude:0,invulnerability:0,respawnTimer:0,stunTimer:0,smokeSlowTimer:0,smokeSlowStrength:1,spawnContext:r,autoRespawn:s,spawnSide:l,aim:We(c,12),active:!0}}function Ne(e=0,t="Ally",a=.5*fe()){const n=a+e,o=b-Le(Oe.standing);return{id:`squad-${Math.random().toString(36).slice(2,8)}`,name:t,x:n,y:o,vx:0,vy:0,facing:1,onGround:!0,state:"follow",fireCooldown:0,commandTimer:0,targetEnemyId:null,flashTimer:0,highlight:0,structureShieldTimer:0,structureShieldStrength:0,aim:We(1,18),roleIndex:0}}const je=ue(),Fe=Le(Oe.standing),He=je?.player?.x??.5*fe(),Ye={x:He,y:je?.player?.y??b-Fe,vx:0,vy:0,facing:1,onGround:!0,controlMode:"onFoot",vehicleId:null,vehicleCandidateId:null,squadCommandIndex:0,squadCommandId:Ee[0]?.id??"hold",squadCommandCooldown:0,rolling:!1,rollTimer:0,crouching:!1,currentPose:Oe.standing,attacking:!1,attackIndex:-1,currentAttack:null,attackElapsed:0,attackInstanceId:0,comboWindowOpen:!1,comboWindowTimer:0,nextAttackQueued:!1,hitboxSpawned:!1,activeHitboxes:[],health:100,maxHealth:100,invulnerability:0,deadTimer:0,throwCooldown:0,fireCooldown:0,gadgetCooldown:0,reloading:!1,stunTimer:0,flashBlindTimer:0,smokeSlowTimer:0,smokeSlowStrength:1,structureShieldTimer:0,structureShieldStrength:0,aim:We(1,22),equippedWeaponId:"combatFists"},Xe=Array.isArray(je?.squadOffsets)?je.squadOffsets:[-120,40,120],ze=[Ne(Xe[0]??-120,"Sparrow",He),Ne(Xe[1]??40,"Rook",He),Ne(Xe[2]??120,"Viper",He)],qe=new Map;function Ke(e){if(!e||!e.id)return;const t="undefined"!=typeof performance?performance.now():Date.now(),a=qe.get(e.id)??{};qe.set(e.id,{id:e.id,name:e.name??a.name??"Remote",x:e.x??a.x??0,y:e.y??a.y??b-Fe,facing:e.facing??a.facing??1,commandId:e.commandId??a.commandId??"hold",lastUpdate:t})}function Ue(){return Array.from(qe.values())}const Ge={id:"training-dummy",x:je?.trainingDummy?.x??.75*fe(),y:je?.trainingDummy?.y??b-120,height:120,radius:26,maxHealth:150,health:150,flashTimer:0,shakeTimer:0,shakeMagnitude:0,respawnTimer:0},Je=Array.isArray(je?.enemies)?je.enemies:[.24*fe(),.68*fe()],Ve=[$e(Je[0],{context:"sandbox",autoRespawn:!0,spawnSide:0,facing:1}),$e(Je[1],{context:"sandbox",autoRespawn:!0,spawnSide:1,facing:-1})];function _e(e,t){const a=Array.isArray(e.enemies)?e.enemies:[],n=Math.max(2,a.length||0),o=Ve.filter(e=>"sandbox"===e.spawnContext),i=new Set(o.map(e=>e.spawnSide??o.indexOf(e)));for(let e=0;e<n;e+=1)if(!i.has(e)){const n=t+(0===e?-320:320),r=$e("number"==typeof a[e]?a[e]:n,{context:"sandbox",autoRespawn:!0,spawnSide:e,facing:0===e?1:-1});Ve.push(r),o.push(r),i.add(e)}for(const n of o){const o=n.spawnSide??0,i=t+(0===o?-320:320),r="number"==typeof a[o]?a[o]:i,s=e.enemyY??b-n.height;n.spawnSide=o,n.spawnContext="sandbox",n.autoRespawn=!0,n.spawnX=r,n.spawnY=s,n.x=r,n.y=s,n.vx=0,n.vy=0,n.health=n.maxHealth,n.invulnerability=0,n.flashTimer=0,n.shakeTimer=0,n.shakeMagnitude=0,n.respawnTimer=0,n.state="patrol",n.stateTimer=1+Math.random(),n.patrolRange={min:r-100,max:r+220},n.onGround=!0,n.facing=0===o?1:-1}}function Qe(){for(let e=Ve.length-1;e>=0;e-=1)"sandbox"===Ve[e].spawnContext&&Ve.splice(e,1)}function Ze(){const e=ue();_e(e,e.player?.x??.5*fe())}Ve.forEach((e,t)=>{!function(e,t){e.spawnSide=t,e.spawnContext=e.spawnContext??"sandbox",e.autoRespawn=e.autoRespawn??!0,e.facing=0===t?1:-1}(e,t)}),pe(e=>{!function(e){const t=e?.spawn??{},a=t.player?.x??.5*fe(),n=Le(Ye.currentPose??Oe.standing),o=t.player?.y??b-n;Ye.x=a,Ye.y=o,Ye.vx=0,Ye.vy=0,Ye.onGround=!0,Ye.controlMode="onFoot",Ye.vehicleId=null,Ye.vehicleCandidateId=null,Ye.rollTimer=0,Ye.crouching=!1,Ye.attacking=!1,Ye.attackIndex=-1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.nextAttackQueued=!1,Ye.hitboxSpawned=!1,Ye.activeHitboxes.length=0,Ye.deadTimer=0,Ye.health=Ye.maxHealth,Ye.structureShieldTimer=0,Ye.structureShieldStrength=0,Ye.invulnerability=0;const i=Array.isArray(t.squadOffsets)?t.squadOffsets:Xe;ze.forEach((e,t)=>{const n=i[t]??80*(t-1),o=a+n,r=b-Le(Oe.standing);e.x=o,e.y=r,e.vx=0,e.vy=0,e.onGround=!0,e.state="follow",e.flashTimer=0,e.highlight=0,e.structureShieldTimer=0,e.structureShieldStrength=0}),Ge.x=t.trainingDummy?.x??.75*fe(),Ge.y=t.trainingDummy?.y??b-Ge.height,Ge.health=Ge.maxHealth,Ge.flashTimer=0,Ge.shakeTimer=0,Ge.shakeMagnitude=0,Ge.respawnTimer=0,_e(t,a)}(e)});const et={inventory:[...Pe],activeIndex:0};function tt(){return et.inventory[et.activeIndex]}function at(e){return!!function(e){return e>=0&&e<et.inventory.length}(e)&&(et.activeIndex=e,Ye.equippedWeaponId=et.inventory[e],!0)}function nt(){return et.inventory.slice()}function ot(e=[],{equipId:t}={}){const a=Array.isArray(e)?e:[],n=Array.from(new Set(a.filter(e=>Re[e]))),o=n.length>0?n:[...Pe];et.inventory=o;let i=t&&o.includes(t)?t:Ye.equippedWeaponId;i&&o.includes(i)||(i=o[0]),Ye.equippedWeaponId=i,et.activeIndex=o.indexOf(i),it()}function it(){const e=et.inventory.indexOf(Ye.equippedWeaponId);e>=0?et.activeIndex=e:(et.inventory[0]=et.inventory[0]??Pe[0],et.activeIndex=0,Ye.equippedWeaponId=et.inventory[0])}it();const rt=new Map;function st(e){if(!e)return null;const t=Re[e];if(!t)return rt.delete(e),null;const a=t.ammo,n=t.spread,o=void 0!==a,i=o?Math.max(0,a.magazine??0):Number.POSITIVE_INFINITY,r=o?Math.max(0,a.reserve??0):Number.POSITIVE_INFINITY,s=o?Math.max(.1,a.reloadSeconds??1.2):0;let l=rt.get(e);return l?(l.capacity=i,i===Number.POSITIVE_INFINITY?l.magazine=Number.POSITIVE_INFINITY:l.magazine=o?Math.min(l.magazine,i):i,l.reserve=r,l.reloadSeconds=s,l.spreadDef=n??null,!l.spread&&n&&(l.spread={current:n.base??0}),n||(l.spread=null)):(l={capacity:i,magazine:i===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:i,reserve:r,reloadSeconds:s,reloadTimer:0,reloading:!1,spreadDef:n??null,spread:n?{current:n.base??0}:null},rt.set(e,l)),l}function lt(e){const t=st(e);return t?{magazine:t.magazine,reserve:t.reserve,capacity:t.capacity,reloading:t.reloading,reloadTimer:t.reloadTimer,reloadSeconds:t.reloadSeconds}:null}function ct(e){const t=st(e);return!(!t||t.capacity===Number.POSITIVE_INFINITY||t.reloading||t.magazine>=t.capacity||t.reserve<=0||(t.reloading=!0,t.reloadTimer=t.reloadSeconds,Ye.equippedWeaponId===e&&(Ye.reloading=!0),0))}function dt(e){const t=st(e);t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.magazine=t.capacity,t.reserve=Re[e]?.ammo?.reserve??t.reserve,t.reloading=!1,t.reloadTimer=0)}function ft(e){const t=st(e);t&&(t.capacity=Number.POSITIVE_INFINITY,t.magazine=Number.POSITIVE_INFINITY,t.reserve=Number.POSITIVE_INFINITY,t.reloading=!1,t.reloadTimer=0,Ye.equippedWeaponId===e&&(Ye.reloading=!1))}function ht(){rt.clear(),Ye.equippedWeaponId&&st(Ye.equippedWeaponId)}let ut=!1;const mt={id:Ye.equippedWeaponId};function gt(){const e=tt();return Re[e]??null}function pt(e){const t=Ye.equippedWeaponId;if(!at(e))return!1;t&&t!==Ye.equippedWeaponId&&function(e){const t=rt.get(e);t&&(t.reloading=!1,t.reloadTimer=0,Ye.equippedWeaponId===e&&(Ye.reloading=!1))}(t),st(Ye.equippedWeaponId),Ye.attacking=!1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.attackIndex=-1,Ye.hitboxSpawned=!1;const a=lt(Ye.equippedWeaponId);return Ye.reloading=a?.reloading??!1,Ye.fireCooldown=0,mt.id=Ye.equippedWeaponId,!0}pt(et.activeIndex);const yt=[{id:"meleePrimary",label:"Melee I",allowedCategories:["melee-short","melee-mid"],defaultWeaponId:"combatFists"},{id:"meleeSecondary",label:"Melee II",allowedCategories:["melee-short","melee-mid"],defaultWeaponId:"shockBaton"},{id:"rangedPrimary",label:"Ranged",allowedCategories:["ranged-short","ranged-mid","ranged-heavy"],defaultWeaponId:"strikerPistol"},{id:"throwableAlpha",label:"Throwable I",allowedCategories:["throwable"],defaultWeaponId:"fragGrenade"},{id:"throwableBeta",label:"Throwable II",allowedCategories:["throwable"],defaultWeaponId:"flashBang"},{id:"throwableGamma",label:"Throwable III",allowedCategories:["throwable"],defaultWeaponId:"smokeCanister"},{id:"gadgetAlpha",label:"Gadget I",allowedCategories:["gadget"],defaultWeaponId:"turretDrone"},{id:"gadgetBeta",label:"Gadget II",allowedCategories:["gadget"],defaultWeaponId:"grappleRig"},{id:"gadgetGamma",label:"Gadget III",allowedCategories:["gadget"],defaultWeaponId:"shieldBubble"}],xt="stickman-warfare-loadout.v1";function bt(e){const t=Array.isArray(e?.allowedCategories)?e.allowedCategories:[];return 0===t.length?[]:Object.values(Re).filter(e=>t.includes(e.category)).sort((e,t)=>e.name.localeCompare(t.name)).map(e=>e.id)}function wt(e,t){const a=bt(e);if(0===a.length)return null;const n=[Pe[t],e.defaultWeaponId];for(const e of n)if(e&&a.includes(e))return e;return a[0]}function vt(){return yt.map((e,t)=>({slotId:e.id,weaponId:wt(e,t)}))}let kt=vt();function Mt(e){return kt.findIndex(t=>t.slotId===e)}function St(){const e=new Set;for(let t=0;t<kt.length;t+=1){const a=yt[t];if(!a)continue;const n=bt(a),o=kt[t];let i=o.weaponId;i&&n.includes(i)&&!e.has(i)||(i=n.find(t=>!e.has(t))??n[0]??null),o.weaponId=i??null,i&&e.add(i)}}function Ct({preserveEquipped:e=!0}={}){St();const t=kt.map(e=>e.weaponId).filter(e=>"string"==typeof e&&e.length>0),a=t.length>0?t:Pe.slice();return ot(a,{equipId:e?tt():a[0]}),ht(),a}function Tt(){if("undefined"==typeof localStorage)return!1;try{const e=kt.map(e=>({...e}));return localStorage.setItem(xt,JSON.stringify(e)),!0}catch(e){return console.warn("Failed to save loadout",e),!1}}function It(){return yt.map((e,t)=>{const a=kt[t],n=a?.weaponId??null,o=n?Re[n]??null:null;return{index:t,slotId:e.id,label:e.label,allowedCategories:Array.isArray(e.allowedCategories)?e.allowedCategories.slice():[],allowedWeaponIds:bt(e),weaponId:n,weapon:o}})}const At={visible:!1,slotIndex:0,optionIndex:0,message:null,messageTimer:0};let Rt=!1;function Pt(e){const t=Array.isArray(e)?e:It();!function(e){if(e<=0)return At.slotIndex=0,void(At.optionIndex=0);At.slotIndex>=e&&(At.slotIndex=e-1),At.slotIndex<0&&(At.slotIndex=0)}(t.length);const a=t[At.slotIndex];if(!a)return At.optionIndex=0,t;const n=a.allowedWeaponIds;if(!Array.isArray(n)||0===n.length)return At.optionIndex=0,t;const o=n.indexOf(a.weaponId);return At.optionIndex=o>=0?o:0,t}function Dt(e){At.message=e??null,At.messageTimer=e?2.6:0}function Bt(e){const t=It();0!==t.length&&(At.slotIndex=(At.slotIndex+e+t.length)%t.length,Pt(t))}function Ot(e){const t=It()[At.slotIndex];if(!t)return;const a=function(e,t=1){const a=Mt(e);if(-1===a)return null;const n=bt(yt[a]);if(0===n.length)return null;const o=kt[a].weaponId;let i=n.indexOf(o);-1===i&&(i=0);const r=function(e,t){const a=Mt(e);if(-1===a)return!1;if(!bt(yt[a]).includes(t))return!1;const n=kt[a].weaponId;if(n===t)return!1;const o=kt.findIndex((e,n)=>n!==a&&e.weaponId===t);return o>=0&&(kt[o].weaponId=n),kt[a].weaponId=t,St(),!0}(e,n[(i+t+n.length)%n.length]);return{slotIndex:a,weaponId:kt[a].weaponId,changed:r}}(t.slotId,e);if(!a||!1===a.changed)return void Pt();const n=Pt()[At.slotIndex],o=n?.weapon?.name??"Updated";var i;i=`${n?.label??"Slot"} ? ${o}`,Ct({preserveEquipped:!0}),Tt(),Dt(i)}function Et(){kt=vt(),St(),kt.map(e=>({...e})),Ct({preserveEquipped:!1}),Tt();const e=Pt(),t=e[0]?.weapon?.name;Dt(t?`Defaults restored (${t} equipped)`:"Defaults restored")}function Wt(e){At.visible&&(e.preventDefault(),e.stopPropagation())}const Lt=[{id:"helmet",label:"Helmet",description:"Headgear and visors for the operative.",options:[{id:"helmet-none",name:"No Helmet",description:"Keeps the classic stickman silhouette.",style:{type:"none"}},{id:"helmet-strike",name:"Strike Visor",description:"Angled carbon shell with cyan visor glow.",style:{type:"visor",shellColor:"#1a2233",accentColor:"#2f3b55",visorColor:"#68e7ff",visorAlpha:.7}},{id:"helmet-vanguard",name:"Vanguard Helm",description:"Tactical helmet with reinforced cheek plates.",style:{type:"plated",shellColor:"#2f2a3f",accentColor:"#5f4c7d",trimColor:"#ffb36a"}}]},{id:"armor",label:"Armor",description:"Chest harness and shoulder plating.",options:[{id:"armor-lite",name:"Light Harness",description:"Minimal straps with subdued accents.",style:{type:"harness",strapColor:"#444b63",accentColor:"#8ca3ff"}},{id:"armor-carbon",name:"Carbon Plating",description:"Segmented chest plates with copper trim.",style:{type:"plating",plateColor:"#212733",trimColor:"#ffad66",glowColor:"#ffa24b"}},{id:"armor-scout",name:"Recon Webbing",description:"Layered harness with utility pouches.",style:{type:"webbing",strapColor:"#2f3a44",pouchColor:"#556668",accentColor:"#9ad6ff"}}]},{id:"jetpack",label:"Jetpack",description:"Back-mounted rigs for aerial flair.",options:[{id:"jetpack-none",name:"No Jetpack",description:"Travel light and nimble.",style:{type:"none"}},{id:"jetpack-sprint",name:"Sprint Thrusters",description:"Compact dual thrusters with teal exhaust glow.",style:{type:"dual",bodyColor:"#1f2d44",exhaustColor:"#76e6ff",exhaustAlpha:.75}},{id:"jetpack-bastion",name:"Bastion Pack",description:"Armored flight rig with amber burn.",style:{type:"shielded",bodyColor:"#3a2f2f",panelColor:"#5e4a3a",exhaustColor:"#ffb96a",exhaustAlpha:.8}}]}],$t=Lt.reduce((e,t)=>(t.options.forEach(a=>{e[a.id]={...a,category:t.id}}),e),{}),Nt={helmet:"helmet-strike",armor:"armor-carbon",jetpack:"jetpack-none"},jt="stickman-warfare-cosmetics.v1",Ft={selections:{...Nt}};function Ht(e){const t=Lt.find(t=>t.id===e);return Array.isArray(t?.options)?t.options.map(e=>e.id):[]}function Yt(e,t){const a=Ht(e);if(0===a.length)return null;if(t&&a.includes(t))return t;const n=Nt[e];return n&&a.includes(n)?n:a[0]}function Xt(){const e={};Lt.forEach(t=>{e[t.id]=Yt(t.id,Ft.selections[t.id])}),Ft.selections=e}function zt(){return{...Ft.selections}}function qt(e){return $t[e]??null}function Kt(){if("undefined"==typeof localStorage)return!1;try{return localStorage.setItem(jt,JSON.stringify(Ft.selections)),!0}catch(e){return console.warn("Failed to save cosmetics",e),!1}}Xt();const Ut={visible:!1,categoryIndex:0,optionIndex:0,message:null,messageTimer:0};let Gt=!1;function Jt(){return Lt.map(e=>({id:e.id,label:e.label,description:e.description,options:e.options.map(t=>({...t,category:e.id}))}))}function Vt(e){const t=Array.isArray(e)?e:Jt();!function(e){if(e<=0)return Ut.categoryIndex=0,void(Ut.optionIndex=0);Ut.categoryIndex>=e&&(Ut.categoryIndex=e-1),Ut.categoryIndex<0&&(Ut.categoryIndex=0)}(t.length);const a=t[Ut.categoryIndex],n=zt();if(!a)return Ut.optionIndex=0,{categories:t,selections:n};const o=Array.isArray(a.options)?a.options:[];if(0===o.length)return Ut.optionIndex=0,{categories:t,selections:n};const i=n[a.id],r=o.findIndex(e=>e.id===i);return Ut.optionIndex=r>=0?r:0,{categories:t,selections:n}}function _t(e){Ut.message=e??null,Ut.messageTimer=e?2.6:0}function Qt(e){const t=Jt();0!==t.length&&(Ut.categoryIndex=(Ut.categoryIndex+e+t.length)%t.length,Vt(t),_t(null))}function Zt(e){const t=Jt(),a=t[Ut.categoryIndex];if(!a)return;const n=function(e,t=1){const a=Ht(e);if(0===a.length)return null;const n=Ft.selections[e]??a[0],o=a.indexOf(n),i=a[(o+t+a.length)%a.length],r=function(e,t){if(!e)return!1;const a=Yt(e,t);return!!a&&Ft.selections[e]!==a&&(Ft.selections={...Ft.selections,[e]:a},!0)}(e,i);return{optionId:i,changed:r}}(a.id,e);if(!n)return;Vt(t);const o=qt(n.optionId);n.changed&&o&&_t(`${a.label}: ${o.name}`),Kt()}function ea(e){Ut.visible&&(e.preventDefault(),e.stopPropagation())}const ta="stickman-warfare-scenarios.v1",aa=[{id:"urban-gauntlet",name:"Urban Gauntlet",environmentId:ee?.[0]??Object.keys(Z)[0],description:"Dual-lane rush with staggered reinforcements.",startingMaterials:1800,enemyCount:6,playerSpawnRatio:.42,dummySpawnRatio:.78,enemySpawnRatios:[.16,.78]},{id:"verdant-encirclement",name:"Verdant Encirclement",environmentId:ee?.[1]??Object.keys(Z)[0],description:"Flank threats among elevated jungle walkways.",startingMaterials:2200,enemyCount:8,playerSpawnRatio:.48,dummySpawnRatio:.72,enemySpawnRatios:[.24,.68]},{id:"spire-overwatch",name:"Spire Overwatch",environmentId:ee?.[3]??Object.keys(Z)[0],description:"Skylanes with vertical sightlines and tight AI patrols.",startingMaterials:2600,enemyCount:10,playerSpawnRatio:.5,dummySpawnRatio:.82,enemySpawnRatios:[.3,.74]}];function na(e){return JSON.parse(JSON.stringify(e))}const oa={scenarios:aa.map(na)};function ia(e){return e&&Z[e]?e:ee?.[0]??Object.keys(Z)[0]}function ra(e,t=.5){return Number.isFinite(e)?Math.min(.98,Math.max(.02,e)):t}function sa(){if("undefined"==typeof localStorage)return!1;try{return localStorage.setItem(ta,JSON.stringify(oa.scenarios)),!0}catch(e){return console.warn("Failed to save scenarios",e),!1}}function la(){return oa.scenarios.map(na)}function ca(e){const t=oa.scenarios;return 0===t.length?0:(e%t.length+t.length)%t.length}function da(e,t,a){const n=ca(e),o=oa.scenarios[n];if(!o)return o;const i={...o};switch(t){case"name":i.name="string"==typeof a&&a.trim().length>0?a.trim():o.name;break;case"description":i.description="string"==typeof a?a.trim():o.description;break;case"environmentId":i.environmentId=ia(a)??o.environmentId;break;case"startingMaterials":i.startingMaterials=Math.max(0,Math.round(Number(a)||0));break;case"enemyCount":i.enemyCount=Math.max(0,Math.round(Number(a)||0));break;case"playerSpawnRatio":i.playerSpawnRatio=ra(Number(a),o.playerSpawnRatio);break;case"dummySpawnRatio":i.dummySpawnRatio=ra(Number(a),o.dummySpawnRatio);break;case"enemySpawnRatios":Array.isArray(a)&&a.length>=2&&(i.enemySpawnRatios=[ra(a[0],o.enemySpawnRatios[0]),ra(a[1],o.enemySpawnRatios[1])])}return oa.scenarios[n]=i,sa(),i}function fa(e,t,a,n=1){const o=ca(e),i=oa.scenarios[o];if(!i)return i;switch(t){case"startingMaterials":return da(o,t,i.startingMaterials+a*n);case"enemyCount":return da(o,t,i.enemyCount+a*n);case"playerSpawnRatio":return da(o,t,i.playerSpawnRatio+a*n);case"dummySpawnRatio":return da(o,t,i.dummySpawnRatio+a*n);case"enemySpawnLeft":return da(o,"enemySpawnRatios",[i.enemySpawnRatios[0]+a*n,i.enemySpawnRatios[1]]);case"enemySpawnRight":return da(o,"enemySpawnRatios",[i.enemySpawnRatios[0],i.enemySpawnRatios[1]+a*n]);default:return i}}!function(){if("undefined"==typeof localStorage)return oa.scenarios;try{const e=localStorage.getItem(ta);if(!e)return oa.scenarios;const t=JSON.parse(e);if(!Array.isArray(t))return oa.scenarios;const a=t.map((e,t)=>function(e,t=aa[0]){const a=e&&"object"==typeof e?e:t;return{id:"string"==typeof a.id?a.id:t.id,name:"string"==typeof a.name?a.name:t.name,environmentId:ia(a.environmentId??t.environmentId),description:"string"==typeof a.description?a.description:t.description,startingMaterials:Number.isFinite(a.startingMaterials)?Math.max(0,Math.round(a.startingMaterials)):t.startingMaterials,enemyCount:Number.isFinite(a.enemyCount)?Math.max(0,Math.round(a.enemyCount)):t.enemyCount,playerSpawnRatio:ra(a.playerSpawnRatio,t.playerSpawnRatio),dummySpawnRatio:ra(a.dummySpawnRatio,t.dummySpawnRatio),enemySpawnRatios:Array.isArray(a.enemySpawnRatios)&&a.enemySpawnRatios.length>=2?[ra(a.enemySpawnRatios[0],t.enemySpawnRatios[0]),ra(a.enemySpawnRatios[1],t.enemySpawnRatios[1])]:t.enemySpawnRatios.slice()}}(e,aa[t%aa.length]));oa.scenarios=a}catch(e){console.warn("Failed to load scenarios",e),oa.scenarios=aa.map(na)}oa.scenarios}();const ha=[{id:"scenarioSlot",label:"Scenario Slot"},{id:"name",label:"Scenario Name",editable:!0},{id:"environmentId",label:"Environment"},{id:"startingMaterials",label:"Starting Materials",step:250},{id:"enemyCount",label:"Enemy Count",step:1},{id:"playerSpawnRatio",label:"Player Spawn %",step:.02},{id:"dummySpawnRatio",label:"Dummy Spawn %",step:.02},{id:"enemySpawnLeft",label:"Enemy Left %",step:.02},{id:"enemySpawnRight",label:"Enemy Right %",step:.02},{id:"description",label:"Mission Brief",editable:!0}],ua={visible:!1,fieldIndex:0,slotIndex:0,message:null,messageTimer:0},ma={pendingApplication:null,appliedScenarioId:null,spawnOverride:null};let ga=!1;function pa(e){ua.message=e??null,ua.messageTimer=e?2.6:0}function ya(){ua.visible&&(ua.visible=!1)}function xa(e){const t=e?Z[e]:null;return t?.name??e??"Unknown"}function ba(e){!function(e){const t=ha.length;ua.fieldIndex=0!==t?(e%t+t)%t:0}(ua.fieldIndex+e),pa(null)}function wa(e){const t=ha[ua.fieldIndex];if(!t)return;if(!la()[ua.slotIndex])return;const a=t.step??1;switch(t.id){case"scenarioSlot":!function(e){const t=la();if(0===t.length)return;const a=((ua.slotIndex+e)%t.length+t.length)%t.length;ua.slotIndex!==a&&(ua.slotIndex=a,pa(`Scenario ${a+1}: ${t[a].name}`))}(e);break;case"environmentId":{const t=function(e,t=1){const a=ca(e),n=oa.scenarios[a];if(!n)return n;const o=Array.isArray(ee)&&ee.length>0?ee:Object.keys(Z),i=o.indexOf(n.environmentId);return da(a,"environmentId",o[((i>=0?i:0)+t+o.length)%o.length])}(ua.slotIndex,e);pa(`Environment: ${xa(t.environmentId)}`);break}case"startingMaterials":pa(`Materials: ${fa(ua.slotIndex,"startingMaterials",e,a).startingMaterials}`);break;case"enemyCount":pa(`Enemies: ${fa(ua.slotIndex,"enemyCount",e,a).enemyCount}`);break;case"playerSpawnRatio":pa(`Player Spawn: ${(100*fa(ua.slotIndex,"playerSpawnRatio",e,a).playerSpawnRatio).toFixed(0)}%`);break;case"dummySpawnRatio":pa(`Dummy Spawn: ${(100*fa(ua.slotIndex,"dummySpawnRatio",e,a).dummySpawnRatio).toFixed(0)}%`);break;case"enemySpawnLeft":pa(`Left Spawn: ${(100*fa(ua.slotIndex,"enemySpawnLeft",e,a).enemySpawnRatios[0]).toFixed(0)}%`);break;case"enemySpawnRight":pa(`Right Spawn: ${(100*fa(ua.slotIndex,"enemySpawnRight",e,a).enemySpawnRatios[1]).toFixed(0)}%`)}}function va(e){ua.visible&&(e.preventDefault(),e.stopPropagation())}const ka={shot:{generator:function(e){const t=Math.floor(.32*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(13.5*-t),i=.55*Math.sin(2*Math.PI*(680+40*Math.sin(110*t))*t),r=Math.sin(2*Math.PI*1320*t)*Math.exp(25*-t)*.2,s=.45*(2*Math.random()-1);n[a]=(i+r+s)*o}return a},playbackRate:[.94,1.08],gain:.9,pan:.35},muzzle:{generator:function(e){const t=Math.floor(.12*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(32*-t),i=.5*Math.sin(2*Math.PI*(1400+120*Math.sin(60*t))*t),r=.25*(2*Math.random()-1);n[a]=(i+r)*o}return a},playbackRate:[1,1.12],gain:.4,pan:.2},reloadStart:{generator:function(e){const t=Math.floor(.24*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*220*t)*Math.exp(6*-t),i=Math.sin(2*Math.PI*440*t)*Math.exp(8*-t)*.3;n[a]=.6*(o+i)}return a},playbackRate:[1,1],gain:.45},reloadFinish:{generator:function(e){const t=Math.floor(.22*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*360*t)*Math.exp(7*-t),i=Math.sin(2*Math.PI*720*t)*Math.exp(9*-t)*.4;n[a]=.6*(o+i)}return a},playbackRate:[1,1],gain:.5},recoil:{generator:function(e){const t=Math.floor(.28*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*110*t)*Math.exp(9*-t),i=(2*Math.random()-1)*Math.exp(18*-t)*.35;n[a]=.7*(o+i)}return a},playbackRate:[.92,1.05],gain:.35},grenadeThrow:{generator:function(e){const t=Math.floor(.3*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*(180+120*t)*t)*Math.exp(6*-t),i=(2*Math.random()-1)*Math.exp(10*-t)*.25;n[a]=.65*(o+i)}return a},playbackRate:[.95,1.05],gain:.3,pan:.25},explosion:{generator:function(e){const t=Math.floor(.9*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(4.5*-t),i=Math.sin(2*Math.PI*(80+20*Math.sin(6*t))*t)*Math.exp(2.2*-t)*.6,r=(2*Math.random()-1)*Math.exp(3.5*-t)*.5;n[a]=(i+r)*o}return a},playbackRate:[.9,1.02],gain:1.1},flash:{generator:function(e){const t=Math.floor(.35*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(18*-t),i=.5*Math.sin(2*Math.PI*(880+140*t)*t),r=Math.sin(2*Math.PI*1760*t)*Math.exp(20*-t)*.3;n[a]=(i+r)*o}return a},playbackRate:[.98,1.05],gain:.7},smokePulse:{generator:function(e){const t=Math.floor(.7*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(3*-t),i=.25*(2*Math.random()-1),r=Math.sin(2*Math.PI*90*t)*Math.exp(4*-t)*.3;n[a]=(i+r)*o}return a},playbackRate:[.9,1.03],gain:.45},shieldHit:{generator:function(e){const t=Math.floor(.4*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*(520+80*Math.sin(45*t))*t)*Math.exp(8*-t)*.6,i=(2*Math.random()-1)*Math.exp(10*-t)*.2;n[a]=o+i}return a},playbackRate:[.95,1.05],gain:.8},shieldShatter:{generator:function(e){const t=Math.floor(.75*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.exp(3.5*-t),i=.6*Math.sin(2*Math.PI*(420+220*Math.sin(6*t))*t),r=.4*Math.sin(2*Math.PI*(980+260*Math.sin(12*t))*t),s=.3*(2*Math.random()-1);n[a]=(i+r+s)*o}return a},playbackRate:[.95,1.02],gain:1},shieldEnd:{generator:function(e){const t=Math.floor(.5*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*(320-90*t)*t)*Math.exp(5*-t);n[a]=.6*o}return a},playbackRate:[.9,1.02],gain:.5},debris:{generator:function(e){const t=Math.floor(.32*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=(2*Math.random()-1)*Math.exp(14*-t)*.35,i=Math.sin(2*Math.PI*640*t)*Math.exp(18*-t)*.2;n[a]=o+i}return a},playbackRate:[.92,1.05],gain:.6,pan:.3},environmentChime:{generator:function(e){const t=Math.floor(.6*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=Math.sin(2*Math.PI*420*t)*Math.exp(3.6*-t)*.5,i=Math.sin(2*Math.PI*630*t)*Math.exp(4.2*-t)*.3,r=Math.sin(2*Math.PI*1260*t)*Math.exp(8.5*-t)*.2;n[a]=o+i+r}return a},playbackRate:[.98,1.04],gain:.4}},Ma={"weapon:shot-fired":{sound:"shot",cooldown:24,intensity:.06},"weapon:muzzle-flash":{sound:"muzzle",cooldown:18,intensity:.01},"weapon:reload-start":{sound:"reloadStart",cooldown:140},"weapon:reload-finish":{sound:"reloadFinish",cooldown:140,intensity:.02},"weapon:recoil-kick":{sound:"recoil",cooldown:32,intensity:.02},"throwable:thrown":{sound:"grenadeThrow",cooldown:90},"throwable:explosion":{sound:"explosion",cooldown:120,intensity:.09},"throwable:flash-burst":{sound:"flash",cooldown:140,intensity:.08},"throwable:smoke-detonate":{sound:"smokePulse",cooldown:220,intensity:.02},"throwable:smoke-dissipate":{sound:"smokePulse",cooldown:260},"shield:hit":{sound:"shieldHit",cooldown:45,intensity:.03},"shield:shatter":{sound:"shieldShatter",cooldown:260,intensity:.08},"shield:end":{sound:"shieldEnd",cooldown:200},"destructible:hit":{sound:"debris",cooldown:26},"destructible:explosion":{sound:"explosion",cooldown:160,intensity:.08},"environment:changed":{sound:"environmentChime",cooldown:600,intensity:.05}};let Sa=null,Ca=null,Ta=null,Ia=null,Aa=!1,Ra=!1,Pa=null,Da=.28,Ba=0;const Oa=new Map,Ea=new Map,Wa=[];function La(e,t){const a=Ma[e];a&&Sa&&function(e,t){if(t<=0)return!0;const a=performance.now();return!(a-(Ea.get(e)??0)<t)&&(Ea.set(e,a),!0)}(e,a.cooldown??0)&&(ja(),function(e,t={}){if(!Sa||!Ta)return;const a=Oa.get(e);if(!a)return;const n=Sa.createBufferSource();n.buffer=a;const o=t.playbackRate??ka[e]?.playbackRate??[1,1];n.playbackRate.value=Ha(o[0],o[1]);const i=Sa.createGain(),r=t.gain??ka[e]?.gain??1;i.gain.value=Fa(r);let s=i;const l=ka[e]?.pan;if("number"==typeof l&&Sa.createStereoPanner){const e=Sa.createStereoPanner();e.pan.value=Ha(-l,l),i.connect(e),s=e}s.connect(Ta),n.connect(i),n.start()}(a.sound,a),a.intensity&&function(e=.05){Da=Math.min(.85,Da+e),$a()}(a.intensity))}function $a(){if(Ra||!Sa||!Ia)return;Ra=!0;const e=[Na(function(e){const t=Math.floor(8*e.sampleRate),a=e.createBuffer(2,t,e.sampleRate);for(let n=0;n<2;n+=1){const o=a.getChannelData(n),i=0===n?220:330;for(let a=0;a<t;a+=1){const t=a/e.sampleRate,n=.4+.4*Math.sin(t*Math.PI*.25),r=Math.sin(2*Math.PI*(i+6*Math.sin(2*t))*t),s=.05*(2*Math.random()-1);o[a]=(.6*r+s)*n}}return a}(Sa)),Na(function(e){const t=Math.floor(4*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate%.5,o=t<.08?Math.exp(80*-t):0,i=Math.sin(2*Math.PI*180*t)*o;n[a]=.8*i}return a}(Sa)),Na(function(e){const t=Math.floor(6*e.sampleRate),a=e.createBuffer(1,t,e.sampleRate),n=a.getChannelData(0);for(let a=0;a<t;a+=1){const t=a/e.sampleRate,o=.4*Math.sin(2*Math.PI*110*t),i=.2*Math.sin(2*Math.PI*55*t);n[a]=(o+i)*(.5+.5*Math.sin(t*Math.PI*.5))}return a}(Sa))].filter(Boolean);Wa.push(...e),Da=.32,Ba=0}function Na(e){if(!e||!Sa||!Ia)return null;const t=Sa.createBufferSource();t.buffer=e,t.loop=!0;const a=Sa.createGain();e.duration>=6?a.gain.value=.55:e.duration>=3?a.gain.value=.4:a.gain.value=.25,t.connect(a).connect(Ia);const n=Sa.currentTime+.05;return t.start(n),t}function ja(){Sa&&"suspended"===Sa.state&&"function"==typeof Sa.resume&&Sa.resume().catch(()=>{})}function Fa(e){return Math.max(0,Math.min(1,Number.isFinite(e)?e:0))}function Ha(e,t){return e+Math.random()*(t-e)}function Ya(){if("undefined"==typeof window||!window.P2P){const e=new Error("P2P module not loaded");throw e.code="P2P_NOT_AVAILABLE",e}return window.P2P}const Xa=`peer-${Math.random().toString(36).slice(2,8)}`;let za=null,qa=null,Ka=null,Ua=0,Ga="disconnected",Ja=null;const Va=[];function _a(){return za||"undefined"==typeof window||!window.RTCPeerConnection||(za=new RTCPeerConnection({iceServers:[]}),Ga="connecting",qa=za.createDataChannel("stickman",{ordered:!0}),Qa(qa),za.addEventListener("icecandidate",e=>{e.candidate&&Va.push(JSON.stringify(e.candidate))}),za.addEventListener("connectionstatechange",()=>{Ga=za.connectionState??"unknown"}),za.addEventListener("datachannel",e=>{Ka=e.channel,Qa(Ka)})),za}function Qa(e){e&&(e.addEventListener("open",()=>{Ga="connected"}),e.addEventListener("close",()=>{Ga="disconnected"}),e.addEventListener("message",e=>{try{(t=JSON.parse(e.data))&&"object"==typeof t&&"playerState"===t.type&&Ke({id:t.id,name:t.name,x:t.x,y:t.y,facing:t.facing,commandId:t.commandId})}catch(e){console.warn("Failed to parse P2P payload",e)}var t}))}function Za(){return{id:Xa,status:Ga,localDescription:Ja,localCandidates:[...Va]}}const en={servers:[],visible:!1,selectedIndex:0,lastFetch:0,fetching:!1,error:null,statusMessage:null,hosting:!1,hostingSessionId:null,hostingLastHeartbeat:0,hostingExpiresAt:0,joinStatus:null,joinError:null,hostingMetrics:{playerCount:1,enemyCount:0,alliesCount:0},p2p:{offer:null,answer:null,pendingOffer:!1,pendingAnswer:!1,pendingCandidates:!1,localCandidates:[],remoteCandidates:[],error:null}};function tn(){return en}function an(e){en.visible=e,e||(en.statusMessage=null,en.error=null)}function nn(e){const t=en.servers[en.selectedIndex]?.id;if(en.servers=Array.isArray(e)?e:[],t){const e=en.servers.findIndex(e=>e.id===t);e>=0&&(en.selectedIndex=e)}en.selectedIndex>=en.servers.length&&(en.selectedIndex=Math.max(0,en.servers.length-1))}function on(e){en.error=e}function rn(e){en.statusMessage=e}function sn(e){en.joinStatus=e}function ln(e){en.joinError=e}function cn(e){en.joinedSessionId=e??null}function dn(e){en.lastFetch=e}function fn(e){en.fetching=e}function hn({id:e,expiresAt:t}){en.hosting=Boolean(e),en.hostingSessionId=e??null,en.hostingLastHeartbeat=performance.now(),en.hostingExpiresAt=t??0}function un(){en.hosting=!1,en.hostingSessionId=null,en.hostingExpiresAt=0,en.hostingLastHeartbeat=0,wn()}function mn(e={}){Number.isFinite(e.playerCount)&&(en.hostingMetrics.playerCount=Math.max(1,Math.round(e.playerCount))),Number.isFinite(e.enemyCount)&&(en.hostingMetrics.enemyCount=Math.max(0,Math.round(e.enemyCount))),Number.isFinite(e.alliesCount)&&(en.hostingMetrics.alliesCount=Math.max(0,Math.round(e.alliesCount)))}function gn(e){en.p2p.answer=e??null}function pn(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=en.p2p.localCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(en.p2p.localCandidates=t)}function yn(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=en.p2p.remoteCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(en.p2p.remoteCandidates=t)}function xn(e){en.p2p.error=e??null}function bn({offer:e,answer:t,candidates:a}){"boolean"==typeof e&&(en.p2p.pendingOffer=e),"boolean"==typeof t&&(en.p2p.pendingAnswer=t),"boolean"==typeof a&&(en.p2p.pendingCandidates=a)}function wn(){en.p2p.offer=null,en.p2p.answer=null,en.p2p.pendingOffer=!1,en.p2p.pendingAnswer=!1,en.p2p.pendingCandidates=!1,en.p2p.localCandidates=[],en.p2p.remoteCandidates=[],en.p2p.error=null}function vn(e,t,a){return Math.max(t,Math.min(a,e))}const kn={buggy:{label:"Recon Buggy",movementType:"ground",width:132,height:48,wheelRadius:18,wheelBase:76,driverSeat:{x:-6,y:42},exitOffsets:[{x:72,y:0},{x:-72,y:0}],enterRadius:96,acceleration:600,braking:920,maxSpeed:460,idleDrag:340,airDrag:.92,baseHealth:320,colorBody:"#2e3147",colorAccent:"#ffb84d",colorDetail:"#f7f9ff"},raptorHeli:{label:"Raptor Helicopter",movementType:"air",mountedWeapons:[{id:"raptorHeli.noseCannon",label:"Nose Cannon",binding:"primary",offset:{x:32,y:2},muzzles:[{x:46,y:-3},{x:46,y:3}],projectile:{speed:760,damage:16,radius:4,color:"#8cf4ff",gravityFactor:.04,knockback:80},scatter:3.5,fireInterval:.085,flashDuration:.08,flashRadius:14,barrelLength:52,barrelWidth:5,barrelColor:"#8cf4ff"}],width:156,height:54,driverSeat:{x:6,y:44},exitOffsets:[{x:88,y:0},{x:-88,y:0}],enterRadius:128,horizontalAcceleration:360,horizontalMaxSpeed:320,horizontalDrag:180,idleDrag:140,airDrag:.98,liftPower:940,descendPower:660,gravityScale:.3,maxVerticalSpeed:240,verticalDamping:.9,hoverMinAltitude:28,hoverMaxAltitude:260,spawnHover:60,autopilotStrength:5.5,baseHealth:460,colorBody:"#303952",colorAccent:"#8cf4ff",colorDetail:"#f4fbff",rotorSpan:210,rotorThickness:7,tailLength:86},arrowJet:{label:"Arrow Fighter",movementType:"air",mountedWeapons:[{id:"arrowJet.rackRockets",label:"Wing Rockets",binding:"secondary",offset:{x:12,y:-6},muzzles:[{x:52,y:-12},{x:52,y:12}],projectile:{speed:820,damage:28,radius:6,color:"#ff6b80",gravityFactor:.05,knockback:180},scatter:4,fireInterval:.24,flashDuration:.09,flashRadius:15,barrelLength:54,barrelWidth:5,barrelColor:"#ff6b80"}],width:180,height:36,driverSeat:{x:0,y:32},exitOffsets:[{x:96,y:-8},{x:-96,y:-8}],enterRadius:132,horizontalAcceleration:400,horizontalMaxSpeed:360,horizontalDrag:160,idleDrag:130,airDrag:.97,liftPower:920,descendPower:640,gravityScale:.32,maxVerticalSpeed:280,verticalDamping:.88,hoverMinAltitude:48,hoverMaxAltitude:360,spawnHover:120,autopilotStrength:4.2,baseHealth:400,colorBody:"#262c3e",colorAccent:"#ff6b80",colorDetail:"#f8f8ff",wingSpan:230},tideSkiff:{label:"Tide Skiff",movementType:"water",mountedWeapons:[{id:"tideSkiff.prowCannon",label:"Prow Cannon",binding:"primary",offset:{x:28,y:-18},muzzles:[{x:36,y:-4}],projectile:{speed:580,damage:22,radius:6,color:"#ffdd8a",gravityFactor:.08,knockback:140},scatter:2.5,fireInterval:.2,flashDuration:.1,flashRadius:14,barrelLength:46,barrelWidth:6,barrelColor:"#5fd3ff"}],width:150,height:42,driverSeat:{x:-10,y:34},exitOffsets:[{x:92,y:-4},{x:-92,y:-4}],enterRadius:120,waterSurfaceOffset:28,waterAcceleration:320,waterMaxSpeed:270,waterReverseSpeed:150,waterIdleDrag:180,turnDrag:240,bobAmplitude:6,bobSpeed:1.5,buoyancyPoint:.58,splashIntensity:.4,baseHealth:360,colorBody:"#1f2e3f",colorAccent:"#5fd3ff",colorDetail:"#f5fbff"},stormBarge:{label:"Storm Barge",movementType:"water",mountedWeapons:[{id:"stormBarge.deckChaingun",label:"Deck Chaingun",binding:"primary",offset:{x:18,y:-24},muzzles:[{x:58,y:-6},{x:58,y:6}],projectile:{speed:640,damage:18,radius:5,color:"#ffc86d",gravityFactor:.06,knockback:100},scatter:5,fireInterval:.1,flashDuration:.08,flashRadius:16,barrelLength:58,barrelWidth:6,barrelColor:"#ffa94d"}],width:200,height:60,driverSeat:{x:14,y:46},exitOffsets:[{x:110,y:-6},{x:-110,y:-6}],enterRadius:132,waterSurfaceOffset:32,waterAcceleration:210,waterMaxSpeed:190,waterReverseSpeed:110,waterIdleDrag:280,turnDrag:320,bobAmplitude:4,bobSpeed:1.2,buoyancyPoint:.62,splashIntensity:.3,baseHealth:520,colorBody:"#232f3a",colorAccent:"#ffa94d",colorDetail:"#f0f4ff"},abyssSub:{label:"Abyss Sub",movementType:"water",mountedWeapons:[{id:"abyssSub.torpedoLauncher",label:"Twin Torpedoes",binding:"secondary",offset:{x:12,y:-10},muzzles:[{x:40,y:-6},{x:40,y:6}],projectile:{speed:520,damage:34,radius:7,color:"#8c9eff",gravityFactor:.02,knockback:200},scatter:1.5,fireInterval:.52,flashDuration:.12,flashRadius:18,barrelLength:48,barrelWidth:7,barrelColor:"#8c9eff"}],width:132,height:48,driverSeat:{x:0,y:36},exitOffsets:[{x:78,y:-10},{x:-78,y:-10}],enterRadius:110,waterSurfaceOffset:36,waterAcceleration:300,waterMaxSpeed:260,waterReverseSpeed:160,waterIdleDrag:210,turnDrag:240,bobAmplitude:3,bobSpeed:1.1,buoyancyPoint:.5,submergedOffset:18,splashIntensity:.2,baseHealth:540,colorBody:"#182733",colorAccent:"#8c9eff",colorDetail:"#e9f1ff"},scoutDrone:{label:"Scout Drone",movementType:"air",width:72,height:28,driverSeat:{x:0,y:20},exitOffsets:[{x:48,y:0},{x:-48,y:0}],enterRadius:90,horizontalAcceleration:320,horizontalMaxSpeed:300,horizontalDrag:200,idleDrag:190,airDrag:.95,liftPower:720,descendPower:560,gravityScale:.26,maxVerticalSpeed:200,verticalDamping:.88,hoverMinAltitude:24,hoverMaxAltitude:220,spawnHover:48,autopilotStrength:6.8,baseHealth:210,colorBody:"#293444",colorAccent:"#ffe066",colorDetail:"#edf4ff"}};let Mn=0;function Sn(e,t,a={}){const n=kn[e];if(!n)throw new Error(`Unknown vehicle type: ${e}`);const o=n.movementType??"ground",i=.5*n.width,r=fe(),s=vn(t??.5*r,i,Math.max(i,r-.5*n.width));let l,c=!0,d=null,f=a.hover??n.spawnHover??0;if("air"===o){const e=n.hoverMinAltitude??0,t=vn(f,e,n.hoverMaxAltitude??e);l=b-n.height-t,c=!1,f=t}else if("water"===o){const e=n.waterSurfaceOffset??24;d=b-e;const t=vn(n.buoyancyPoint??.55,.2,.9),a=n.submergedOffset??0;l=d-n.height*t+a,c=!1,f=0}else l=b-n.height;const h={id:`vehicle-${e}-${Mn+=1}`,type:e,x:s,y:l,vx:0,vy:0,tilt:0,facing:1,driverId:null,health:n.baseHealth,maxHealth:n.baseHealth,enterCooldown:0,damageFlash:0,onGround:c,preferredAltitude:"air"===o?f:0,waterLineY:d,bobPhase:Math.random()*Math.PI*2};return h.mounts=(n.mountedWeapons??[]).map((t,a)=>({id:t.id??`${e}-mount-${a}`,cooldown:0,flashTimer:0,muzzleIndex:0,lastMuzzleX:null,lastMuzzleY:null})),h}const Cn=[Sn("buggy",.14*fe()),Sn("buggy",.28*fe()),Sn("tideSkiff",.38*fe()),Sn("raptorHeli",.56*fe(),{hover:140}),Sn("arrowJet",.64*fe(),{hover:200}),Sn("stormBarge",.74*fe()),Sn("abyssSub",.78*fe()),Sn("scoutDrone",.9*fe(),{hover:100})];function Tn(e,t,a){return Math.max(t,Math.min(a,e))}let In=0;function An(){return In}const Rn={bestWave:0,bestKills:0,bestReward:0},Pn={active:!1,stage:"inactive",timer:0,wave:0,enemiesAlive:0,lastReward:0,kills:0,runReward:0,bestWave:0,bestKills:0,bestReward:0,lastOutcome:null};function Dn({preserveStats:e=!0}={}){(function(e=!0){e?(Rn.bestWave=Math.max(Rn.bestWave,Pn.bestWave),Rn.bestKills=Math.max(Rn.bestKills,Pn.bestKills),Rn.bestReward=Math.max(Rn.bestReward,Pn.bestReward)):(Rn.bestWave=0,Rn.bestKills=0,Rn.bestReward=0)})(!!e),Pn.active=!1,Pn.stage="inactive",Pn.timer=0,Pn.wave=0,Pn.enemiesAlive=0,Pn.lastReward=0,Pn.kills=0,Pn.runReward=0,Pn.lastOutcome=null,Pn.bestWave=Rn.bestWave,Pn.bestKills=Rn.bestKills,Pn.bestReward=Rn.bestReward}function Bn(e,t=0){Pn.stage=e,Pn.timer=Math.max(0,t??0)}function On(e){Pn.timer=Math.max(0,e??0)}function En(e){Pn.enemiesAlive=Math.max(0,Math.floor(e??0))}function Wn(e){const t=Math.max(0,Math.round(e??0));Pn.lastReward=t,t>0&&(Pn.runReward+=t,Pn.bestReward=Math.max(Pn.bestReward,Pn.runReward),Rn.bestReward=Math.max(Rn.bestReward,Pn.bestReward))}function Ln(e){const t=Math.max(0,Math.round(e??0));t<=0||(Pn.runReward+=t,Pn.bestReward=Math.max(Pn.bestReward,Pn.runReward),Rn.bestReward=Math.max(Rn.bestReward,Pn.bestReward))}function $n(e){Pn.lastOutcome=e??null}function Nn(){return Pn}Pn.bestWave=Math.max(Pn.bestWave,Rn.bestWave),Pn.bestKills=Math.max(Pn.bestKills,Rn.bestKills),Pn.bestReward=Math.max(Pn.bestReward,Rn.bestReward),pe(()=>{Dn({preserveStats:!1})});const jn={player:[{radius:16,offsetX:0,offsetY:-42,color:"#f4f7ff"},{radius:12,offsetX:0,offsetY:-14,color:"#cfd3df"},{radius:10,offsetX:-14,offsetY:6,color:"#f4f7ff"},{radius:10,offsetX:14,offsetY:6,color:"#f4f7ff"},{radius:11,offsetX:-10,offsetY:34,color:"#cfd3df"},{radius:11,offsetX:10,offsetY:34,color:"#cfd3df"}],enemy:[{radius:16,offsetX:0,offsetY:-40,color:"#fa5b4a"},{radius:12,offsetX:0,offsetY:-12,color:"#d94d3f"},{radius:10,offsetX:-12,offsetY:8,color:"#ff9488"},{radius:10,offsetX:12,offsetY:8,color:"#ff9488"},{radius:11,offsetX:-10,offsetY:36,color:"#d94d3f"},{radius:11,offsetX:10,offsetY:36,color:"#d94d3f"}]},Fn=[];function Hn(e,t,a,n=1,o=0,i=0){const r=jn[e];if(r)for(const e of r)Fn.push({x:t+e.offsetX*n,y:a+e.offsetY,vx:o+n*(40+80*Math.random())+60*(Math.random()-.5),vy:i-(80+140*Math.random()),radius:e.radius,color:e.color,life:1.6+.8*Math.random(),maxLife:1.6+.8*Math.random()})}const Yn=[];function Xn(e,t,a){Yn.push({x:e,y:t,value:a,life:.75,maxLife:.75,vx:24*(Math.random()-.5),vy:-60-20*Math.random()})}const zn=[],qn=[];let Kn=!1;const Un=["#8b0f14","#b11217","#d92c32","#f0483c"],Gn=["rgba(240, 72, 60, 0.55)","rgba(217, 44, 50, 0.45)"],Jn=["#ffd36b","#ffeaa1","#ff9b45"],Vn={sand:["#cbb188","#a17b53","#e4c9a2"],stone:["#d6d8df","#adb4c1","#8b929f"],steel:["#94aaff","#c5d2ff","#6f7ab0"],default:["#c8b7a1","#9c8366"]};function _n(e){return e[Math.floor(Math.random()*e.length)]??e[0]}function Qn(e={}){const t=e.ttl??.4,a={x:e.x??0,y:e.y??0,startRadius:e.startRadius??70,endRadius:e.endRadius??140,color:e.color??"#ffffff",maxTtl:t,ttl:t,lineWidth:e.lineWidth??5};return qn.push(a),a}function Zn(e={}){const t=e.x??0,a=e.y??0,n=e.facing??1,o=Tn(e.intensity??(e.damage??0)/Math.max(1,e.maxDamage??60),0,1),i=Math.max(4,Math.round(e.amount??8+10*o)),r=e.speed??220+140*o,s=e.gravity??980;for(let l=0;l<i;l+=1){const i=e.spread??.55*Math.PI,l=Math.random()*i-.5*i+(n>=0?0:Math.PI),c=r*(.55+.9*Math.random()),d=Math.cos(l)*c,f=Math.sin(l)*c-(80+140*o),h=.45+.25*Math.random();zn.push({type:"blood",x:t,y:a,vx:d,vy:f,ttl:h,maxTtl:h,radius:3+2.6*Math.random(),color:_n(Un),gravity:s})}const l=Math.max(2,Math.round(.35*i));for(let e=0;e<l;e+=1){const e=Math.random()*Math.PI*2,n=60+110*Math.random(),o=.35+.3*Math.random();zn.push({type:"bloodMist",x:t+6*Math.cos(e),y:a+4*Math.sin(e),vx:Math.cos(e)*n*.4,vy:Math.sin(e)*n*.2-40,ttl:o,maxTtl:o,radius:12+10*Math.random(),color:_n(Gn)})}}function eo(e={}){const t=e.x??0,a=e.y??0,n=Math.max(4,Math.round(e.amount??8)),o=e.speed??260,i=Array.isArray(e.palette)&&e.palette.length>0?e.palette:Jn;for(let r=0;r<n;r+=1){const n=(e.angle??0)+(Math.random()-.5)*(e.spread??.9*Math.PI),r=o*(.5+.8*Math.random()),s=.18+.18*Math.random();zn.push({type:"spark",x:t,y:a,vx:Math.cos(n)*r,vy:Math.sin(n)*r,ttl:s,maxTtl:s,radius:2+2*Math.random(),color:_n(i)})}}function to(e={}){const t=e.x??0,a=e.y??0,n=Math.max(4,Math.round(e.amount??9)),o=Array.isArray(e.palette)&&e.palette.length>0?e.palette:function(e,t=Vn.default){return e?Vn[e]??t:t}(e.paletteName,Vn.default),i=e.angle??1.5*Math.PI,r=e.spread??.9*Math.PI,s=e.speed??160;for(let l=0;l<n;l+=1){const n=i+(Math.random()-.5)*r,l=s*(.5+.9*Math.random()),c=.6+.3*Math.random();zn.push({type:"dust",x:t,y:a,vx:Math.cos(n)*l,vy:Math.sin(n)*l-40,ttl:c,maxTtl:c,radius:(e.radius??12)*(.5+.6*Math.random()),color:_n(o)})}}function ao(e={}){to({x:e.x,y:e.y,amount:e.amount??8,paletteName:e.paletteName??"sand",speed:e.speed??140,spread:e.spread??1.1*Math.PI,angle:e.angle??1.4*Math.PI,radius:e.radius??14})}function no(e={},t={}){const a=e.center??{x:e.x??0,y:e.y??0};return Qn({x:a.x,y:a.y,ttl:t.ttl??.4,startRadius:t.startRadius??e.radius??70,endRadius:t.endRadius??1.25*(e.radius??70),color:t.color??"#7cd6ff",lineWidth:t.lineWidth??5})}function oo(e={}){const t=e.center??{x:0,y:0};for(let e=0;e<9;e+=1){const e=Math.random()*Math.PI*2,a=90+150*Math.random(),n=Math.cos(e)*a,o=Math.sin(e)*a,i=.3+.2*Math.random();zn.push({type:"shield",x:t.x,y:t.y,vx:n,vy:o,ttl:i,maxTtl:i,radius:6+6*Math.random(),color:"#9be9ff"})}no(e,{ttl:.35,startRadius:.75*(e.radius??72),endRadius:1.15*(e.radius??72),lineWidth:4,color:"#a9f0ff"})}function io(){Kn||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",e=>{!function(e={}){const t=e.x??0,a=e.y??0,n=e.facing??1;for(let e=0;e<6;e+=1){const e=140+120*Math.random(),o=.6*Math.random()-.3+(n>0?0:Math.PI),i=Math.cos(o)*e,r=Math.sin(o)*e,s=.18+.08*Math.random();zn.push({type:"spark",x:t,y:a,vx:i,vy:r,ttl:s,maxTtl:s,radius:4+3*Math.random(),color:"#ffdd9a"})}}(e?.detail??{})}),window.addEventListener("shield:hit",e=>{oo(e?.detail??{})}),window.addEventListener("shield:shatter",e=>{!function(e={}){no(e,{ttl:.55,startRadius:.9*(e.radius??96),endRadius:1.6*(e.radius??96),lineWidth:7,color:"#7cd6ff"}),oo({center:e.center,radius:e.radius??96})}(e?.detail??{})}),window.addEventListener("throwable:explosion",e=>{ro(e?.detail??{})}),window.addEventListener("throwable:flash-burst",e=>{!function(e={}){const t=e.x??0,a=e.y??0,n=e.radius??140;Qn({x:t,y:a,startRadius:.6*n,endRadius:1.35*n,color:"#fff6d0",lineWidth:8,ttl:.32});for(let e=0;e<12;e+=1){const e=Math.random()*Math.PI*2,n=160+140*Math.random(),o=.18+.08*Math.random();zn.push({type:"flash",x:t,y:a,vx:Math.cos(e)*n,vy:Math.sin(e)*n,ttl:o,maxTtl:o,radius:5+3*Math.random(),color:"#fffbe0"})}}(e?.detail??{})}),window.addEventListener("throwable:smoke-spawn",e=>{so(e?.detail??{})}),window.addEventListener("throwable:smoke-dissipate",e=>{!function(e={}){Qn({x:e.x??0,y:e.y??0,startRadius:.8*(e.radius??110),endRadius:1.1*(e.radius??110),color:"#95a8b8",lineWidth:3,ttl:.4})}(e?.detail??{})}),window.addEventListener("destructible:hit",e=>{!function(e={}){const t={concrete:["#dfe6f2","#b9c3d0","#6c7584"],vehicle:["#ffd6c8","#ff9a82","#3a1a1a"],volatile:["#ffd38a","#ff9c3b","#6e2c05"],generic:["#f2f5ff","#c9d0de"]},a=t[e.material??"generic"]??t.generic,n=Math.max(1,e.maxHealth??e.health??1),o=Tn(1-Math.max(0,Math.min(n,e.health??n))/n,0,1),i=Math.max(6,Math.round(6+6*o)),r=160+200*o;for(let t=0;t<i;t+=1){const n=Math.random()*Math.PI*2,o=r*(.45+.65*Math.random());zn.push({type:"debris",x:e.x??0,y:e.y??0,vx:Math.cos(n)*o,vy:Math.sin(n)*o*.7-50,ttl:.45+.3*Math.random(),maxTtl:.45+.3*Math.random(),radius:3+4*Math.random(),color:a[t%a.length]})}}(e?.detail??{})}),Kn=!0)}function ro(e={}){const t=e.x??0,a=e.y??0,n=e.radius??110;for(let e=0;e<18;e+=1){const e=Math.random()*Math.PI*2,n=220+220*Math.random(),o=.3+.25*Math.random();zn.push({type:"ember",x:t,y:a,vx:Math.cos(e)*n,vy:Math.sin(e)*n,ttl:o,maxTtl:o,radius:5+4*Math.random(),color:Math.random()>.55?"#ff9c4a":"#ffd56b"})}Qn({x:t,y:a,startRadius:.45*n,endRadius:1.05*n,color:"#ffb347",lineWidth:6,ttl:.45})}function so(e={}){const t=e.x??0,a=e.y??0,n=e.radius??e.maxRadius??120;for(let e=0;e<14;e+=1){const e=Math.random()*Math.PI*2,o=30+60*Math.random(),i=Math.cos(e)*o*.4,r=-40-50*Math.random(),s=.9+.5*Math.random();zn.push({type:"smoke",x:t+Math.cos(e)*n*.2,y:a+Math.sin(e)*n*.1,vx:i,vy:r,ttl:s,maxTtl:s,radius:n*(.15+.18*Math.random()),color:"#aec4d8"})}Qn({x:t,y:a,startRadius:.5*n,endRadius:1.2*n,color:"#9db8ca",lineWidth:4,ttl:.5})}const lo=[];function co(e){const t=function(){const e=[];Ge.health>0&&e.push({id:Ge.id,x:Ge.x,y:Ge.y+.5*Ge.height});for(const t of Ve)t.health>0&&e.push({id:t.id,x:t.x,y:t.y+.5*t.height,ref:t});return e}();let a=null,n=1/0;for(const o of t){const t=o.x-e.x,i=o.y-(e.y+.4*e.height),r=t*t+i*i;r<=e.range*e.range&&r<n&&(a=o,n=r)}return a}function fo(e,t){const a=e.x,n=e.y+.35*e.height,o=t.x-a,i=t.y-n;e.facing=Math.sign(o)||e.facing;const r=Math.hypot(o,i)||1,s=e.projectile.speed,l=o/r*s;Ni({x:a,y:n,vx:l,vy:i/r*s,radius:e.projectile.radius,lifetime:e.projectile.lifetime,color:e.projectile.color,damage:e.projectile.damage,knockback:e.projectile.knockback,facing:Math.sign(l)||1,gravityFactor:0}),e.fireTimer=e.fireInterval}const ho={active:!1,tetherLength:0,maxLength:0,targetX:0,targetY:0,duration:0,retracting:!1,cooldown:0,color:"#8cf1ff",travelSpeed:860,pullSpeed:740};function uo(){ho.active=!1,ho.retracting=!1,ho.tetherLength=0,ho.maxLength=0}const mo={active:!1,strength:0,maxStrength:0,duration:0,maxDuration:0,radius:90,color:"#7cd6ff",flashTimer:0};function go(){const e=2*(Ye.currentPose?.headRadius??16)+(Ye.currentPose?.bodyLength??34)+(Ye.currentPose?.legLength??36);return{x:Ye.x,y:Ye.y+.5*e}}function po(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function yo(e="expired"){if(!mo.active)return;const t={reason:e,remainingStrength:mo.strength,maxStrength:mo.maxStrength,duration:mo.duration,maxDuration:mo.maxDuration,center:go(),radius:mo.radius};mo.active=!1,mo.strength=0,mo.duration=0,mo.flashTimer=0,po("shield:end",t)}function xo(e){const t=e?.gadget;if(!t)return!1;if((Ye.gadgetCooldown??0)>0)return!1;switch(t.type??"turret"){case"turret":return function(e){const t=function(e,t){const a=e.height??54,n=e.spawnOffset??{x:64,y:0},o=Le(Ye.currentPose??null)||0,i=fe(),r=Tn(Ye.x+t*(n.x??64),40,i-40),s=Ye.y+o,l=Math.min(s+(n.y??0),b),c=Math.min(b-a,l-a);return{id:`turret-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:r,y:c,height:a,facing:t,range:e.range??260,fireInterval:Math.max(.1,e.fireInterval??.6),fireTimer:.1,duration:e.duration??8,maxDuration:e.duration??8,projectile:{speed:e.projectile?.speed??520,radius:e.projectile?.radius??5,damage:e.projectile?.damage??10,knockback:e.projectile?.knockback??70,lifetime:e.projectile?.lifetime??1.1,color:e.projectile?.color??"#9ae9ff"},baseColor:e.baseColor??"#7a8bff",headColor:e.headColor??"#cfd8ff"}}(e,Ye.facing||1),a=Math.max(1,e.maxActive??1);lo.length>=a&&lo.shift(),lo.push(t)}(t),Ye.gadgetCooldown=t.cooldownSeconds??2.5,!0;case"grapple":return!(ho.active||(Ye.gadgetCooldown??0)>0||(function(e){const t=fe(),a=e.clamp??{left:80,right:t-80},n=e.apex??{y:b-280},o=e.maxLength??320,i=Ye.facing||1,r=Tn(Ye.x+i*o,a.left,a.right),s=Math.min(n.y??b-240,Ye.y-(e.maxRise??260));ho.active=!0,ho.retracting=!1,ho.tetherLength=0,ho.maxLength=Math.hypot(r-Ye.x,s-Ye.y),ho.targetX=r,ho.targetY=s,ho.duration=e.duration??.65,ho.cooldown=e.cooldownSeconds??1.6,ho.color=e.color??"#8cf1ff",ho.travelSpeed=e.travelSpeed??860,ho.pullSpeed=e.pullSpeed??740,Ye.gadgetCooldown=ho.cooldown}(t),0));case"shield":return function(e={}){const t=e.strength??90;!mo.active&&(mo.active=!0,mo.strength=t,mo.maxStrength=t,mo.duration=e.duration??6,mo.maxDuration=mo.duration,mo.radius=e.radius??96,mo.color=e.color??"#7cd6ff",mo.flashTimer=0,Ye.gadgetCooldown=e.cooldownSeconds??4.5)}(t),!0;default:return!1}}function bo(e,t={}){const a=t.context??"sandbox",n=t.autoRespawn??"survival"!==a,o=ma.spawnOverride,i=(o&&Array.isArray(o.points)&&o.points.length>=2&&(!o.context||o.context===a)?o.points:null)??function(){const e=fe(),t=ue(),a=Array.isArray(t?.enemies)?t.enemies.slice(0,2):[];return a.length>=2?a:[.25*e,.75*e]}(),r=Math.min(i.length,2);let s=0;for(let t=0;t<i.length&&!(s>=e||Ve.length>=2);t+=1){if("survival"===a){const e=Ve.some(e=>"survival"===e.spawnContext&&e.spawnSide===t&&e.health>0);if(e)continue}const e=i[t],o=$e(e,{context:a,autoRespawn:n,spawnSide:t,facing:0===t?1:-1});if(o.spawnX=e,o.spawnY=o.y,o.respawnTimer=0,Ve.push(o),s+=1,s>=r)break}}const wo="survival";function vo(){for(let e=Ve.length-1;e>=0;e-=1)Ve[e].spawnContext===wo&&Ve.splice(e,1)}function ko(e,{stage:t="inactive",timer:a=0}={}){Pn.active=Boolean(false),Bn(t,a),$n(e),En(0),vo(),Ze()}function Mo(e,t){const a=e.baseStats??{},n=a.maxHealth??e.maxHealth??120,o=a.attackDamage??e.attackDamage??12,i=a.moveSpeed??e.moveSpeed??160,r=Math.max(0,t-1),s=1+.2*r,l=1+.18*r,c=1+.12*r;e.maxHealth=Math.round(n*s),e.health=e.maxHealth,e.attackDamage=Math.round(o*l),e.moveSpeed=i*c,e.attackKnockback=Math.round(e.attackKnockback*(1+.05*r)),e.survivalWave=t}function So(e,t){if(e<=0)return;const a=new Set(Ve.filter(e=>e.spawnContext===wo).map(e=>e.id));bo(e,{context:wo,autoRespawn:!1});for(const e of Ve)e.spawnContext!==wo||a.has(e.id)||Mo(e,t)}function Co(e){const t=Nn();if(ke.survivalToggleBuffered&&(ke.survivalToggleBuffered=!1,t.active?ko("aborted"):(Qe(),vo(),function(){const e=Math.max(0,Math.min(1,.7)),t=Math.round(Ye.maxHealth*(e||1));Ye.health=Math.max(Ye.health,t),Ye.health<=0&&(Ye.health=Math.max(1,t||Ye.maxHealth)),Ye.deadTimer=0,Ye.invulnerability=Math.max(Ye.invulnerability,.6)}(),Pn.active=!0,Pn.wave=0,Pn.lastReward=0,Pn.kills=0,Pn.runReward=0,Pn.lastOutcome=null,Bn("countdown",5),$n(null))),!t.active&&"defeat"===t.stage)return On(Math.max(0,t.timer-e)),void(t.timer<=0&&Bn("inactive",0));if(!t.active)return;On(Math.max(0,t.timer-e));for(let e=Ve.length-1;e>=0;e-=1){const t=Ve[e];t.spawnContext===wo&&t.health<=0&&!1===t.autoRespawn&&Ve.splice(e,1)}const a=Ve.reduce((e,t)=>e+(t.spawnContext===wo&&t.health>0?1:0),0);if(En(a),Ye.health<=0)ko("defeat",{stage:"defeat",timer:Math.max(0,6)});else switch(t.stage){case"countdown":if(t.timer<=0){!function(){Pn.wave+=1;Pn.wave>Pn.bestWave&&(Pn.bestWave=Pn.wave,Rn.bestWave=Math.max(Rn.bestWave,Pn.bestWave))}();const e=3+1*(t.wave-1),a=8;So(Math.max(0,Math.min(e,a)),t.wave),Bn("wave",0)}break;case"wave":if(0===a){const e=35+12*(t.wave-1);!function(e,t){t>0?(ie(t),Wn(t)):Wn(0);Nn().bestWave===e&&(ie(50),Ln(50))}(t.wave,e),Bn("rest",10)}else{const e=3+1*(t.wave-1),n=8,o=Math.max(0,Math.min(e,n)-a);o>0&&So(o,t.wave)}break;case"rest":t.timer<=0&&Bn("countdown",5)}}function To(){ko("reset"),Dn({preserveStats:!0})}const Io={briefingDuration:4,successHoldDuration:6,failureHoldDuration:5,betweenMissionsDelay:4,startKeyLabel:"Q"},Ao=[{id:"neo-break-line",name:"Break the Line",environmentId:"neoDistrict",description:"Push hostile raiders out of the plaza and secure the street.",briefing:"Command wants the plaza cleared. Sweep through and eliminate the raiders.",objective:{type:"eliminate",label:"Neutralize raider squads",target:4},spawn:{batchSize:2,replenishDelay:3.2,autoRespawn:!1},rewards:{materials:60},successMessage:"Plaza secured. Supply convoy rolling in.",failureMessage:"Raiders regained ground; rally and try again."},{id:"verdant-holdout",name:"Hold the Ridge",environmentId:"verdantWilds",description:"Hold the ridge until evac arrives and keep the squad alive.",briefing:"Allied transports are inbound. Hold the ridge until they arrive.",objective:{type:"survive",label:"Hold position until evac arrives",duration:45},spawn:{batchSize:2,replenishDelay:2.4,autoRespawn:!0},rewards:{materials:90},successMessage:"Evac transports secured the ridge. Nice hold.",failureMessage:"The ridge fell before evac arrived. They need you back in the fight."},{id:"orbital-insertion",name:"Orbital Insertion",environmentId:"orbitalSpire",description:"Clear the orbital spire landing pads and neutralize the security teams guarding them.",briefing:"The spire lifts are jammed. Clear the pads so the boarding teams can land.",objective:{type:"eliminate",label:"Disable spire security",target:6},spawn:{batchSize:2,replenishDelay:2.8,autoRespawn:!1},rewards:{materials:120},successMessage:"Landing pads clear. Boarding teams inbound.",failureMessage:"Security sealed the spire. Regroup for another push."}],Ro={active:!1,stage:"inactive",missionIndex:-1,missionId:null,completedMissions:0,totalMissions:Ao.length,message:"",stageTimer:0,objective:{type:"none",label:"",target:0,progress:0,duration:0,remaining:0},spawn:{batchSize:0,replenishDelay:0,autoRespawn:!1,cooldown:0},rewards:{},successMessage:"Mission complete.",failureMessage:"Mission failed.",briefing:"",environmentId:null,lastOutcome:null};function Po(){return Ro}function Do(e=Ro.missionIndex){return e<0||e>=Ao.length?null:Ao[e]}function Bo(){return Ao}function Oo(e){Ro.active=Boolean(e)}function Eo(e,t=0){Ro.stage=e,Ro.stageTimer=Math.max(0,t??0)}function Wo(e){Ro.message=e??""}function Lo(e){Ro.objective.progress=Math.max(0,e??0)}function $o(e){Ro.spawn.cooldown=Math.max(0,e??0)}function No(e){Ro.lastOutcome=e??null}function jo(){return Io}const Fo="campaign";function Ho(){for(let e=Ve.length-1;e>=0;e-=1)Ve[e].spawnContext===Fo&&Ve.splice(e,1)}function Yo(){const e=Po();if("active"!==e.stage)return;if(!Do())return;const t=e.spawn??{},a=Math.max(0,t.batchSize??0);if(a<=0)return;if((t.cooldown??0)>0)return;const n=Ve.reduce((e,t)=>t.spawnContext===Fo&&t.health>0?e+1:e,0);if(n>=a)return;let o=a-n;if("eliminate"===e.objective.type){const t=Math.max(0,e.objective.target-e.objective.progress);if(t<=0)return;o=Math.min(o,t)}if(o<=0)return;bo(o,{context:Fo,autoRespawn:Boolean(t.autoRespawn)});const i=t.replenishDelay??0;$o(i>0?i:.75)}function Xo(e="Objective in progress"){const t=Po();Eo("active",0),Wo(t.objective.label||e),Ro.objective.remaining=Math.max(0,Ro.objective.duration??0),Lo(0),$o(0),Yo()}function zo(e){const t=function(e){const t=Do(e);return t?(Ro.missionIndex=e,Ro.missionId=t.id,Ro.environmentId=t.environmentId??null,Ro.objective={type:t.objective?.type??"none",label:t.objective?.label??"",target:Math.max(0,Math.floor(t.objective?.target??t.objective?.duration??0)),progress:0,duration:Math.max(0,t.objective?.duration??0),remaining:Math.max(0,t.objective?.duration??0)},Ro.spawn={batchSize:Math.max(0,Math.floor(t.spawn?.batchSize??0)),replenishDelay:Math.max(0,t.spawn?.replenishDelay??0),autoRespawn:Boolean(t.spawn?.autoRespawn),cooldown:0},Ro.rewards=t.rewards??{},Ro.successMessage=t.successMessage??"Mission complete.",Ro.failureMessage=t.failureMessage??"Mission failed.",Ro.briefing=t.briefing??t.description??"",Ro.message=Ro.briefing,Ro.lastOutcome=null,t):null}(e);if(!t)return Ko(),!1;const a=jo();var n;Ho(),Qe(),(n=t.environmentId)&&ge(n)||me(),Qe();const o=t.briefingDuration??a.briefingDuration??0;return o>0&&(t.briefing??"").trim().length>0?(Eo("briefing",o),Wo(`${t.briefing} (Press Q to deploy early)`)):Xo(t.objective?.label??"Objective started"),No(null),!0}function qo(){const e=Po().missionIndex+1;e>=Bo().length?Ko(!0):zo(e)}function Ko(e=!0){const t=Po();t.active||"inactive"!==t.stage?(Ho(),Ze(),e?(No("complete"),Wo("Campaign complete! Press Q to replay the story.")):(No("aborted"),Wo("Campaign closed. Press Q to restart missions.")),Eo("complete",0),Oo(!1)):Ze()}function Uo(){const e=Po();if("active"!==e.stage)return;const t=Do(),a=jo();Ho(),function(e={}){const t=Math.max(0,Math.floor(e.materials??0));t>0&&ie(t)}(e.rewards),function(e){const t=Math.max(0,Math.min(Ao.length,Math.floor(e??0)));Ro.completedMissions=Math.max(Ro.completedMissions,t)}(e.missionIndex+1);const n=t?.successHoldDuration??a.successHoldDuration??4;Wo(`${e.successMessage||"Mission complete."} (Press Q to continue)`),Eo("success",n),No("success")}function Go(){if(ke.campaignStartBuffered)switch(ke.campaignStartBuffered=!1,Po().stage){case"inactive":case"complete":default:!function(e=0){To(),Ro.active=!1,Ro.stage="inactive",Ro.missionIndex=-1,Ro.missionId=null,Ro.completedMissions=0,Ro.message="",Ro.stageTimer=0,Ro.objective={type:"none",label:"",target:0,progress:0,duration:0,remaining:0},Ro.spawn={batchSize:0,replenishDelay:0,autoRespawn:!1,cooldown:0},Ro.rewards={},Ro.successMessage="Mission complete.",Ro.failureMessage="Mission failed.",Ro.briefing="",Ro.environmentId=null,Ro.lastOutcome=null,Oo(!0);const t=Bo();zo(Math.min(Math.max(0,e),Math.max(0,t.length-1)))}(0);break;case"briefing":Xo();break;case"active":break;case"success":qo();break;case"failure":!function(){const e=Po(),t=e.missionIndex>=0?e.missionIndex:0;Oo(!0),zo(t)}()}}const Jo="sandboxSkirmish",Vo={active:!1,arsenalGranted:!1,inRest:!0,restTimer:0,wave:0,kills:0,bestWave:0,bestKills:0,lastWaveDuration:0,runTime:0,waveStartTime:null,enemiesAlive:0,lastOutcome:null,previousInventory:null,previousEquippedId:null,previousMaterials:null};function _o(){for(let e=Ve.length-1;e>=0;e-=1)Ve[e].spawnContext===Jo&&Ve.splice(e,1)}function Qo(e=!1){const t=12e3;const a=ne();(e||a<t)&&oe(Math.max(a,t))}function Zo(){if(Vo.arsenalGranted)return;const e=Object.keys(Re),t=e.includes(Ye.equippedWeaponId)?Ye.equippedWeaponId:e.includes("strikerPistol")?"strikerPistol":e[0];ot(e,{equipId:t});for(const t of e)ft(t);Vo.arsenalGranted=!0}function ei(e,t){const a=e.baseStats??{},n=a.maxHealth??e.maxHealth??120,o=a.attackDamage??e.attackDamage??12,i=a.moveSpeed??e.moveSpeed??160,r=Math.max(0,t-1),s=1+.14*r,l=1+.12*r,c=1+.08*r;e.maxHealth=Math.round(n*s),e.health=e.maxHealth,e.attackDamage=Math.round(o*l),e.moveSpeed=i*c}function ti(e="inactive"){Vo.active||Vo.arsenalGranted?(Vo.bestWave=Math.max(Vo.bestWave,Vo.wave),Vo.bestKills=Math.max(Vo.bestKills,Vo.kills),Vo.active=!1,Vo.inRest=!0,Vo.restTimer=0,Vo.waveStartTime=null,Vo.lastOutcome=e,_o(),Ze(),function(){const e=Vo.previousInventory,t=Vo.previousEquippedId;e&&e.length>0?ot(e,{equipId:t}):ot(Pe,{equipId:Pe[0]}),ht();const a=nt();for(const e of a)st(e);Vo.arsenalGranted=!1}(),"number"==typeof Vo.previousMaterials&&oe(Vo.previousMaterials),Vo.previousInventory=null,Vo.previousEquippedId=null,Vo.previousMaterials=null):Vo.lastOutcome=e}function ai(e){const t=e.damage??0,a=e.knockback??0;Ge.health=Math.max(0,Ge.health-t),Ge.flashTimer=.18,Ge.shakeTimer=Math.min(.4,Ge.shakeTimer+.22),Ge.shakeMagnitude=Math.min(14,Ge.shakeMagnitude+a/60);const n=Ge.y+.55*Ge.height-Ge.radius-12;if(Xn(Ge.x,n,t),t>0){const e=Ge.y+.55*Ge.height;to({x:Ge.x,y:e,amount:Math.round(6+.3*t),palette:["#f2dfc6","#d1b18b","#9f7f59"],speed:150+.4*a,spread:.8*Math.PI,angle:1.5*Math.PI,radius:10})}0===Ge.health&&Ge.respawnTimer<=0&&(Ge.respawnTimer=2.5)}function ni(e,t){if(e.health<=0||e.invulnerability>0)return;const a=t.damage??0,n=t.knockback??0,o=t.launch??0,i=t.facing??Ye.facing;if(e.health=Math.max(0,e.health-a),e.flashTimer=.18,e.shakeTimer=Math.min(.5,e.shakeTimer+.24),e.shakeMagnitude=Math.min(18,e.shakeMagnitude+n/55),e.vx+=n*i*.35,o>0&&(e.vy-=.3*o),a>0){const t=e.x+.6*(e.radius??24)*i,n=e.y+.42*(e.height??120),o=e.baseStats?.maxHealth??e.maxHealth??100;Zn({x:t,y:n,facing:i,damage:a,maxDamage:o,amount:Math.round(7+Math.min(18,.5*a)),intensity:Tn(a/Math.max(1,o))})}if(Xn(e.x+14*e.facing,e.y-14,a),e.invulnerability=.15,0===e.health&&(Zn({x:e.x,y:e.y+.4*(e.height??120),facing:i,amount:Math.round(12+Math.min(24,a)),intensity:.85,damage:1.5*a,maxDamage:e.baseStats?.maxHealth??e.maxHealth??100}),e.respawnTimer<=0&&Hn("enemy",e.x,e.y,i,e.vx,e.vy),e.state="defeated",e.attackCooldown=1.2,e.respawnTimer=3,function(e){if(!e||e.spawnContext!==Fo)return;const t=Po();"active"===t.stage&&"eliminate"===t.objective.type&&function(e=1){Ro.objective.progress=Math.max(0,Math.min(Ro.objective.target||Ro.objective.duration||Number.POSITIVE_INFINITY,Ro.objective.progress+e))}(1)}(e),function(e){e&&e.spawnContext===Jo&&Vo.active&&(Vo.kills+=1,Vo.bestKills=Math.max(Vo.bestKills,Vo.kills))}(e),Pn.active)){const e=3;!function(e=1){!Number.isFinite(e)||e<=0||(Pn.kills+=e,Pn.bestKills=Math.max(Pn.bestKills,Pn.kills),Rn.bestKills=Math.max(Rn.bestKills,Pn.bestKills))}(1),e>0&&(Ln(e),ie(e))}}function oi(e,t){if(Ye.invulnerability>0||Ye.health<=0)return;const a=t?.damage??e.attackDamage??0,n=t?.knockback??e.attackKnockback??0,o=t?.launch??e.attackLaunch??0,i=t?.facing??e.facing??1;let r=function(e){if(!mo.active)return e;const t=e.damage??0;if(t<=0)return e;const a=Math.min(t,mo.strength);mo.strength-=a,mo.flashTimer=Math.max(mo.flashTimer,.2);const n=go();po("shield:hit",{absorb:a,remainingStrength:Math.max(0,mo.strength),maxStrength:mo.maxStrength,duration:mo.duration,maxDuration:mo.maxDuration,center:n,radius:mo.radius});const o=t-a,i={...e,damage:o};return o<=0&&(i.damage=0,i.knockback=.25*(e.knockback??0),i.launch=.25*(e.launch??0)),mo.strength<=0&&(po("shield:shatter",{reason:"damage",absorb:a,center:n,maxStrength:mo.maxStrength,radius:mo.radius}),yo("shatter")),i}({damage:a,knockback:n,launch:o,facing:i}),s=r?.damage??0,l=r?.knockback??n,c=r?.launch??o;const d=r?.facing??i,f=Math.max(0,Math.min(.9,Ye.structureShieldStrength??0));if(f>0&&(s*=1-f,l*=1-.5*f,c*=1-.5*f),s>0?(Ye.health=Math.max(0,Ye.health-s),Ye.invulnerability=.6):Ye.invulnerability=Math.max(Ye.invulnerability,.2),Ye.vx+=l*d,Ye.vy+=c,Xn(Ye.x,Ye.y+10,Math.max(0,Math.round(s))),s>0){const e=Ye.y+(Ye.currentPose?.bodyLength??34);Zn({x:Ye.x+.4*(Ye.currentPose?.headRadius??16)*d,y:e,facing:d,damage:s,maxDamage:Ye.maxHealth??100,amount:Math.round(8+Math.min(20,.8*s)),intensity:Tn(s/Math.max(1,Ye.maxHealth??100))})}s>0&&0===Ye.health&&Ye.deadTimer<=0&&(Ye.deadTimer=2.6,Ye.attacking=!1,Ye.activeHitboxes=[],Ye.comboWindowOpen=!1,Ye.attackIndex=-1,Ye.rolling=!1,Hn("player",Ye.x,Ye.y,-d,Ye.vx,Ye.vy))}const ii={concreteBarrier:{maxHealth:600,width:180,height:110,rubbleHeight:34,material:"concrete",bodyColor:"#4c5564",edgeColor:"#2a313c",accentColor:"#9aa4b4",damageHighlight:"#d5dde8",debrisColor:"#3a424f",smokeDuration:2.4,shakeFactor:16,salvage:12},streetCar:{maxHealth:420,width:168,height:90,rubbleHeight:38,material:"vehicle",bodyColor:"#ba3c38",edgeColor:"#1c1d25",accentColor:"#f4f7fb",glassColor:"#4ac3ff",damageHighlight:"#ffe5dc",debrisColor:"#5a1f1a",smokeDuration:3.4,shakeFactor:22,salvage:18,deathBlast:{radius:140,maxDamage:160,knockback:320,minDamageRatio:.32}},fuelBarrelCluster:{maxHealth:220,width:96,height:96,rubbleHeight:28,material:"volatile",bodyColor:"#c0671c",edgeColor:"#2f1a08",accentColor:"#ffe7ba",stripeColor:"#ffd45f",damageHighlight:"#ffd4a1",debrisColor:"#6e2c05",smokeDuration:4.2,shakeFactor:26,salvage:22,deathBlast:{radius:180,maxDamage:240,knockback:400,minDamageRatio:.4}},timberWall:{maxHealth:540,width:172,height:102,rubbleHeight:32,material:"concrete",bodyColor:"#5c4b2d",edgeColor:"#362a18",accentColor:"#8b7344",damageHighlight:"#f5d6a4",debrisColor:"#3a2d1a",smokeDuration:2.1,shakeFactor:18,salvage:16},sandbagLine:{maxHealth:520,width:200,height:88,rubbleHeight:30,material:"concrete",bodyColor:"#c2a274",edgeColor:"#7a6142",accentColor:"#e3cc9b",damageHighlight:"#ffe8b8",debrisColor:"#8a6d48",smokeDuration:1.9,shakeFactor:14,salvage:14},roverWreck:{maxHealth:380,width:176,height:96,rubbleHeight:36,material:"vehicle",bodyColor:"#8d9fb4",edgeColor:"#1f2a35",accentColor:"#f5f9ff",glassColor:"#9be9ff",damageHighlight:"#d6e2ff",debrisColor:"#46586a",smokeDuration:3.1,shakeFactor:20,salvage:20,deathBlast:{radius:120,maxDamage:120,knockback:240,minDamageRatio:.28}},plasmaCell:{maxHealth:260,width:102,height:102,rubbleHeight:26,material:"volatile",bodyColor:"#3b89ff",edgeColor:"#15213a",accentColor:"#8bd4ff",stripeColor:"#62f5ff",damageHighlight:"#b0f0ff",debrisColor:"#1c3c66",smokeDuration:4.6,shakeFactor:30,salvage:26,deathBlast:{radius:220,maxDamage:280,knockback:420,minDamageRatio:.45}}};function ri(){return function(){const e=de();return Array.isArray(e?.destructibles)?e.destructibles:[]}().map(e=>function(e){const t=ii[e.type];if(!t)throw new Error(`Unknown destructible template: ${e.type}`);const a=e.templateOverrides??{},n={...t,...a},o=e.width??n.width??t.width,i=e.height??n.height??t.height,r=o/2,s=n.maxHealth??t.maxHealth??100,l={id:e.id,type:e.type,template:n,x:e.x,y:e.baseY,width:o,height:i,halfWidth:r,health:s,maxHealth:s,destroyed:!1,flashTimer:0,shakeTimer:0,shakeMagnitude:0,smokeTimer:0,rubbleLevel:0,deathTriggered:!1,facing:e.facing??1,spawnConfig:{...e}};return e.overrides&&"object"==typeof e.overrides&&Object.assign(l,e.overrides),l}(e))}const si=ri();function li(e,t,a=.25){const n=Tn(1-e/Math.max(1,t),0,1);return Tn(a+n*(1-a),0,1)}function ci({x:e,y:t,radius:a,maxDamage:n=0,maxKnockback:o=0,minDamageRatio:i=.25,selfDamageScale:r=1,selfKnockbackScale:s=1,includeTrainingDummy:l=!0,includeEnemies:c=!0,includePlayer:d=!0}){const f={dummyHit:!1,enemiesHit:0,playerHit:!1},h=Math.max(0,n),u=Math.max(0,o??1.2*h),m=Math.max(1,a),g=Tn(i,0,1);if(l&&Ge.health>0){const a=Ge.x,n=Ge.y+.55*Ge.height,o=Math.hypot(a-e,n-t);if(o<=m){const t=li(o,m,g),n=u*t;ai({damage:h*t,knockback:n,launch:.18*n,facing:a>=e?1:-1}),f.dummyHit=!0}}if(c)for(const a of Ve){if(a.health<=0)continue;const n=a.x,o=a.y+.5*a.height,i=Math.hypot(n-e,o-t);if(i>m)continue;const r=li(i,m,g),s=h*r,l=u*r;s<=0&&l<=0||(ni(a,{damage:s,knockback:l,launch:.24*l,facing:n>=e?1:-1}),f.enemiesHit+=1)}if(d&&Ye.health>0){const a=Le(Ye.currentPose??{headRadius:16,bodyLength:34,legLength:36}),n=Ye.y+.6*a,o=Math.hypot(Ye.x-e,n-t);if(o<=m){const t=li(o,m,g),a=Math.max(0,h*t*r),n=u*t*s,i=Ye.x>=e?1:-1;(a>0||n>0)&&(oi(null,{damage:a,knockback:n,launch:.25*n,facing:i}),f.playerHit=!0)}}return f}function di(e){const t=e.halfWidth??e.width/2;return{left:e.x-t,right:e.x+t,top:e.y-e.height,bottom:e.y}}function fi(e,t,a,n){const{left:o,right:i,top:r,bottom:s}=di(n),l=e-Tn(e,o,i),c=t-Tn(t,r,s);return l*l+c*c<=a*a}function hi(e,t,a){const{left:n,right:o,top:i,bottom:r}=di(a),s=Math.max(n-e,0,e-o),l=Math.max(i-t,0,t-r);return Math.hypot(s,l)}function ui(e,t={}){if(!e||e.destroyed)return{applied:!1,destroyed:!1};const a=e.template,n=Math.max(0,t.damage??0);if(n<=0)return{applied:!1,destroyed:!1};const o=Math.min(n,e.health);e.health=Math.max(0,e.health-o),e.flashTimer=.2,e.shakeTimer=Math.min(.45,e.shakeTimer+.18+o/e.maxHealth*.3);const i=a?.shakeFactor??14;e.shakeMagnitude=Math.max(.6*e.shakeMagnitude,i*(.35+o/e.maxHealth*1.2)),e.smokeTimer=Math.min(a?.smokeDuration??0,(e.smokeTimer??0)+.5),function(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:hit",{detail:{id:e.id,type:e.type,material:e.template?.material??"generic",cause:t.cause??"impact",x:t.impactX??e.x,y:t.impactY??e.y-.5*e.height,health:e.health,maxHealth:e.maxHealth}}))}(e,t);let r=!1;return e.health<=0&&(e.destroyed=!0,e.rubbleLevel=Math.max(e.rubbleLevel,.05),e.smokeTimer=a?.smokeDuration??0,function(e,t={}){const a=e.template;if(!a||e.deathTriggered)return;e.deathTriggered=!0;const n=t.impactX??e.x,o=t.impactY??e.y-.35*e.height;if(ro({x:n,y:o,radius:.8*Math.max(e.width,e.height)}),so({x:n,y:o,radius:Math.max(e.width,e.height),maxRadius:.6*(a.deathBlast?.radius??1.2*e.width)}),Qn({x:n,y:o,startRadius:.35*e.width,endRadius:1.1*e.width,color:"#ffb347",ttl:.55,lineWidth:5}),a.deathBlast){const t=a.deathBlast;"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:explosion",{detail:{id:e.id,x:n,y:o,radius:t.radius}})),ci({x:n,y:o,radius:t.radius,maxDamage:t.maxDamage,maxKnockback:t.knockback,minDamageRatio:t.minDamageRatio??.25}),mi({x:n,y:o,radius:t.radius,maxDamage:t.maxDamage,minDamageRatio:t.minDamageRatio??.25,sourceId:e.id,cause:"chain-explosion"})}const i=a.salvage??Math.round((e.maxHealth??200)/25);if(i>0){const t=Math.max(1,Math.round(i/10)),a=Math.max(1,Math.round(i/t));for(let i=0;i<t;i+=1)re({x:n+(Math.random()-.5)*(e.width??120)*.4,y:o,amount:a,vy:-120-60*Math.random()})}}(e,t),r=!0),{applied:!0,destroyed:r}}function mi({x:e,y:t,radius:a,maxDamage:n,minDamageRatio:o=.25,sourceId:i=null,cause:r="explosion"}){const s=Math.max(0,n??0);if(s<=0||a<=0)return 0;const l=Tn(o,0,1);let c=0;for(const n of si){if(n.id===i||n.destroyed&&n.deathTriggered)continue;const o=hi(e,t,n);if(o>a)continue;const d=s*li(o,a,l);d<=0||ui(n,{damage:d,cause:r,impactX:Tn(e,n.x-n.halfWidth,n.x+n.halfWidth),impactY:Tn(t,n.y-n.height,n.y)}).applied&&(c+=1)}return c}function gi(e){for(const t of si)if(!t.destroyed&&fi(e.x,e.y,e.radius,t))return ui(t,{damage:e.damage??0,cause:"projectile",impactX:e.x,impactY:e.y}),!0;return!1}function pi(e){let t=!1;for(const a of si)a.destroyed||e.hitTargets.has(a.id)||fi(e.x,e.y,e.radius,a)&&(e.hitTargets.add(a.id),ui(a,{damage:e.damage??0,cause:"melee",impactX:e.x,impactY:e.y}),t=!0);return t}pe(()=>{!function(){si.length=0;const e=ri();for(const t of e)si.push(t)}()});const yi={barricade:{id:"barricade",name:"Reinforced Barricade",width:160,height:96,maxHealth:600,cost:40,color:"#4f5a6c",accentColor:"#8ea0ba",strokeColor:"#273041",blocking:!0},watchtower:{id:"watchtower",name:"Scout Tower",width:120,height:200,maxHealth:520,cost:65,color:"#6c5b3f",accentColor:"#a7824f",strokeColor:"#2f2415",turret:{range:420,cooldown:1.25,projectile:{speed:520,damage:18,color:"#ffd57a"}}},shieldEmitter:{id:"shieldEmitter",name:"Shield Emitter",width:110,height:110,maxHealth:360,cost:55,color:"#2a3b58",accentColor:"#6fb7ff",strokeColor:"#152032",shield:{radius:220,damageReduction:.4,buffDuration:.6},ambient:{radius:260,intensity:.9,color:"#7cd6ff",flicker:.35}},shockTrap:{id:"shockTrap",name:"Shock Trap",width:100,height:28,maxHealth:280,cost:30,color:"#2b2f3c",accentColor:"#9af0ff",strokeColor:"#181b26",trap:{radius:140,damage:24,stun:.8,cooldown:2.6},ambient:{radius:180,intensity:.6,color:"#8cf2ff",flicker:.4}}},xi=[],bi={active:!1,blueprintIndex:0,lastPreview:{x:0,y:0,valid:!1}};function wi(){return Object.values(yi)}function vi(e=0){const t=wi();return 0===t.length?null:t[(e%t.length+t.length)%t.length]}function ki(){xi.length=0}function Mi(){return xi}function Si(){return bi}pe(()=>{ki(),bi.active=!1,bi.lastPreview={...bi.lastPreview,valid:!1}});const Ci=new Map,Ti=[];let Ii=!1,Ai=function(){const e=de();return Array.isArray(e?.ambientLights)?e.ambientLights:[]}();function Ri(e){return Tn(e,0,3)}function Pi(e,t){const{r:a,g:n,b:o}=function(e){if("string"!=typeof e)return{r:255,g:255,b:255};const t=e.trim();if(t.startsWith("#")){let e=t.slice(1);if(3===e.length&&(e=e.split("").map(e=>e+e).join("")),6===e.length){const t=Number.parseInt(e,16);if(!Number.isNaN(t))return{r:t>>16&255,g:t>>8&255,b:255&t}}}const a=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return a?{r:Number.parseInt(a[1],10),g:Number.parseInt(a[2],10),b:Number.parseInt(a[3],10)}:{r:255,g:255,b:255}}(e);return`rgba(${a}, ${n}, ${o}, ${Tn(t,0,1.2)})`}function Di(e,t){let a=Ci.get(e);a||(a={id:e,intensity:0,targetIntensity:Ri(t.intensity??1),type:t.type??"point",smoothing:t.smoothing??10},Ci.set(e,a)),a.type=t.type??a.type??"point",a.x=t.x??a.x??0,a.y=t.y??a.y??0,a.radius=t.radius??a.radius??180,a.fov=t.fov??a.fov??Math.PI/2,a.direction=t.direction??a.direction??0,a.color=t.color??a.color??"#ffffff",a.stretch=t.stretch??a.stretch??1,a.flicker=t.flicker??a.flicker??0,a.smoothing=t.smoothing??a.smoothing??10,a.targetIntensity=Ri(t.intensity??a.targetIntensity??1),a.active=!0}function Bi(e={}){Oi();const t=Math.max(.016,e.ttl??.3);Ti.push({type:e.type??"point",x:e.x??0,y:e.y??0,radius:e.radius??160,intensity:Ri(e.intensity??1),color:e.color??"#ffffff",direction:e.direction??0,fov:e.fov??Math.PI/2,stretch:e.stretch??1,flicker:e.flicker??0,decay:Tn(e.decay??1,.3,4),ttl:t,maxTtl:t})}function Oi(){Ii||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",e=>{const t=e?.detail??{};Bi({type:"point",x:t.x??0,y:t.y??0,radius:t.radius?1.2*t.radius:140,intensity:1.2,color:"#ffe4b0",ttl:.12,flicker:.35,decay:.7}),"number"==typeof t.facing&&0!==t.facing&&Bi({type:"cone",x:t.x??0,y:t.y??0,radius:200,intensity:.9,color:"#fff7d4",direction:t.facing>0?0:Math.PI,fov:Math.PI/5,stretch:.4,ttl:.12,flicker:.25,decay:.8})}),window.addEventListener("throwable:explosion",e=>{const t=e?.detail??{},a=t.radius?1.6*t.radius:240;Bi({type:"point",x:t.x??0,y:t.y??0,radius:a,intensity:1.7,color:"#ffbf6b",ttl:.45,flicker:.45,decay:.7})}),window.addEventListener("throwable:flash-burst",e=>{const t=e?.detail??{};Bi({type:"point",x:t.x??0,y:t.y??0,radius:1.4*(t.radius??220),intensity:2,color:"#ffffff",ttl:.35,flicker:.6,decay:.6})}),window.addEventListener("throwable:smoke-spawn",e=>{const t=e?.detail??{};Bi({type:"point",x:t.x??0,y:t.y??0,radius:1.1*(t.radius??160),intensity:.5,color:"#7ad4ff",ttl:.5,flicker:.2,decay:1.4})}),window.addEventListener("throwable:smoke-dissipate",e=>{const t=e?.detail??{};Bi({type:"point",x:t.x??0,y:t.y??0,radius:1.3*(t.radius??160),intensity:.35,color:"#a4f1ff",ttl:.4,flicker:.18,decay:1.6})}),window.addEventListener("destructible:hit",e=>{const t=e?.detail??{};Bi({type:"point",x:t.impactX??t.x??0,y:t.impactY??t.y??0,radius:140,intensity:.55,color:"#ffe1a4",ttl:.18,flicker:.3,decay:1.1})}),Ii=!0)}function Ei(e){const t=e.radius??0;if(t<=0)return!1;const a=x.canvas.width,n=x.canvas.height;return e.x+t>=0&&e.x-t<=a&&e.y+t>=0&&e.y-t<=n}function Wi(e,t){if(!Ei(e))return;const a=e.radius??160,n=x.createRadialGradient(e.x,e.y,0,e.x,e.y,a);n.addColorStop(0,Pi(e.color,Tn(1.05*t,0,1.1))),n.addColorStop(.4,Pi(e.color,Tn(.6*t,0,.9))),n.addColorStop(1,Pi(e.color,0)),x.fillStyle=n,x.beginPath(),x.arc(e.x,e.y,a,0,2*Math.PI),x.fill()}function Li(e,t){if(!Ei(e))return;const a=e.radius??200,n=Tn(e.fov??Math.PI/3,Math.PI/12,Math.PI),o=Tn(e.stretch??.5,.2,1.2);x.save(),x.translate(e.x,e.y),x.rotate(e.direction??0),x.scale(1,o);const i=x.createRadialGradient(0,0,0,0,0,a);i.addColorStop(0,Pi(e.color,Tn(t,0,1))),i.addColorStop(.45,Pi(e.color,Tn(.6*t,0,.8))),i.addColorStop(1,Pi(e.color,0)),x.fillStyle=i,x.beginPath();const r=n/2;x.moveTo(0,0),x.arc(0,0,a,-r,r),x.closePath(),x.fill(),x.restore()}pe(e=>{Ai=Array.isArray(e?.ambientLights)?e.ambientLights:[],Ci.clear()});const $i=[];function Ni({x:e,y:t,vx:a,vy:n,radius:o=6,lifetime:i=1.4,color:r="#ffcf7a",damage:s=0,knockback:l=0,facing:c=1,gravityFactor:d=.2}){$i.push({x:e,y:t,vx:a,vy:n,radius:o,life:i,maxLife:i,color:r,damage:s,knockback:l,facing:c,gravityFactor:d,lightCooldown:0,hitTargets:new Set})}function ji(e,t,a,n,o,i){const r=e-n,s=t-o,l=a+i;return r*r+s*s<=l*l}const Fi=[],Hi=[];function Yi(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function Xi(e){if(e.detonated)return;e.detonated=!0,e.explosionTimer=Math.max(e.explosionDuration,.08),e.fuse=0;const t={id:e.id,effectType:e.effectType,x:e.x,y:e.y,radius:e.explosionRadius};switch(e.effectType){case"flash":!function(e){const{x:t,y:a,explosionRadius:n,stunDuration:o,playerStunDuration:i}=e,r=Math.max(.1,o);if(Ge.health>0){const e=Ge.x-t,o=Ge.y+.55*Ge.height-a;Math.hypot(e,o)<=n&&(Ge.flashTimer=Math.max(Ge.flashTimer,.6*r),Ge.shakeTimer=Math.max(Ge.shakeTimer,.5*r),Ge.shakeMagnitude=Math.max(Ge.shakeMagnitude,14))}for(const e of Ve){if(e.health<=0)continue;const o=e.x-t,i=e.y+.5*e.height-a;Math.hypot(o,i)<=n&&(e.stunTimer=Math.max(e.stunTimer??0,r),e.flashTimer=Math.max(e.flashTimer,.7*r),e.shakeTimer=Math.max(e.shakeTimer,.4*r),e.shakeMagnitude=Math.max(e.shakeMagnitude,12))}if(i>0&&Ye.health>0){const e=Le(Ye.currentPose??{headRadius:16,bodyLength:34,legLength:36}),o=Ye.y+.6*e,r=Ye.x-t,s=o-a;Math.hypot(r,s)<=n&&(Ye.flashBlindTimer=Math.max(Ye.flashBlindTimer??0,i),Ye.stunTimer=Math.max(Ye.stunTimer??0,.6*i))}}(e),t.radius=e.explosionRadius,t.stunDuration=e.stunDuration,t.playerStunDuration=e.playerStunDuration,Yi("throwable:flash-burst",{...t,stunDuration:e.stunDuration,playerStunDuration:e.playerStunDuration});break;case"smoke":{const a=function(e){const t=Math.max(.5,e.smokeDuration),a=Math.max(40,e.smokeRadius),n={id:`smoke-${Date.now()}-${Math.random().toString(36).slice(2,5)}`,x:e.x,y:e.y,radius:a,baseRadius:a,maxRadius:a*(e.smokeExpansion??1.1),duration:t,life:t,slowMultiplier:Tn(e.smokeSlowMultiplier??.55,.1,1),tick:e.smokeTickDuration??.5,tickTimer:0};return Hi.push(n),Yi("throwable:smoke-spawn",{id:n.id,x:n.x,y:n.y,radius:n.radius,maxRadius:n.maxRadius,duration:n.duration}),n}(e);t.radius=a.maxRadius,t.duration=a.duration,t.cloudId=a.id,Yi("throwable:smoke-detonate",{...t,radius:a.maxRadius,duration:a.duration,cloudId:a.id});break}default:(function(e){const{x:t,y:a,explosionRadius:n,damage:o,knockback:i}=e;ci({x:t,y:a,radius:n,maxDamage:o,maxKnockback:i,minDamageRatio:e.damageFalloff??.3,selfDamageScale:e.selfDamageScale??1,selfKnockbackScale:e.selfKnockbackScale??1}),o>0&&mi({x:t,y:a,radius:n,maxDamage:o,minDamageRatio:e.destructibleFalloff??.35,cause:e.effectType??"explosion"}),function(e={}){const t=e.x??0,a=e.y??0,n=e.count??14,o=(e.radius,e.speed??260),i=e.palette??["#ffdd9a","#f7a24a","#b55628","#5b4340"];for(let r=0;r<n;r+=1){const n=Math.random()*Math.PI*2,s=o*(.45+.65*Math.random()),l=.6*(Math.random()-.5);zn.push({type:"debris",x:t+Math.cos(n)*(e.offsetRadius??0),y:a+Math.sin(n)*(e.offsetRadius??0),vx:Math.cos(n+l)*s,vy:Math.sin(n+l)*s*.7-60,ttl:.4+.3*Math.random(),maxTtl:.4+.3*Math.random(),radius:3+4*Math.random(),color:i[r%i.length]})}}({x:t,y:a,radius:n,count:Math.max(10,Math.round(n/10)),speed:220+.5*Math.max(0,i??0)})})(e),t.damage=e.damage,t.knockback=e.knockback,Yi("throwable:explosion",{...t,damage:e.damage,knockback:e.knockback})}Yi("throwable:detonate",t)}let zi=null;const qi={enemiesTotal:0,enemiesCulled:0,squadTotal:0,squadCulled:0,remoteTotal:0,remoteCulled:0,vehicleTotal:0,vehicleCulled:0,destructibleTotal:0,destructibleCulled:0,interactableTotal:0,interactableCulled:0,buildingTotal:0,buildingCulled:0,resourceTotal:0,resourceCulled:0};function Ki(e,t=0,a=240){const n=zi;if(!n)return!0;const o=(n.left??0)-a,i=(n.right??(n.left??0)+2*(n.halfWidth??0))+a;return e+t>=o&&e-t<=i}function Ui(e,t){const a=`${e}Total`,n=`${e}Culled`;Object.prototype.hasOwnProperty.call(qi,a)&&(qi[a]+=1,t&&Object.prototype.hasOwnProperty.call(qi,n)&&(qi[n]+=1))}const Gi={ammo:{id:"ammo",label:"Ammo Cache",description:"Refills magazines and reserves for all weapons.",weight:.45,crateColor:"#4d7cff",glowColor:"#b5c8ff",materialsReward:20},medkit:{id:"medkit",label:"Field Medkit",description:"Restores health and grants brief damage resistance.",weight:.35,crateColor:"#ff6f6f",glowColor:"#ffb4b4",materialsReward:25},heavy:{id:"heavy",label:"Heavy Arsenal",description:"Drops a powerful heavy weapon with fresh ammo.",weight:.2,crateColor:"#ffb347",glowColor:"#ffe0a3",weaponId:"thunderCannon",materialsReward:35,weaponId:"thunderCannon"}},Ji=[],Vi={nextDropTimer:18,nextDropTypeId:_i(),incomingMessage:null,incomingTimer:0,incomingDuration:3,rewardMessage:null,rewardTimer:0,rewardDuration:3.5,dropSequence:0};function _i(){const e=Object.values(Gi);if(0===e.length)return null;const t=e.reduce((e,t)=>e+(t.weight??1),0);let a=Math.random()*t;for(const t of e){const e=t.weight??1;if(a<=e)return t.id;a-=e}return e[e.length-1].id}function Qi(e){switch(e){case"medkit":Ye.health=Math.min(Ye.maxHealth,Ye.health+70),Ye.invulnerability=Math.max(Ye.invulnerability,.4),Vi.rewardMessage="Health restored";break;case"heavy":(function(){const e=Gi.heavy,t=e?.weaponId??null;t&&Re[t]&&(function(e,{autoEquip:t=!1}={}){if(!e||!Re[e])return!1;let a=et.inventory.indexOf(e);-1===a&&(et.inventory.push(e),a=et.inventory.length-1),t?at(a):it()}(t,{autoEquip:!0}),st(t),dt(t))})(),Vi.rewardMessage="Heavy weapon acquired";break;default:!function(){const e=nt();for(const t of e){const e=st(t);e&&e.capacity!==Number.POSITIVE_INFINITY&&dt(t)}Ye.reloading=!1}(),Vi.rewardMessage="Ammo resupply"}Vi.rewardTimer=Vi.rewardDuration;const t=Gi[e];if(t?.materialsReward){const e=Math.max(0,Math.round(.7*t.materialsReward));e>0&&(ie(e),Vi.rewardMessage=`${Vi.rewardMessage} (+${e} materials)`)}}function Zi(e,t){const a=Ye.x,n=Ye.currentPose??POSES.standing,o=Ye.y+Le(n),i=a-e.x,r=o-(e.y+.5*e.height);return Math.hypot(i,r)<=68?(e.highlight=Tn(e.highlight+4*t,0,1),!0):(e.highlight=Tn(e.highlight-2*t,0,1),!1)}function er(e){Qi(e.typeId),e.state="collected",e.despawnTimer=3.5,e.highlight=1;const t=Gi[e.typeId]?.materialsReward??0;if(t>0){const a=Math.max(0,Math.round(.3*t));if(a>0){const t=Math.max(1,Math.round(a/12)),n=Math.max(1,Math.round(a/t));for(let a=0;a<t;a+=1){const t=60*(Math.random()-.5);re({x:e.x+t,y:e.y,amount:n,vy:-160-60*Math.random()})}}}}function tr(e){Vi.nextDropTimer<=0&&Ji.length<3&&(function(e){const t=Gi[e]??Gi.ammo,a=getEnvironmentWidth(),n=Math.max(31.2,.05*a),o=(Math.max(0,a-2*n),Tn(a*(.2+.6*Math.random()),n,a-n)),i={id:`supply-${Vi.dropSequence+=1}`,typeId:t.id,label:t.label,description:t.description,crateColor:t.crateColor??"#4d7cff",glowColor:t.glowColor??"#9ab5ff",width:52,height:42,x:o,y:-280,vx:18*(2*Math.random()-1),vy:0,state:"descending",timer:0,highlight:0,despawnTimer:12,parachutePhase:0};Ji.push(i),Vi.incomingMessage=`${t.label} inbound!`,Vi.incomingTimer=Vi.incomingDuration}(Vi.nextDropTypeId),Vi.nextDropTimer=26+12*Math.random(),Vi.nextDropTypeId=_i()),Vi.incomingTimer>0&&(Vi.incomingTimer=Math.max(0,Vi.incomingTimer-e)),Vi.rewardTimer>0&&(Vi.rewardTimer=Math.max(0,Vi.rewardTimer-e));for(let t=Ji.length-1;t>=0;t-=1){const a=Ji[t];if(a.timer+=e,"descending"===a.state){a.vy=Math.min(180,a.vy+140*e),a.y+=a.vy*e;const t=getEnvironmentWidth();a.x=Tn(a.x+a.vx*e,.5*a.width,t-.5*a.width),a.parachutePhase+=e,a.y>=b-a.height&&(a.y=b-a.height,a.vy=0,a.state="ready",a.timer=0)}else if("ready"===a.state){if(Zi(a,e))er(a);else if(a.despawnTimer-=e,a.despawnTimer<=0){Ji.splice(t,1);continue}}else if("collected"===a.state&&(a.highlight=Tn(a.highlight-.6*e,0,1),a.despawnTimer-=e,a.despawnTimer<=0)){Ji.splice(t,1);continue}}}function ar(e){const t="collected"===e.state?Tn(e.despawnTimer/3.5,0,1):1;if(x.save(),x.globalAlpha=t,"descending"===e.state){const t=1.8*e.width,a=.9*e.height;x.fillStyle=e.glowColor,x.beginPath(),x.moveTo(e.x-.5*t,e.y+.2*a),x.quadraticCurveTo(e.x,e.y-.8*a,e.x+.5*t,e.y+.2*a),x.closePath(),x.fill(),x.strokeStyle=e.glowColor,x.lineWidth=2,x.beginPath(),x.moveTo(e.x-.3*t,e.y+.25*a),x.lineTo(e.x-.25*e.width,e.y+.1*e.height),x.moveTo(e.x+.3*t,e.y+.25*a),x.lineTo(e.x+.25*e.width,e.y+.1*e.height),x.stroke()}const a=e.glowColor,n=e.crateColor,o=e.highlight??0;x.fillStyle=n,x.fillRect(e.x-.5*e.width,e.y,e.width,e.height),x.fillStyle=a,x.fillRect(e.x-.5*e.width,e.y-.25*e.height,e.width,.25*e.height),x.strokeStyle="rgba(12, 16, 24, 0.65)",x.lineWidth=3,x.strokeRect(e.x-.5*e.width,e.y,e.width,e.height),o>0&&(x.globalAlpha=.6*o,x.fillStyle=e.glowColor,x.beginPath(),x.arc(e.x,e.y+.5*e.height,68,0,2*Math.PI),x.fill()),x.restore()}const nr=Number.POSITIVE_INFINITY;function or(e){let t=e;for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}function ir(e,{targetAngle:t,targetX:a,targetY:n,anchorX:o,anchorY:i,smoothing:r,active:s},l){const c=function(e,t=.18){return e?("number"!=typeof e.smoothing&&(e.smoothing=t),e):{angle:0,targetAngle:0,vectorX:1,vectorY:0,magnitude:0,anchorX:0,anchorY:0,targetX:0,targetY:0,smoothing:t,active:!1,lastUpdated:0}}(e,r),d="undefined"!=typeof performance?performance.now():Date.now(),f=function(e,t,a,n){const o=function(e,t){return or(t-e)}(e,t);if(!Number.isFinite(o))return t;const i=Math.max(0,a??.18);return or(e+o*(1-Math.exp(-i*Math.max(n,0))))}(c.angle??t,t,r??c.smoothing,l),h=Math.cos(f),u=Math.sin(f);return c.targetAngle=t,c.angle=f,c.vectorX=Number.isFinite(h)?h:1,c.vectorY=Number.isFinite(u)?u:0,c.anchorX=o,c.anchorY=i,c.targetX=a,c.targetY=n,c.magnitude=Math.hypot(a-o,n-i),c.active=Boolean(s),c.lastUpdated=d,c}function rr(){return ke.left&&!ke.right?Math.PI:ke.right&&!ke.left?0:ke.down&&!Ye.onGround?.5*Math.PI:Ye.vx&&Math.abs(Ye.vx)>6?Ye.vx>0?0:Math.PI:Ye.facing>=0?0:Math.PI}function sr(e,t){const a=t??Oe.standing,n=a.headRadius??16,o=a.armLength?.2*a.armLength:6,i=e.y+2*n+o;return{x:e.x,y:i}}function lr(e){return e?Ve.find(t=>t.id===e)??null:null}function cr(e){Se(),function(e){const t="undefined"!=typeof performance?performance.now():Date.now(),a=Ye.rolling?Oe.rolling:Ye.crouching?Oe.crouching:Oe.standing,n=sr(Ye,a),o=function(){const e=ve(),t=e?.offsetX??0,a=e?.y??0;return{x:Me.screenX+t,y:Me.screenY+a}}(),i=o.x-n.x,r=o.y-n.y,s=Math.hypot(i,r),l=(Me.lastUpdate??0)>0,c=s>=4,d=function(e){return!!Me.active&&(!Number.isFinite(nr)||e-(Me.lastUpdate??0)<=nr)}(t),f=c&&(d||l);let h,u,m;if(f)h=o.x,u=o.y,m=Math.atan2(r,i);else if(Ye.aim){const e=Ye.aim.targetAngle??Ye.aim.angle??rr(),t=320;m=e,h=n.x+Math.cos(e)*t,u=n.y+Math.sin(e)*t}else{const e=rr();m=e;const t=320;h=n.x+Math.cos(e)*t,u=n.y+Math.sin(e)*t}const g=ir(Ye.aim,{targetAngle:or(m),targetX:h,targetY:u,anchorX:n.x,anchorY:n.y,smoothing:Ye.aim?.smoothing??22,magnitude:s,active:f},e);Ye.aim=g,f&&g&&(Ye.facing=g.vectorX>=0?1:-1)}(e),function(e){for(const t of ze){const a=sr(t,Oe.standing),n=lr(t.targetEnemyId),o=n?n.x:Ye.aim?.targetX??t.x+120*t.facing,i=n?n.y+.35*n.height:Ye.aim?.targetY??t.y,r=Math.atan2(i-a.y,o-a.x);t.aim=ir(t.aim,{targetAngle:or(r),targetX:o,targetY:i,anchorX:a.x,anchorY:a.y,smoothing:t.aim?.smoothing??18,active:Boolean(n)},e),t.aim&&(t.facing=t.aim.vectorX>=0?1:-1)}}(e),function(e){const t=sr(Ye,Ye.rolling?Oe.rolling:Ye.crouching?Oe.crouching:Oe.standing);for(const a of Ve){if(a.health<=0)continue;const n={x:a.x,y:a.y+.35*(a.height??100)},o=t.x,i=t.y,r=Math.atan2(i-n.y,o-n.x);a.aim=ir(a.aim,{targetAngle:or(r),targetX:o,targetY:i,anchorX:n.x,anchorY:n.y,smoothing:a.aim?.smoothing??12,active:!0},e),a.aim&&(a.facing=a.aim.vectorX>=0?1:-1)}}(e),function(e){for(const t of Cn){const a=kn[t.type];if(!a)continue;const n=a.mountedWeapons??[];Array.isArray(t.mounts)||(t.mounts=[]);for(let a=0;a<n.length;a+=1){const o=n[a];if(!o)continue;const i=t.mounts[a]??(t.mounts[a]={}),r=o.offset??{x:0,y:0},s=!1!==o.followVehicleFacing,l=s?t.facing??1:1,c=t.x+(r.x??0)*l,d=t.y+(r.y??0);let f,h,u=!1;if("player-stickman"===t.driverId&&Ye.aim)f=Ye.aim.targetX,h=Ye.aim.targetY,u=Ye.aim.active;else{const e=(o.facing??1)*(s?t.facing??1:1)>=0?0:Math.PI,a=o.range??220;f=c+Math.cos(e)*a,h=d+Math.sin(e)*a}const m=Math.atan2(h-d,f-c);i.aim=ir(i.aim,{targetAngle:or(m),targetX:f,targetY:h,anchorX:c,anchorY:d,smoothing:i.aim?.smoothing??14,active:u},e)}}}(e)}function dr(e,{length:t,aimAngle:a,bendDirection:n=1,stretch:o=1,elbowOffset:i=10}){const r=Math.max(0,t*o),s=.55*r,l=i*n,c=Math.cos(a),d=Math.sin(a);return{elbow:{x:e.x+c*s-d*l,y:e.y+d*s+c*l},hand:{x:e.x+c*r,y:e.y+d*r}}}function fr(e,{length:t,offsetX:a,phase:n,lift:o}){const i=e.x+a,r=b,s=Math.max(0,-n)*o,l=e.y+.6*t,c=Math.min(l,r-.42*t-s);return{knee:{x:e.x+.5*a,y:c},foot:{x:i,y:r}}}function hr(e,t,a,n,o=1){x.save(),x.strokeStyle=a,x.lineWidth=n,x.lineCap="round",x.globalAlpha=o,x.beginPath(),x.moveTo(e.x,e.y),x.lineTo(t.knee.x,t.knee.y),x.lineTo(t.foot.x,t.foot.y),x.stroke(),x.restore()}function ur(e,t,a,n,o=1){x.save(),x.strokeStyle=a,x.lineWidth=n,x.lineCap="round",x.globalAlpha=o,x.beginPath(),x.moveTo(e.x,e.y),x.lineTo(t.elbow.x,t.elbow.y),x.lineTo(t.hand.x,t.hand.y),x.stroke(),x.restore()}function mr(e,t,a){x.save(),x.fillStyle=a,x.beginPath(),x.arc(e.x,e.y,t,0,2*Math.PI),x.fill(),x.restore()}function gr(e){if(!e||!e.category)return null;const t=e.category;if(t.startsWith("melee")){const e=t.includes("mid")||t.includes("long"),a=e?72:56;return{length:a,thickness:e?6:5,color:"#ffcc80",detailColor:"#ffdca6",handleOffset:.5*a,strapColor:"#ffe6b8"}}if(t.startsWith("ranged-heavy")){const e=68;return{length:e,thickness:12,color:"#4d596b",detailColor:"#9aa9c7",handleOffset:.32*e,strapColor:"#5f6d82"}}if(t.startsWith("ranged-mid")){const e=50;return{length:e,thickness:9,color:"#4a5668",detailColor:"#8294b8",handleOffset:.28*e,strapColor:"#7687ab"}}if(t.startsWith("ranged")){const e=38;return{length:e,thickness:7,color:"#4f5a6b",detailColor:"#9aa9c7",handleOffset:.22*e,strapColor:"#7c8baa"}}return t.startsWith("throwable")?{length:18,thickness:10,color:"#adb7c4",detailColor:"#e3e6eb",handleOffset:6,strapColor:"#c6ccd8"}:null}function pr(e,t,a,n,o){const i=Math.max(0,Math.min(o,.5*Math.min(a,n)));x.beginPath(),x.moveTo(e+i,t),x.lineTo(e+a-i,t),x.quadraticCurveTo(e+a,t,e+a,t+i),x.lineTo(e+a,t+n-i),x.quadraticCurveTo(e+a,t+n,e+a-i,t+n),x.lineTo(e+i,t+n),x.quadraticCurveTo(e,t+n,e,t+n-i),x.lineTo(e,t+i),x.quadraticCurveTo(e,t,e+i,t),x.closePath()}function yr(e){const{entity:t,pose:a=Oe.standing,aim:n=null,weapon:o=null,weaponVisual:i=null,cosmetics:r=null,primaryColor:s="#f4f7ff",supportColor:l=s,lineWidth:c=4,crouching:d=!1,rolling:f=!1,label:h=null,labelColor:u="#d0d4de",showHealthBar:m=!1,healthRatio:g=null,healthColor:p="#5fffb5",flashColor:y=null,flashAmount:b=0,highlightColor:w=null,attackInfo:v=null}=e,k=a??Oe.standing,M=function(e,t,a,n=1){const o=n>=0?0:Math.PI,i=sr(e,t);if(!a)return{angle:o,vectorX:Math.cos(o),vectorY:Math.sin(o),anchorX:i.x,anchorY:i.y,active:!1};const r=Number.isFinite(a.angle)?a.angle:o;return{angle:r,vectorX:Number.isFinite(a.vectorX)?a.vectorX:Math.cos(r),vectorY:Number.isFinite(a.vectorY)?a.vectorY:Math.sin(r),anchorX:Number.isFinite(a.anchorX)?a.anchorX:i.x,anchorY:Number.isFinite(a.anchorY)?a.anchorY:i.y,active:Boolean(a.active)}}(t,k,n,t.facing??((t.vx??0)>=0?1:-1)),S=i??gr(o),C=k.headRadius??16,T=k.bodyLength??34,I=k.legLength??36,A=k.armLength??28,R=t.vx??0,P=Tn(Math.abs(R)/De,0,1),D=An(),B=.28*Tn(R/De,-1,1),O=d?6:0,E=t.x+6*B,W=t.y+C-.5*O,L=t.y+2*C-.6*O,$=L+6-.4*O,N={x:E,y:$},j={x:t.x+4*B,y:$+T-O},F=D*(4.8+5.6*P),H=I*(.25+.18*P)*(d?.7:1),Y=d?5:Math.max(8,.22*I),X=Math.sin(F),z=Math.sin(F+Math.PI),q=6*B,K=H+z*P*I*.3+q,U=fr(j,{length:I,offsetX:X*P*I*.3-H+q,phase:X,lift:Y}),G=fr(j,{length:I,offsetX:K,phase:z,lift:Y}),J=M.angle,V=M.vectorX,_=M.vectorY,Q=V>=0?1:-1;let Z=J,ee=1,te=12+6*P,ae=J-.22*Q,ne=.92,oe=8+4*P;if(v?.active){const e=Tn(v.progress??0,0,1);(v.type??"").startsWith("melee")?(ee=1.1+.25*e,te=12+16*e,Z=J+Q*e*.45,ae=J-Q*(.35-.18*e),ne=.86):(v.type??"").startsWith("ranged")&&(ee=1,te=12+10*e,ae=J-Q*(.18-.08*e),ne=.94)}const ie=dr(N,{length:A,aimAngle:Z,bendDirection:Q,stretch:ee,elbowOffset:te}),re=dr(N,{length:A*ne,aimAngle:ae,bendDirection:-Q,stretch:ne,elbowOffset:oe}),se=Q>=0?U:G,le=Q>=0?G:U,ce=Q>=0?re:ie,de=Q>=0?ie:re,fe=Q>=0?re:ie,he=c,ue=r??null,me=ue?.helmet?.style??null,ge=ue?.armor?.style??null,pe=ue?.jetpack?.style??null;if(pe&&"none"!==pe.type&&function(e,{entityX:t,shoulder:a,hip:n}){if(!e)return;const o=a.y+4,i=Math.max(32,n.y-o+12);if("dual"===e.type){const a=12,n=18;if(x.save(),x.globalAlpha=.9,x.fillStyle=e.bodyColor??"#1f2d44",x.fillRect(t-n-a/2,o,a,i),x.fillRect(t+n-a/2,o,a,i),e.accentColor&&(x.strokeStyle=e.accentColor,x.lineWidth=3,x.beginPath(),x.moveTo(t-n,o+6),x.lineTo(t-n,o+i-10),x.moveTo(t+n,o+6),x.lineTo(t+n,o+i-10),x.stroke()),x.restore(),e.exhaustColor){const r=.8*a,s=18;x.save(),x.fillStyle=e.exhaustColor,x.globalAlpha=e.exhaustAlpha??.7,x.beginPath(),x.moveTo(t-n-r/2,o+i),x.lineTo(t-n,o+i+s),x.lineTo(t-n+r/2,o+i),x.closePath(),x.fill(),x.beginPath(),x.moveTo(t+n-r/2,o+i),x.lineTo(t+n,o+i+s),x.lineTo(t+n+r/2,o+i),x.closePath(),x.fill(),x.restore()}return}if("shielded"===e.type){const a=28,i=Math.max(36,n.y-o+16);if(x.save(),x.globalAlpha=.92,x.fillStyle=e.bodyColor??"#3a2f2f",pr(t-a/2,o,a,i,10),x.fill(),e.panelColor&&(x.fillStyle=e.panelColor,pr(t-a/2+4,o+6,a-8,i-12,6),x.fill()),x.restore(),e.exhaustColor){x.save(),x.fillStyle=e.exhaustColor,x.globalAlpha=e.exhaustAlpha??.8;const a=20,n=20;x.beginPath(),x.moveTo(t-a/2,o+i),x.lineTo(t,o+i+n),x.lineTo(t+a/2,o+i),x.closePath(),x.fill(),x.restore()}}}(pe,{entityX:t.x,shoulder:N,hip:j}),hr(j,se,s,he,.55),hr(j,le,s,he,1),x.save(),x.strokeStyle=s,x.lineWidth=he,x.lineCap="round",x.beginPath(),x.moveTo(N.x,L),x.lineTo(j.x,j.y),x.stroke(),x.restore(),ge&&"none"!==ge.type&&function(e,{entityX:t,shoulder:a,hip:n,lineWidth:o}){if(!e)return;const i=a.y+4,r=n.y-10;if("harness"===e.type)return x.save(),x.strokeStyle=e.strapColor??"#444b63",x.lineWidth=Math.max(3,.85*o),x.lineCap="round",x.beginPath(),x.moveTo(t-16,i),x.lineTo(t-6,r),x.moveTo(t+16,i),x.lineTo(t+6,r),x.stroke(),e.accentColor&&(x.strokeStyle=e.accentColor,x.lineWidth=2.4,x.beginPath(),x.moveTo(t-14,i+16),x.lineTo(t+14,i+16),x.stroke()),void x.restore();if("plating"===e.type){const a=34,n=Math.max(28,r-i),o=t-a/2;return x.save(),x.globalAlpha=.94,x.fillStyle=e.plateColor??"#212733",pr(o,i,a,n,10),x.fill(),e.trimColor&&(x.strokeStyle=e.trimColor,x.lineWidth=2,pr(o+1,i+1,a-2,n-2,9),x.stroke()),e.glowColor&&(x.fillStyle=e.glowColor,x.globalAlpha=.7,x.beginPath(),x.arc(t,i+.55*n,4,0,2*Math.PI),x.fill()),void x.restore()}if("webbing"===e.type){const a=36,n=5;x.save(),x.globalAlpha=.9,x.fillStyle=e.strapColor??"#2f3a44";for(let e=0;e<3;e+=1){const o=i+6+10*e;x.fillRect(t-a/2,o,a,n)}if(e.pouchColor){const a=10,n=12,o=r-n-2;x.fillStyle=e.pouchColor,x.fillRect(t-a-4,o,a,n),x.fillRect(t+4,o,a,n)}e.accentColor&&(x.strokeStyle=e.accentColor,x.lineWidth=2,x.beginPath(),x.moveTo(t-18,i+12),x.lineTo(t+18,i+12),x.stroke()),x.restore()}}(ge,{entityX:t.x,shoulder:N,hip:j,lineWidth:he}),ur(N,ce,l,.9*he,.45),function(e,t,a,n){if(!e)return;const{length:o,thickness:i,color:r,detailColor:s,handleOffset:l,strapColor:c}=e;x.save(),x.translate(t.x,t.y),x.rotate(n),x.fillStyle=r,x.fillRect(-l,.5*-i,o,i),s&&(x.fillStyle=s,x.fillRect(.2*o-l,.33*-i,.18*o,.66*i),x.fillRect(.7*o-l,.18*-i,.12*o,.36*i)),x.restore(),a&&(x.save(),x.strokeStyle=c??r,x.lineWidth=Math.max(2,.25*i),x.beginPath(),x.moveTo(t.x,t.y),x.lineTo(a.x,a.y),x.stroke(),x.restore())}(S,ie.hand,re.hand,J),ur(N,fe,l,.9*he,.8),ur(N,de,s,he,1),mr(re.hand,3.2,l),mr(ie.hand,3.4,s),x.save(),x.strokeStyle=s,x.lineWidth=he,x.lineCap="round",x.beginPath(),x.arc(E,W,C,0,2*Math.PI),x.stroke(),x.restore(),me&&"none"!==me.type&&function(e,{headCenterX:t,headCenterY:a,headRadius:n,aimAngle:o}){if(!e)return;const i=n+2;if("visor"===e.type){x.save(),x.lineCap="round",x.strokeStyle=e.shellColor??"#1a2233",x.lineWidth=.7*n,x.beginPath(),x.arc(t,a,i,.55*Math.PI,1.45*Math.PI),x.stroke(),e.accentColor&&(x.strokeStyle=e.accentColor,x.lineWidth=.32*n,x.beginPath(),x.arc(t,a,i-1,.6*Math.PI,1.4*Math.PI),x.stroke()),x.restore(),x.save(),x.translate(t,a),x.rotate(o);const r=1.5*n,s=.8*n;return x.fillStyle=e.visorColor??"#68e7ff",x.globalAlpha=e.visorAlpha??.65,x.fillRect(-r/2,-s/2,r,s),x.globalAlpha=1,x.strokeStyle=e.shellColor??"#1a2233",x.lineWidth=2,x.strokeRect(-r/2,-s/2,r,s),void x.restore()}"plated"===e.type&&(x.save(),x.lineCap="round",x.strokeStyle=e.shellColor??"#2f2a3f",x.lineWidth=.8*n,x.beginPath(),x.arc(t,a,i,.6*Math.PI,1.4*Math.PI),x.stroke(),e.accentColor&&(x.strokeStyle=e.accentColor,x.lineWidth=.38*n,x.beginPath(),x.arc(t,a,i-1,.7*Math.PI,1.3*Math.PI),x.stroke()),e.trimColor&&(x.strokeStyle=e.trimColor,x.lineWidth=2.4,x.beginPath(),x.arc(t,a,i+1,.52*Math.PI,1.48*Math.PI),x.stroke()),x.restore())}(me,{headCenterX:E,headCenterY:W,headRadius:C,aimAngle:J}),w&&(x.save(),x.strokeStyle=w,x.lineWidth=.6*he,x.globalAlpha=.6,x.beginPath(),x.arc(t.x,t.y+C,C+6,0,2*Math.PI),x.stroke(),x.restore()),y&&b>0&&(x.save(),x.fillStyle=y,x.globalAlpha=Tn(b,0,1),x.beginPath(),x.arc(ie.hand.x+6*V,ie.hand.y+6*_,10,0,2*Math.PI),x.fill(),x.restore()),m&&null!=g){const e=90,a=8,n=t.x-e/2,o=t.y-1.6*C;x.save(),x.fillStyle="#232733",x.fillRect(n,o,e,a),x.fillStyle=p,x.fillRect(n,o,e*Tn(g,0,1),a),x.strokeStyle="#404653",x.lineWidth=1.5,x.strokeRect(n,o,e,a),x.restore()}h&&(x.save(),x.fillStyle=u,x.font="14px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(h,t.x,t.y-1.9*C),x.restore())}function xr(e,t){const a=e.template;if(!a)return;const n=e.shakeMagnitude??0,o=e.shakeTimer??0,i=8*t+.05*e.x,r=o>0?Math.sin(i)*n*.35:0,s=o>0?Math.cos(.75*i)*n*.22:0;if(x.save(),x.translate(e.x+r,e.y+s),e.destroyed&&function(e,t,a){const n=e.width,o=Math.max(8,(t.rubbleHeight??32)*a),i=t.debrisColor??t.bodyColor??"#4a4a4a";x.fillStyle=i,x.beginPath(),x.moveTo(-n/2,0),x.lineTo(.35*-n,.3*-o),x.lineTo(.12*-n,-o),x.lineTo(.08*n,.65*-o),x.lineTo(.32*n,.9*-o),x.lineTo(n/2,0),x.closePath(),x.fill(),x.fillStyle="rgba(30, 32, 40, 0.6)",x.fillRect(-n/2,0,n,Math.max(6,.2*o))}(e,a,Tn(e.rubbleLevel??0,0,1)),!e.destroyed||(e.rubbleLevel??0)<1)switch(a.material){case"vehicle":!function(e,t){const a=e.width,n=e.height,o=-n,i=e.facing??1,r=Tn(1-e.health/e.maxHealth,0,1);x.save(),x.scale(i,1);const s=t.bodyColor??"#b13d30",l=t.glassColor??"#4ac3ff",c=t.accentColor??"#f7f9ff",d=t.edgeColor??"#1c1d25",f=o+.15*n,h=.55*n,u=Math.max(12,.18*n);x.fillStyle=s,x.beginPath(),x.moveTo(-a/2,f+.1*n),x.lineTo(.42*-a,o+.45*h),x.lineTo(.25*-a,o),x.lineTo(.22*a,o),x.lineTo(.45*a,o+.5*h),x.lineTo(a/2,f+.1*n),x.closePath(),x.fill(),x.fillStyle=l;const m=.55*h;x.fillRect(.28*-a,o+.12*h,.42*a,m),x.fillStyle=c,x.fillRect(-a/2,f+.55*h,a,.2*n),x.fillStyle=d,x.beginPath(),x.arc(.28*-a,-.15*u,u,0,2*Math.PI),x.arc(.28*a,-.15*u,u,0,2*Math.PI),x.fill(),!e.destroyed&&r>.05&&(x.strokeStyle="rgba(0, 0, 0, 0.35)",x.lineWidth=2,x.beginPath(),x.moveTo(.12*-a,o+.8*h),x.lineTo(.22*-a,f+.55*n),x.lineTo(.05*-a,f+.7*n),x.stroke(),x.beginPath(),x.moveTo(.18*a,o+.6*h),x.lineTo(.3*a,f+.4*n),x.lineTo(.12*a,f+.65*n),x.stroke()),x.restore()}(e,a);break;case"volatile":!function(e,t,a){const n=e.width,o=e.height,i=Tn(1-e.health/e.maxHealth,0,1),r=.22*n,s=.48*o,l=-o,c=t.bodyColor??"#c0671c",d=t.stripeColor??t.accentColor??"#ffd45f",f=t.edgeColor??"#2f1a08",h=[{x:.22*-n,y:l+.45*o},{x:.22*n,y:l+.5*o},{x:0,y:l+.1*o}],u=e.destroyed?1:3;for(let e=0;e<u;e+=1){const t=h[e];x.save(),x.translate(t.x,t.y),x.fillStyle=c,x.beginPath(),x.ellipse(0,0,r,.5*s,0,0,2*Math.PI),x.fill(),x.fillRect(-r,.5*-s,2*r,s),x.fillStyle=d,x.fillRect(-r,.12*-s,2*r,.24*s),x.strokeStyle=f,x.lineWidth=3,x.strokeRect(-r,.5*-s,2*r,s),x.restore()}if(!e.destroyed&&i>.2){const t=.2+.3*Math.abs(Math.sin(8*a+.05*e.x))*i;x.fillStyle=`rgba(255, 174, 72, ${t.toFixed(3)})`,x.beginPath(),x.ellipse(0,l+.1*o,.12*n,.18*o,0,0,2*Math.PI),x.fill()}}(e,a,t);break;default:!function(e,t,a){const n=e.width,o=e.height,i=-o,r=t.bodyColor??"#555",s=t.accentColor??"#888",l=t.edgeColor??"#333",c=t.damageHighlight??"#d5dde8",d=Tn(1-e.health/e.maxHealth,0,1);if(x.fillStyle=r,x.fillRect(-n/2,i,n,o),x.fillStyle=s,x.fillRect(-n/2,i,n,Math.max(10,.12*o)),x.fillRect(-n/2,i+.55*o,n,Math.max(8,.1*o)),x.strokeStyle=l,x.lineWidth=4,x.strokeRect(-n/2,i,n,o),d>0){const t=3+Math.floor(3*d),r=3*a+.02*e.x;x.strokeStyle=c,x.lineWidth=2;for(let e=0;e<t;e+=1){const a=.45*-n+n*((e+1)/(t+1)),s=o*(.2+.5*d),l=12*Math.sin(r+1.7*e);x.beginPath(),x.moveTo(a,i+.18*o),x.lineTo(a+.3*l,i+.18*o+.45*s),x.lineTo(a+l,i+.18*o+s),x.stroke()}}}(e,a,t)}if(!e.destroyed&&e.maxHealth>0){const t=Tn(e.health/e.maxHealth,0,1);t<.95&&function(e,t,a){const n=Tn(t,0,1),o=.85*e;x.fillStyle="rgba(0, 0, 0, 0.45)",x.fillRect(-o/2,a,o,5),x.fillStyle=n>.5?"#58ec8c":n>.25?"#ffd15c":"#ff675c",x.fillRect(-o/2,a,o*n,5)}(e.width,t,-e.height-10)}const l=e.flashTimer??0;if(l>0){const t=.45*Tn(l/.2,0,1);x.fillStyle=`rgba(255, 255, 255, ${t.toFixed(3)})`,x.fillRect(-e.width/2,-e.height,e.width,e.height)}!function(e,t,a){if((e.smokeTimer??0)<=0)return;const n=t.smokeDuration??1.5,o=Tn((e.smokeTimer??0)/n,0,1),i=.25+.35*o;for(let t=0;t<4;t+=1){const n=a*(.4+.15*t)+.03*e.x+1.3*t,r=.35*e.width*(1+.6*o+.15*t);x.globalAlpha=Tn(i-.06*t,0,.45),x.fillStyle="#9fb6c8",x.beginPath(),x.arc(Math.sin(n)*e.width*.12,-e.height*(.65+.2*t)-6*Math.cos(.6*n),.3*r,0,2*Math.PI),x.fill()}x.globalAlpha=1}(e,a,t),x.restore()}function br(){const e=Si(),t=vi(e.blueprintIndex);if(!t)return e.lastPreview.valid=!1,e.lastPreview;const a=(t.width??120)/2,n=(o=Ye.x+Ye.facing*Math.max(140,a+30),20*Math.round(o/20));var o;const i=fe(),r=Math.max(a+30,Math.min(i-a-30,n)),s=function(e,t){let a=b;const n=he();for(const o of n){const n=o.x-t,i=o.x+o.width+t;e>=n&&e<=i&&o.y<a&&(a=o.y)}return a}(r,a),l=t.cost??0;return e.lastPreview={x:r,y:s,width:t.width,height:t.height,blueprintId:t.id,cost:l,color:t.color,accentColor:t.accentColor,strokeColor:t.strokeColor,ambient:t.ambient??null,valid:ne()>=l},e.lastPreview}function wr(){const e=Si(),t=br();if(!t.valid)return!1;const a=vi(e.blueprintIndex);if(!a)return!1;if(!function(e){const t=Math.round(e??0);return t<=0||!!function(e){return te.materials>=(e??0)}(t)&&(te.materials-=t,!0)}(a.cost??0))return e.lastPreview.valid=!1,!1;const n=function(e,t){return{id:`${e.id}-${Date.now().toString(36)}-${Math.floor(1e3*Math.random())}`,type:e.id,x:t.x,y:t.y,width:e.width,height:e.height,health:e.maxHealth,maxHealth:e.maxHealth,color:e.color,accentColor:e.accentColor,strokeColor:e.strokeColor,ambient:e.ambient??null,blocking:e.blocking??!1,turret:e.turret??null,shield:e.shield??null,trap:e.trap??null,fireCooldown:0,trapCooldown:0,flashTimer:0}}(a,t);return function(e){xi.push(e)}(n),Qn({x:n.x,y:n.y-(n.height??80),startRadius:20,endRadius:Math.max(90,n.width??120),color:a.accentColor??"#8cffd4",ttl:.35}),!0}function vr(e){const t=Si();t.active="boolean"==typeof e?e:!t.active,t.active?br():t.lastPreview.valid=!1}function kr(e,t){!e||t<=0||(e.health=Math.max(0,e.health-t),e.flashTimer=.25)}function Mr(e,t,a){Qn({x:a.x,y:a.y-(a.height??80),startRadius:30,endRadius:Math.max(120,1.4*(a.width??120)),color:a.accentColor??"#ffb347",ttl:.4}),e.splice(t,1);const n=Math.max(5,Math.round((a.maxHealth??200)/15));re({x:a.x,y:a.y-(a.height??80),amount:n,vy:-150})}function Sr(e,t){const a=e.turret;if(!a)return;if(e.fireCooldown=Math.max(0,(e.fireCooldown??0)-t),e.fireCooldown>0)return;let n=null,o=Number.POSITIVE_INFINITY;const i=e.y-(e.height??100)+24;for(const t of Ve){if(t.health<=0)continue;const r=t.x-e.x,s=t.y+.5*t.height-i,l=Math.hypot(r,s);l>(a.range??420)||l<o&&(o=l,n=t)}if(!n)return;const r=n.x-e.x,s=n.y+.5*n.height-i,l=Math.max(1,Math.hypot(r,s)),c=a.projectile?.speed??520,d=r/l*c,f=s/l*c;Ni({x:e.x,y:i,vx:d,vy:f,radius:a.projectile?.radius??6,lifetime:1.4,damage:a.projectile?.damage??18,color:a.projectile?.color??"#ffd57a",facing:Math.sign(r)||1,gravityFactor:.05}),e.fireCooldown=a.cooldown??1.2}function Cr(e,t){const a=e.shield;if(!a)return;const n=a.radius??220,o=e.y-.6*(e.height??100),i=[Ye,...ze];for(const t of i){if(!t||t.health<=0)continue;const i=t.x-e.x,r=t.y+t.height-o;Math.hypot(i,r)<=n&&(t.structureShieldTimer=Math.max(t.structureShieldTimer??0,a.buffDuration??.6),t.structureShieldStrength=Math.max(t.structureShieldStrength??0,a.damageReduction??.4))}}function Tr(e,t){const a=e.trap;if(!a)return;if(e.trapCooldown=Math.max(0,(e.trapCooldown??0)-t),e.trapCooldown>0)return;const n=a.radius??140,o=e.y-.5*(e.height??24);let i=!1;for(const t of Ve){if(t.health<=0)continue;const r=t.x-e.x,s=t.y+.5*t.height-o;Math.hypot(r,s)<=n&&(ni(t,{damage:a.damage??24,knockback:160,launch:0,facing:Math.sign(r)||1}),t.stunTimer=Math.max(t.stunTimer??0,a.stun??.6),i=!0)}i&&(e.trapCooldown=a.cooldown??2.6,Bi({type:"point",x:e.x,y:o,radius:1.2*n,intensity:1.4,color:a.color??"#9af0ff",ttl:.25,flicker:.5,decay:1.2}),Qn({x:e.x,y:o,startRadius:.6*n,endRadius:1.3*n,color:a.color??"#9af0ff",ttl:.3,lineWidth:5}))}function Ir(e,t){const a=(e.width??120)/2,n=e.y-(e.height??80);for(const o of Ve){if(o.health<=0)continue;const i=Math.abs(o.x-e.x)-(a+o.radius-6),r=o.y+o.height-n;i<=0&&r>-40&&(kr(e,(o.attackDamage??12)*t),o.vx*=.2,o.stateTimer=Math.max(o.stateTimer??0,.2))}}function Ar(e){!function(){const e=Si();if(ke.buildToggleBuffered&&(vr(),ke.buildToggleBuffered=!1),!e.active)return ke.buildCycleBuffered=0,ke.buildConfirmBuffered=!1,void(ke.buildCancelBuffered=!1);0!==ke.buildCycleBuffered&&(function(e){const t=Si();t.blueprintIndex=function(e){const t=wi();return 0===t.length?0:(e%t.length+t.length)%t.length}(t.blueprintIndex+e)}(ke.buildCycleBuffered),ke.buildCycleBuffered=0,br()),ke.buildCancelBuffered&&(vr(!1),ke.buildCancelBuffered=!1),(ke.buildConfirmBuffered||ke.attackBuffered)&&(wr()?(ke.buildConfirmBuffered=!1,ke.attackBuffered=!1,ke.attackDown=!1,br()):(ke.buildConfirmBuffered=!1,ke.attackBuffered=!1))}(),function(e){const t=Mi();for(let a=t.length-1;a>=0;a-=1){const n=t[a];n.flashTimer=Math.max(0,(n.flashTimer??0)-e),Ir(n,e),Sr(n,e),Cr(n),Tr(n,e),n.health<=0&&Mr(t,a,n)}}(e),Si().active&&br()}ki();const Rr={active:!1,connected:0,bestConnected:0,maxParticipants:100,packetsPerSecond:0,averageLatency:0,hostId:`coop-host-${Math.random().toString(36).slice(2,8)}`,lastOutcome:"inactive"};function Pr(){return{active:Rr.active,participants:Rr.connected,maxParticipants:Rr.maxParticipants,bestParticipants:Rr.bestConnected,packetsPerSecond:Rr.packetsPerSecond,averageLatency:Rr.averageLatency,hostId:Rr.hostId,lastOutcome:Rr.lastOutcome}}const Dr={pushCrate:{category:"movable",width:96,height:72,mass:3.2,friction:3.6,maxSpeed:160,pushImpulse:360,hitImpulse:520,bodyColor:"#8b6f4a",edgeColor:"#4a3b28",braceColor:"#c59b61",highlightColor:"#ffd89a"},kickBarrel:{category:"rolling",radius:30,height:78,mass:1.1,friction:1.8,maxSpeed:320,pushImpulse:280,hitImpulse:680,bodyColor:"#a33b32",stripeColor:"#ffd45f",edgeColor:"#3a1c18",topColor:"#c95b4f"},shockTrap:{category:"trap",width:110,height:20,damage:24,knockback:90,launch:-160,cooldown:2.8,stunDuration:.75,bodyColor:"#2a374b",accentColor:"#6ddcff",glowColor:"#8cf7ff"}};function Br(){return function(){const e=de();return Array.isArray(e?.interactables)?e.interactables:[]}().map(e=>function(e){const t=Dr[e.type];if(!t)throw new Error(`Unknown interactable template: ${e.type}`);const a=e.templateOverrides??{},n={...t,...a},o=e.width??n.width??(n.radius?2*n.radius:64),i=e.height??n.height??48,r=e.radius??n.radius??.5*Math.max(o,i),s={id:e.id,type:e.type,template:n,x:e.x,y:e.baseY,vx:0,vy:0,width:o,height:i,radius:r,state:n.initialState??"idle",timer:0,cooldown:0,highlight:0,triggered:!1,flashTimer:0,smokeTimer:0,mass:n.mass??1,friction:n.friction??2,maxSpeed:n.maxSpeed??240,pushImpulse:n.pushImpulse??240,hitImpulse:n.hitImpulse??n.pushImpulse??320,facing:e.facing??1,minX:e.minX??null,maxX:e.maxX??null};return e.overrides&&"object"==typeof e.overrides&&Object.assign(s,e.overrides),s}(e))}const Or=Br();function Er(e,t){const a=e.template??{};switch(a.category){case"movable":!function(e,t,a){const n=(e.width??96)/2,o=e.height??72,i=(e.y,Math.sin(4*a+.02*e.x)*(e.vx??0)*.002);x.save(),x.translate(e.x,e.y),x.rotate(i),x.fillStyle=t.bodyColor??"#8b6f4a",x.fillRect(-n,-o,2*n,o),x.strokeStyle=t.edgeColor??"#4a3b28",x.lineWidth=4,x.strokeRect(-n,-o,2*n,o),x.strokeStyle=t.braceColor??"#c59b61",x.lineWidth=3;const r=.4*n;x.beginPath(),x.moveTo(-n,8-o),x.lineTo(-r,.4*o-o),x.moveTo(n,8-o),x.lineTo(r,.4*o-o),x.moveTo(-n,.55*o-o),x.lineTo(-r,-8),x.moveTo(n,.55*o-o),x.lineTo(r,-8),x.stroke(),x.restore()}(e,a,t);break;case"rolling":!function(e,t,a){const n=e.radius??30,o=e.height??2.2*n,i=e.y-o,r=Math.sin(6*a+.05*e.x)*(e.vx??0)*.003;x.save(),x.translate(e.x,i+o/2),x.rotate(r),x.fillStyle=t.bodyColor??"#a33b32",x.beginPath(),x.ellipse(0,0,n,.5*o,0,0,2*Math.PI),x.fill(),x.fillStyle=t.topColor??"#c95b4f",x.beginPath(),x.ellipse(0,.5*-o,.95*n,.55*n,0,0,2*Math.PI),x.fill(),x.fillStyle=t.edgeColor??"#3a1c18",x.beginPath(),x.ellipse(0,.5*o,.95*n,.55*n,0,0,2*Math.PI),x.fill(),x.strokeStyle=t.stripeColor??"#ffd45f",x.lineWidth=5,x.beginPath(),x.moveTo(.85*-n,.25*-o),x.lineTo(.85*n,.1*-o),x.moveTo(.85*-n,.05*o),x.lineTo(.85*n,.2*o),x.stroke(),x.restore()}(e,a,t);break;case"trap":!function(e,t,a){const n=(e.width??110)/2,o=e.height??20,i=e.y-o,r=t.glowColor??"#8cf7ff",s=t.accentColor??"#6ddcff",l=t.bodyColor??"#2a374b",c=.15*Math.sin(5*a+.04*e.x)+.35+(e.cooldown>0?.1:.35);x.save(),x.translate(e.x,0),x.fillStyle=l,x.fillRect(-n,i,2*n,o),x.fillStyle=s,x.fillRect(.9*-n,i+.25*o,1.8*n,.35*o),x.globalAlpha=Tn(c,0,1),x.fillStyle=r,x.fillRect(-n,i-6,2*n,.2*o),x.fillRect(-n,i+o-4,2*n,.2*o),x.globalAlpha=1,x.restore()}(e,a,t)}const n=e.flashTimer??0;if(n>0){const t=.4*Tn(n/.2,0,1),a=e.width?e.width/2:e.radius,o=e.height??1.4*a;x.save(),x.fillStyle=`rgba(255, 255, 255, ${t.toFixed(3)})`,x.translate(e.x,e.y),x.fillRect(-a,-o,2*a,o),x.restore()}const o=Tn(e.highlight??0,0,1);if(o>.01){const t=a.highlightColor??a.accentColor??"#ffd89a",n=e.width?e.width/2:e.radius,i=e.height??1.4*n;x.save(),x.globalAlpha=.45*o,x.fillStyle=t,x.translate(e.x,e.y),x.fillRect(1.15*-n,1.05*-i,2.3*n,1.3*i),x.restore()}}pe(()=>{!function(){Or.length=0;const e=Br();for(const t of e)Or.push(t)}()});const Wr=[],Lr=[],$r=[],Nr=[],jr=[],Fr={weapons:!0,shield:!0,throwables:!0},Hr={Digit6:"weapons",Digit7:"shield",Digit8:"throwables"};function Yr(e,t=1.8){const a=Nr[Nr.length-1];if(a&&a.message===e)return a.ttl=t,a.maxTtl=t,void(a.age=0);for(Nr.push({message:e,ttl:t,maxTtl:t,age:0});Nr.length>6;)Nr.shift()}function Xr(e,t={},a=.4){const n={type:e,x:t.x??Ye.x,y:t.y??Ye.y,radius:t.radius??110,ttl:a,maxTtl:a};return $r.push(n),n}function zr(e){return!1!==Fr[e]}function qr(e){if(!e.altKey||e.repeat)return;const t=Hr[e.code];t&&("function"==typeof e.preventDefault&&e.preventDefault(),function(e){Fr[e]=!Fr[e],Yr(`Debug filter ${e.charAt(0).toUpperCase()+e.slice(1)} ${Fr[e]?"ON":"OFF"}`,1.4),Fr[e]||("weapons"===e?(Wr.length=0,jr.length=0):"shield"===e?Lr.length=0:"throwables"===e&&($r.length=0))}(t))}function Kr(e){if(!zr("weapons"))return;const t=e?.detail??{};Wr.push({weaponId:t.weaponId??"unknown",x:t.x??Ye.x,y:t.y??Ye.y,facing:t.facing??Ye.facing??1,ttl:.12,maxTtl:.12})}function Ur(e){if(!zr("weapons"))return;const t=.4,a=(e?.detail??{}).weaponId??"unknown",n=jr.find(e=>e.weaponId===a);if(n)return n.ttl=t,n.maxTtl=t,void(n.age=0);for(jr.push({weaponId:a,ttl:t,maxTtl:t,age:0});jr.length>5;)jr.shift()}function Gr(e){zr("weapons")&&Yr(`Reloading ${e?.detail?.weaponId??"unknown"}`)}function Jr(e){zr("weapons")&&Yr(`Reload complete ${e?.detail?.weaponId??"unknown"}`,1.4)}function Vr(e){if(!zr("weapons"))return;const t=e?.detail??{},a=t.weaponId??"unknown",n=t.recoil?.horizontal??0,o=t.recoil?.vertical??0,i=Math.hypot(n,o);i<=0||Yr(`Recoil ${a}: ${i.toFixed(2)}`,1.2)}function _r(e){const t=e?.detail?.environment,a=t?.name??t?.id;a&&Yr(`Environment set to ${a}`,2.2)}function Qr(e){if(!zr("shield"))return;const t=e?.detail??{},a={x:t.center?.x??Ye.x,y:t.center?.y??Ye.y};Lr.push({type:"hit",absorb:t.absorb??0,center:a,ttl:.28,maxTtl:.28}),void 0!==t.absorb&&Yr(`Shield absorb ${Math.round(t.absorb)}`,1.2)}function Zr(e){if(!zr("shield"))return;const t=e?.detail??{},a={x:t.center?.x??Ye.x,y:t.center?.y??Ye.y};Lr.push({type:"shatter",center:a,ttl:.45,maxTtl:.45}),Yr(`Shield ${t.reason??"shatter"}`,1.6)}function es(e){if(!zr("shield"))return;const t=e?.detail?.reason??"ended";"shatter"!==t&&Yr(`Shield ${t}`,1.4)}function ts(e){zr("throwables")&&Yr(`Throwable thrown (${(e?.detail??{}).effectType??"unknown"})`,1.4)}function as(e){if(!zr("throwables"))return;const t=e?.detail??{};Xr("explosion",t,.55),void 0!==t.damage?Yr(`Explosion damage ${t.damage}`,1.6):Yr("Explosion triggered",1.4)}function ns(e){if(!zr("throwables"))return;const t=e?.detail??{};Xr("flash",t,.45);const a=t.stunDuration??0;Yr(`Flash burst (stun ${"number"==typeof a?a.toFixed(1):String(a)}s)`,1.6)}function os(e){if(!zr("throwables"))return;const t=e?.detail??{},a=Xr("smoke",t,.6);a.maxRadius=t.radius??a.radius,Yr(`Smoke deployed (${Math.round(10*((t.duration??0)+Number.EPSILON))/10}s)`,1.6)}function is(e){zr("throwables")&&(Xr("smoke-fade",e?.detail??{},.4),Yr("Smoke dissipated",1.4))}let rs=!1;function ss(){rs||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",Kr),window.addEventListener("weapon:shot-fired",Ur),window.addEventListener("weapon:reload-start",Gr),window.addEventListener("weapon:reload-finish",Jr),window.addEventListener("weapon:recoil-kick",Vr),window.addEventListener("shield:hit",Qr),window.addEventListener("shield:shatter",Zr),window.addEventListener("shield:end",es),window.addEventListener("throwable:thrown",ts),window.addEventListener("throwable:explosion",as),window.addEventListener("throwable:flash-burst",ns),window.addEventListener("throwable:smoke-detonate",os),window.addEventListener("throwable:smoke-dissipate",is),window.addEventListener("environment:changed",_r),window.addEventListener("keydown",qr),rs=!0)}function ls(e,t){for(let a=e.length-1;a>=0;a-=1){const n=e[a];n.ttl-=t,n.age=(n.age??0)+t,n.ttl<=0&&e.splice(a,1)}}function cs(){return ss(),{muzzleFlashes:Wr,shieldBursts:Lr,throwableBursts:$r,notices:Nr,shotIndicators:jr,filters:{...Fr}}}const ds={horizontalKick:0,verticalKick:0,decay:12,lastShotTime:0};function fs(e,t,a){const n=t+a,o=he();for(const t of o){if(e.vy<0)continue;const o=e.y+a;if(n<=t.y&&o>=t.y&&e.x>=t.x&&e.x<=t.x+t.width)return e.y=t.y-a,e.vy=0,Object.prototype.hasOwnProperty.call(e,"onGround")&&(e.onGround=!0),!0}return!1}const hs={street:{fill:"#2c2f36",stroke:"#1b1d22"},metro:{fill:"#3d4252",stroke:"#272b37"},rooftop:{fill:"#4c5566",stroke:"#2f3541"},skybridge:{fill:"#596274",stroke:"#323846"},terrace:{fill:"#46505f",stroke:"#2a303b"},balcony:{fill:"#525a6a",stroke:"#2f3540"},median:{fill:"#3a404a",stroke:"#23272f"},jungleFloor:{fill:"#314629",stroke:"#1c2917"},stone:{fill:"#4c5f4c",stroke:"#2a3628"},canopy:{fill:"#3f5e3a",stroke:"#23361f"},branch:{fill:"#594427",stroke:"#2e2010"},sand:{fill:"#cfa665",stroke:"#8a6a3a"},cliff:{fill:"#8b6b42",stroke:"#5b4426"},plateau:{fill:"#b78b4f",stroke:"#7f6032"},deck:{fill:"#303a4c",stroke:"#1d2431"},catwalk:{fill:"#3c4a63",stroke:"#212a39"},maglev:{fill:"#2a315a",stroke:"#181d33"},plain:{fill:"#36404c",stroke:"#222730"}};function us(e){const t=hs[e.type]??hs.plain;x.fillStyle=t.fill,x.fillRect(e.x,e.y,e.width,e.height),x.strokeStyle=t.stroke,x.lineWidth=2,x.strokeRect(e.x,e.y,e.width,e.height)}function ms(e){x.save(),x.fillStyle="#2a3240",x.fillRect(e.x,e.y,e.width,e.height),x.fillStyle="#4a6076";const t=Math.max(3,Math.floor(e.height/60));for(let a=0;a<t;a+=1){const n=e.y+20+a*(e.height/t);x.fillRect(e.x+10,n,e.width-20,8)}x.restore()}function gs(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b,n=e.height??220;x.save(),x.translate(t,a),x.strokeStyle="#3c2d1b",x.lineWidth=8,x.beginPath(),x.moveTo(0,0),x.lineTo(0,-n),x.stroke(),x.lineWidth=6,x.beginPath(),x.moveTo(0,-n),x.quadraticCurveTo(18,24-n,32,58-n),x.moveTo(0,-n),x.quadraticCurveTo(-18,24-n,-32,58-n),x.stroke(),x.fillStyle="#3f8f4a";for(let e=-2;e<=2;e+=1)x.beginPath(),x.ellipse(12*e,40-n,40,16,Math.PI/8*e,0,2*Math.PI),x.fill();x.restore()}function ps(e){x.save(),x.fillStyle="#484f3d",x.fillRect(e.x,e.y,e.width,e.height),x.fillStyle="#2f3526";const t=Math.max(2,Math.floor(e.height/40));for(let a=0;a<t;a+=1){const n=e.y+a*(e.height/t);x.fillRect(e.x+4,n+6,e.width-8,6)}x.strokeStyle="#9db27e",x.lineWidth=3,x.setLineDash([6,10]),x.strokeRect(e.x+6,e.y+6,e.width-12,e.height-12),x.setLineDash([]),x.restore()}function ys(e){x.save(),x.strokeStyle="#3a5c35",x.lineWidth=10;const t=e.x,a=e.y,n=e.width??180,o=e.height??120;x.beginPath(),x.arc(t,a,n/2,Math.PI,0,!1),x.stroke(),x.lineWidth=4,x.strokeStyle="#5f8d4a",x.beginPath(),x.arc(t,a,n/2-10,Math.PI,0,!1),x.stroke(),x.fillStyle="#7fcf6a";for(let e=-3;e<=3;e+=1)x.beginPath(),x.ellipse(t+18*e,a-.4*o,12,20,Math.PI/6,0,2*Math.PI),x.fill();x.restore()}function xs(e){const t=e.x,a=e.y;x.save();const n=x.createRadialGradient(t,a,0,t,a,26);n.addColorStop(0,"rgba(120, 255, 191, 0.8)"),n.addColorStop(1,"rgba(120, 255, 191, 0)"),x.fillStyle=n,x.beginPath(),x.arc(t,a,26,0,2*Math.PI),x.fill(),x.fillStyle="#63ffbd",x.beginPath(),x.arc(t,a,8,0,2*Math.PI),x.fill(),x.restore()}function bs(e){const t=e.width??80,a=e.height??200,n=e.x-t/2,o=e.y-a,i=x.createLinearGradient(n,o,n,o+a);i.addColorStop(0,"rgba(110, 216, 255, 0.5)"),i.addColorStop(1,"rgba(110, 216, 255, 0.1)"),x.fillStyle=i,x.fillRect(n,o,t,a),x.strokeStyle="rgba(173, 245, 255, 0.6)",x.lineWidth=2;for(let e=0;e<t;e+=16)x.beginPath(),x.moveTo(n+e+4,o),x.lineTo(n+e+8,o+a),x.stroke()}function ws(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b,n=e.width??260,o=e.height??100;x.save(),x.fillStyle=e.color??"#d59c5a",x.beginPath(),x.moveTo(t-n/2,a),x.quadraticCurveTo(t,a-o,t+n/2,a),x.closePath(),x.fill(),x.fillStyle="rgba(255, 226, 170, 0.35)",x.beginPath(),x.moveTo(t-.3*n,a-.25*o),x.quadraticCurveTo(t,a-.65*o,t+.35*n,a-.28*o),x.lineTo(t+.3*n,a-.18*o),x.fill(),x.restore()}function vs(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b,n=e.height??240;x.save(),x.fillStyle="#7d6040",x.beginPath(),x.moveTo(t-18,a),x.lineTo(t+18,a),x.lineTo(t+6,a-n),x.lineTo(t-12,a-.65*n),x.closePath(),x.fill(),x.strokeStyle="#c6a37c",x.lineWidth=3,x.beginPath(),x.moveTo(t-4,a-.3*n),x.lineTo(t+6,a-.6*n),x.stroke(),x.restore()}function ks(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b-20;x.save(),x.strokeStyle="#5b3e24",x.lineWidth=5,x.beginPath(),x.moveTo(t-16,a+12),x.lineTo(t+12,a-4),x.moveTo(t+16,a+12),x.lineTo(t-12,a-4),x.stroke();const n=x.createRadialGradient(t,a-10,0,t,a-10,36);n.addColorStop(0,"rgba(255, 174, 72, 0.95)"),n.addColorStop(.5,"rgba(255, 116, 32, 0.6)"),n.addColorStop(1,"rgba(255, 116, 32, 0)"),x.fillStyle=n,x.beginPath(),x.arc(t,a-10,36,0,2*Math.PI),x.fill(),x.restore()}function Ms(e){const t=e.x,a=e.y,n=e.height??300;x.save(),x.strokeStyle="#b89c6d",x.lineWidth=4,x.beginPath(),x.moveTo(t,a+n),x.lineTo(t,a),x.stroke(),x.strokeStyle="#ffe6ac",x.lineWidth=2;for(let e=0;e<4;e+=1){const o=(e+1)*(n/5);x.beginPath(),x.moveTo(t-18,a+o),x.lineTo(t+18,a+o-12),x.stroke()}x.fillStyle="#ffe89a",x.beginPath(),x.arc(t,a,10,0,2*Math.PI),x.fill(),x.restore()}function Ss(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b,n=e.height??320;x.save(),x.fillStyle="#3f5ac9",x.beginPath(),x.moveTo(t-28,a),x.lineTo(t+28,a),x.lineTo(t+8,a-n),x.lineTo(t-12,a-.6*n),x.closePath(),x.fill(),x.fillStyle="rgba(120, 200, 255, 0.35)",x.beginPath(),x.moveTo(t,a-.92*n),x.lineTo(t+16,a-.4*n),x.lineTo(t-4,a-.32*n),x.closePath(),x.fill(),x.restore()}function Cs(e){x.save();const t=e.x-e.width/2,a=e.y-e.height,n=x.createLinearGradient(t,a,t+e.width,a+e.height);n.addColorStop(0,"rgba(85, 170, 255, 0.4)"),n.addColorStop(1,"rgba(170, 120, 255, 0.7)"),x.fillStyle=n,x.fillRect(t,a,e.width,e.height),x.strokeStyle="#8bd4ff",x.lineWidth=3,x.strokeRect(t,a,e.width,e.height),x.fillStyle="#e5f5ff",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(e.text??"HOLO",e.x,e.y-e.height/2),x.restore()}function Ts(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??b-20,n=e.height??180;x.save(),x.strokeStyle="#3d4e88",x.lineWidth=6,x.beginPath(),x.moveTo(t-14,a),x.lineTo(t-14,a-n),x.moveTo(t+14,a),x.lineTo(t+14,a-n),x.stroke(),x.strokeStyle="#7ce7ff",x.lineWidth=3;for(let e=0;e<=n;e+=32)x.beginPath(),x.moveTo(t-14,a-e),x.quadraticCurveTo(t,a-e-12,t+14,a-e-2),x.stroke();x.fillStyle="#9ef5ff",x.beginPath(),x.arc(t,a-n-14,18,0,2*Math.PI),x.fill(),x.restore()}function Is(e){x.save(),x.fillStyle="#5d8fff",x.beginPath(),x.ellipse(e.x,e.y,46,16,0,0,2*Math.PI),x.fill(),x.fillStyle="#1f2536",x.fillRect(e.x-26,e.y-8,52,16),x.restore()}function As(){return Ee[Ye.squadCommandIndex%Ee.length]??Ee[0]}function Rs(e,t){let a=null,n=Number.POSITIVE_INFINITY;for(const o of Ve){if(o.health<=0)continue;const i=o.x-e,r=o.y+.5*o.height-t,s=Math.hypot(i,r);s<n&&(n=s,a=o)}return a}function Ps(e,t,a,n=1){const o=t-e.x;if(e.vx=0,Math.abs(o)>12){const t=Math.sign(o);e.vx=t*De*n,e.facing=t}}function Ds(e,t,a){if(e.fireCooldown=Math.max(0,(e.fireCooldown??0)-a),e.fireCooldown>0)return;e.fireCooldown=.45;const n=e.aim??null,o=n&&Number.isFinite(n.anchorX)&&Number.isFinite(n.anchorY)?{x:n.anchorX,y:n.anchorY}:sr(e,Oe.standing),i=t.x,r=t.y+.35*t.height,s=n&&Number.isFinite(n.vectorX)?n.vectorX:i-o.x,l=n&&Number.isFinite(n.vectorY)?n.vectorY:r-o.y,c=Math.hypot(s,l)||1,d=s/c,f=l/c,h=-f,u=d,m=4*(e.roleIndex??0)-4,g=520*d,p=g>=0?1:-1;Ni({x:o.x+32*d+h*m,y:o.y+32*f+u*m,vx:g,vy:520*f-18,radius:5,lifetime:.8,color:p>0?"#8cffd4":"#a0ffe1",damage:12,knockback:110,facing:p}),e.flashTimer=.12}function Bs(e,t){const a=As(),n=Le(Oe.standing);switch(e.y+n>=b-2&&Math.abs(e.vy)<1&&(e.onGround=!0),e.targetEnemyId=null,a?.id){case"attack":{const a=Rs(e.x,e.y);a&&Math.abs(a.x-Ye.x)<=640?(Ps(e,a.x-24,0,.95),Ds(e,a,t),e.targetEnemyId=a.id):Ps(e,Ye.x-60,0,.8);break}case"defend":{const a=40*(e.roleIndex??0)-40;Ps(e,Ye.x+a,0,.7);const n=Rs(e.x,e.y);n&&Math.abs(n.x-Ye.x)<=180&&(Ds(e,n,t),e.targetEnemyId=n.id);break}case"flank":{const a=220*((e.roleIndex??0)%2==0?-1:1);Ps(e,Ye.x+a,0,.9);const n=Rs(e.x,e.y);n&&(Ds(e,n,t),e.targetEnemyId=n.id);break}default:{const t=36*(e.roleIndex??0)-36;Ps(e,Ye.x+t,0,.6);break}}!function(e,t){e.vy+=Be*t;const a=e.y;e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1;const n=Le(Oe.standing);fs(e,a,n)||e.y+n>=b&&(e.y=b-n,e.vy=0,e.onGround=!0),e.vx=Math.max(-240,Math.min(De,e.vx))}(e,t),e.flashTimer=Math.max(0,(e.flashTimer??0)-t)}const Os="player-stickman";function Es(){return Ye.vehicleId?(e=Ye.vehicleId,Cn.find(t=>t.id===e)??null):null;var e}function Ws(e,t,a){if(t<=0)return;const n=t*a;e.vx>0?e.vx=Math.max(0,e.vx-n):e.vx<0&&(e.vx=Math.min(0,e.vx+n))}function Ls(e,t){const a=t.driverSeat??{x:0,y:t.height},n=Le(Oe.standing),o=e.x+a.x,i=e.y+a.y,r=Tn(o,40,fe()-40);Ye.x=r,Ye.y=i-n,Ye.vx=e.vx,Ye.vy=e.vy;const s=t.movementType??"ground";Ye.onGround="air"!==s&&("water"===s||e.onGround),Ye.facing=e.facing??Ye.facing}function $s(e,t={}){const a=kn[e.type];if(!a)return Ye.vehicleId=null,void(Ye.controlMode="onFoot");e.driverId=null,t.skipCooldown||(e.enterCooldown=Math.max(e.enterCooldown,t.cooldown??.35));const n=Le(Oe.standing),o=t.preferDirection??(e.facing>=0?1:-1),i=a.exitOffsets??[],r=o>=0?{x:.6*a.width,y:0}:{x:.6*-a.width,y:0},s=o>=0?i[0]??r:i[1]??r;Ye.vehicleId=null,Ye.controlMode="onFoot",Ye.vehicleCandidateId=null;const l=fe();Ye.x=Tn(e.x+s.x,40,l-40),Ye.y=b-n,!1===t.inheritVelocity?(Ye.vx=0,Ye.vy=0):(Ye.vx=.5*e.vx,Ye.vy=Math.min(e.vy,0)),Ye.onGround=!0,Ye.facing=o>=0?1:-1}function Ns(e,t,a,n){n?function(e,t,a){const n=ke.right&&!ke.left,o=ke.left&&!ke.right,i=n?1:o?-1:0,r=t.acceleration??0,s=t.braking??600,l=t.maxSpeed??360,c=t.idleDrag??0;if(0!==i&&r>0&&(e.vx+=i*r*a),ke.down&&e.onGround&&s>0){const t=s*a;e.vx>0?e.vx=Math.max(0,e.vx-t):e.vx<0&&(e.vx=Math.min(0,e.vx+t))}else 0===i&&Ws(e,c,a);l>0&&(e.vx=Tn(e.vx,-l,l)),0!==i?e.facing=i:Math.abs(e.vx)>8&&(e.facing=e.vx>0?1:-1)}(e,t,a):Ws(e,t.idleDrag??0,a);const o=t.airDrag??1;!e.onGround&&o>0&&o<1&&(e.vx*=Math.pow(o,Math.max(0,60*a))),e.vy+=Be*a,e.x+=e.vx*a,e.y+=e.vy*a;const i=b-t.height;e.y>=i?(e.y=i,e.vy=0,e.onGround=!0):e.onGround=!1;const r=.5*t.width,s=r+32,l=fe()-r-32;e.x=Tn(e.x,s,l),e.x!==s&&e.x!==l||(e.vx=0);const c=Tn(e.vx/Math.max(1,t.maxSpeed??360)*.12,-.25,.25);e.tilt+=(c-e.tilt)*Math.min(1,10*a)}function js(e,t,a,n){const o=t.waterAcceleration??t.acceleration??220,i=t.waterMaxSpeed??t.maxSpeed??220,r=t.waterReverseSpeed??Math.max(80,.6*i),s=t.waterIdleDrag??t.idleDrag??200,l=t.turnDrag??220,c=t.bobAmplitude??4,d=t.bobSpeed??1.4,f=t.splashIntensity??.3,h=e.waterLineY??b-(t.waterSurfaceOffset??24),u=t.buoyancyPoint??.55,m=t.submergedOffset??0,g=n&&ke.right&&!ke.left,p=n&&ke.left&&!ke.right,y=g?1:p?-1:0;if(0!==y&&o>0?e.vx+=y*o*a:Ws(e,s,a),n&&ke.down){const t=l*a;e.vx>0?e.vx=Math.max(e.vx-t,-r):e.vx<0?e.vx=Math.min(e.vx+t,r):t>0&&(e.vx=Tn(e.vx-e.facing*t*.15,-r,r))}e.vx=Tn(e.vx,-r,i),0!==y?e.facing=y:Math.abs(e.vx)>4&&(e.facing=e.vx>0?1:-1),e.x+=e.vx*a;const x=.5*t.width,w=x+32,v=fe()-x-32;e.x=Tn(e.x,w,v),e.x!==w&&e.x!==v||(e.vx=0),e.vy=0,e.bobPhase=(e.bobPhase??0)+a*(d*(n?1.2:.85));const k=Math.sin(e.bobPhase)*c,M=Math.sin(.5*e.bobPhase+.02*e.x)*f*6,S=h-t.height*u+m+k+M;e.y+=(S-e.y)*Math.min(1,6.5*a),e.onGround=!1;const C=Tn(e.vx/Math.max(1,i)*.22+.05*Math.sin(e.bobPhase+.4*e.facing),-.45,.45);e.tilt+=(C-e.tilt)*Math.min(1,5*a)}function Fs(e,t,a,n){const o=t.horizontalAcceleration??t.acceleration??0,i=t.horizontalMaxSpeed??t.maxSpeed??320,r=t.horizontalDrag??t.idleDrag??200,s=t.airDrag??.97,l=t.hoverMinAltitude??0,c=Math.max(l,t.hoverMaxAltitude??l),d=t.altitudeRate??160,f=t.autopilotStrength??4,h=t.verticalDamping??.9,u=t.maxVerticalSpeed??220,m=t.liftPower??0,g=t.descendPower??m,p=n&&ke.right&&!ke.left,y=n&&ke.left&&!ke.right,x=p?1:y?-1:0;0!==x&&o>0?e.vx+=x*o*a:Ws(e,r,a),i>0&&(e.vx=Tn(e.vx,-i,i)),0!==x?e.facing=x:Math.abs(e.vx)>6&&(e.facing=e.vx>0?1:-1),e.vx*=Math.pow(s,60*a);const w=Be*(t.gravityScale??.25);if(e.vy+=w*a,Number.isFinite(e.preferredAltitude)||(e.preferredAltitude=t.spawnHover??l),n)ke.jump&&(e.preferredAltitude+=d*a),ke.down&&(e.preferredAltitude-=d*a);else{const n=b-(e.y+t.height);e.preferredAltitude+=(n-e.preferredAltitude)*Math.min(1,.5*a)}e.preferredAltitude=Tn(e.preferredAltitude,l,c);const v=Tn(b-(e.y+t.height),l,c),k=e.preferredAltitude-v;e.vy-=k*f*a,n&&m>0&&(ke.jump&&(e.vy-=.25*m*a),ke.down&&(e.vy+=.25*g*a)),e.vy*=Math.pow(h,60*a),u>0&&(e.vy=Tn(e.vy,-u,u)),e.x+=e.vx*a,e.y+=e.vy*a;const M=.5*t.width,S=M+32,C=fe()-M-32;e.x=Tn(e.x,S,C),e.x!==S&&e.x!==C||(e.vx=0);const T=Tn(b-(e.y+t.height),l,c);e.y=b-t.height-T,(T===l&&e.vy>0||T===c&&e.vy<0)&&(e.vy=0),e.onGround=!1;const I=Tn(e.vx/Math.max(1,i)*.35-.02*k,-.6,.6);e.tilt+=(I-e.tilt)*Math.min(1,6*a)}function Hs(e,t,a){const n=a.aim??null,o=n&&Number.isFinite(n.angle)?n.angle:Math.atan2(n?.vectorY??0,n?.vectorX??t.facing??1),i=Math.cos(o),r=Math.sin(o),s=t.offset??{x:0,y:0},l=Number.isFinite(n?.anchorX)?n.anchorX:e.x+s.x,c=Number.isFinite(n?.anchorY)?n.anchorY:e.y+s.y,d=t.muzzles&&t.muzzles.length>0?t.muzzles:[{x:t.muzzle?.x??0,y:t.muzzle?.y??0}],f=a.muzzleIndex??0,h=d[f%d.length];a.muzzleIndex=(f+1)%d.length;const u=h?.x??0,m=h?.y??0,g=l+u*i-m*r,p=c+u*r+m*i,y=t.projectile??{},x=y.speed??600,b=(t.scatter??0)*(Math.PI/180),w=o+(b>0?(Math.random()-.5)*b:0),v=Math.cos(w)*x,k=v>=0?1:-1;Ni({x:g,y:p,vx:v,vy:Math.sin(w)*x+(y.verticalSpeed??0),radius:y.radius??5,lifetime:y.lifetime??1.3,color:y.color??"#ffd27a",damage:y.damage??12,knockback:y.knockback??80,facing:k,gravityFactor:y.gravityFactor??.12}),a.flashTimer=t.flashDuration??.1,a.lastMuzzleX=g,a.lastMuzzleY=p}function Ys(e,t,a,n){const o=t.mountedWeapons??[],i=e.mounts??[];if(0===o.length||0===i.length)return;const r=n&&ke.attackDown,s=n&&ke.throwDown;for(let t=0;t<o.length;t+=1){const l=o[t],c=i[t];if(!l||!c)continue;c.cooldown=Math.max(0,(c.cooldown??0)-a),c.flashTimer=Math.max(0,(c.flashTimer??0)-a);let d=!1;const f=l.binding??"primary";n?"primary"===f?d=r:"secondary"===f&&(d=s):l.autoFire&&(d=!0),!d||c.cooldown>0||(Hs(e,l,c),c.cooldown=l.fireInterval??.2)}}const Xs={id:"squadCarbine",name:"Support Carbine",category:"ranged-mid"},zs="16px 'Segoe UI Semibold', 'Segoe UI', Arial, sans-serif",qs="14px 'Segoe UI', Arial, sans-serif",Ks="12px 'Segoe UI', Arial, sans-serif";function Us(e,t,a,n,o,i=8){const r=Math.min(i,.5*n,.5*o);e.beginPath(),e.moveTo(t+r,a),e.lineTo(t+n-r,a),e.arcTo(t+n,a,t+n,a+r,r),e.lineTo(t+n,a+o-r),e.arcTo(t+n,a+o,t+n-r,a+o,r),e.lineTo(t+r,a+o),e.arcTo(t,a+o,t,a+o-r,r),e.lineTo(t,a+r),e.arcTo(t,a,t+r,a,r),e.closePath()}function Gs(e,t,a,n,o={}){const i=x;i.save(),Us(i,e,t,a,n,o.radius??12),i.fillStyle=o.fill??"rgba(12, 18, 28, 0.78)",i.fill(),!1!==o.stroke&&(i.strokeStyle=o.stroke??"rgba(140, 170, 210, 0.22)",i.lineWidth=o.strokeWidth??1.4,i.stroke()),o.accent&&(i.fillStyle=o.accent,i.fillRect(e,t,a,o.accentHeight??3)),i.restore()}function Js(e,t,a,n,o,i={}){const r=x,s=i.radius??.5*n,l=Tn(o??0,0,1);r.save(),Us(r,e,t,a,n,s),r.fillStyle=i.background??"rgba(255, 255, 255, 0.08)",r.fill(),r.clip(),r.fillStyle=i.fill??"#8cffd4",r.fillRect(e,t,a*l,n),r.restore(),!1!==i.border&&(r.save(),Us(r,e,t,a,n,s),r.strokeStyle=i.border??"rgba(140, 170, 210, 0.35)",r.lineWidth=i.borderWidth??1,r.stroke(),r.restore())}function Vs(e,t,a,n={}){const o=x;o.save(),o.font=Ks,o.textAlign="left",o.textBaseline="middle";const i=n.paddingX??10,r=n.height??20,s=Math.ceil(o.measureText(e).width)+2*i;return Us(o,t,a,s,r,.5*r),o.fillStyle=n.background??"rgba(140, 170, 220, 0.32)",o.fill(),n.border&&(o.strokeStyle=n.border,o.stroke()),o.fillStyle=n.color??"#e0e8ff",o.fillText(e,t+i,a+.5*r+(n.offsetY??0)),o.restore(),s}function _s(e){return e?e.startsWith("melee")?"rgba(255, 139, 139, 0.45)":e.startsWith("ranged")?"rgba(124, 214, 255, 0.45)":"throwable"===e?"rgba(255, 205, 135, 0.45)":"gadget"===e?"rgba(140, 255, 212, 0.45)":"rgba(146, 166, 210, 0.35)":"rgba(146, 166, 210, 0.35)"}function Qs(e){const t=Math.max(0,e??0);return t>=10?`${Math.round(t)}s`:`${t.toFixed(1)}s`}function Zs(){const e=x.canvas.width,t=x.canvas.height,a=gt(),n=nt().map(e=>Re[e]??{id:e,name:"Unknown"}),o=a?lt(a.id):null,i=function(){const e={active:mo.active,strength:mo.strength,maxStrength:mo.maxStrength,duration:mo.duration,maxDuration:mo.maxDuration};return{turretCount:lo.length,grappleActive:ho.active,shieldActive:e.active,shieldStrength:e.strength,shieldMaxStrength:e.maxStrength,gadgetCooldown:Ye.gadgetCooldown??0}}(),r=ds.horizontalKick,s=ds.verticalKick,l=function(){const e=Si(),t=vi(e.blueprintIndex);return{active:e.active,resources:ne(),blueprintName:t?.name??"None",cost:t?.cost??0,valid:e.lastPreview.valid}}(),c=Math.max(0,l?.resources??0);if((Ye.flashBlindTimer??0)>0){const a=Math.min(.55,(Ye.flashBlindTimer??0)/1.2);x.fillStyle=`rgba(255, 255, 224, ${a})`,x.fillRect(0,0,e,t)}x.save(),x.textAlign="left",x.textBaseline="alphabetic";const d=Math.max(1,Ye.maxHealth??100),f=Tn(Ye.health/d,0,1),h=i?.shieldMaxStrength??0,u=i?.shieldStrength??0,m=h>0?Tn(u/h,0,1):0,g=(i?.shieldActive??!1)||u>0,p=g?158:138,y=t-p-32;Gs(24,y,308,p,{accent:"#5dc2ff"}),x.font=zs,x.fillStyle="#f4f7ff",x.fillText("Player Vitals",40,y+30),x.font=qs,x.fillStyle="#d7dff1",x.fillText(`Health ${Math.round(Ye.health)} / ${Math.round(d)}`,40,y+56),Js(40,y+62,276,10,f,{fill:"#ff7d7d"});let b=y+88;g&&(x.fillStyle="#cbeaff",x.fillText(`Shield ${Math.round(u)} / ${Math.round(h)}`,40,b),Js(40,b+6,276,10,m,{fill:"#7cd6ff"}),b+=32),x.fillStyle="#9aa6bf",x.fillText(`Materials ${c}`,40,b),b+=22;const w=n.find(e=>"throwable"===e.category),v=n.find(e=>"gadget"===e.category),k=Math.max(0,Ye.throwCooldown??0),M=Math.max(0,i?.gadgetCooldown??0),S=Math.max(w?.throwable?.cooldownSeconds??0,k),C=Math.max(v?.gadget?.cooldownSeconds??0,M),T=[];if(Ye.comboWindowOpen&&T.push({text:"Combo window open",background:"rgba(255, 205, 135, 0.32)",color:"#ffe0b8"}),w&&(k>.05?T.push({text:`Throw ${Qs(k)}`,background:"rgba(255, 173, 102, 0.32)",color:"#ffd7a8"}):T.push({text:"Throw ready",background:"rgba(140, 255, 212, 0.28)",color:"#d6ffee"})),v&&(M>.05?T.push({text:`Gadget ${Qs(M)}`,background:"rgba(124, 214, 255, 0.28)",color:"#d6f1ff"}):T.push({text:"Gadget ready",background:"rgba(124, 214, 255, 0.2)",color:"#d6f1ff"})),(Ye.stunTimer??0)>0&&T.push({text:`Stunned ${Qs(Ye.stunTimer)}`,background:"rgba(255, 140, 122, 0.32)",color:"#ffe0d6"}),(Ye.flashBlindTimer??0)>0&&T.push({text:`Blinded ${Qs(Ye.flashBlindTimer)}`,background:"rgba(255, 230, 128, 0.32)",color:"#fff2c4"}),(Ye.smokeSlowTimer??0)>0&&T.push({text:`Smoke slow ${Qs(Ye.smokeSlowTimer)}`,background:"rgba(168, 186, 208, 0.32)",color:"#e1e7f1"}),Ye.health<=0&&T.push({text:"Downed",background:"rgba(255, 125, 109, 0.36)",color:"#ffe1d6"}),T.length>0){let e=40,t=b;for(const a of T){const n=Vs(a.text,e,t,a);e+=n+8,e+n>316&&(e=40,t+=24)}b=t+28}const I=320,A=e-I-24;Gs(A,24,I,212,{accent:_s(a?.category??"")}),x.font=zs,x.fillStyle="#f4f7ff",x.fillText("Weapon",A+16,54),x.font=qs,x.fillStyle="#d7dff1",x.fillText(a?.name??"Unarmed",A+16,80),a?.category&&(x.font=Ks,x.fillStyle="#9aa6bf",x.fillText(a.category.replace(/-/g," ").toUpperCase(),A+16,98));let R=124;if(o){const e=o.capacity===Number.POSITIVE_INFINITY,t=e?"INF":`${Math.max(0,o.magazine)}`,a=e?"INF":`${Math.max(0,o.reserve)}`;x.font=qs,x.fillStyle="#d7dff1",x.fillText(`Magazine ${t}   Reserve ${a}`,A+16,R),R+=18,!e&&o.capacity>0&&(Js(A+16,R,288,8,Tn(o.magazine/o.capacity,0,1),{fill:"#ffd27f"}),R+=20),o.reloading&&o.reloadSeconds>0&&(Js(A+16,R,288,6,1-Tn(o.reloadTimer/o.reloadSeconds,0,1),{fill:"#ffcf7a"}),R+=16,x.font=Ks,x.fillStyle="#ffcf7a",x.fillText(`Reloading ${Qs(o.reloadTimer)}`,A+16,R+4),R+=18)}else x.font=qs,x.fillStyle="#9aa6bf",x.fillText("No ammunition required",A+16,R),R+=18;if(w){const e=k<=.05;x.font=Ks,x.fillStyle=e?"#8cffd4":"#ffcf7a",x.fillText(`Throw ${e?"ready":Qs(k)}`,A+16,R),R+=14,S>0&&(Js(A+16,R,288,6,e?1:1-Tn(k/S,0,1),{fill:"#ffd27f"}),R+=16)}if(v){const e=M<=.05;x.font=Ks,x.fillStyle=e?"#8cffd4":"#7cd6ff",x.fillText(`Gadget ${e?"ready":Qs(M)}`,A+16,R),R+=14,C>0&&(Js(A+16,R,288,6,e?1:1-Tn(M/C,0,1),{fill:"#7cd6ff"}),R+=16)}Math.hypot(r??0,s??0)>.05&&(x.font=Ks,x.fillStyle="#9aa6bf",x.fillText(`Recoil offset H ${(r??0).toFixed(2)}  V ${(s??0).toFixed(2)}`,A+16,R),R+=18);const P=[];if((i?.turretCount??0)>0&&P.push({text:`Turrets ${i.turretCount}`,background:"rgba(140, 255, 212, 0.25)",color:"#d6ffee"}),i?.grappleActive&&P.push({text:"Grapple active",background:"rgba(124, 214, 255, 0.25)",color:"#d6f1ff"}),P.length>0){let e=A+16;const t=208;for(const a of P)e+=Vs(a.text,e,t,a)+8}const D=["Move: WASD / Arrows   Jump: Space   Roll: Shift","Attack: Left Click or J   Throw: Right Click or G","Build Mode: B toggle   , / . cycle blueprints","Toggle Modes: Y Survival   K Sandbox   F9 Co-Op"];Gs(24,24,360,32+18*D.length,{accent:"rgba(146, 166, 210, 0.35)"}),x.font=zs,x.fillStyle="#f4f7ff",x.fillText("Core Controls",40,48),x.font=qs,x.fillStyle="#d7dff1";let B=70;for(const e of D)x.fillText(e,40,B),B+=18;const O=[],E=function(){const e=Po(),t=Do();return{active:e.active||"inactive"!==e.stage,stage:e.stage,message:e.message,missionIndex:e.missionIndex,missionName:t?.name??"",missionDescription:t?.description??"",completedMissions:e.completedMissions,totalMissions:e.totalMissions,lastOutcome:e.lastOutcome,objective:{type:e.objective.type,label:e.objective.label,target:e.objective.target,progress:e.objective.progress,remaining:e.objective.remaining,duration:e.objective.duration}}}();if(E)if(E.stage&&"inactive"!==E.stage){const e=[],t=E.missionName??"Story Mission",a=Math.max(0,E.totalMissions??0),n=E.missionIndex??-1;let o=t;a>0&&n>=0&&(o+=` (${n+1}/${a})`),e.push({text:o,color:"#fce6b3"});const i=E.objective??{};if("eliminate"===i.type&&i.target>0){const t=Math.min(i.target,Math.round(i.progress??0));e.push(`${i.label??"Eliminate"}: ${t}/${i.target}`)}else"survive"===i.type&&(i.remaining??0)>0?e.push(`${i.label??"Hold out"}: ${Qs(i.remaining)}`):i.label&&e.push(i.label);E.message&&e.push({text:E.message,color:"#d7dff1"}),O.push({title:"Campaign",accent:"#ffd66c",lines:e,footer:"Press Q for briefing"})}else O.push({title:"Campaign",accent:"rgba(255, 214, 108, 0.22)",lines:["Press Q to begin missions."]});const W=function(){const e=Nn();return{active:e.active,stage:e.stage,timer:e.timer,wave:e.wave,enemiesAlive:e.enemiesAlive,lastReward:e.lastReward,kills:e.kills,runReward:e.runReward,bestWave:e.bestWave,bestKills:e.bestKills,bestReward:e.bestReward,lastOutcome:e.lastOutcome}}();if(W){const e=[],t=Boolean(W.active),a=Math.max(1,W.wave||W.bestWave||1);e.push(t?`Wave ${Math.max(1,W.wave||1)}`:`Best Wave ${Math.max(1,W.bestWave||a)}`),t?("rest"===W.stage?e.push(`Resupply ${Qs(W.timer??0)}`):"countdown"===W.stage?e.push(`Deploying ${Qs(W.timer??0)}`):e.push(`Enemies ${W.enemiesAlive}`),e.push(`Kills ${W.kills??0}`)):"defeat"===W.lastOutcome?(e.push("Defeated last run"),e.push(`Kills ${W.kills??0} | Materials ${W.runReward??0}`)):(e.push("Press Y to launch waves."),(W.bestKills??0)>0&&e.push(`Best kills ${W.bestKills}`)),O.push({title:"Survival",accent:t?"#ffd66c":"rgba(255, 214, 108, 0.18)",lines:e,footer:t?"Press Y to exit Survival":"Press Y to begin Survival"})}const L={active:Vo.active,wave:Vo.wave,enemiesAlive:Vo.enemiesAlive,kills:Vo.kills,bestWave:Vo.bestWave,bestKills:Vo.bestKills,restTimer:Vo.inRest?Vo.restTimer:0,inRest:Vo.inRest,lastWaveDuration:Vo.lastWaveDuration,lastOutcome:Vo.lastOutcome,materialFloor:12e3};if(L){const e=[],t=Boolean(L.active);t?(e.push(`Wave ${Math.max(1,L.wave||1)}`),L.inRest&&(L.restTimer??0)>0?e.push(`Next wave ${Qs(L.restTimer??0)}`):e.push(`Enemies ${L.enemiesAlive}`),e.push(`Kills ${L.kills??0}`)):(e.push("Press K to start full-arsenal skirmish."),((L.bestWave??0)>0||(L.bestKills??0)>0)&&e.push(`Best Wave ${Math.max(1,L.bestWave??0)} | Kills ${L.bestKills??0}`)),O.push({title:"Sandbox",accent:t?"#8cffd4":"rgba(140, 255, 212, 0.2)",lines:e,footer:t?"Press K to exit Sandbox Skirmish":"Press K to toggle Sandbox"})}const $=Pr();if($){const e=[],t=Boolean($.active);if(t){const t=Math.max(0,$.participants||1),a=Math.max(t,$.maxParticipants||t);e.push(`${t}/${a} connected`),e.push(`Latency ${Math.max(0,$.averageLatency??0).toFixed(0)} ms`),e.push(`Throughput ${Math.max(0,$.packetsPerSecond??0).toFixed(1)} pkt/s`)}else e.push("Press F9 to open Massive Co-Op."),$.lastOutcome&&"inactive"!==$.lastOutcome&&e.push(`Last session: ${$.lastOutcome}`);O.push({title:"Massive Co-Op",accent:t?"#8cffd4":"rgba(140, 255, 212, 0.18)",lines:e,footer:t?"Press F9 to disconnect":"Press F9 to connect"})}const N={timeUntilNext:Math.max(0,Vi.nextDropTimer),nextDropLabel:Gi[Vi.nextDropTypeId]?.label??null,incomingMessage:Vi.incomingTimer>0?Vi.incomingMessage:null,incomingAlpha:Vi.incomingTimer>0?Vi.incomingTimer/Vi.incomingDuration:0,rewardMessage:Vi.rewardTimer>0?Vi.rewardMessage:null,rewardAlpha:Vi.rewardTimer>0?Vi.rewardTimer/Vi.rewardDuration:0,activeCount:Ji.length};if(N&&(N.incomingMessage||N.rewardMessage||(N.activeCount??0)>0)){const e=[];N.incomingMessage&&e.push({text:N.incomingMessage,color:"#d6f1ff"}),(N.timeUntilNext??0)>.2&&N.nextDropLabel&&e.push(`Next drop ${N.nextDropLabel}: ${Qs(N.timeUntilNext??0)}`),(N.activeCount??0)>0&&e.push(`Drops on field ${N.activeCount}`),N.rewardMessage&&e.push({text:`Reward ${N.rewardMessage}`,color:"#8cffd4"}),O.push({title:"Supply Drops",accent:"#8cffd4",lines:e})}const j=Za?.();if(j&&j.status&&"inactive"!==j.status){const e=[];e.push(`Status: ${j.status}`),"connected"!==j.status?e.push("Use window.P2P.createOffer() in console"):e.push(`Remote peers ${Ue().length}`),O.push({title:"P2P Session",accent:"rgba(146, 166, 210, 0.35)",lines:e})}const F=function(e,t){let a=252;for(const n of e){const e=n.lines??[],o=40+18*e.length+20*(n.footer?1:0),i=Math.max(n.minHeight??64,o);Gs(t,a,320,i,{accent:n.accent??"rgba(146, 166, 210, 0.35)",fill:n.fill}),x.save(),x.textAlign="left",x.font=zs,x.fillStyle=n.titleColor??"#f4f7ff",x.fillText(n.title,t+16,a+28),x.font=qs;let r=a+52;for(const a of e){const e="string"==typeof a?a:a.text,n="string"==typeof a?"#d7dff1":a.color??"#d7dff1";x.fillStyle=n,x.fillText(e,t+16,r),r+=18}n.footer&&(x.font=Ks,x.fillStyle=n.footerColor??"#9aa6bf",x.fillText(n.footer,t+16,a+i-12)),x.restore(),a+=i+16}return a}(O,A);!function(e,t,a,n,o){if(!e||0===e.length)return;const i=e.length,r=Math.min(.9*n,560),s=Math.min(118,Math.max(72,(r-12*(i-1))/i)),l=.6*s,c=(n-(s*i+12*(i-1)))/2,d=o-l-16;e.forEach((e,n)=>{const o=c+n*(s+12),i=e.id===t?.id;Gs(o,d,s,l,{accent:i?_s(e.category??""):"rgba(255, 255, 255, 0.06)",fill:i?"rgba(18, 28, 40, 0.94)":"rgba(12, 18, 28, 0.78)",radius:10,stroke:"rgba(140, 170, 210, 0.18)"}),x.save(),x.textAlign="left",x.font=Ks,x.fillStyle=i?"#f5f8ff":"#aeb7cc",x.fillText(`${n+1}`,o+12,d+18),x.font=qs,x.fillStyle=i?"#f5f8ff":"#d7dff1";const r=e.name.length>16?`${e.name.slice(0,15)}...`:e.name;if(x.fillText(r,o+12,d+38),i&&a){const e=a.capacity===Number.POSITIVE_INFINITY,t=e?"INF":`${Math.max(0,a.magazine)}`,n=e?"INF":`${Math.max(0,a.reserve)}`;x.font=Ks,x.fillStyle="#9aa6bf",x.fillText(`${t}/${n}`,o+12,d+l-12)}x.restore()})}(n,a,o,e,t);const H=[["En","enemies"],["Sq","squad"],["Veh","vehicle"],["Net","remote"],["Dst","destructible"],["Bld","building"],["Int","interactable"],["Res","resource"]],Y=[];for(const[e,t]of H){const a=`${t}Culled`,n=qi[`${t}Total`]??0;if(n<=0)continue;const o=Math.max(0,n-(qi[a]??0));Y.push(`${e} ${o}/${n}`)}let X=t-24;if(Y.length>0){x.font=Ks;const a=Y.join("   "),n=Math.max(200,Math.ceil(x.measureText(a).width)+32),o=48,i=e-n-24,r=t-o-24;Gs(i,r,n,o,{accent:"rgba(146, 166, 210, 0.35)",radius:10}),x.save(),x.font=Ks,x.fillStyle="#9aa6bf",x.fillText("Performance",i+16,r+20),x.fillStyle="#d0d7e9",x.fillText(a,i+16,r+o-12),x.restore(),X=r}const z=cs(),q=z?.notices?.slice(-4).reverse()??[],K=z?.shotIndicators??[],U=[];for(const e of q){const t=e.maxTtl>0?Tn(e.ttl/e.maxTtl,0,1):1;U.push({text:e.message,alpha:t})}for(const e of K){const t=e.maxTtl>0?Tn(e.ttl/e.maxTtl,0,1):1;U.push({text:`Shot: ${e.weaponId}`,alpha:t})}const G=Object.entries(z?.filters??{}).filter(([,e])=>e);if(G.length>0&&U.push({text:`Filters ${G.map(([e])=>e).join(", ")}`,alpha:.85,color:"#9aa6bf"}),U.length>0){const e=32+18*U.length;let t=F+12;const a=X-e-12;t>a&&(t=a),Gs(A,t,I,e,{accent:"rgba(146, 166, 210, 0.25)",radius:10,fill:"rgba(10, 16, 26, 0.82)"}),x.save(),x.font=Ks,x.fillStyle="#9aa6bf",x.fillText("Debug Feed",A+16,t+20);let n=t+38;for(const e of U)x.globalAlpha=e.alpha??1,x.fillStyle=e.color??"#d0d7e9",x.fillText(e.text,A+16,n),n+=18;x.restore()}x.restore()}function el(){!function(){if(0!==$i.length){x.save(),x.lineWidth=2;for(const e of $i){const t=Math.max(0,e.life/e.maxLife);x.fillStyle=`rgba(255, 200, 120, ${t})`,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill()}x.restore()}}(),function(){const e=An();x.save();for(const t of Fi)if(t.detonated){const e=Math.max(t.explosionDuration,.001),a=Tn(1-t.explosionTimer/e,0,1),n=Tn(1-a,0,1);if("flash"===t.effectType){const e=t.explosionRadius*(.8+.5*a),o=Math.max(0,Math.min(1,.75*n+.15));x.fillStyle=`rgba(255, 255, 224, ${o.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.fill()}else if("smoke"===t.effectType){const e=t.explosionRadius*(.6+.6*a),o=Math.max(0,Math.min(.65,.5*n+.1));x.fillStyle=`rgba(180, 200, 220, ${o.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.fill()}else{const e=t.explosionRadius*(.65+.4*a),o=Math.max(0,Math.min(1,.7*n));x.strokeStyle=`rgba(255, 196, 120, ${o.toFixed(3)})`,x.lineWidth=6*(1-.6*a),x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.stroke();const i=Math.max(0,Math.min(1,.75*n));x.fillStyle=`rgba(255, 118, 64, ${i.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,.6*e,0,2*Math.PI),x.fill()}}else{x.globalAlpha=1,x.fillStyle=t.color,x.beginPath(),x.arc(t.x,t.y,t.radius,0,2*Math.PI),x.fill();const a=t.maxFuse>0?Tn(t.fuse/t.maxFuse,0,1):0;x.strokeStyle="rgba(255, 232, 194, 0.85)",x.lineWidth=3,x.beginPath(),x.arc(t.x,t.y,.65*t.radius,-Math.PI/2,-Math.PI/2+2*Math.PI*a),x.stroke();const n=Math.cos(20*e)*t.radius*.4,o=Math.sin(24*e)*t.radius*.2-.8*t.radius;x.fillStyle="rgba(255, 240, 210, 0.9)",x.beginPath(),x.arc(t.x+n,t.y+o,3.2,0,2*Math.PI),x.fill()}x.restore(),function(){if(0!==Hi.length){x.save();for(const e of Hi){const t=Tn(e.life/e.duration,0,1),a=e.radius,n=x.createRadialGradient(e.x,e.y,.15*a,e.x,e.y,a);n.addColorStop(0,"rgba(172, 196, 216, 0.35)"),n.addColorStop(1,"rgba(40, 52, 64, 0)"),x.globalAlpha=t,x.fillStyle=n,x.beginPath(),x.arc(e.x,e.y,a,0,2*Math.PI),x.fill()}x.restore()}}()}(),function(){if(io(),0!==zn.length||0!==qn.length){x.save();for(const e of qn){const t=Tn(e.ttl/e.maxTtl,0,1),a=1-t,n=e.startRadius+(e.endRadius-e.startRadius)*a;x.globalAlpha=.6*Tn(t,0,1),x.lineWidth=e.lineWidth,x.strokeStyle=e.color,x.beginPath(),x.arc(e.x,e.y,n,0,2*Math.PI),x.stroke()}for(const e of zn){const t=Tn(e.ttl/e.maxTtl,0,1);let a=Tn(t,0,1);"smoke"===e.type?a*=.55:"blood"===e.type?a=.45+.45*a:"bloodMist"===e.type?a=.25+.4*a:"flash"===e.type?a=.35+.65*a:"spark"===e.type?a=.35+.55*a:"dust"===e.type?a=.3+.4*a:"debris"===e.type&&(a=.5+.5*a),x.globalAlpha=a,x.fillStyle=e.color;let n=t;"smoke"===e.type?n=1:"blood"===e.type?n=.7+.4*t:"bloodMist"===e.type?n=1:"spark"===e.type?n=.5+.5*t:"dust"===e.type?n=.8+.3*t:"debris"===e.type&&(n=.6+.4*t);const o=Math.max(1.2,e.radius*n);x.beginPath(),x.arc(e.x,e.y,o,0,2*Math.PI),x.fill()}x.restore()}}(),function(){const{muzzleFlashes:e,shieldBursts:t,throwableBursts:a}=cs();if(0!==e.length||0!==t.length||0!==a.length){x.save();for(const t of e){const e=Tn(t.ttl/t.maxTtl,0,1),a=.25+.6*e,n=12+14*(1-e),o=(t.facing??1)*(10+6*(1-e));x.globalAlpha=a,x.fillStyle="#ffd27a",x.beginPath(),x.arc(t.x+o,t.y,n,0,2*Math.PI),x.fill()}for(const e of t){const t=Tn(e.ttl/e.maxTtl,0,1),a=("shatter"===e.type?.55:.35)*t;if(a<=0)continue;const n=("shatter"===e.type?120:80)*(1-.35*t);x.globalAlpha=a,x.lineWidth="shatter"===e.type?6:3,x.strokeStyle="shatter"===e.type?"#7cd6ff":"#9be9ff",x.beginPath(),x.arc(e.center.x,e.center.y,n,0,2*Math.PI),x.stroke()}for(const e of a){const t=Tn(e.ttl/e.maxTtl,0,1);if(t<=0)continue;let a="#ffb347";"flash"===e.type?a="#fff6d0":"smoke"!==e.type&&"smoke-fade"!==e.type||(a="#9db8ca");const n=e.radius*(1+.35*(1-t));x.globalAlpha=("smoke-fade"===e.type?.3:.45)*t,x.lineWidth="flash"===e.type?5:4,x.strokeStyle=a,x.beginPath(),x.arc(e.x,e.y,n,0,2*Math.PI),x.stroke()}x.restore()}}()}function tl(e){return`${Math.round(100*(e??0))}%`}function al(e){const t=gt(),a=(t?.attackChain??[])[e];a&&(Ye.attacking=!0,Ye.attackIndex=e,Ye.currentAttack=a,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.nextAttackQueued=!1,Ye.hitboxSpawned=!1,Ye.attackInstanceId+=1)}function nl(e,t={}){if(!e)return null;const a=t.pose??(e===Ye?Ye.currentPose??Oe.standing:Oe.standing),n=t.height??e.height??Le(a),o=t.halfWidth??e.radius??22,i=t.vx??e.vx??0,r=t.onGround??e.onGround??!0;return{ref:e,x:e.x,y:e.y,vx:i,onGround:r,facing:e.facing??1,height:n,halfWidth:o}}function ol(e,t,a,n){if(!a||"movable"!==t.category&&"rolling"!==t.category)return;const o=a.y+a.height;if(Math.abs(o-e.y)>.6*e.height+.25*a.height+24)return;const i=e.width?e.width/2:e.radius,r=a.x-e.x;if(a.halfWidth+i-Math.abs(r)<=0)return;const s=r>=0?1:-1,l=t.pushImpulse??260,c=a.ref===Ye,d=(l+Math.abs(a.vx)*(c?.7:.45))*n;e.vx+=s*d;const f=t.maxSpeed??e.maxSpeed??240;e.vx=Tn(e.vx,-f,f);const h=e.x+s*(i+a.halfWidth+.5);if(a.ref.x=s>0?Math.min(a.ref.x,h):Math.max(a.ref.x,h),a.ref===Ye){const e=fe();Ye.x=Tn(Ye.x,40,e-40)}e.flashTimer=Math.max(e.flashTimer,.12),e.state="rolling"===t.category?"rolling":"pushed"}function il(e,t){const a=e.template??{};e.flashTimer=Math.max(0,(e.flashTimer??0)-t),e.timer=Math.max(0,(e.timer??0)-t);const n=Le(Ye.currentPose??Oe.standing),o=Ye.y+n,i=Math.abs(o-e.y),r=Math.abs(Ye.x-e.x),s=i<e.height+.25*n+32&&r<(e.width?e.width:2*e.radius)+120?1:0;if(e.highlight+=(s-e.highlight)*Tn(6*t,0,1),e.highlight=Tn(e.highlight,0,1),"trap"===a.category)return void function(e,t,a){if(e.cooldown=Math.max(0,(e.cooldown??0)-a),e.cooldown>0)return;const n=e.width?e.width/2:e.radius,o=n+26,i=t.damage??0,r=t.knockback??80,s=t.launch??-140,l=t.stunDuration??.6;let c=!1;const d=[];d.push(nl(Ye,{halfWidth:22,vx:Ye.vx}));for(const e of Ve)e.health>0&&d.push(nl(e,{halfWidth:24}));for(const t of d){if(!t)continue;const a=t.y+t.height;if(Math.abs(a-e.y)>.8*e.height+.35*t.height)continue;const n=t.x-e.x;if(Math.abs(n)>o+t.halfWidth)continue;const d=n>=0?1:-1;c=!0,t.ref===Ye?(oi({attackDamage:i,attackKnockback:r,attackLaunch:s,facing:d},{damage:i,knockback:r,launch:s,facing:d}),Ye.stunTimer=Math.max(Ye.stunTimer??0,l)):(ni(t.ref,{damage:i,knockback:r,launch:Math.abs(s),facing:d}),t.ref.stunTimer=Math.max(t.ref.stunTimer??0,.8*l))}c&&(e.cooldown=t.cooldown??2.4,e.flashTimer=.25,e.state="triggered",e.timer=t.cooldown??2.4,Qn({x:e.x,y:e.y-.5*e.height,startRadius:.6*n,endRadius:1.6*n,color:t.glowColor??"#96f7ff",ttl:.35,lineWidth:6}),so({x:e.x,y:e.y-.5*e.height,radius:1.2*n,maxRadius:1.8*n,ttl:.4}),Bi({type:"point",x:e.x,y:e.y,radius:3*n,intensity:1.4,color:t.glowColor??"#8cf7ff",ttl:.22,flicker:.5,decay:.8}))}(e,a,t);const l=(e.friction??2)*("rolling"===a.category?24:32);var c,d;e.vx=(d=l*t,(c=e.vx)>0?Math.max(0,c-d):c<0?Math.min(0,c+d):0),Math.abs(e.vx)<2&&(e.vx=0),e.x+=e.vx*t;const f=e.width?e.width/2:e.radius,h=fe();let u=e.minX??f+24,m=e.maxX??h-f-24;if(u>m){const e=(u+m)/2;u=e,m=e}e.x<=u&&(e.x=u,e.vx=Math.max(0,e.vx)),e.x>=m&&(e.x=m,e.vx=Math.min(0,e.vx)),ol(e,a,nl(Ye,{halfWidth:22,vx:Ye.vx}),t);for(const n of ze)n&&"defeated"!==n.state&&ol(e,a,nl(n,{halfWidth:20}),t)}function rl(e){let t=!1;for(const a of Or){const n=a.template??{};if("movable"!==n.category&&"rolling"!==n.category)continue;if(e.hitTargets.has(a.id))continue;const o=a.radius??(a.width?a.width/2:32),i=a.y-(a.height??o),r=e.x-a.x,s=e.y-i;if(Math.hypot(r,s)>e.radius+o)continue;e.hitTargets.add(a.id);const l=r>=0?1:-1,c=n.hitImpulse??a.hitImpulse??420;a.vx+=l*c;const d=n.maxSpeed??a.maxSpeed??260;a.vx=Tn(a.vx,-d,d),a.flashTimer=Math.max(a.flashTimer,.16),a.state="rolling"===n.category?"rolling":"nudged",t=!0}return t}function sl(e){Ye.activeHitboxes.push({id:Ye.attackInstanceId,attackIndex:Ye.attackIndex,remaining:e.active,duration:e.active,offsetX:e.range,heightOffset:e.heightOffset,radius:e.radius,damage:e.damage,knockback:e.knockback,launch:e.launch,ownerFacing:Ye.facing,hitTargets:new Set,x:0,y:0})}function ll(){const e=gt();if(!e||!e.category?.startsWith("ranged"))return!1;if(!function(e){const t=st(e);return!(t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.reloading||t.magazine<=0||(t.magazine-=1,0)))}(e.id))return ct(e.id)&&(Ye.attacking=!1,Ye.currentAttack=null,Ye.attackIndex=-1,"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:reload-start",{detail:{weaponId:e.id}}))),!1;const t=e.projectile??{},a=t.speed??460,n=Ye.aim??null,o=Number.isFinite(n?.vectorX)?n.vectorX:Ye.facing||1,i=Number.isFinite(n?.vectorY)?n.vectorY:0,r=Math.hypot(o,i)||1,s=o/r,l=i/r,c=Number.isFinite(n?.anchorX)?n.anchorX:Ye.x,d=Number.isFinite(n?.anchorY)?n.anchorY:Ye.y+24,f=t.muzzleDistance??38,h=t.muzzleSideOffset??0,u=c+s*f+-l*h,m=d+l*f+s*h+(t.muzzleVerticalOffset??0),g=Math.atan2(l,s)+function(e){const t=st(e),a=t?.spreadDef;if(!t||!a)return 0;t.spread||(t.spread={current:a.base??0});const n=t.spread,o=a.base??0,i=Math.max(o,n.current??o),r=a.max??i,s=Math.min(r,i),l=s*(Math.PI/180),c=l>0?(2*Math.random()-1)*l:0,d=a.perShot??0;return n.current=Math.min(r,s+d),c}(e.id),p=Math.cos(g)*a+(t.initialVx??0),y=Math.sin(g)*a+(t.initialVy??0),x=p>=0?1:-1;var b;return e.recoil&&(b=e.recoil,ds.horizontalKick+=b?.horizontal??0,ds.verticalKick+=b?.vertical??0,ds.decay=b?.decay??ds.decay,ds.lastShotTime=An(),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:recoil-kick",{detail:{weaponId:e.id,recoil:e.recoil}}))),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:muzzle-flash",{detail:{weaponId:e.id,x:u,y:m,facing:x,direction:{x:s,y:l}}})),Ni({x:u,y:m,vx:p,vy:y,radius:t.radius??5,lifetime:t.lifetime??.9,color:t.color??"#ffca7a",damage:t.damage??10,knockback:t.knockback??60,facing:x,gravityFactor:t.gravityFactor??.2}),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:shot-fired",{detail:{weaponId:e.id}})),!0}const cl=new Map;let dl=0,fl=0,hl=0;const ul=Le(Oe.standing),ml=b-ul;function gl(e){const t=`coop-${e}-${Math.random().toString(36).slice(2,8)}`,a=420+260*Math.random(),n=Math.random()*Math.PI*2,o=.4+Math.random()*(1.1-.4),i=30+110*Math.random();return{id:t,name:`Agent ${e+1}`,angle:n,radius:a,speed:o,latency:i,latencyTarget:i,latencyTimer:1+2*Math.random(),x:Ye.x+Math.cos(n)*a,y:ml,jitter:Math.random()*Math.PI*2}}function pl(e,t,a){e.angle=(e.angle+e.speed*t)%(2*Math.PI);const n=Ye.x+Math.cos(e.angle)*e.radius,o=Math.max(120,a-120);e.x=Math.min(o,Math.max(120,n));const i=46*Math.sin(2*e.angle+e.jitter);e.y=ml+i,e.latencyTimer-=t,e.latencyTimer<=0&&(e.latencyTarget=24+160*Math.random(),e.latencyTimer=1.5+2.5*Math.random());const r=e.latencyTarget-e.latency;e.latency+=r*Math.min(1,.6*t);const s=e.x>=Ye.x?1:-1;return Ke({id:e.id,name:e.name,x:e.x,y:e.y,facing:s,commandId:"support"}),hl+=1,e.latency}function yl(){for(const e of cl.keys())qe.delete(e);cl.clear()}function xl(e){if(ke.coopToggleBuffered){ke.coopToggleBuffered=!1;const e=Pr();e?.active?function(e="inactive"){!function(e="inactive"){Rr.active=!1,Rr.connected=0,Rr.packetsPerSecond=0,Rr.averageLatency=0,Rr.lastOutcome=e??"inactive"}(e),yl(),dl=0,fl=0,hl=0}("aborted"):(function(e=Rr.maxParticipants){Rr.active=!0,Rr.lastOutcome="active",Rr.maxParticipants=Math.max(1,Math.floor(e??Rr.maxParticipants))}(100),"string"==typeof(t="active")&&t.trim()&&(Rr.lastOutcome=t.trim()),dl=0,fl=0,hl=0,yl(),To(),ti("coop"))}var t;const a=Pr();if(!a?.active)return;!function(e){if(cl.size>=100)return;if(dl+=e,dl<.25)return;dl=0;const t=Math.min(12,100-cl.size);for(let e=0;e<t;e+=1){const e=gl(cl.size);cl.set(e.id,e)}}(e);const n=fe();let o=0,i=0;for(const t of cl.values())o+=pl(t,e,n),i+=1;(function(e,t=Rr.maxParticipants){const a=Math.max(0,Math.floor(e??0));Rr.connected=a,Rr.bestConnected=Math.max(Rr.bestConnected,a),"number"==typeof t&&Number.isFinite(t)&&(Rr.maxParticipants=Math.max(a,Math.floor(t)))})(cl.size+1,100),fl+=e,fl>=1&&(!function({packetsPerSecond:e,averageLatency:t}={}){"number"==typeof e&&Number.isFinite(e)&&(Rr.packetsPerSecond=Math.max(0,e)),"number"==typeof t&&Number.isFinite(t)&&(Rr.averageLatency=Math.max(0,t))}({packetsPerSecond:hl/fl,averageLatency:i>0?o/i:0}),hl=0,fl=0)}function bl(e,t){if(e.invulnerability=Math.max(0,e.invulnerability-t),e.attackCooldown=Math.max(0,e.attackCooldown-t),e.stunTimer=Math.max(0,(e.stunTimer??0)-t),e.smokeSlowTimer=Math.max(0,(e.smokeSlowTimer??0)-t),e.smokeSlowTimer<=0&&(e.smokeSlowStrength=1),e.flashTimer>0&&(e.flashTimer=Math.max(0,e.flashTimer-t)),e.shakeTimer>0&&(e.shakeTimer=Math.max(0,e.shakeTimer-t)),e.shakeMagnitude=Math.max(0,e.shakeMagnitude-20*t),e.health<=0)return e.respawnTimer=Math.max(0,e.respawnTimer-t),void(0===e.respawnTimer&&(e.health=e.maxHealth,e.x=e.spawnX,e.y=e.spawnY,e.vx=0,e.vy=0,e.state="patrol",e.stateTimer=1+Math.random(),e.attackCooldown=.6,e.onGround=!0,e.stunTimer=0,e.smokeSlowTimer=0,e.smokeSlowStrength=1));const a=Ye.x-e.x,n=Math.abs(a);e.facing=a>=0?1:-1;const o=e.stunTimer>0,i=e.smokeSlowTimer>0?Math.max(.2,Math.min(1,e.smokeSlowStrength??1)):1,r=e.moveSpeed*i,s=e.aggressionRange*(e.smokeSlowTimer>0?.85:1),l=!o&&n<s;if(n>1.8*s)return e.vx=0,void(e.state="idle");if(o?(e.state="stunned",e.vx=0,e.attackWindup=0,e.attackActive=0,e.stateTimer=Math.max(e.stateTimer,e.stunTimer),e.attackCooldown=Math.max(e.attackCooldown,e.stunTimer+.2)):"stunned"===e.state&&(e.state="idle",e.stateTimer=.6),!o)switch(e.state){case"idle":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state="patrol",e.stateTimer=1.2+Math.random(),e.facing=Math.random()<.5?-1:1),l&&(e.state="chase");break;case"patrol":e.vx=r*e.facing,e.x<=e.patrolRange.min?e.facing=1:e.x>=e.patrolRange.max&&(e.facing=-1),e.stateTimer-=t,e.stateTimer<=0&&(e.state="idle",e.stateTimer=1+Math.random(),e.vx=0),l&&(e.state="chase");break;case"chase":if(!l){e.state="patrol";break}const o=a>=0?1:-1;e.vx=r*o,n<=e.attackRange&&e.attackCooldown<=0&&(e.state="attack-windup",e.attackWindup=.35,e.attackActive=.16,e.vx=0);break;case"attack-windup":e.vx=0,e.attackWindup-=t,e.attackWindup<=0&&(e.state="attack-active",e.attackActive=.16);break;case"attack-active":e.vx=.35*r*e.facing,e.attackActive-=t,e.attackActive<=0&&(e.state="recover",e.stateTimer=.4,e.attackCooldown=1.2);break;case"recover":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state=l?"chase":"idle",e.stateTimer=.9+.4*Math.random());break;default:e.vx=0}const c=e.y;e.vy+=Be*t,e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1,!fs(e,c,e.height)&&e.y+e.height>=b&&(e.y=b-e.height,e.vy=0,e.onGround=!0);const d=fe();e.x=Math.max(60,Math.min(d-60,e.x))}function wl(e){if(e.health<=0)return;if("attack-active"!==e.state)return;const t=e.attackRange+e.radius,a=Ye.x-e.x,n=Ye.y-e.y;a*a+n*n<=t*t&&oi(e)}let vl=0,kl=0,Ml=[],Sl=[],Cl=null,Tl=null,Il=null;function Al(){return"https://projectstickfightinggame.onrender.com".replace(/\/$/,"")}function Rl(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`session-${Math.random().toString(36).slice(2,10)}`}function Pl(e){return"string"!=typeof e?"":e.trim()}async function Dl(e){if(!e||"undefined"==typeof navigator||!navigator.clipboard?.writeText)return!1;try{return await navigator.clipboard.writeText(e),!0}catch(e){return console.warn("Clipboard write failed",e),!1}}function Bl(e){return Array.isArray(e)?e.map(e=>function(e){if("string"==typeof e)return Pl(e);if(e&&"object"==typeof e)try{return Pl(JSON.stringify(e))}catch{return""}return""}(e)).filter(e=>e.length>0):[]}function Ol(e=[],t=[]){if(e.length!==t.length)return!1;for(let a=0;a<e.length;a+=1)if(e[a]!==t[a])return!1;return!0}function El(e){if(!e||"object"!=typeof e)return null;const t=e.metadata??{};return{id:e.id,name:e.name??e.id,map:e.map??t.map??"Unknown",players:t.playerCount??e.playerCount??e.players??0,maxPlayers:e.maxPlayers??t.maxPlayers??0,region:e.region??t.region??"--",mode:e.mode??t.mode??"",enemyCount:t.enemyCount??null,alliesCount:t.alliesCount??null,updatedAt:e.updatedAt??null,signal:{hostOffer:e.signal?.hostOffer??null,hostCandidates:Array.isArray(e.signal?.hostCandidates)?e.signal.hostCandidates.slice():[],joinAnswer:e.signal?.joinAnswer??null,joinCandidates:Array.isArray(e.signal?.joinCandidates)?e.signal.joinCandidates.slice():[]}}}function Wl(e){const t=El(e);if(!t)return;const a=tn(),n=a.servers.findIndex(e=>e.id===t.id);n>=0?a.servers[n]=t:a.servers.push(t)}function Ll(){Ml=[],Sl=[],vl=0,kl=0,Cl&&(clearTimeout(Cl),Cl=null),Tl&&(clearTimeout(Tl),Tl=null),Il=null}function $l(){const e=tn();e.hosting&&e.hostingSessionId&&(vl=Date.now(),Ul().catch(e=>console.warn("[serverBrowser] heartbeat update failed",e)))}function Nl(e){const t=tn();t.joinedSessionId&&Array.isArray(e)&&0!==e.length&&(kl=Date.now(),async function(e,t={}){const a=Al();if(a&&e&&t&&0!==Object.keys(t).length)try{const n=await fetch(`${a}/sessions/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.json();o?.session&&(Wl(o.session),Array.isArray(o.session.signal?.hostCandidates)&&o.session.signal.hostCandidates.length>0&&ec(o.session.signal.hostCandidates))}catch(t){console.warn(`[serverBrowser] joiner update failed for ${e}`,t)}}(t.joinedSessionId,{signalCandidates:e}).catch(e=>{console.warn("[serverBrowser] failed to publish joiner candidates",e)}))}function jl(e){const t=tn();t.hosting||(Ml=[]),t.joinedSessionId||(Sl=[]),Array.isArray(e)&&0!==e.length?(t.hosting&&t.hostingSessionId&&!Ol(Ml,e)&&(Ml=e.slice(),function(){const e=tn();if(!e.hosting||!e.hostingSessionId)return;const t=Date.now(),a=Math.max(0,1e3-(t-vl));a>0?Cl||(Cl=setTimeout(()=>{Cl=null,$l()},a)):$l()}()),t.joinedSessionId&&!Ol(Sl,e)&&(Sl=e.slice(),function(e){if(!tn().joinedSessionId||!Array.isArray(e)||0===e.length)return;const t=Date.now(),a=Math.max(0,1e3-(t-kl));if(a>0)return Il=e.slice(),void(Tl||(Tl=setTimeout(()=>{const e=Il;Tl=null,Il=null,Nl(e)},a)));Nl(e)}(e.slice()))):t.hosting||t.joinedSessionId||(Ll(),cn(null))}function Fl(){const e=tn();let t;try{t=Ya()}catch{return(e.p2p?.localCandidates??[]).length>0&&(pn([]),jl([])),[]}if(!t?.getLocalCandidates)return(e.p2p?.localCandidates??[]).length>0&&(pn([]),jl([])),[];const a=Array.isArray(e.p2p?.localCandidates)?e.p2p.localCandidates.slice():[],n=Bl(t.getLocalCandidates()??[]);return Ol(a,n)||(pn(n),jl(n)),n}async function Hl({silent:e=!1}={}){try{bn({candidates:!0});const t=Fl();if(0===t.length)return e||rn("No ICE candidates yet. Wait a moment after generating offer/answer."),{copied:!1,count:0};const a=t.join("\n"),n=await Dl(a);return e||rn(n?`Copied ${t.length} ICE candidate${1===t.length?"":"s"}.`:"Candidates ready. Copy manually if clipboard access is blocked."),{copied:n,count:t.length,payload:a}}catch(e){throw xn(e?.message??"Failed to copy ICE candidates"),e}finally{bn({candidates:!1})}}async function Yl(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=tn(),t=(e.p2p.remoteCandidates??[]).join("\n"),a=window.prompt("Paste remote ICE candidates (JSON array or newline separated)",t);if(null==a)return rn("Candidate entry cancelled."),null;const n=function(e){const t=Pl(e);if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e))return Bl(e);if(e&&"object"==typeof e)return Bl([e]);if("string"==typeof e)return Bl([e])}catch{}return Bl(t.split(/\r?\n+/).map(e=>e.trim()).filter(e=>e.length>0))}(a);if(0===n.length)throw rn("No valid ICE candidates detected."),new Error("No ICE candidates provided");const o=Xl();xn(null),bn({candidates:!0});try{for(const e of n)await o.addRemoteCandidate(e);const t=function(e,t){const a=[...e,...t],n=new Set,o=[];for(const e of a)n.has(e)||(n.add(e),o.push(e));return o}(e.p2p.remoteCandidates??[],n);return yn(t),rn(`Applied ${n.length} ICE candidate${1===n.length?"":"s"}.`),n}catch(e){throw xn(e?.message??"Failed to apply ICE candidates"),e}finally{bn({candidates:!1})}}function Xl(){try{return Ya()}catch(e){throw xn(e?.message??"P2P subsystem unavailable"),e}}function zl(e,t){const a=e?.playerCount??t;return{playerCount:a,enemyCount:e?.enemyCount??0,alliesCount:e?.alliesCount??Math.max(0,a-1)}}async function ql({silent:e=!1}={}){const t=Al();if(!t)return on("Server list URL not configured"),void nn([]);fn(!0),e||rn("Fetching server list...");try{const a=await fetch(`${t}/sessions`,{headers:{Accept:"application/json"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);const n=await a.json(),o=(Array.isArray(n)?n:Array.isArray(n?.servers)?n.servers:[]).map(e=>El(e)).filter(Boolean),i=Math.max(3e4,Math.round(165e3)),r=Date.now(),s=o.filter(e=>{if(!e.updatedAt)return!0;const t=Date.parse(e.updatedAt);return!!Number.isNaN(t)||r-t<=i});nn(s),on(null),e||rn(0===s.length?"No active sessions.":"Fetched session list.")}catch(t){nn([]),on(`Failed to fetch servers: ${t.message}`),e||rn("Unable to reach session service.")}finally{fn(!1)}}async function Kl({id:e=Rl(),name:t="ProjectStickFightingGame Lobby",region:a="na-west",map:n="Neo District",playerCount:o=1,maxPlayers:i=4,mode:r="freeplay",signal:s=null}={}){const l=Al(),c="sk-stickman-host-123456789987654321";if(!l)throw new Error("Server API base not configured");const d=tn(),f=d.hostingMetrics??{},h=f.playerCount??o,u=s??{hostOffer:d.p2p.offer??null,hostCandidates:d.p2p.localCandidates??[]},m=await fetch(`${l}/sessions`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":c},body:JSON.stringify({id:e,name:t,region:a,map:n,mode:r,playerCount:h,maxPlayers:i,ttlSeconds:150,metadata:zl(f,h),signal:{hostOffer:u.hostOffer??null,hostCandidates:Array.isArray(u.hostCandidates)?u.hostCandidates:[]}})});if(!m.ok)throw new Error(`Failed to host session (HTTP ${m.status})`);const g=await m.json();return pn(Array.isArray(u.hostCandidates)?u.hostCandidates:[]),hn({id:e,expiresAt:Date.now()+1e3*(g?.ttlSeconds??150)}),rn(`Hosting ${t}`),{id:e,ttlSeconds:g?.ttlSeconds??150}}async function Ul(){const e=Al(),t="sk-stickman-host-123456789987654321",a=tn();if(!(a.hosting&&a.hostingSessionId&&e&&t))return;const n=a.hostingMetrics??{},o=n.playerCount??1;try{const r=await fetch(`${e}/sessions/${a.hostingSessionId}/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":t},body:JSON.stringify({playerCount:o,ttlSeconds:150,metadata:zl(n,o),signal:{hostOffer:a.p2p.offer??null,hostCandidates:Array.isArray(a.p2p.localCandidates)?a.p2p.localCandidates:[]}})});if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();i=performance.now(),en.hostingLastHeartbeat=i,s?.ttlSeconds&&hn({id:a.hostingSessionId,expiresAt:Date.now()+1e3*s.ttlSeconds})}catch(e){console.warn("Heartbeat failed",e),rn("Heartbeat failed; hosting paused."),un(),Ll()}var i}async function Gl(){const e=Al(),t="sk-stickman-host-123456789987654321",a=tn();if(!(a.hosting&&a.hostingSessionId&&e&&t))return un(),void Ll();try{await fetch(`${e}/sessions/${a.hostingSessionId}`,{method:"DELETE",headers:{"x-session-secret":t}})}catch(e){console.warn("Failed to stop hosting",e)}finally{un(),Ll()}}async function Jl(e,t={}){const a=Al();if(!a)throw new Error("Server API base not configured");sn("Contacting host..."),ln(null);const n=`${a}/sessions/${e}/join`,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const e=`Join failed (HTTP ${o.status})`;throw sn(null),ln(e),new Error(e)}const i=await o.json(),r=i?.session?.name??e;return wn(),Ll(),Wl(i?.session),sn(`Joined ${r}`),rn("Joined lobby. Establishing connection..."),i}async function Vl({forceRegenerate:e=!1}={}){const t=tn();if(!e&&t.p2p.offer)return Fl(),t.p2p.offer;const a=Xl();xn(null),bn({offer:!0});try{const e=await a.createOffer();return function(e){en.p2p.offer=e??null}(e),Fl(),e}catch(e){throw xn(e?.message??"Failed to create offer"),e}finally{bn({offer:!1})}}async function _l({forceRegenerate:e=!1,silent:t=!1}={}){const a=await Vl({forceRegenerate:e}),n=await Dl(a);return t||rn(n?"Offer copied. Share it with your party.":"Offer ready. Copy it manually if clipboard access is blocked."),{offer:a,copied:n}}async function Ql(e,{autoCopyAnswer:t=!0}={}){const a=Pl(e);if(!a)throw new Error("Offer empty");let n;try{n=JSON.stringify(JSON.parse(a))}catch(e){throw xn("Offer must be valid JSON"),e}const o=Xl();xn(null),bn({answer:!0});try{const e=await o.createAnswer(n);return gn(e),Fl(),rn(t?await Dl(e)?"Answer copied. Send it back to the host.":"Answer ready. Copy it manually for the host.":"Answer ready. Share it with the host."),e}catch(e){throw xn(e?.message??"Failed to build answer"),e}finally{bn({answer:!1})}}async function Zl(e){const t=Pl(e);if(!t)throw new Error("Answer empty");let a;try{a=JSON.stringify(JSON.parse(t))}catch(e){throw xn("Answer must be valid JSON"),e}const n=Xl();xn(null);try{await n.acceptRemoteDescription(a),gn(a),rn("Answer applied. Waiting for connection...")}catch(e){throw xn(e?.message??"Failed to accept answer"),e}}function ec(e){if(!Array.isArray(e)||0===e.length)return;const t=Bl(e);if(0===t.length)return;let a;try{a=Xl()}catch(e){return void console.warn("P2P unavailable while applying candidates",e)}const n=tn(),o=Array.isArray(n.p2p.remoteCandidates)?n.p2p.remoteCandidates:[],i=new Set(o),r=o.slice();for(const e of t)if(!i.has(e))try{a.addRemoteCandidate(e),r.push(e),i.add(e)}catch(e){console.warn("Failed to add ICE candidate",e)}yn(r)}function tc(){const e=tn();if(e.hosting&&e.hostingSessionId){const t=e.servers.find(t=>t.id===e.hostingSessionId),a=t?.signal??null;a&&(a.joinAnswer&&e.p2p.answer!==a.joinAnswer&&Zl(a.joinAnswer).catch(e=>{console.warn("Failed to apply joiner answer",e)}),Array.isArray(a.joinCandidates)&&a.joinCandidates.length>0&&ec(a.joinCandidates),a.joinAnswer&&(e.hostingMetrics?.playerCount??1)<2&&(mn({playerCount:Math.max(2,e.hostingMetrics?.playerCount??1)}),Ul().catch(e=>console.warn("Heartbeat update failed",e))))}if(e.joinedSessionId){const t=e.servers.find(t=>t.id===e.joinedSessionId),a=t?.signal??null;a&&Array.isArray(a.hostCandidates)&&a.hostCandidates.length>0?ec(a.hostCandidates):t||cn(null)}}async function ac(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the host offer JSON","");if(null==e)return rn("Offer entry cancelled."),null;try{return await Ql(e,{autoCopyAnswer:!0})}catch(e){throw rn("Invalid offer. Please try again."),e}}async function nc(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the player's answer JSON","");if(null==e)return rn("Answer entry cancelled."),null;try{return await Zl(e),e}catch(e){throw rn("Invalid answer. Ask the player to resend it."),e}}function oc(){const e=tn();return e.hosting?(rn("Already hosting."),Promise.resolve({alreadyHosting:!0})):(wn(),Ll(),cn(null),rn("Preparing host offer..."),on(null),Vl({forceRegenerate:!0}).then(t=>Kl({signal:{hostOffer:t,hostCandidates:Fl()}}).then(t=>(rn(`Hosting ${e.hostingSessionId??t.id}`),t))).catch(e=>{throw on("string"==typeof e?.message?e.message:"Host failed"),rn(null),e}))}function ic(){return tn().hosting?(rn("Stopping session..."),on(null),Gl().then(()=>{rn("Hosting stopped."),cn(null)}).catch(e=>{throw on("string"==typeof e?.message?e.message:"Stop failed"),e})):(rn("Not hosting any session."),Promise.resolve({alreadyStopped:!0}))}function rc(e){return e?(()=>{const t=e.signal??{};return t.hostOffer?(console.debug(`[serverBrowser] using cached signal for ${e.id}`),Promise.resolve({server:e,signal:t})):(console.debug(`[serverBrowser] cached signal missing for ${e.id}, fetching detail`),rn("Syncing host signal..."),async function(e){const t=Al();if(!t)throw new Error("Server API base not configured");console.debug(`[serverBrowser] fetching session detail for ${e}`);const a=await fetch(`${t}/sessions/${e}`);if(404===a.status)return console.warn(`[serverBrowser] session ${e} no longer exists (404)`),{notFound:!0};if(!a.ok)throw console.warn(`[serverBrowser] session detail request failed ${a.status} for ${e}`),new Error(`Session lookup failed (HTTP ${a.status})`);const n=await a.json();return console.debug(`[serverBrowser] received session detail for ${e}`),n}(e.id).then(t=>{if(t?.notFound){console.warn(`[serverBrowser] session ${e.id} vanished before join`);const t=tn(),a=t.servers.findIndex(t=>t.id===e.id);throw a>=0&&t.servers.splice(a,1),cn(null),new Error("Session no longer available")}const a=t?.session,n=a?.signal??{};if(!n.hostOffer)throw new Error("Host offer unavailable. Ask the host to refresh.");const o=tn(),i={...e,signal:{hostOffer:n.hostOffer??null,hostCandidates:Array.isArray(n.hostCandidates)?n.hostCandidates.slice():[],joinAnswer:n.joinAnswer??null,joinCandidates:Array.isArray(n.joinCandidates)?n.joinCandidates.slice():[]},updatedAt:a?.updatedAt??e.updatedAt},r=o.servers.findIndex(t=>t.id===e.id);return r>=0&&(o.servers[r]=i),console.debug(`[serverBrowser] refreshed signal for ${e.id}`),{server:i,signal:i.signal}}))})().then(({server:e,signal:t})=>(wn(),Ll(),ln(null),console.debug(`[serverBrowser] applying host offer for ${e.id}`),rn(`Connecting to ${e.name??e.id}...`),on(null),Ql(t.hostOffer,{autoCopyAnswer:!1}).then(t=>{const a=Fl();return console.debug(`[serverBrowser] posting join payload for ${e.id}`),Jl(e.id,{signalAnswer:t,signalCandidates:a}).then(t=>(cn(e.id),Array.isArray(t?.session?.signal?.hostCandidates)&&ec(t.session.signal.hostCandidates),rn(`Joined ${t?.session?.name??e.name??e.id}`),t))}))).catch(t=>{const a="string"==typeof t?.message?t.message:"Join failed";throw console.warn(`[serverBrowser] join failed for ${e.id}: ${a}`),ln(a),rn(null),t}):(ln("No server selected."),Promise.reject(new Error("No server selected")))}function sc(){const e=fe(),t=Math.max(40,e-40);Ye.x=Math.max(40,Math.min(t,Ye.x))}function lc(e,t,a){const n=Math.max(1,a??fe());return Math.max(t,Math.min(n-t,e))}function cc(e){!function(e){In+=e}(e),Ar(e),function(e){const t=te;for(let a=t.pickups.length-1;a>=0;a-=1){const n=t.pickups[a];if(!n){t.pickups.splice(a,1);continue}if(n.ttl-=e,n.ttl<=0){t.pickups.splice(a,1);continue}n.vy=(n.vy??-80)+520*e,n.x+=(n.vx??0)*e,n.y+=n.vy*e,n.y>=b-12&&(n.y=b-12,n.vx=.65*(n.vx??0),n.vy*=-.35);const o=n.x-Ye.x,i=n.y-(Ye.y+Ye.currentPose?.headRadius??16);Math.hypot(o,i)<38&&(ie(n.amount??5),Qn({x:n.x,y:n.y,startRadius:12,endRadius:46,color:"#a9ffd1",ttl:.28}),t.pickups.splice(a,1))}}(e),Co(e),xl(e),function(e){ke.sandboxToggleBuffered&&(ke.sandboxToggleBuffered=!1,Vo.active?ti("aborted"):Vo.active||(Vo.previousInventory=nt(),Vo.previousEquippedId=Ye.equippedWeaponId,Vo.previousMaterials=ne(),Vo.active=!0,Vo.inRest=!0,Vo.restTimer=.5,Vo.wave=0,Vo.kills=0,Vo.runTime=0,Vo.waveStartTime=null,Vo.lastWaveDuration=0,Vo.lastOutcome="ready",Vo.enemiesAlive=0,Zo(),Qo(!0),Qe(),_o(),To())),Vo.enemiesAlive=function(){let e=0;for(let t=Ve.length-1;t>=0;t-=1){const a=Ve[t];a.spawnContext===Jo&&(a.health<=0&&!1===a.autoRespawn?Ve.splice(t,1):a.health>0&&(e+=1))}return e}(),Vo.active&&(Vo.runTime+=e,Qo(),Vo.inRest||0!==Vo.enemiesAlive||(null!=Vo.waveStartTime&&(Vo.lastWaveDuration=Math.max(0,Vo.runTime-Vo.waveStartTime)),Vo.waveStartTime=null,Vo.inRest=!0,Vo.restTimer=4,Vo.lastOutcome="rest"),Vo.inRest&&(Vo.restTimer=Math.max(0,Vo.restTimer-e),Vo.restTimer<=0&&function(){const e=Object.keys(Re);!Vo.arsenalGranted&&e.length>0&&Zo();const t=Vo.wave+1,a=Math.max(0,2),n=Math.min(3+Math.floor(1*(t-1)),16),o=a>0?Math.floor(Math.random()*(2*a+1)-a):0,i=Math.max(1,Math.min(16,n+o)),r=new Set(Ve.filter(e=>e.spawnContext===Jo).map(e=>e.id));bo(i,{context:Jo,autoRespawn:!1});for(const e of Ve)e.spawnContext!==Jo||r.has(e.id)||ei(e,t);Vo.wave=t,Vo.bestWave=Math.max(Vo.bestWave,Vo.wave),Vo.inRest=!1,Vo.waveStartTime=Vo.runTime,Vo.lastOutcome="wave"}()))}(e),function(e){!function(e){Ro.stageTimer=Math.max(0,Ro.stageTimer-e)}(e),function(e){Ro.spawn.cooldown=Math.max(0,Ro.spawn.cooldown-e)}(e),Go();const t=Po();if(t.active||"inactive"!==t.stage)if("briefing"!==t.stage){if("active"===t.stage){if("survive"===t.objective.type){!function(e){Ro.objective.remaining=Math.max(0,Ro.objective.remaining-e)}(e);const a=t.objective.duration??0;if(Lo(Math.max(0,a-t.objective.remaining)),t.objective.remaining<=0)return void Uo()}return"eliminate"===t.objective.type&&t.objective.target>0&&t.objective.progress>=t.objective.target?void Uo():(function(){if("active"===Po().stage)for(let e=Ve.length-1;e>=0;e-=1){const t=Ve[e];t.spawnContext===Fo&&t.health<=0&&!1===t.autoRespawn&&Ve.splice(e,1)}}(),Yo(),Ye.health<=0?void function(e=""){const t=Po();if("active"!==t.stage)return;const a=Do(),n=jo();Ho(),Wo(`${t.failureMessage||"Mission failed."}${e?` � ${e}`:""} (Press Q to retry)`),Eo("failure",a?.failureHoldDuration??n.failureHoldDuration??4),No("failure"),Ze()}("Operative down"):void 0)}"success"!==t.stage?"failure"!==t.stage||t.stageTimer:t.stageTimer<=0&&qo()}else t.stageTimer<=0&&Xo()}(e),Ye.invulnerability=Math.max(0,Ye.invulnerability-e),Ye.structureShieldTimer=Math.max(0,(Ye.structureShieldTimer??0)-e),Ye.structureShieldTimer<=0&&(Ye.structureShieldStrength=0),Ye.throwCooldown=Math.max(0,Ye.throwCooldown-e),Ye.gadgetCooldown=Math.max(0,(Ye.gadgetCooldown??0)-e),Ye.stunTimer=Math.max(0,(Ye.stunTimer??0)-e),Ye.flashBlindTimer=Math.max(0,(Ye.flashBlindTimer??0)-e),Ye.smokeSlowTimer=Math.max(0,(Ye.smokeSlowTimer??0)-e),Ye.smokeSlowTimer<=0&&(Ye.smokeSlowStrength=1),function(e=0){At.messageTimer>0&&(At.messageTimer=Math.max(0,At.messageTimer-e),0===At.messageTimer&&(At.message=null))}(e),function(e=0){Ut.messageTimer>0&&(Ut.messageTimer=Math.max(0,Ut.messageTimer-e),0===Ut.messageTimer&&(Ut.message=null))}(e),function(e=0){ua.messageTimer>0&&(ua.messageTimer=Math.max(0,ua.messageTimer-e),0===ua.messageTimer&&(ua.message=null))}(e);const t=At.visible,a=Ut.visible,n=ua.visible,o=t||a||n,i=function(){const e=ma.pendingApplication;return ma.pendingApplication=null,e}();i&&function(e){const t=e?.scenario;if(!t)return;ge(t.environmentId);const a=fe(),n=Le(Oe.standing),o=lc(a*(t.playerSpawnRatio??.5),40,a);Ye.x=o,Ye.y=b-n,Ye.vx=0,Ye.vy=0,Ye.onGround=!0,Ye.controlMode="onFoot",Ye.vehicleId=null,Ye.vehicleCandidateId=null,Ye.rollTimer=0,Ye.crouching=!1,Ye.attacking=!1,Ye.attackIndex=-1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.hitboxSpawned=!1,Ye.activeHitboxes.length=0,Ye.throwCooldown=0,Ye.gadgetCooldown=0,Ye.reloading=!1,Ye.flashBlindTimer=0,Ye.smokeSlowTimer=0,Ye.smokeSlowStrength=1,Ye.health=Ye.maxHealth,Ye.invulnerability=0;const i=lc(a*(t.dummySpawnRatio??.8),80,a);Ge.x=i,Ge.y=b-Ge.height,Ge.health=Ge.maxHealth,Ge.flashTimer=0,Ge.shakeTimer=0,Ge.shakeMagnitude=0,Ge.respawnTimer=0,ze.forEach((e,t)=>{const n=90*t-140;e.x=lc(o+n,60,a),e.y=b-Le(Oe.standing),e.vx=0,e.vy=0,e.onGround=!0,e.state="follow",e.targetEnemyId=null,e.fireCooldown=0}),Ve.length=0;const r=[lc(a*(t.enemySpawnRatios?.[0]??.25),40,a),lc(a*(t.enemySpawnRatios?.[1]??.75),40,a)];oe(Math.max(0,t.startingMaterials??0)),function({scenarioId:e,spawnOverride:t}){ma.appliedScenarioId=e??null,ma.spawnOverride=t??null}({scenarioId:t.id,spawnOverride:{context:"scenario",points:r}});const s=Math.max(0,Math.round(t.enemyCount??0));s>0&&bo(s,{context:"scenario",autoRespawn:!1})}(i);const r=!o&&ke.interactBuffered;ke.interactBuffered=!1;const s=!o&&ke.squadCommandCycleBuffered,l=o?null:ke.squadCommandSelect,c=!o&&ke.serverBrowserToggleBuffered,d=o?0:ke.serverBrowserNavigate,f=!o&&ke.serverBrowserJoinBuffered,h=!o&&ke.serverBrowserHostBuffered,u=!o&&ke.serverBrowserStopHostBuffered,m=!o&&ke.serverBrowserCopyOfferBuffered,g=!o&&ke.serverBrowserPasteOfferBuffered,p=!o&&ke.serverBrowserAcceptAnswerBuffered,y=!o&&ke.serverBrowserCopyCandidatesBuffered,x=!o&&ke.serverBrowserPasteCandidatesBuffered;ke.squadCommandCycleBuffered=!1,ke.squadCommandSelect=null,ke.serverBrowserToggleBuffered=!1,ke.serverBrowserNavigate=0,ke.serverBrowserJoinBuffered=!1,ke.serverBrowserHostBuffered=!1,ke.serverBrowserStopHostBuffered=!1,ke.serverBrowserCopyOfferBuffered=!1,ke.serverBrowserPasteOfferBuffered=!1,ke.serverBrowserAcceptAnswerBuffered=!1,ke.serverBrowserCopyCandidatesBuffered=!1,ke.serverBrowserPasteCandidatesBuffered=!1;const w=!o&&Ye.health>0&&ke.attackBuffered,v=!o&&Ye.health>0&&ke.throwBuffered,k=!o&&Ye.health>0&&ke.reloadBuffered;ke.attackBuffered=!1,ke.throwBuffered=!1,ke.reloadBuffered=!1;const M=!o&&ke.roll;if(ke.roll=!1,function(e){if(Ye.vehicleId){Ye.vehicleCandidateId=null;const t=Es();return void(e&&t&&t.enterCooldown<=.01&&$s(t,{preferDirection:t.facing}))}if(Ye.health<=0)return void(Ye.vehicleCandidateId=null);let t=null,a=Number.POSITIVE_INFINITY;const n=Le(Oe.standing),o=Ye.y+n;for(const e of Cn){const n=kn[e.type];if(!n)continue;if(e.driverId)continue;if(e.enterCooldown>0)continue;const i=Math.abs(Ye.x-e.x);if(i>(n.enterRadius??64))continue;const r=e.y+n.height,s=Math.abs(o-r),l=n.movementType??"ground";let c;if(c="air"===l?Math.max(120,(n.hoverMinAltitude??0)+80):"water"===l?Math.max(90,(n.waterSurfaceOffset??24)+70):80,s>c)continue;const d=i+.5*s;d<a&&(a=d,t=e)}Ye.vehicleCandidateId=t?.id??null,e&&t&&function(e){const t=kn[e.type];t&&(e.driverId=Os,e.enterCooldown=.45,Ye.vehicleId=e.id,Ye.controlMode="vehicle",Ye.vehicleCandidateId=null,Ye.attacking=!1,Ye.currentAttack=null,Ye.attackIndex=-1,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.nextAttackQueued=!1,Ye.hitboxSpawned=!1,Ye.activeHitboxes.length=0,Ye.crouching=!1,Ye.rolling=!1,Ls(e,t))}(t)}(r),s&&function(){if(Ye.squadCommandCooldown>0)return As();Ye.squadCommandIndex=(Ye.squadCommandIndex+1)%Ee.length;const e=As();Ye.squadCommandId=e?.id??Ye.squadCommandId,Ye.squadCommandCooldown=1.4}(),l&&function(e){const t=Ee.findIndex(t=>t.id===e);t>=0&&(Ye.squadCommandIndex=t,Ye.squadCommandId=e,Ye.squadCommandCooldown=1.4)}(l),c&&(tn().visible?an(!1):(an(!0),dn(0),ql())),0!==d&&tn().visible&&function(e){0!==en.servers.length&&(en.selectedIndex=(en.selectedIndex+e+en.servers.length)%en.servers.length)}(d),f){const e=tn(),t=e.visible?e.servers[e.selectedIndex]:null;t&&rc(t).catch(e=>console.warn("Join failed",e))}if(h&&tn().visible&&oc().catch(e=>console.warn("Host failed",e)),u&&tn().visible&&ic().catch(e=>console.warn("Stop hosting failed",e)),m){const e=tn();e.visible&&e.hosting&&_l({forceRegenerate:!1,silent:!1}).catch(e=>console.warn("Offer copy failed",e))}if(g&&tn().visible&&ac().catch(e=>console.warn("Offer accept failed",e)),p){const e=tn();e.visible&&e.hosting&&nc().catch(e=>console.warn("Answer apply failed",e))}if(y){const e=tn();e.visible&&e.hosting&&Hl({silent:!1}).catch(e=>console.warn("Candidate copy failed",e))}x&&tn().visible&&Yl().catch(e=>console.warn("Candidate apply failed",e));let S=Es(),C=Boolean(S);Ye.health<=0&&C&&(function(e={}){const t=Es();if(!t)return Ye.vehicleId=null,void(Ye.controlMode="onFoot");$s(t,{skipCooldown:!0,inheritVelocity:!1,...e})}({preferDirection:S?.facing}),S=null,C=!1),M&&Ye.health>0&&!C&&function(e){if(Ye.vehicleId)return;if(!Ye.onGround||Ye.rolling||Ye.attacking||Ye.health<=0||(Ye.stunTimer??0)>0)return;const{left:t,right:a}=e;t&&!a?Ye.facing=-1:a&&!t&&(Ye.facing=1),Ye.rolling=!0,Ye.rollTimer=.32,Ye.crouching=!1,Ye.vy=0}({left:ke.left,right:ke.right}),C||"vehicle"!==Ye.controlMode||(Ye.controlMode="onFoot");const T=!o&&!C&&Ye.stunTimer<=0&&!Ye.reloading,I=!!T&&w,A=!!T&&v,R=!!T&&k;Ye.health>0?C?function(){const e=Es();if(!e)return Ye.vehicleId=null,void(Ye.controlMode="onFoot");Ye.controlMode="vehicle",Ye.crouching=!1,Ye.rolling=!1,Ye.onGround=e.onGround||null!=e.waterLineY}():function(e){if(Ye.vehicleId)return;if(Ye.crouching=ke.down&&Ye.onGround&&!Ye.rolling&&!Ye.attacking,Ye.rolling)Ye.vx=420*Ye.facing,Ye.vy=0,Ye.rollTimer-=e,Ye.rollTimer<=0&&(Ye.rolling=!1);else{let t=De;if(Ye.crouching&&(t*=.55),Ye.attacking&&(t*=.7),Ye.reloading&&(t*=.8),Ye.smokeSlowTimer>0){const e=Ye.smokeSlowStrength??.6;t*=Math.max(.1,Math.min(1,e))}Ye.stunTimer>0&&(t*=.25),Ye.vx=0,ke.left&&(Ye.vx-=t,Ye.facing=-1),ke.right&&(Ye.vx+=t,Ye.facing=1);const a=Ye.stunTimer<=0;Ye.onGround&&a&&ke.jump&&!Ye.crouching&&!Ye.attacking&&(Ye.vy=-460,Ye.onGround=!1),Ye.vy+=Be*e}const t=Ye.y;Ye.x+=Ye.vx*e,Ye.y+=Ye.vy*e,Ye.onGround=!1;const a=Le(Oe.standing);fs(Ye,t,a)||Ye.y+a>=b&&(Ye.y=b-a,Ye.vy=0,Ye.onGround=!0),sc()}(e):function(e){const t=Le(Oe.standing);if(Ye.vehicleId=null,Ye.controlMode="onFoot",Ye.vehicleCandidateId=null,Ye.deadTimer=Math.max(0,Ye.deadTimer-e),Ye.vx*=.9,Ye.vy+=Be*e,Ye.x+=Ye.vx*e,Ye.y+=Ye.vy*e,Ye.y+t>=b&&(Ye.y=b-t,Ye.vy=0,Ye.onGround=!0),sc(),0===Ye.deadTimer){Ye.health=Ye.maxHealth,Ye.invulnerability=1.2,Ye.throwCooldown=0,Ye.gadgetCooldown=0,Ye.reloading=!1,Ye.stunTimer=0,Ye.flashBlindTimer=0,Ye.smokeSlowTimer=0,Ye.smokeSlowStrength=1,lo.length=0,yo("cleared"),uo();const e=fe();Ye.x=.5*e,Ye.y=b-t,Ye.vx=0,Ye.vy=0,Ye.onGround=!0}}(e),Ye.currentPose=Ye.rolling?Oe.rolling:Ye.crouching?Oe.crouching:Oe.standing;const P=Le(Ye.currentPose);mn({playerCount:1+Ue().length,enemyCount:Ve.reduce((e,t)=>e+(t.health>0?1:0),0),alliesCount:ze.reduce((e,t)=>e+(t&&"defeated"!==t.state?1:0),0)});const D="undefined"!=typeof performance?performance.now():Date.now();!function(e){for(const t of Cn){const a=kn[t.type];if(!a)continue;t.enterCooldown=Math.max(0,t.enterCooldown-e),t.damageFlash=Math.max(0,t.damageFlash-e);const n=t.driverId===Os,o=a.movementType??"ground";"air"===o?Fs(t,a,e,n):"water"===o?js(t,a,e,n):Ns(t,a,e,n),Ys(t,a,e,n),n?Ls(t,a):"ground"===o&&(t.tilt+=(0-t.tilt)*Math.min(1,10*e))}}(e),tr(e),function(e){for(const t of si)t.flashTimer=Math.max(0,(t.flashTimer??0)-e),t.shakeTimer=Math.max(0,(t.shakeTimer??0)-e),t.smokeTimer=Math.max(0,(t.smokeTimer??0)-e),t.shakeMagnitude*=t.shakeTimer>0?.92:.6,t.destroyed?t.rubbleLevel=Math.min(1,(t.rubbleLevel??0)+2.2*e):t.rubbleLevel=Math.max(0,(t.rubbleLevel??0)-.8*e)}(e),function(e){if(!(e<=0))for(const t of Or)il(t,e)}(e),function(e,t){const a=tn();tc(),Fl();const n=Math.min(15e3,3e3),o=a.visible?15e3:n;if((a.visible||a.hosting||Boolean(a.joinedSessionId))&&t-a.lastFetch>=o&&!a.fetching&&(dn(t),ql({silent:!a.visible})),a.visible){if(a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&Ul()}tc()}else if(a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&Ul()}}(0,D),function(){if(function(e=6e3){const t="undefined"!=typeof performance?performance.now():Date.now();for(const[a,n]of qe.entries())t-(n.lastUpdate??t)>e&&qe.delete(a)}(),_a(),!qa||"open"!==qa.readyState)return;const e="undefined"!=typeof performance?performance.now():Date.now();if(e-Ua<60)return;Ua=e;const t={type:"playerState",id:Xa,name:"Remote",x:Ye.x,y:Ye.y,facing:Ye.facing,commandId:Ye.squadCommandId};try{qa.send(JSON.stringify(t))}catch{}}(),function(e){Ye.squadCommandCooldown=Math.max(0,Ye.squadCommandCooldown-e);let t=0;for(const a of ze)a.roleIndex=t,t+=1,Bs(a,e)}(e);for(const t of ze)t&&(t.structureShieldTimer=Math.max(0,(t.structureShieldTimer??0)-e),t.structureShieldTimer<=0&&(t.structureShieldStrength=0));S=Es(),C=Boolean(S),C&&(Ye.controlMode="vehicle"),cr(e),T||(Ye.attacking=!1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.nextAttackQueued=!1,Ye.hitboxSpawned=!1,Ye.attackIndex=-1,Ye.activeHitboxes.length=0),Ye.fireCooldown=Math.max(0,(Ye.fireCooldown??0)-e);const B=gt(),O=B?.category??"",E=(B?.attackChain??[]).length>0,W=O.startsWith("ranged"),L="throwable"===O;if("gadget"===O)(I||A)&&xo(B),Ye.activeHitboxes.length=0;else if(L)(I||A)&&function(){const e=gt();if((Ye.stunTimer??0)>0)return!1;if(!e||"throwable"!==e.category)return!1;if(Ye.throwCooldown>0||Ye.health<=0||Ye.rolling)return!1;const t=e.throwable??{},a=Ye.aim??null,n=Number.isFinite(a?.vectorX)?a.vectorX:Ye.facing||1,o=Number.isFinite(a?.vectorY)?a.vectorY:0,i=Math.hypot(n,o)||1,r=n/i,s=o/i,l=-s,c=r,d=Number.isFinite(a?.anchorX)?a.anchorX:Ye.x,f=Number.isFinite(a?.anchorY)?a.anchorY:Ye.y+24,h=t.spawnOffset??{x:22,y:12},u=h.x??22,m=h.y??12,g=h.side??0,p=Tn(d+r*u+l*g,40,fe()-40),y=f+s*u+c*g+m,x=t.arcVelocity??{vx:260,vy:-420},b=x.vx??260,w=x.vy??-420,v=r*b+l*(x.side??0),k=s*b+c*(x.side??0)+w;Ye.throwCooldown=t.cooldownSeconds??.9;const M={id:`grenade-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:p,y,vx:v,vy:k,radius:t.radius??16,fuse:t.fuseSeconds??1.5,maxFuse:t.fuseSeconds??1.5,explosionRadius:t.explosionRadius??120,damage:t.damage??45,knockback:t.knockback??260,gravityFactor:t.gravityFactor??.5,bounciness:Tn(t.bounciness??.45,0,.95),color:t.color??"#ffb347",explosionDuration:t.explosionDuration??.32,selfDamageScale:Tn(t.selfDamageScale??.65,0,1),selfKnockbackScale:Tn(t.selfKnockbackScale??.6,0,1),effectType:t.effectType??"explosive",stunDuration:t.stunDuration??0,playerStunDuration:t.playerStunDuration??0,smokeDuration:t.smokeDuration??0,smokeRadius:t.smokeRadius??t.explosionRadius??120,smokeExpansion:t.smokeExpansion??1.1,smokeSlowMultiplier:Tn(t.smokeSlowMultiplier??.55,.1,1),smokeTickDuration:t.smokeTickDuration??.5,detonated:!1,explosionTimer:0};Fi.push(M),Yi("throwable:thrown",{id:M.id,effectType:M.effectType,x:M.x,y:M.y,radius:M.explosionRadius,fuse:M.fuse})}(),Ye.activeHitboxes.length=0;else if(W&&!E){if(Ye.activeHitboxes.length=0,B){const e=lt(B.id),t=Math.max(B.fireInterval??.26,.05),a=!0===B.auto&&ke.attackDown&&T;R&&ct(B.id)&&(Ye.attacking=!1,Ye.currentAttack=null,Ye.attackIndex=-1),(I||a)&&Ye.fireCooldown<=0&&ll()&&(Ye.fireCooldown=t),e&&e.magazine<=0&&e.reserve>0&&!e.reloading&&ct(B.id)}}else if(E)I&&function(){if(Ye.vehicleId)return;if(Ye.rolling||Ye.health<=0||(Ye.stunTimer??0)>0||Ye.reloading)return;const e=gt(),t=e?.attackChain??[];0!==t.length&&(Ye.attacking?Ye.comboWindowOpen&&Ye.attackIndex+1<t.length&&(Ye.nextAttackQueued=!0):al(0))}(),Ye.attacking&&function(e,t){if(Ye.vehicleId)return Ye.attacking=!1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.hitboxSpawned=!1,void(Ye.attackIndex=-1);const a=Ye.currentAttack;if(!a)return;if((Ye.stunTimer??0)>0||Ye.reloading)return Ye.attacking=!1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,void(Ye.hitboxSpawned=!1);Ye.attackElapsed+=e,!Ye.hitboxSpawned&&Ye.attackElapsed>=a.windup&&(t(a),Ye.hitboxSpawned=!0),!Ye.comboWindowOpen&&Ye.attackElapsed>=a.comboStart&&(Ye.comboWindowOpen=!0,Ye.comboWindowTimer=a.comboWindow),Ye.comboWindowOpen&&(Ye.comboWindowTimer-=e,Ye.comboWindowTimer<=0&&(Ye.comboWindowOpen=!1));const n=gt(),o=n?.attackChain??[];if(Ye.attackElapsed>=a.windup+a.active+a.recovery){const e=Ye.attackIndex+1,t=Ye.nextAttackQueued&&e<o.length;Ye.attacking=!1,Ye.currentAttack=null,Ye.attackElapsed=0,Ye.comboWindowOpen=!1,Ye.comboWindowTimer=0,Ye.hitboxSpawned=!1,Ye.nextAttackQueued=!1,t?al(e):Ye.attackIndex=-1}}(e,sl),function(e,t){Ye.activeHitboxes=Ye.activeHitboxes.filter(a=>(a.remaining-=e,a.ownerFacing=Ye.facing,a.x=Ye.x+Ye.facing*a.offsetX,a.y=Ye.y+t+a.heightOffset,a.remaining>0))}(e,P),function(){for(const e of Ye.activeHitboxes){if(Ge.health>0&&!e.hitTargets.has(Ge.id)){const t=e.x-Ge.x,a=e.y-(Ge.y+.55*Ge.height);Math.hypot(t,a)<=e.radius+Ge.radius&&(e.hitTargets.add(Ge.id),ai({damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}for(const t of Ve){if(t.health<=0||e.hitTargets.has(t.id))continue;const a=e.x-t.x,n=e.y-(t.y+.5*t.height);Math.hypot(a,n)<=e.radius+t.radius&&(e.hitTargets.add(t.id),ni(t,{damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}pi(e),rl(e)}}();else if(Ye.activeHitboxes.length=0,W){const e=Math.max(B?.fireInterval??.26,.05),t=!0===B?.auto&&ke.attackDown&&T;(I||t)&&Ye.fireCooldown<=0&&ll()&&(Ye.fireCooldown=e)}var $;$=Ye.x,ye.targetX=be($),function(e){const t=be(ye.targetX),a=Math.min(1,6*e);ye.x+=(t-ye.x)*a,ye.x=be(ye.x)}(e),function(e){Ge.flashTimer>0&&(Ge.flashTimer=Math.max(0,Ge.flashTimer-e)),Ge.shakeTimer>0&&(Ge.shakeTimer=Math.max(0,Ge.shakeTimer-e)),Ge.shakeMagnitude=Math.max(0,Ge.shakeMagnitude-20*e),Ge.health<=0&&(Ge.respawnTimer=Math.max(0,Ge.respawnTimer-e),0===Ge.respawnTimer&&(Ge.health=Ge.maxHealth,Ge.flashTimer=0,Ge.shakeTimer=0,Ge.shakeMagnitude=0))}(e),function(e){const t=fe();for(const a of Fi)a.detonated?a.explosionTimer-=e:(a.fuse-=e,a.vy+=Be*a.gravityFactor*e,a.x+=a.vx*e,a.y+=a.vy*e,a.y+a.radius>=b&&(a.y=b-a.radius,a.vy>0&&(a.vy=-a.vy*a.bounciness),a.vx*=.7,Math.abs(a.vy)<36&&(a.vy=0)),(a.x-a.radius<=0||a.x+a.radius>=t)&&(a.x=Tn(a.x,a.radius,t-a.radius),a.vx=.45*-a.vx),a.fuse<=0&&Xi(a));for(let e=Fi.length-1;e>=0;e-=1)Fi[e].detonated&&Fi[e].explosionTimer<=0&&Fi.splice(e,1);!function(e){for(const t of Hi){t.life=Math.max(0,t.life-e);const a=1-t.life/t.duration;if(t.radius=Tn(t.baseRadius+(t.maxRadius-t.baseRadius)*Tn(a,0,1),t.baseRadius,t.maxRadius),t.tickTimer-=e,t.tickTimer<=0){t.tickTimer=t.tick;const e=t.radius;for(const a of Ve){if(a.health<=0)continue;const n=a.x-t.x,o=a.y+.5*a.height-t.y;Math.hypot(n,o)<=e&&(a.smokeSlowTimer=Math.max(a.smokeSlowTimer??0,t.tick+.4),a.smokeSlowStrength=Math.min(a.smokeSlowStrength??1,t.slowMultiplier))}const a=Le(Ye.currentPose??{headRadius:16,bodyLength:34,legLength:36}),n=Ye.y+.6*a,o=Ye.x-t.x,i=n-t.y;Math.hypot(o,i)<=e&&(Ye.smokeSlowTimer=Math.max(Ye.smokeSlowTimer??0,t.tick+.4),Ye.smokeSlowStrength=Math.min(Ye.smokeSlowStrength??1,t.slowMultiplier+.1))}}for(let e=Hi.length-1;e>=0;e-=1)if(Hi[e].life<=0){const t=Hi.splice(e,1)[0];Yi("throwable:smoke-dissipate",{id:t.id,x:t.x,y:t.y,radius:t.maxRadius??t.radius})}}(e)}(e),function(e){!function(e){for(const t of lo){t.duration-=e,t.fireTimer-=e;const a=co(t);a&&t.fireTimer<=0&&fo(t,a)}for(let e=lo.length-1;e>=0;e-=1)lo[e].duration<=0&&lo.splice(e,1)}(e),function(e){mo.active&&(mo.duration-=e,mo.flashTimer=Math.max(0,mo.flashTimer-e),mo.duration<=0?yo("expired"):mo.strength<=0&&(po("shield:shatter",{reason:"decayed",center:go(),maxStrength:mo.maxStrength,radius:mo.radius}),yo("shatter")))}(e)}(e),function(e){!function(e){ho.cooldown>0&&(ho.cooldown=Math.max(0,ho.cooldown-e)),function(e){if(!ho.active)return;const t=ho.travelSpeed??860,a=ho.pullSpeed??740,n=(ho.retracting?a:t)*e;if(ho.retracting){ho.duration-=e;const t=ho.targetX-Ye.x,o=ho.targetY-Ye.y,i=Math.hypot(t,o);if(i>12){const n=Math.min(i,a*e);Ye.vx=t/i*n/e,Ye.vy=o/i*n/e,Ye.x+=t/i*n,Ye.y+=o/i*n}ho.tetherLength=Math.max(0,ho.tetherLength-n),(ho.duration<=0||ho.tetherLength<=0)&&uo()}else ho.tetherLength+=n,ho.tetherLength>=ho.maxLength&&(ho.tetherLength=ho.maxLength,ho.retracting=!0)}(e)}(e)}(e),function(e,t){const a=[];for(const[t,n]of rt.entries())if(Re[t]){if(n.reloading&&(n.reloadTimer=Math.max(0,n.reloadTimer-e),n.reloadTimer<=0)){if(n.capacity!==Number.POSITIVE_INFINITY){const e=n.capacity-n.magazine;if(e>0){const t=Math.min(e,n.reserve);n.magazine+=t,n.reserve-=t}}n.reloading=!1,n.reloadTimer=0,a.push(t)}if(n.spread&&n.spreadDef){const t=n.spreadDef.base??0,a=n.spreadDef.recovery??0;n.spread.current=a>0?Math.max(t,n.spread.current-a*e):Math.max(t,n.spread.current??t)}}else rt.delete(t);if(t){const e=rt.get(t);Ye.reloading=e?.reloading??!1}else Ye.reloading=!1;if("undefined"!=typeof window)for(const e of a)window.dispatchEvent(new CustomEvent("weapon:reload-finish",{detail:{weaponId:e}}))}(e,B?.id??null),function(e){const t=ds.decay??12,a=Math.max(0,1-t*e);ds.horizontalKick*=a,ds.verticalKick*=a}(e),function(e){for(const t of Yn)t.life-=e,t.x+=t.vx*e,t.y+=t.vy*e,t.vy-=40*e;for(let e=Yn.length-1;e>=0;e-=1)Yn[e].life<=0&&Yn.splice(e,1)}(e),function(e){io();for(let t=zn.length-1;t>=0;t-=1){const a=zn[t];if(a.ttl-=e,a.ttl<=0){zn.splice(t,1);continue}const n=Tn(a.ttl/a.maxTtl,0,1);a.x+=a.vx*e,a.y+=a.vy*e,"blood"===a.type?(a.vy+=(a.gravity??980)*e,a.vx*=.82,a.vy*=.9,a.radius*=.94):"bloodMist"===a.type?(a.vx*=.9,a.vy*=.92,a.radius*=1.02):"shield"===a.type?(a.vx*=.88,a.vy*=.88,a.radius*=.96+.04*n):"smoke"===a.type?(a.vx*=.9,a.vy=.9*(a.vy??0)-24*e,a.radius*=.995+.02*n):"ember"===a.type?(a.vx*=.94,a.vy*=.94):"spark"===a.type?(a.vx*=.88,a.vy=.9*(a.vy??0)+160*e,a.radius*=.86):"debris"===a.type?(a.vy+=520*e,a.vx*=.88,a.vy*=.9,a.radius*=.95):"dust"===a.type?(a.vx*=.82,a.vy=.9*(a.vy??0)+240*e,a.radius*=.96):"flash"===a.type?(a.vx*=.8,a.vy*=.8,a.radius*=.9+.08*n):(a.vx*=.86,a.vy*=.86)}for(let t=qn.length-1;t>=0;t-=1){const a=qn[t];a.ttl-=e,a.ttl<=0&&qn.splice(t,1)}}(e),function(e){Oi();for(const e of Ci.values())e.active=!1;!function(){const e=Array.isArray(Ai)?Ai:[];for(let t=0;t<e.length;t+=1){const a=e[t]??{};Di(a.id??"env-light-"+t,a)}}(),function(){const e=Ye.facing??1,t=Ye.deadTimer<=0,a="vehicle"===Ye.controlMode,n=t?a?.65:.9:0;Di("player-flashlight",{type:"cone",x:Ye.x+34*e,y:Ye.y+28,radius:a?280:240,intensity:n,color:"#ffd591",direction:e>=0?0:Math.PI,fov:.5*Math.PI,stretch:.42,smoothing:18,flicker:.2}),ze.forEach((e,t)=>{if(!e||"defeated"===e.state)return;const a=e.facing??1;Di("squad-flashlight-"+(e.id??t),{type:"cone",x:e.x+30*a,y:e.y+26,radius:210,intensity:.6,color:"#fff0c4",direction:a>=0?0:Math.PI,fov:.45*Math.PI,stretch:.38,smoothing:20,flicker:.24})})}();const t=Mi();for(let e=0;e<t.length;e+=1){const a=t[e],n=a?.ambient;n&&Di(`structure-${a.id}`,{type:n.type??"point",x:a.x+(n.offsetX??0),y:a.y-(a.height??120)+(n.offsetY??-40),radius:n.radius??220,intensity:n.intensity??.8,color:n.color??"#8cffd4",smoothing:n.smoothing??10,flicker:n.flicker??.25,fov:n.fov,direction:n.direction,stretch:n.stretch??.5})}for(const[t,a]of Ci.entries()){if(!a.active){Ci.delete(t);continue}const n=Tn(a.smoothing??12,1,60),o=Tn(e*n,0,1);a.intensity+=(a.targetIntensity-a.intensity)*o,a.intensity=Ri(a.intensity),a.flicker>0&&(a.intensity=Ri(a.intensity+(Math.random()-.5)*a.flicker))}for(let t=Ti.length-1;t>=0;t-=1){const a=Ti[t];a.ttl-=e,a.ttl<=0&&Ti.splice(t,1)}}(e),function(e){ss(),ls(Wr,e),ls(Lr,e),ls($r,e),ls(Nr,e),ls(jr,e)}(e),function(e){for(const t of $i){if(t.life-=e,t.vy+=Be*e*t.gravityFactor,t.x+=t.vx*e,t.y+=t.vy*e,t.lightCooldown=Math.max(0,(t.lightCooldown??0)-e),t.lightCooldown<=0&&t.life>0){const e=Math.max(90,16*t.radius);Bi({type:"point",x:t.x,y:t.y,radius:e,intensity:.4+.2*Math.random(),color:t.color??"#ffcf7a",ttl:.08,flicker:.25,decay:1.3}),t.lightCooldown=.05}if(t.y+t.radius>=b)ao({x:t.x,y:b-6,amount:Math.round(5+.8*t.radius),speed:120+.3*Math.abs(t.vx)}),t.life=0;else if(Ge.health>0&&!t.hitTargets.has(Ge.id)&&ji(t.x,t.y,t.radius,Ge.x,Ge.y+.55*Ge.height,Ge.radius))t.hitTargets.add(Ge.id),ai({damage:t.damage,knockback:t.knockback,facing:t.facing}),t.life=0;else{for(const e of Ve)if(!(e.health<=0||t.hitTargets.has(e.id))&&ji(t.x,t.y,t.radius,e.x,e.y+.5*e.height,e.radius)){t.hitTargets.add(e.id),ni(e,{damage:t.damage,knockback:t.knockback,launch:0,facing:t.facing}),t.life=0;break}t.life>0&&gi(t)&&(eo({x:t.x,y:t.y,amount:Math.round(6+4*Math.random()),speed:220+.4*Math.abs(t.vx),spread:.9*Math.PI,angle:Math.atan2(t.vy,t.vx)+Math.PI}),t.life=0)}}for(let e=$i.length-1;e>=0;e-=1)$i[e].life<=0&&$i.splice(e,1)}(e),function(e,t){for(const a of Fn)a.life-=e,a.vy+=Be*e*.9,a.x+=a.vx*e,a.y+=a.vy*e,a.vx*=.96,a.y+a.radius>=t&&(a.y=t-a.radius,a.vy=.35*-a.vy,a.vx*=.7,Math.abs(a.vy)<20&&(a.vy=0));for(let e=Fn.length-1;e>=0;e-=1)Fn[e].life<=.05&&Fn.splice(e,1)}(e,b),function(e){for(const t of Ve)bl(t,e);for(const e of Ve)wl(e)}(e)}"undefined"!=typeof window&&(window.ServerBrowser={fetch:ql,host:Kl,join:Jl,stop:Gl,attemptHost:oc,attemptStop:ic,attemptJoin:rc,copyOffer:_l,regenerateOffer:()=>_l({forceRegenerate:!0,silent:!0}),promptOffer:ac,promptAnswer:nc,copyCandidates:Hl,promptCandidates:Yl,syncCandidates:Fl,state:tn}),Te||(window.addEventListener("keydown",e=>Ie(!0,e)),window.addEventListener("keyup",e=>Ie(!1,e)),window.addEventListener("mousedown",function(e){Ce(e),0===e.button?(ke.attackBuffered=!0,ke.attackDown=!0,e.preventDefault()):2===e.button&&(ke.throwBuffered=!0,ke.throwDown=!0,e.preventDefault())}),window.addEventListener("mouseup",function(e){Ce(e),0===e.button?(ke.attackDown=!1,e.preventDefault()):2===e.button&&(ke.throwDown=!1,e.preventDefault())}),window.addEventListener("mousemove",function(e){Ce(e)}),window.addEventListener("mouseleave",function(){Me.active=!1}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("blur",Ae),Se(),Te=!0),ut||(window.addEventListener("keydown",function(e){const t=(a=e.code).startsWith("Digit")?Number.parseInt(a.slice(5),10):a.startsWith("Numpad")?Number.parseInt(a.slice(6),10):Number.NaN;var a;!Number.isNaN(t)&&t>=1&&(pt(t-1),e.preventDefault())}),ut=!0),Rt||(function(){if("undefined"==typeof localStorage)return St(),!1;try{const t=localStorage.getItem(xt);if(!t)return St(),!1;const a=JSON.parse(t);if(!Array.isArray(a))return St(),!1;const n=a.map(e=>{if(!e||"object"!=typeof e)return null;const t=e.slotId??null,a="string"==typeof e.weaponId?e.weaponId:null;return t&&a?{slotId:t,weaponId:a}:null}).filter(Boolean);return e=n,kt=yt.map((t,a)=>{const n=e.find(e=>e.slotId===t.id);let o=n?.weaponId??null;const i=bt(t);return o&&i.includes(o)||(o=wt(t,a)),{slotId:t.id,weaponId:o}}),St(),St(),!0}catch(e){return console.warn("Failed to load saved loadout",e),St(),!1}var e}(),Ct({preserveEquipped:!0}),Pt(),window.addEventListener("keydown",function(e){if(e.defaultPrevented)return;const t=e.code;if(At.visible){switch(t){case"Escape":case"KeyL":case"Enter":At.visible&&(At.visible=!1,Ae(),Dt(null));break;case"ArrowUp":Bt(-1),Dt(null);break;case"ArrowDown":Bt(1),Dt(null);break;case"Tab":Bt(e.shiftKey?-1:1),Dt(null);break;case"ArrowLeft":Ot(-1);break;case"ArrowRight":Ot(1);break;case"KeyR":Et();break;default:return}e.preventDefault(),e.stopPropagation()}else"KeyL"===t&&(At.visible||(At.visible=!0,Pt(),Dt(null),Ae()),e.preventDefault(),e.stopPropagation())},!0),window.addEventListener("mousedown",Wt,!0),window.addEventListener("mouseup",Wt,!0),window.addEventListener("contextmenu",Wt,!0),Rt=!0),Gt||(function(){if("undefined"==typeof localStorage)return Xt(),!1;try{const e=localStorage.getItem(jt);if(!e)return Xt(),!1;const t=JSON.parse(e);if(!t||"object"!=typeof t)return Xt(),!1;const a={...Nt};return Lt.forEach(e=>{a[e.id]=Yt(e.id,t[e.id])}),Ft.selections=a,!0}catch(e){return console.warn("Failed to load cosmetics",e),Xt(),!1}}(),Vt(),window.addEventListener("keydown",function(e){if(e.defaultPrevented)return;const t=e.code;if(Ut.visible){switch(t){case"Escape":case"Enter":case"F7":Ut.visible&&(Ut.visible=!1,Ae(),_t(null));break;case"ArrowUp":Qt(-1);break;case"ArrowDown":Qt(1);break;case"Tab":Qt(e.shiftKey?-1:1);break;case"ArrowLeft":Zt(-1);break;case"ArrowRight":Zt(1);break;case"KeyR":!function(){Ft.selections={...Nt},zt(),Kt(),Vt();const e=Jt()[Ut.categoryIndex],t=zt(),a=e?qt(t[e.id]):null;_t(a?`${e.label} reset to ${a.name}`:"Cosmetics reset")}();break;default:return}e.preventDefault(),e.stopPropagation()}else"F7"===t&&(Ut.visible||(Ut.visible=!0,Vt(),_t(null),Ae()),e.preventDefault(),e.stopPropagation())},!0),window.addEventListener("mousedown",ea,!0),window.addEventListener("mouseup",ea,!0),window.addEventListener("contextmenu",ea,!0),Gt=!0),ga||"undefined"==typeof window||(window.addEventListener("keydown",function(e){if(e.defaultPrevented)return;const t=e.code;if(ua.visible){switch(t){case"Escape":case"F8":ya();break;case"ArrowUp":ba(-1);break;case"ArrowDown":ba(1);break;case"Tab":ba(e.shiftKey?-1:1);break;case"ArrowLeft":wa(-1);break;case"ArrowRight":wa(1);break;case"KeyE":{const e=ha[ua.fieldIndex];e?.editable&&function(e){const t=la()[ua.slotIndex];if(t)if("name"===e){const e="undefined"!=typeof window?window.prompt("Scenario name",t.name):null;e&&e.trim()&&(da(ua.slotIndex,"name",e.trim()),pa(`Renamed to ${e.trim()}`))}else if("description"===e){const e="undefined"!=typeof window?window.prompt("Mission brief",t.description??""):null;null!=e&&(da(ua.slotIndex,"description",e),pa("Updated brief"))}}(e.id);break}case"KeyR":pa(`Scenario reset: ${function(e){const t=ca(e),a=aa[t%aa.length]??aa[0];return oa.scenarios[t]=na(a),sa(),oa.scenarios[t]}(ua.slotIndex).name}`);break;case"Enter":!function(){const e=la()[ua.slotIndex];e?(ma.pendingApplication={scenario:e,slotIndex:ua.slotIndex},pa(`Scenario armed: ${e.name}`),ya()):pa("No scenario to apply")}();break;default:return}e.preventDefault(),e.stopPropagation()}else"F8"===t&&(ua.visible||(ua.visible=!0,pa(null)),e.preventDefault(),e.stopPropagation())},!0),window.addEventListener("mousedown",va,!0),window.addEventListener("mouseup",va,!0),window.addEventListener("contextmenu",va,!0),ga=!0),Aa||"undefined"==typeof window||(Aa=!0,function(){if(Sa||"undefined"==typeof window)return;const e=window.AudioContext||window.webkitAudioContext;e&&(Sa=new e)}(),Sa&&(Sa&&(Ca=Sa.createGain(),Ca.gain.value=.9,Ta=Sa.createGain(),Ta.gain.value=.95,Ia=Sa.createGain(),Ia.gain.value=0,Ta.connect(Ca),Ia.connect(Ca),Ca.connect(Sa.destination)),function(){if(Sa){Oa.clear();for(const[e,t]of Object.entries(ka))try{const a=t.generator(Sa);Oa.set(e,a)}catch(t){console.warn(`Failed to generate sound buffer for ${e}`,t)}}}(),function(){if("undefined"!=typeof window)for(const e of Object.keys(Ma))window.addEventListener(e,t=>{La(e)})}(),"undefined"!=typeof window&&(Pa&&window.clearInterval(Pa),Pa=window.setInterval(()=>{if(!Sa||!Ia)return;Da=Math.max(.18,Da-.015),Ba+=.2*(Da-Ba);const e=Fa(Ba);Ia.gain.cancelScheduledValues(Sa.currentTime),Ia.gain.linearRampToValueAtTime(e,Sa.currentTime+.12)},220)),function(){if("undefined"==typeof window)return;const e=()=>{ja(),$a(),window.removeEventListener("pointerdown",e),window.removeEventListener("keydown",e)};window.addEventListener("pointerdown",e),window.addEventListener("keydown",e)}())),_a(),"undefined"!=typeof window&&(window.P2P={createOffer:async function(){_a();const e=await za.createOffer();return await za.setLocalDescription(e),Ja=JSON.stringify(e),Ja},createAnswer:async function(e){_a();const t=JSON.parse(e);await za.setRemoteDescription(new RTCSessionDescription(t));const a=await za.createAnswer();return await za.setLocalDescription(a),Ja=JSON.stringify(a),Ja},acceptRemoteDescription:async function(e){_a();const t=JSON.parse(e);await za.setRemoteDescription(new RTCSessionDescription(t))},addRemoteCandidate:async function(e){if(!e)return;_a();const t=new RTCIceCandidate(JSON.parse(e));await za.addIceCandidate(t)},getLocalDescription:function(){return Ja},getLocalCandidates:function(){return[...Va]},getStatus:Za,close:function(){qa&&(qa.close(),qa=null),Ka&&(Ka.close(),Ka=null),za&&(za.close(),za=null),Ga="disconnected"}}),ce||"undefined"==typeof window||(window.addEventListener("keydown",function(e){if(e.altKey&&!e.repeat&&("Digit9"===e.code||"Digit0"===e.code)){(function(e=1){if(!Array.isArray(ee)||0===ee.length)return!1;const t=ee.indexOf(se),a=((t>=0?t:0)+e+ee.length)%ee.length;return ge(ee[a])})("Digit9"===e.code?-1:1)&&"function"==typeof e.preventDefault&&e.preventDefault()}}),ce=!0);let dc=performance.now();window.requestAnimationFrame(function e(t){const a=Math.min((t-dc)/1e3,.1);dc=t,cc(a);const n=ve();(function(e){!function(){for(const e of Object.keys(qi))qi[e]=0}(),function(e){zi=e||null}(e);const t=de(),a=t?.background??{},n=e?.offsetX??0,o=Array.isArray(a.gradientStops)&&a.gradientStops.length>0?a.gradientStops:[{offset:0,color:"#111a2c"},{offset:.4,color:"#182439"},{offset:.75,color:"#1f2d44"},{offset:1,color:"#232f49"}],i=x.createLinearGradient(0,0,0,x.canvas.height);for(const e of o){const t="number"==typeof e.offset?Math.min(Math.max(e.offset,0),1):0,a=e.color??"#111a2c";i.addColorStop(t,a)}x.fillStyle=i,x.fillRect(0,0,x.canvas.width,x.canvas.height);const r=Array.isArray(a.silhouettes)?a.silhouettes:[];for(const e of r){const t=Array.isArray(e.points)?e.points:[];if(!(t.length<3)){x.fillStyle=e.color??"rgba(0, 0, 0, 0.45)",x.beginPath(),x.moveTo(t[0].x-n,t[0].y);for(let e=1;e<t.length;e+=1)x.lineTo(t[e].x-n,t[e].y);x.closePath(),x.fill()}}const s=a.horizonBand;if(s){const e=s.height??120,t=s.start??b-e-30,a=x.createLinearGradient(0,t,0,t+e);a.addColorStop(0,s.topColor??"rgba(46, 86, 126, 0.25)"),a.addColorStop(1,s.bottomColor??"rgba(28, 52, 84, 0)"),x.fillStyle=a,x.fillRect(0,t,x.canvas.width,e)}if("desert"===t?.theme){const e=a.sun?.x??.72*x.canvas.width,t=a.sun?.y??.18*x.canvas.height,n=a.sun?.radius??70,o=x.createRadialGradient(e,t,0,e,t,n);o.addColorStop(0,"rgba(255, 214, 128, 0.9)"),o.addColorStop(1,"rgba(255, 214, 128, 0)"),x.fillStyle=o,x.beginPath(),x.arc(e,t,n,0,2*Math.PI),x.fill()}else if("sci-fi"===t?.theme){const e=110;x.fillStyle="#a8c2ff",x.globalAlpha=.35;for(let t=0;t<x.canvas.width;t+=e)for(let a=0;a<b-40;a+=e){const e=8*Math.sin(13.37*t+a)%18,n=6*Math.cos(7.91*a+t)%14;x.fillRect(t+e,a+n,2,2)}x.globalAlpha=1}if("jungle"===t?.theme){const e=b-140,t=x.createLinearGradient(0,e,0,b);t.addColorStop(0,"rgba(60, 120, 80, 0.18)"),t.addColorStop(1,"rgba(40, 70, 50, 0)"),x.fillStyle=t,x.fillRect(0,e,x.canvas.width,b-e)}x.fillStyle=a.groundColor??"#1b2231",x.fillRect(0,b,x.canvas.width,x.canvas.height-b)})(n),x.save(),x.translate(-n.offsetX,0),function(){!function(){const e=function(){const e=de();return Array.isArray(e?.waterZones)?e.waterZones:[]}();for(const t of e){const e=x.createLinearGradient(t.x,t.top,t.x,t.top+t.depth);e.addColorStop(0,t.topColor??"rgba(54, 98, 144, 0.88)"),e.addColorStop(.7,t.midColor??"rgba(36, 72, 112, 0.9)"),e.addColorStop(1,t.bottomColor??"rgba(24, 50, 84, 0.95)"),x.fillStyle=e,x.fillRect(t.x,t.top,t.width,t.depth),!1!==t.highlight&&(x.fillStyle=t.highlightColor??"rgba(255, 204, 112, 0.25)",x.fillRect(t.x-10,t.top+2,t.width+20,4));const a=t.rippleColor??"rgba(255, 255, 255, 0.12)";x.strokeStyle=a,x.lineWidth=1.6;for(let e=0;e<t.width;e+=40){const a=t.top+6+3*Math.sin(.03*(e+t.top));x.beginPath(),x.moveTo(t.x+e,a),x.quadraticCurveTo(t.x+e+10,a+3,t.x+e+20,a),x.stroke()}}}();const e=he();for(const t of e)us(t);!function(){const e=function(){const e=de();return Array.isArray(e?.decor)?e.decor:[]}();for(const t of e)switch(t.type){case"building":ms(t);break;case"billboard":x.save(),x.fillStyle="#1f2330",x.fillRect(t.x-t.width/2,t.y-t.height,t.width,t.height),x.fillStyle="#ffc851",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(t.text??"Ad",t.x,t.y-t.height/2),x.strokeStyle="#ffa940",x.lineWidth=3,x.strokeRect(t.x-t.width/2,t.y-t.height,t.width,t.height),x.restore();break;case"streetlight":x.save(),x.strokeStyle="#707789",x.lineWidth=4,x.beginPath(),x.moveTo(t.x,t.y+140),x.lineTo(t.x,t.y+30),x.stroke(),x.fillStyle="#ffd97a",x.beginPath(),x.arc(t.x,t.y+12,10,0,2*Math.PI),x.fill(),x.restore();break;case"hovercar":Is(t);break;case"palm":gs(t);break;case"ruin":ps(t);break;case"vineArch":ys(t);break;case"glowPlant":xs(t);break;case"waterfall":bs(t);break;case"dune":ws(t);break;case"rockSpire":vs(t);break;case"campfire":ks(t);break;case"antenna":Ms(t);break;case"spire":Ss(t);break;case"holoBillboard":Cs(t);break;case"energyCoil":Ts(t)}}()}(),function(){const e=An(),t=si;if(t&&0!==t.length){x.save();for(const a of t){const t=.5*(a.width??120)+50,n=!Ki(a.x,t,320);Ui("destructible",n),n||xr(a,e)}x.restore()}}(),function(){const e=Or;if(!e||0===e.length)return;const t=An();x.save();for(const a of e){const e=.5*(a.width??80)+36,n=!Ki(a.x,e,280);Ui("interactable",n),n||Er(a,t)}x.restore()}(),function(){const e=Es(),t=Ye.vehicleCandidateId;for(const a of Cn){const n=kn[a.type];if(!n)continue;const o=.5*(n.width??120)+30,i=!Ki(a.x,o,320);if(Ui("vehicle",i),i)continue;if(!n)continue;const r=e?.id===a.id,s=!r&&t===a.id,l=n.width??120,c=n.height??48,d=n.colorBody??"#2c3245",f=n.colorAccent??"#f0b239";x.save(),x.translate(a.x,a.y),x.rotate((a.tilt??0)*Math.PI/180),x.fillStyle=d,x.fillRect(-l/2,-c/2,l,c),x.fillStyle=f,x.fillRect(-l/2,-c/2-6,.6*l,8),x.restore(),(r||s)&&(x.save(),x.lineWidth=r?4:3,x.strokeStyle=r?"#8cffd4":"#ffc66d",x.setLineDash(r?[]:[8,8]),x.strokeRect(a.x-l/2-10,a.y-c/2-12,l+20,c+24),x.restore())}}(),function(){const e=Ji;if(0!==e.length){x.save(),x.textAlign="center",x.font="15px 'Segoe UI', Arial, sans-serif";for(const t of e){const e=!Ki(t.x,60,360);if(Ui("resource",e),e)continue;ar(t);const a=Gi[t.typeId];"descending"!==t.state&&(x.fillStyle=t.glowColor,x.globalAlpha=.9,x.fillText(a?.label??t.label??"Supply Drop",t.x,t.y-16))}x.restore()}}(),function(){const e=Ue();for(const t of e){const e=!Ki(t.x,36,240);Ui("remote",e),e||yr({entity:t,pose:Oe.standing,aim:t.aim??null,weapon:null,primaryColor:"#ff9cf7",supportColor:"#ffc5ff",lineWidth:3.2,label:t.name??t.id??"Peer",labelColor:"#ffd6ff"})}}(),function(){const e=As(),t=(Ye.squadCommandCooldown,{hold:"#8cffd4",defend:"#66b3ff",attack:"#ff9f7a",flank:"#ffdd6f"}[e?.id??"hold"]??"#8cffd4"),a=gr(Xs);for(const e of ze){const n=40,o=!Ki(e.x,n,240);if(Ui("squad",o),o)continue;const i=e.flashTimer??0,r=Tn(i/.18,0,1),s=e.highlight??0,l=null!=e.fireCooldown&&e.fireCooldown<.08;yr({entity:e,pose:Oe.standing,aim:e.aim,weapon:Xs,weaponVisual:a,primaryColor:t,supportColor:t,lineWidth:3.6,attackInfo:e.targetEnemyId||l?{active:!0,progress:l?.7:.4,type:"ranged-mid"}:null,label:e.name??"Ally",labelColor:"#cfe4ff",flashColor:i>0?"rgba(140, 255, 212, 0.85)":null,flashAmount:r,highlightColor:s>0?"rgba(140, 255, 212, 0.45)":null})}}(),function(){const e=Ge,t=An(),a=e.y,n=e.shakeTimer>0?Math.sin(40*t)*e.shakeMagnitude*Tn(e.shakeTimer/.4,0,1):0,o=e.health>0?n:0,i=e.health>0?e.flashTimer>0?"#ffe3af":"#9ca4b8":"#3b3f49";x.lineWidth=5,x.strokeStyle=i,x.lineCap="round";const r=e.x+o;x.beginPath(),x.arc(r,a+20,20,0,2*Math.PI),x.stroke(),x.beginPath(),x.moveTo(r,a+40),x.lineTo(r,b-20),x.stroke(),x.beginPath(),x.moveTo(r,b-20),x.lineTo(r-28,b),x.moveTo(r,b-20),x.lineTo(r+28,b),x.stroke();const s=a+48;x.beginPath(),x.moveTo(r,s),x.lineTo(r-36,s+18),x.moveTo(r,s),x.lineTo(r+36,s+18),x.stroke();const l=r-70,c=a-24;x.fillStyle="#23262d",x.fillRect(l,c,140,10);const d=e.health/e.maxHealth;x.fillStyle=e.health>0?"#5fffb5":"#44474f",x.fillRect(l,c,140*Tn(d,0,1),10),x.strokeStyle="#50535b",x.strokeRect(l,c,140,10),x.fillStyle="#cfd3df",x.font="14px 'Segoe UI', Arial, sans-serif",x.textAlign="center";const f=e.health>0?`Training Dummy ${Math.round(e.health)}/${e.maxHealth}`:"Respawning...";x.fillText(f,r,c-6),x.textAlign="left"}(),function(){for(const e of Ve){if(e.health<=0)continue;const t=(e.radius??22)+48,a=!Ki(e.x,t,260);if(Ui("enemies",a),a)continue;const n=18,o={headRadius:n,bodyLength:Math.max(38,(e.height??118)-2*n-26),legLength:42,armLength:30},i=e.stunTimer>0?"#ffd166":e.flashTimer>0?"#ff9488":"#fa5b4a",r=e.flashTimer??0,s=Tn(r/.18,0,1),l=e.shakeTimer>0?"rgba(255, 139, 126, 0.35)":null;yr({entity:e,pose:o,aim:e.aim,weapon:null,primaryColor:i,supportColor:"#fca289",lineWidth:4.4,showHealthBar:!0,healthRatio:e.health/e.maxHealth,healthColor:"#ff6f61",flashColor:r>0?"rgba(255, 148, 136, 0.85)":null,flashAmount:s,highlightColor:l,attackInfo:"attack-active"===e.state?{active:!0,progress:.8,type:"melee-mid"}:null})}}(),function(){if(!mo.active)return;x.save();const e=Tn(mo.flashTimer>0?.45:.25+mo.strength/Math.max(1,mo.maxStrength)*.35,.15,.6);x.strokeStyle=mo.color,x.lineWidth=4,x.globalAlpha=e,x.beginPath();const t=go();x.arc(t.x,t.y,mo.radius,0,2*Math.PI),x.stroke(),x.globalAlpha=.4*e,x.fillStyle=mo.color,x.beginPath(),x.arc(t.x,t.y,.9*mo.radius,0,2*Math.PI),x.fill(),x.restore()}(),function(){if(0!==lo.length){x.save();for(const e of lo){const t=40,a=.4*e.height,n=Tn(e.duration/(e.maxDuration||1),0,1);x.fillStyle=e.baseColor,x.fillRect(e.x-.5*t,e.y+e.height-a,t,a);const o=.6*e.height;x.fillStyle=e.headColor,x.fillRect(e.x-.3*t,e.y,.6*t,o),x.fillStyle="#ffd66d",x.fillRect(e.x-.3*t,e.y-6,.6*t*n,4)}x.restore()}}(),function(){if(!ho.active)return;x.save(),x.strokeStyle=ho.color,x.lineWidth=3,x.beginPath(),x.moveTo(Ye.x,Ye.y);const e=ho.tetherLength/(ho.maxLength||1),t=Ye.x+(ho.targetX-Ye.x)*e,a=Ye.y+(ho.targetY-Ye.y)*e;x.lineTo(t,a),x.stroke(),x.restore()}(),function(){x.save();for(const e of Fn){const t=Tn(e.life/e.maxLife,0,1);x.globalAlpha=.85*t,x.fillStyle=e.color,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill()}x.restore()}(),function(){if(Ye.health<=0||Ye.vehicleId)return;const e=Ye.currentPose||Oe.standing,t=gt(),a=Ye.currentAttack,n=a?a.windup+a.active+a.recovery:0,o=a?{active:Ye.attacking,progress:n>0?Tn(Ye.attackElapsed/n,0,1):0,type:t?.category??""}:null,i=zt(),r={helmet:qt(i.helmet)??null,armor:qt(i.armor)??null,jetpack:qt(i.jetpack)??null};yr({entity:Ye,pose:e,aim:Ye.aim,weapon:t,cosmetics:r,primaryColor:"#f4f7ff",supportColor:"#d0d4de",lineWidth:4,crouching:Ye.crouching,rolling:Ye.rolling,attackInfo:o,flashColor:Ye.flashBlindTimer>0?"rgba(255, 255, 224, 0.7)":null,flashAmount:Tn((Ye.flashBlindTimer??0)/1.2,0,1),highlightColor:Ye.structureShieldStrength>0?"rgba(124, 214, 255, 0.55)":null}),function(){const e=Ye.aim;if(!e)return;const t=function(){const e=Ye.rolling?Oe.rolling:Ye.crouching?Oe.crouching:Oe.standing;return sr(Ye,e)}(),a=e.active&&Number.isFinite(e.targetX)&&Number.isFinite(e.targetY),n=a?Math.max(72,Math.min(320,e.magnitude||220)):220,o=Number.isFinite(e.vectorX)?e.vectorX:Ye.facing>=0?1:-1,i=Number.isFinite(e.vectorY)?e.vectorY:0,r=Math.hypot(o,i)||1,s=o/r,l=i/r,c=a?e.targetX:t.x+s*n,d=a?e.targetY:t.y+l*n;x.save(),x.lineWidth=2,x.setLineDash([6,6]),x.strokeStyle=a?"rgba(124, 214, 255, 0.85)":"rgba(160, 196, 255, 0.7)",x.beginPath(),x.moveTo(t.x,t.y),x.lineTo(c,d),x.stroke(),x.setLineDash([]),x.fillStyle=a?"rgba(124, 214, 255, 0.9)":"rgba(160, 196, 255, 0.8)",x.beginPath(),x.arc(c,d,4,0,2*Math.PI),x.fill(),x.fillStyle=a?"rgba(124, 214, 255, 1)":"rgba(160, 196, 255, 1)",x.globalAlpha=.45,x.beginPath(),x.arc(t.x,t.y,3,0,2*Math.PI),x.fill(),x.globalAlpha=1,x.restore()}()}(),function(){for(const e of Ye.activeHitboxes){const t=Tn(e.remaining/e.duration,0,1);x.fillStyle=`rgba(255, 153, 102, ${.2*t})`,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill(),x.strokeStyle=`rgba(255, 198, 141, ${t})`,x.lineWidth=2,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.stroke()}}(),el(),function(){if(0!==Ci.size||0!==Ti.length){x.save(),x.globalCompositeOperation="lighter",x.globalAlpha=1;for(const e of Ci.values()){const t=Ri(e.intensity);t<=.01||("cone"===e.type?Li(e,t):Wi(e,t))}for(const e of Ti){const t=Tn(e.ttl/e.maxTtl,0,1);let a=Ri(e.intensity*Math.pow(t,e.decay??1));e.flicker>0&&(a=Ri(a+(Math.random()-.5)*e.flicker)),a<=.01||("cone"===e.type?Li(e,a):Wi(e,a))}x.restore()}}(),function(){x.save(),x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center";for(const e of Yn){const t=Tn(e.life/e.maxLife,0,1);x.fillStyle=`rgba(255, 214, 102, ${t})`,x.fillText(`-${Math.round(e.value)}`,e.x,e.y)}x.restore()}(),x.restore(),Zs(),function(){const e=tn();if(!e.visible)return;const t=420,a=.5*x.canvas.width-240,n=.5*x.canvas.height-210;x.save(),x.fillStyle="rgba(12, 16, 24, 0.82)",x.fillRect(a,n,480,t),x.strokeStyle="#6f7fa0",x.lineWidth=3,x.strokeRect(a,n,480,t),x.fillStyle="#cfe3ff",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="left",x.fillText("Server Browser",a+20,n+32),x.font="13px 'Segoe UI', Arial, sans-serif",x.fillStyle="#9aa9c7",x.fillText("Join: Enter  |  Navigate: [ / ]  |  Close: L",a+20,n+52),x.fillText("Toggle: L  |  Join: Enter  |  Host: H  |  Stop: U  |  Next: ] or /  |  Prev: [",a+20,n+68);let o=n+88;e.error&&(x.fillStyle="#ff8080",x.fillText(e.error,a+20,o),o+=18),e.statusMessage&&(x.fillStyle="#8cffd4",x.fillText(e.statusMessage,a+20,o),o+=18),e.joinError&&(x.fillStyle="#ff9a9a",x.fillText(e.joinError,a+20,o),o+=18),e.joinStatus&&(x.fillStyle="#cfe3ff",x.fillText(e.joinStatus,a+20,o),o+=18);const i=o+12,r=n+t-140,s=e.servers??[],l=Math.max(0,Math.floor((r-i)/34)),c=Math.min(s.length,Math.min(l,8));x.font="14px 'Segoe UI', Arial, sans-serif";for(let t=0;t<c;t+=1){const n=s[t],o=i+34*t;t===e.selectedIndex&&(x.fillStyle="rgba(108, 132, 220, 0.4)",x.fillRect(a+12,o-6,456,30)),x.fillStyle="#e4ecff",x.fillText(n.name??n.id??"Server",a+24,o+8),x.fillStyle="#9aa9c7";const r=`${n.map??"Unknown"} | ${n.players??"?"}/${n.maxPlayers??"?"} | ${n.region??"--"}`;x.fillText(r,a+24,o+22)}0===s.length&&(x.fillStyle="#a6b2cf",x.fillText("No servers available.",a+24,i+16));const d=(e,t=64)=>"string"!=typeof e?"":e.length>t?`${e.slice(0,t)}...`:e,f=e.p2p??{};let h=n+t-120;x.font="12px 'Segoe UI', Arial, sans-serif",x.fillStyle="#9aa9c7",x.fillText("P2P Handshake",a+20,h),h+=16,f.error&&(x.fillStyle="#ff8080",x.fillText(f.error,a+20,h),h+=16),e.hosting?(f.pendingOffer?(x.fillStyle="#ffd27f",x.fillText("Generating offer...",a+20,h),h+=16):f.offer?(x.fillStyle="#8cffd4",x.fillText("Offer ready and shared with joiners.",a+20,h),h+=16,x.fillStyle="#9aa9c7",x.fillText(d(f.offer),a+20,h),h+=16):(x.fillStyle="#9aa9c7",x.fillText("Preparing host offer...",a+20,h),h+=16),f.pendingAnswer&&(x.fillStyle="#ffd27f",x.fillText("Waiting for a joiner answer...",a+20,h),h+=16)):f.pendingAnswer?(x.fillStyle="#ffd27f",x.fillText("Generating answer...",a+20,h),h+=16):f.answer?(x.fillStyle="#8cffd4",x.fillText("Answer applied. Waiting for host handshake.",a+20,h),h+=16,x.fillStyle="#9aa9c7",x.fillText(d(f.answer),a+20,h),h+=16):(x.fillStyle="#9aa9c7",x.fillText("Waiting for host offer...",a+20,h),h+=16);const u=Array.isArray(f.localCandidates)?f.localCandidates:[],m=Array.isArray(f.remoteCandidates)?f.remoteCandidates:[];f.pendingCandidates&&(x.fillStyle="#ffd27f",x.fillText("Processing ICE candidates...",a+20,h),h+=16);const g="Local ICE ready: "+u.length+"  |  Remote applied: "+m.length;if(x.fillStyle="#9aa9c7",x.fillText(g,a+20,h),h+=16,u.length>0){const e="Last local: "+d(u[u.length-1],54);x.fillStyle="#6f86d0",x.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(x.fillStyle="#9aa9c7",x.fillText("Local ICE will appear shortly after offer/answer.",a+20,h),h+=16);if(m.length>0){const e="Last remote: "+d(m[m.length-1],54);x.fillStyle="#6fd0c5",x.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(x.fillStyle="#9aa9c7",e.hosting?x.fillText("Press N after players send their ICE (M).",a+20,h):x.fillText("Press M to copy your ICE and send it to the host.",a+20,h),h+=16);x.restore()}(),function(){const e=function(){const e=Pt();return{visible:At.visible,slotIndex:At.slotIndex,optionIndex:At.optionIndex,slots:e,message:At.message,messageTimer:At.messageTimer}}(),{visible:t,slots:a,slotIndex:n,optionIndex:o,message:i,messageTimer:r}=e,s=Boolean(i)&&r>.03;if(!t&&!s)return;const l=x.canvas.width,c=x.canvas.height;if(x.save(),t){x.fillStyle="rgba(6, 10, 18, 0.65)",x.fillRect(0,0,l,c);const e=Math.min(l-120,560),t=36,i=80,r=160,s=48,d=Math.min(c-120,i+a.length*t+r+s),f=.5*(l-e),h=.5*(c-d);x.fillStyle="rgba(12, 18, 32, 0.94)",x.fillRect(f,h,e,d),x.strokeStyle="rgba(120, 150, 240, 0.9)",x.lineWidth=2,x.strokeRect(f+.5,h+.5,e-1,d-1);const u=26;let m=h+u+6;const g=f+u;x.fillStyle="#f2f5ff",x.font="20px 'Segoe UI', Arial, sans-serif",x.fillText("Loadout Editor",g,m),m+=28,x.fillStyle="#9aa9c7",x.font="13px 'Segoe UI', Arial, sans-serif",x.fillText("?/? choose slot   ?/? cycle weapons   R reset   Enter/Esc close",g,m),m+=30,x.font="15px 'Segoe UI', Arial, sans-serif";const p=g,y=f+e-u,b="rgba(92, 128, 220, 0.22)",w="#c5cee4",v="#dfe7ff",k="#8cffd4",M="#9da9cc";a.forEach((a,o)=>{const i=m+o*t;o===n&&(x.fillStyle=b,x.fillRect(p-12,i-24,e-2*u+24,t));const r=o===n?v:w,s=o===n?k:M,l=a.label??a.slotId,c=a.weapon?.name??"Empty";x.fillStyle=r,x.fillText(l,p,i),x.fillStyle=s,x.fillText(c,y-x.measureText(c).width,i)}),m+=a.length*t+22;const S=a[n]??null;x.font="14px 'Segoe UI', Arial, sans-serif",x.fillStyle="#dce6ff",x.fillText("Available weapons",g,m),m+=24;const C=function(e,t,a,n){if(!e)return n;const o=Array.isArray(e.allowedWeaponIds)?e.allowedWeaponIds:[];if(0===o.length)return x.fillStyle="#8a96b9",x.font="13px 'Segoe UI', Arial, sans-serif",x.fillText("No compatible items for this slot.",a,n),n+20;x.font="13px 'Segoe UI', Arial, sans-serif";let i=n;return o.forEach((e,n)=>{const o=Re[e],r=o?.name??e;x.fillStyle=n===t?"#ffcf7a":"#aab5d5",x.fillText(r,a,i),i+=22}),i}(S,o,g,m);if(m=Math.max(m+24,C+6),S?.weapon){const t=S.weapon;if(x.font="13px 'Segoe UI', Arial, sans-serif",x.fillStyle="#8cffd4",x.fillText(`Selected: ${t.name}`,g,m),m+=20,x.fillStyle="#9aa9c7",x.font="12px 'Segoe UI', Arial, sans-serif",x.fillText(`Category: ${t.category??"unknown"}`,g,m),m+=18,t.description){const a=e-2*u;m+=16*function(e,t,a,n){if(!e)return 0;const o=String(e).split(/\s+/);let i="",r=0;for(const e of o){const o=i.length>0?`${i} ${e}`:e;x.measureText(o).width>n&&i?(x.fillText(i,t,a),i=e,a+=16,r+=1):i=o}return i&&(x.fillText(i,t,a),r+=1),r}(t.description,g,m,a)}}const T=h+d-u;x.font="12px 'Segoe UI', Arial, sans-serif",x.fillStyle="#7f8aad",x.fillText("Changes apply instantly and persist locally.",g,T)}s&&!t&&function(e,t=1){const a=String(e??"").trim();if(!a)return;x.save(),x.globalAlpha=t,x.font="14px 'Segoe UI', Arial, sans-serif";const n=x.measureText(a).width,o=Math.min(x.canvas.width-48,n+24);x.fillStyle="rgba(10, 16, 28, 0.84)",x.fillRect(24,24,o,32),x.strokeStyle="rgba(140, 168, 255, 0.55)",x.lineWidth=1,x.strokeRect(24.5,24.5,o-1,31),x.fillStyle="#dce6ff",x.fillText(a,36,44),x.restore()}(i,Math.max(0,Math.min(1,r/.4))),x.restore()}(),function(){const e=function(){const{categories:e}=Vt(),t=zt(),a=e[Ut.categoryIndex],n=(Array.isArray(a?.options)?a.options:[]).map((e,n)=>({...e,selected:t[a?.id]===e.id,index:n}));return{visible:Ut.visible,categoryIndex:Ut.categoryIndex,optionIndex:Ut.optionIndex,categories:e,selections:t,options:n,activeCategory:a,message:Ut.message,messageTimer:Ut.messageTimer}}(),{visible:t,categories:a=[],categoryIndex:n=0,optionIndex:o=0,options:i=[],activeCategory:r=null,selections:s={},message:l=null,messageTimer:c=0}=e,d=Boolean(l)&&c>.03;if(!t&&!d)return;const f=x.canvas.width,h=x.canvas.height;if(t){x.save(),x.fillStyle="rgba(6, 10, 18, 0.65)",x.fillRect(0,0,f,h);const e=Math.min(f-140,620),t=Math.min(h-120,420),l=.5*(f-e),c=.5*(h-t);x.fillStyle="rgba(14, 20, 32, 0.94)",x.fillRect(l,c,e,t),x.strokeStyle="rgba(140, 168, 255, 0.85)",x.lineWidth=2,x.strokeRect(l+.5,c+.5,e-1,t-1);const d=26;let u=c+d+4;const m=l+d;x.fillStyle="#f2f5ff",x.font="20px 'Segoe UI', Arial, sans-serif",x.fillText("Cosmetic Customization",m,u),u+=28,x.fillStyle="#9aa9c7",x.font="13px 'Segoe UI', Arial, sans-serif",x.fillText("F7 close   ?/? categories   ?/? cycle variants   R reset",m,u),u+=26;const g=200,p=32,y=m+g+28,b=l+e-d-y;x.font="15px 'Segoe UI', Arial, sans-serif",a.forEach((e,t)=>{const a=u+t*p,o=t===n;o&&(x.fillStyle="rgba(92, 128, 220, 0.22)",x.fillRect(m-10,a-22,g+20,p)),x.fillStyle=o?"#dfe7ff":"#c5cee4",x.fillText(e.label,m,a);const i=s?.[e.id],r=e.options?.find(e=>e.id===i)??null;r&&(x.fillStyle=o?"#8cffd4":"#9aa9c7",x.font="12px 'Segoe UI', Arial, sans-serif",x.fillText(r.name,m,a+14),x.font="15px 'Segoe UI', Arial, sans-serif")});let w=u;x.font="15px 'Segoe UI', Arial, sans-serif",x.fillStyle="#dce6ff",x.fillText(r?.label??"Variants",y,w),w+=24,0===i.length?(x.fillStyle="#8a96b9",x.font="13px 'Segoe UI', Arial, sans-serif",x.fillText("No cosmetics available for this category.",y,w),w+=22):i.forEach((e,t)=>{const a=t===o,n=e.selected;x.font="14px 'Segoe UI', Arial, sans-serif",x.fillStyle=a?"#ffcf7a":n?"#8cffd4":"#aab5d5";const i=n?"� ":"";x.fillText(`${i}${e.name}`,y,w),w+=22});const v=w+10,k=i[o]??null;if(k?.description){x.fillStyle="#9aa9c7",x.font="12px 'Segoe UI', Arial, sans-serif";const e=function(e,t,a,n){const o=String(e??"").split(/\s+/).filter(Boolean);if(0===o.length)return 0;let i="",r=a,s=0;for(const e of o){const a=i.length>0?`${i} ${e}`:e;x.measureText(a).width>n&&i?(x.fillText(i,t,r),i=e,r+=16,s+=1):i=a}return i&&(x.fillText(i,t,r),s+=1),s}(k.description,y,v,b);w=v+16*e+10}const M=c+t-d+4;x.fillStyle="#7f8aad",x.font="12px 'Segoe UI', Arial, sans-serif",x.fillText("Selections save locally and apply instantly.",m,M),x.restore()}d&&!t&&function(e,t=1){const a=String(e??"").trim();if(!a)return;x.save(),x.globalAlpha=Math.max(0,Math.min(1,t)),x.font="14px 'Segoe UI', Arial, sans-serif";const n=x.measureText(a).width,o=Math.min(x.canvas.width-48,n+24),i=x.canvas.height-32-32;x.fillStyle="rgba(12, 18, 32, 0.9)",x.fillRect(24,i,o,32),x.strokeStyle="rgba(140, 168, 255, 0.55)",x.lineWidth=1,x.strokeRect(24.5,i+.5,o-1,31),x.fillStyle="#dce6ff",x.fillText(a,36,i+20),x.restore()}(l,Math.min(1,c/.4))}(),function(){const e=function(){const e=la(),t=e[ua.slotIndex]??null;return{visible:ua.visible,slotIndex:ua.slotIndex,fieldIndex:ua.fieldIndex,fields:ha,scenario:t,scenarios:e,environmentName:t?xa(t.environmentId):"--",message:ua.message,messageTimer:ua.messageTimer}}(),{visible:t,fieldIndex:a=0,fields:n=[],scenario:o,environmentName:i,message:r,messageTimer:s=0,slotIndex:l=0}=e,c=Boolean(r)&&s>.03;if(!t&&!c)return;const d=x.canvas.width,f=x.canvas.height;if(t){x.save(),x.fillStyle="rgba(8, 12, 20, 0.65)",x.fillRect(0,0,d,f);const e=Math.min(d-140,620),t=Math.min(f-120,420),r=.5*(d-e),s=.5*(f-t);x.fillStyle="rgba(14, 20, 36, 0.94)",x.fillRect(r,s,e,t),x.strokeStyle="rgba(140, 168, 255, 0.85)",x.lineWidth=2,x.strokeRect(r+.5,s+.5,e-1,t-1);const c=26;let h=s+c;const u=r+c,m=r+e-c;x.fillStyle="#f2f5ff",x.font="20px 'Segoe UI', Arial, sans-serif",x.fillText("Scenario Editor",u,h),h+=30,x.fillStyle="#9aa9c7",x.font="13px 'Segoe UI', Arial, sans-serif",x.fillText("F8 close   ?/? fields   ?/? adjust   Enter apply   E edit text   R reset",u,h),h+=26,x.font="14px 'Segoe UI', Arial, sans-serif",x.fillStyle="#8cffd4";const g=o?`${l+1}. ${o.name}`:`Slot ${l+1}`;x.fillText(g,u,h),h+=24;const p=la().length;x.font="15px 'Segoe UI', Arial, sans-serif",n.forEach((t,n)=>{let r="--";if(o)switch(t.id){case"scenarioSlot":r=`${l+1} / ${p}`;break;case"name":r=o.name;break;case"environmentId":r=i;break;case"startingMaterials":r=`${o.startingMaterials}`;break;case"enemyCount":r=`${o.enemyCount}`;break;case"playerSpawnRatio":r=tl(o.playerSpawnRatio);break;case"dummySpawnRatio":r=tl(o.dummySpawnRatio);break;case"enemySpawnLeft":r=tl(o.enemySpawnRatios?.[0]);break;case"enemySpawnRight":r=tl(o.enemySpawnRatios?.[1]);break;case"description":r=o.description??"";break;default:r=""}else r="N/A";const s=h+28*n,d=n===a;d&&(x.fillStyle="rgba(92, 128, 220, 0.3)",x.fillRect(u-12,s-22,e-2*c+24,28)),x.fillStyle=d?"#dfe7ff":"#c5cee4",x.fillText(t.label,u,s),x.fillStyle=d?"#8cffd4":"#9aa9c7",x.font="description"===t.id?"13px 'Segoe UI', Arial, sans-serif":"15px 'Segoe UI', Arial, sans-serif";const f=x.measureText(r).width;x.fillText(r,Math.max(u,m-f),s),x.font="15px 'Segoe UI', Arial, sans-serif"});let y=h+28*n.length+12;if(o?.description){x.fillStyle="#9aa9c7",x.font="12px 'Segoe UI', Arial, sans-serif";const t=e-2*c,a=function(e,t,a,n){const o=String(e??"").split(/\s+/).filter(Boolean);if(0===o.length)return 0;let i="",r=a,s=0;for(const e of o){const a=i.length>0?`${i} ${e}`:e;x.measureText(a).width>n&&i?(x.fillText(i,t,r),i=e,r+=16,s+=1):i=a}return i&&(x.fillText(i,t,r),s+=1),s}(o.description,u,y,t);y+=16*a+8}const b=s+t-c+4;x.fillStyle="#7f8aad",x.font="12px 'Segoe UI', Arial, sans-serif",x.fillText("Apply to rebuild the arena with new spawns and resources.",u,b),x.restore()}c&&!t&&function(e,t=1){const a=String(e??"").trim();if(!a)return;x.save(),x.globalAlpha=Math.max(0,Math.min(1,t)),x.font="14px 'Segoe UI', Arial, sans-serif";const n=x.measureText(a).width,o=Math.min(x.canvas.width-48,n+24),i=x.canvas.width-o-24,r=x.canvas.height-32-32;x.fillStyle="rgba(12, 20, 36, 0.88)",x.fillRect(i,r,o,32),x.strokeStyle="rgba(140, 168, 255, 0.55)",x.lineWidth=1,x.strokeRect(i+.5,r+.5,o-1,31),x.fillStyle="#dce6ff",x.fillText(a,i+12,r+20),x.restore()}(r,Math.min(1,s/.4))}(),window.requestAnimationFrame(e)})})();
//# sourceMappingURL=bundle.32b55797b2a761ec2215.js.map