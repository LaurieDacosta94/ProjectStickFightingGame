<!doctype html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Stickman Warfare Prototype</title></head><body><canvas id="game-canvas" width="1600" height="900"></canvas><script>
(()=>{"use strict";var e={56:(e,t,a)=>{e.exports=function(e){var t=a.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function a(e){for(var a=-1,n=0;n<t.length;n++)if(t[n].identifier===e){a=n;break}return a}function n(e,n){for(var i={},r=[],s=0;s<e.length;s++){var l=e[s],d=n.base?l[0]+n.base:l[0],c=i[d]||0,f="".concat(d," ").concat(c);i[d]=c+1;var h=a(f),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==h)t[h].references++,t[h].updater(u);else{var m=o(u,n);n.byIndex=s,t.splice(s,0,{identifier:f,updater:m,references:1})}r.push(f)}return r}function o(e,t){var a=t.domAPI(t);return a.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;a.update(e=t)}else a.remove()}}e.exports=function(e,o){var i=n(e=e||[],o=o||{});return function(e){e=e||[];for(var r=0;r<i.length;r++){var s=a(i[r]);t[s].references--}for(var l=n(e,o),d=0;d<i.length;d++){var c=a(i[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}i=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a="",n=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),n&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),n&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a}).join("")},t.i=function(e,a,n,o,i){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(n)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);n&&r[c[0]]||(void 0!==i&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=i),a&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=a):c[2]=a),o&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=o):c[4]="".concat(o)),t.push(c))}},t}},354:e=>{e.exports=function(e){var t=e[1],a=e[3];if(!a)return t;if("function"==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),o="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(n),i="/*# ".concat(o," */");return[t].concat([i]).join("\n")}return[t].join("\n")}},365:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(354),o=a.n(n),i=a(314),r=a.n(i)()(o());r.push([e.id,'* {\n  box-sizing: border-box;\n}\n\nbody {\n  margin: 0;\n  background-color: #0f1115;\n  color: #f0f3f7;\n  font-family: "Segoe UI", Arial, sans-serif;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n}\n\ncanvas {\n  border: 2px solid #2a2d34;\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\n  width: min(90vw, 960px);\n  max-width: 100%;\n  height: auto;\n}\n',"",{version:3,sources:["webpack://./src/styles.css"],names:[],mappings:"AAAA;EACE,sBAAsB;AACxB;;AAEA;EACE,SAAS;EACT,yBAAyB;EACzB,cAAc;EACd,0CAA0C;EAC1C,aAAa;EACb,mBAAmB;EACnB,uBAAuB;EACvB,iBAAiB;AACnB;;AAEA;EACE,yBAAyB;EACzB,6DAA6D;EAC7D,uBAAuB;EACvB,eAAe;EACf,YAAY;AACd",sourcesContent:['* {\r\n  box-sizing: border-box;\r\n}\r\n\r\nbody {\r\n  margin: 0;\r\n  background-color: #0f1115;\r\n  color: #f0f3f7;\r\n  font-family: "Segoe UI", Arial, sans-serif;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  min-height: 100vh;\r\n}\r\n\r\ncanvas {\r\n  border: 2px solid #2a2d34;\r\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\r\n  width: min(90vw, 960px);\r\n  max-width: 100%;\r\n  height: auto;\r\n}\r\n'],sourceRoot:""}]);const s=r},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},659:e=>{var t={};e.exports=function(e,a){var n=function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}t[e]=a}return t[e]}(e);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");n.appendChild(a)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(a){!function(e,t,a){var n="";a.supports&&(n+="@supports (".concat(a.supports,") {")),a.media&&(n+="@media ".concat(a.media," {"));var o=void 0!==a.layer;o&&(n+="@layer".concat(a.layer.length>0?" ".concat(a.layer):""," {")),n+=a.css,o&&(n+="}"),a.media&&(n+="}"),a.supports&&(n+="}");var i=a.sourceMap;i&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(n,e,t.options)}(t,e,a)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function a(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={id:n,exports:{}};return e[n](i,i.exports,a),i.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nc=void 0;var n=a(72),o=a.n(n),i=a(825),r=a.n(i),s=a(659),l=a.n(s),d=a(56),c=a.n(d),f=a(540),h=a.n(f),u=a(113),m=a.n(u),g=a(365),y={};y.styleTagTransform=m(),y.setAttributes=c(),y.insert=l().bind(null,"head"),y.domAPI=r(),y.insertStyleElement=h(),o()(g.A,y),g.A&&g.A.locals&&g.A.locals;const p=Object.seal({left:!1,right:!1,jump:!1,down:!1,roll:!1,attackBuffered:!1,throwBuffered:!1,reloadBuffered:!1,interactBuffered:!1,attackDown:!1,throwDown:!1,squadCommandCycleBuffered:!1,squadCommandSelect:null,serverBrowserToggleBuffered:!1,serverBrowserNavigate:0,serverBrowserJoinBuffered:!1,serverBrowserHostBuffered:!1,serverBrowserStopHostBuffered:!1,serverBrowserCopyOfferBuffered:!1,serverBrowserPasteOfferBuffered:!1,serverBrowserAcceptAnswerBuffered:!1,serverBrowserCopyCandidatesBuffered:!1,serverBrowserPasteCandidatesBuffered:!1});let x=!1;function w(e,t){switch(t.code){case"ArrowLeft":case"KeyA":p.left=e,t.preventDefault();break;case"ArrowRight":case"KeyD":p.right=e,t.preventDefault();break;case"ArrowUp":case"KeyW":case"Space":p.jump=e,t.preventDefault();break;case"ArrowDown":case"KeyS":p.down=e,t.preventDefault();break;case"ShiftLeft":case"ShiftRight":e&&(p.roll=!0,t.preventDefault());break;case"KeyJ":case"KeyF":e?(p.attackBuffered=!0,p.attackDown=!0,t.preventDefault()):(p.attackDown=!1,t.preventDefault());break;case"KeyG":e?(p.throwBuffered=!0,p.throwDown=!0,t.preventDefault()):(p.throwDown=!1,t.preventDefault());break;case"KeyR":e&&(p.reloadBuffered=!0,t.preventDefault());break;case"KeyE":e&&(p.interactBuffered=!0,t.preventDefault());break;case"KeyT":e&&(p.squadCommandCycleBuffered=!0,t.preventDefault());break;case"KeyZ":e&&(p.squadCommandSelect="hold",t.preventDefault());break;case"KeyX":e&&(p.squadCommandSelect="defend",t.preventDefault());break;case"KeyC":e&&(p.squadCommandSelect="attack",t.preventDefault());break;case"KeyV":e&&(p.squadCommandSelect="flank",t.preventDefault());break;case"KeyL":e&&(p.serverBrowserToggleBuffered=!0,t.preventDefault());break;case"BracketLeft":e&&(p.serverBrowserNavigate=-1,t.preventDefault());break;case"BracketRight":case"Slash":e&&(p.serverBrowserNavigate=1,t.preventDefault());break;case"Enter":e&&(p.serverBrowserJoinBuffered=!0,t.preventDefault());break;case"KeyH":e&&(p.serverBrowserHostBuffered=!0,t.preventDefault());break;case"KeyU":e&&(p.serverBrowserStopHostBuffered=!0,t.preventDefault());break;case"KeyO":e&&(p.serverBrowserCopyOfferBuffered=!0,t.preventDefault());break;case"KeyP":e&&(p.serverBrowserPasteOfferBuffered=!0,t.preventDefault());break;case"KeyI":e&&(p.serverBrowserAcceptAnswerBuffered=!0,t.preventDefault());break;case"KeyM":e&&(p.serverBrowserCopyCandidatesBuffered=!0,t.preventDefault());break;case"KeyN":e&&(p.serverBrowserPasteCandidatesBuffered=!0,t.preventDefault())}}const v={combatFists:{id:"combatFists",name:"Combat Fists",description:"Baseline martial arts combo with balanced speed and control.",category:"melee-short",attackChain:[{name:"Quick Jab",windup:.06,active:.12,recovery:.14,comboStart:.12,comboWindow:.18,range:74,heightOffset:-46,radius:26,damage:8,knockback:140,launch:0},{name:"Cross Strike",windup:.08,active:.12,recovery:.18,comboStart:.18,comboWindow:.2,range:82,heightOffset:-40,radius:28,damage:12,knockback:180,launch:0},{name:"Rising Kick",windup:.1,active:.14,recovery:.24,comboStart:.24,comboWindow:.2,range:68,heightOffset:-64,radius:30,damage:16,knockback:220,launch:160}]},shockBaton:{id:"shockBaton",name:"Shock Baton",description:"Electrified staff built for crowd control and guard breaks.",category:"melee-mid",attackChain:[{name:"Jab Feint",windup:.06,active:.08,recovery:.14,comboStart:.14,comboWindow:.16,range:68,heightOffset:-30,radius:26,damage:9,knockback:90,launch:0},{name:"Slide Sweep",windup:.1,active:.12,recovery:.2,comboStart:.2,comboWindow:.18,range:86,heightOffset:-12,radius:34,damage:16,knockback:180,launch:30},{name:"Arc Burst",windup:.16,active:.2,recovery:.32,comboStart:.32,comboWindow:.2,range:94,heightOffset:-28,radius:42,damage:26,knockback:280,launch:160}]},strikerPistol:{id:"strikerPistol",name:"Striker Pistol",description:"Semi-auto sidearm. Tap fire for consistent ranged pressure.",category:"ranged-short",attackChain:[],projectile:{radius:6,speed:520,damage:14,knockback:90,lifetime:.9,gravityFactor:.25,color:"#ffca7a"},ammo:{magazine:12,reserve:48,reloadSeconds:1.3}},vectorSmg:{id:"vectorSmg",name:"Vector SMG",description:"Rapid PDW prototype tuned for controllable spray.",category:"ranged-mid",attackChain:[],projectile:{radius:5,speed:620,damage:10,knockback:70,lifetime:.85,gravityFactor:.18,color:"#98d8ff"},ammo:{magazine:32,reserve:160,reloadSeconds:2.1},recoil:{horizontal:.6,vertical:1.4,decay:10},spread:{base:1.5,perShot:.6,max:6.5,recovery:3.2}},fragGrenade:{id:"fragGrenade",name:"Frag Grenade",description:"Timed explosive. Toss, bounce, and detonate in a wide area.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.6,explosionRadius:120,damage:45,knockback:260,arcVelocity:{vx:280,vy:-420},gravityFactor:.5,bounciness:.45,color:"#ffb347",radius:16,cooldownSeconds:1.05,explosionDuration:.32,selfDamageScale:.55,selfKnockbackScale:.5,effectType:"explosive"}},flashBang:{id:"flashBang",name:"Flashbang",description:"Blinding charge that staggers enemies caught in the burst.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.2,explosionRadius:160,damage:0,knockback:0,arcVelocity:{vx:260,vy:-420},gravityFactor:.45,bounciness:.4,color:"#f9f2c7",radius:14,cooldownSeconds:1.4,explosionDuration:.24,effectType:"flash",stunDuration:1.8,playerStunDuration:.9}},smokeCanister:{id:"smokeCanister",name:"Smoke Canister",description:"Rapid-deploy screen that slows foes and softens line of sight.",category:"throwable",attackChain:[],throwable:{fuseSeconds:.9,explosionRadius:80,damage:0,knockback:0,arcVelocity:{vx:220,vy:-360},gravityFactor:.52,bounciness:.35,color:"#aeb9c6",radius:18,cooldownSeconds:2.3,explosionDuration:.2,effectType:"smoke",smokeDuration:4.6,smokeRadius:150,smokeExpansion:1.35,smokeSlowMultiplier:.55,smokeTickDuration:.45}},turretDrone:{id:"turretDrone",name:"Deployable Turret",description:"Drops an auto-targeting sentry that covers a lane with suppressive fire.",category:"gadget",attackChain:[],gadget:{type:"turret",cooldownSeconds:3.2,duration:8.5,range:260,fireInterval:.55,maxActive:2,height:54,spawnOffset:{x:70,y:0},baseColor:"#6f7bff",headColor:"#d6dcff",projectile:{speed:540,radius:4,damage:9,knockback:80,lifetime:1.1,color:"#9ae9ff"}}},grappleRig:{id:"grappleRig",name:"Grapple Rig",description:"Launch, latch, and zip to an overhead anchor for quick repositioning.",category:"gadget",attackChain:[],gadget:{type:"grapple",cooldownSeconds:1.8,duration:.6,maxLength:320,maxRise:260,travelSpeed:900,pullSpeed:760,color:"#8cf1ff"}},thunderCannon:{id:"thunderCannon",name:"Thunder Cannon",description:"Supply drop-exclusive launcher that fires high-impact bolts.",category:"ranged-heavy",attackChain:[],projectile:{radius:10,speed:620,damage:42,knockback:260,lifetime:1.2,gravityFactor:.18,color:"#ffd76a"},ammo:{magazine:4,reserve:12,reloadSeconds:2.9},recoil:{horizontal:2.2,vertical:5.4,recovery:6.5},spread:{base:1.5,max:6,increase:1.1,recovery:3.5}},shieldBubble:{id:"shieldBubble",name:"Shield Bubble",description:"Pop a temporary energy shell that soaks damage and keeps you grounded.",category:"gadget",attackChain:[],gadget:{type:"shield",cooldownSeconds:4.5,duration:6,strength:90,radius:96,color:"#7cd6ff"}}},b=["combatFists","shockBaton","strikerPistol","fragGrenade","flashBang","smokeCanister","turretDrone","grappleRig","shieldBubble"],k=document.getElementById("game-canvas"),T=k.getContext("2d");if(!T)throw new Error("Canvas 2D context not available.");const S=k.height-60,M=240,C=1400,I={standing:{headRadius:16,bodyLength:34,legLength:36,armLength:28,strideMultiplier:1,armSwingAmplitude:12,legSwingAmplitude:12},crouching:{headRadius:16,bodyLength:24,legLength:24,armLength:22,strideMultiplier:.6,armSwingAmplitude:6,legSwingAmplitude:6},rolling:{headRadius:16,bodyLength:18,legLength:18,armLength:18,strideMultiplier:0,armSwingAmplitude:0,legSwingAmplitude:0}},A=[{x:-240,y:S-26,width:520,height:26,type:"street"},{x:320,y:S-26,width:420,height:26,type:"street"},{x:820,y:S-26,width:380,height:26,type:"street"},{x:1220,y:S-26,width:520,height:26,type:"street"},{x:40,y:S-120,width:260,height:18,type:"metro"},{x:360,y:S-180,width:280,height:16,type:"rooftop"},{x:680,y:S-240,width:220,height:16,type:"skybridge"},{x:960,y:S-180,width:320,height:18,type:"rooftop"},{x:1240,y:S-140,width:280,height:16,type:"terrace"},{x:1460,y:S-220,width:200,height:14,type:"balcony"},{x:600,y:S-88,width:260,height:14,type:"median"},{x:980,y:S-96,width:320,height:14,type:"median"}],P=[{x:580,width:220,top:S-16,depth:18}],D=[{type:"building",x:-120,y:S-360,width:220,height:360},{type:"building",x:220,y:S-420,width:180,height:420},{type:"building",x:520,y:S-360,width:260,height:360},{type:"building",x:860,y:S-440,width:220,height:440},{type:"building",x:1120,y:S-400,width:260,height:400},{type:"building",x:1400,y:S-360,width:200,height:360},{type:"billboard",x:320,y:S-210,width:180,height:90,text:"Neo District"},{type:"billboard",x:1040,y:S-230,width:200,height:96,text:"Rail 7"},{type:"streetlight",x:180,y:S-160},{type:"streetlight",x:760,y:S-160},{type:"streetlight",x:1280,y:S-160},{type:"hovercar",x:560,y:S-120},{type:"hovercar",x:1180,y:S-150}],R=[{id:"hold",label:"Hold",description:"Regroup on you and stay close.",order:0},{id:"defend",label:"Defend",description:"Form a defensive ring and cover your position.",order:1},{id:"attack",label:"Attack",description:"Press the nearest enemy with ranged fire.",order:2},{id:"flank",label:"Flank",description:"Split wide and pressure the enemy from the side.",order:3}];function B(e){return 2*e.headRadius+e.bodyLength+e.legLength}function E(e=.25*k.width){const t=S-118;return{id:`grunt-${Math.random().toString(36).slice(2,8)}`,spawnX:e,spawnY:t,x:e,y:t,vx:0,vy:0,radius:22,height:118,facing:1,onGround:!0,state:"patrol",stateTimer:1+Math.random(),patrolRange:{min:e-100,max:e+220},aggressionRange:360,attackRange:86,moveSpeed:160,health:120,maxHealth:120,attackCooldown:0,attackWindup:0,attackActive:0,attackDamage:12,attackKnockback:120,attackLaunch:-80,flashTimer:0,shakeTimer:0,shakeMagnitude:0,invulnerability:0,respawnTimer:0,stunTimer:0,smokeSlowTimer:0,smokeSlowStrength:1}}function L(e=0,t="Ally"){const a=.5*k.width+e,n=S-B(I.standing);return{id:`squad-${Math.random().toString(36).slice(2,8)}`,name:t,x:a,y:n,vx:0,vy:0,facing:1,onGround:!0,state:"follow",fireCooldown:0,commandTimer:0,targetEnemyId:null,flashTimer:0,highlight:0,roleIndex:0}}const O={x:.5*k.width,y:S-B(I.standing),vx:0,vy:0,facing:1,onGround:!0,controlMode:"onFoot",vehicleId:null,vehicleCandidateId:null,squadCommandIndex:0,squadCommandId:R[0]?.id??"hold",squadCommandCooldown:0,rolling:!1,rollTimer:0,crouching:!1,currentPose:I.standing,attacking:!1,attackIndex:-1,currentAttack:null,attackElapsed:0,attackInstanceId:0,comboWindowOpen:!1,comboWindowTimer:0,nextAttackQueued:!1,hitboxSpawned:!1,activeHitboxes:[],health:100,maxHealth:100,invulnerability:0,deadTimer:0,throwCooldown:0,gadgetCooldown:0,reloading:!1,stunTimer:0,flashBlindTimer:0,smokeSlowTimer:0,smokeSlowStrength:1,equippedWeaponId:"combatFists"},$=[L(-120,"Sparrow"),L(40,"Rook"),L(120,"Viper")],F=new Map;function H(){return Array.from(F.values())}const W={id:"training-dummy",x:.75*k.width,y:S-120,height:120,radius:26,maxHealth:150,health:150,flashTimer:0,shakeTimer:0,shakeMagnitude:0,respawnTimer:0},N=[E(.24*k.width),E(.68*k.width)],j={inventory:[...b],activeIndex:0};function z(e){return!!function(e){return e>=0&&e<j.inventory.length}(e)&&(j.activeIndex=e,O.equippedWeaponId=j.inventory[e],!0)}function q(){return j.inventory.slice()}function Y(){const e=j.inventory.indexOf(O.equippedWeaponId);e>=0?j.activeIndex=e:(j.inventory[0]=j.inventory[0]??b[0],j.activeIndex=0,O.equippedWeaponId=j.inventory[0])}Y();const G=new Map;function J(e){if(!e)return null;const t=v[e];if(!t)return G.delete(e),null;const a=t.ammo,n=t.spread,o=void 0!==a,i=o?Math.max(0,a.magazine??0):Number.POSITIVE_INFINITY,r=o?Math.max(0,a.reserve??0):Number.POSITIVE_INFINITY,s=o?Math.max(.1,a.reloadSeconds??1.2):0;let l=G.get(e);return l?(l.capacity=i,i===Number.POSITIVE_INFINITY?l.magazine=Number.POSITIVE_INFINITY:l.magazine=o?Math.min(l.magazine,i):i,l.reserve=r,l.reloadSeconds=s,l.spreadDef=n??null,!l.spread&&n&&(l.spread={current:n.base??0}),n||(l.spread=null)):(l={capacity:i,magazine:i===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:i,reserve:r,reloadSeconds:s,reloadTimer:0,reloading:!1,spreadDef:n??null,spread:n?{current:n.base??0}:null},G.set(e,l)),l}function K(e){const t=J(e);return t?{magazine:t.magazine,reserve:t.reserve,capacity:t.capacity,reloading:t.reloading,reloadTimer:t.reloadTimer,reloadSeconds:t.reloadSeconds}:null}function U(e){const t=J(e);return!(!t||t.capacity===Number.POSITIVE_INFINITY||t.reloading||t.magazine>=t.capacity||t.reserve<=0||(t.reloading=!0,t.reloadTimer=t.reloadSeconds,O.equippedWeaponId===e&&(O.reloading=!0),0))}function V(e){const t=J(e);t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.magazine=t.capacity,t.reserve=v[e]?.ammo?.reserve??t.reserve,t.reloading=!1,t.reloadTimer=0)}let X=!1;const _={id:O.equippedWeaponId};function Q(){const e=j.inventory[j.activeIndex];return v[e]??null}function Z(e){const t=O.equippedWeaponId;if(!z(e))return!1;t&&t!==O.equippedWeaponId&&function(e){const t=G.get(e);t&&(t.reloading=!1,t.reloadTimer=0,O.equippedWeaponId===e&&(O.reloading=!1))}(t),J(O.equippedWeaponId),O.attacking=!1,O.currentAttack=null,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.attackIndex=-1,O.hitboxSpawned=!1;const a=K(O.equippedWeaponId);return O.reloading=a?.reloading??!1,_.id=O.equippedWeaponId,!0}Z(j.activeIndex);let ee=null,te=!1;const ae=new Map,ne={"weapon:shot-fired":{frequency:()=>880+220*Math.random(),duration:.08,gain:.05,shape:"square",cooldown:40},"weapon:muzzle-flash":{frequency:()=>760+120*Math.random(),duration:.06,gain:.045,shape:"sawtooth",cooldown:35},"weapon:reload-start":{frequency:210,duration:.18,gain:.08,shape:"triangle",cooldown:120},"weapon:reload-finish":{frequency:320,duration:.16,gain:.09,shape:"triangle",cooldown:120},"weapon:recoil-kick":{frequency:e=>480+60*(e?.recoil?.horizontal??0),duration:.12,gain:.045,shape:"sine",cooldown:90},"shield:hit":{frequency:140,duration:.22,gain:.1,shape:"sine",cooldown:140},"shield:shatter":{frequency:90,duration:.4,gain:.14,shape:"sawtooth",cooldown:260},"shield:end":{frequency:260,duration:.16,gain:.05,shape:"triangle",cooldown:200},"throwable:explosion":{frequency:180,duration:.35,gain:.12,shape:"sawtooth",cooldown:240},"throwable:flash-burst":{frequency:()=>960+180*Math.random(),duration:.18,gain:.07,shape:"triangle",cooldown:220},"throwable:smoke-detonate":{frequency:220,duration:.32,gain:.055,shape:"sine",cooldown:260},"throwable:smoke-dissipate":{frequency:150,duration:.36,gain:.035,shape:"sine",cooldown:320}};function oe(){if(ee||"undefined"==typeof window)return ee;const e=window.AudioContext||window.webkitAudioContext;return e?(ee=new e,ee):null}function ie(){ee&&"suspended"===ee.state&&"function"==typeof ee.resume&&ee.resume().catch(()=>{})}function re(){ie(),window.removeEventListener("pointerdown",re),window.removeEventListener("keydown",re)}function se(){if("undefined"==typeof window||!window.P2P){const e=new Error("P2P module not loaded");throw e.code="P2P_NOT_AVAILABLE",e}return window.P2P}const le=`peer-${Math.random().toString(36).slice(2,8)}`;let de=null,ce=null,fe=null,he=0,ue="disconnected",me=null;const ge=[];function ye(){return de||"undefined"==typeof window||!window.RTCPeerConnection||(de=new RTCPeerConnection({iceServers:[]}),ue="connecting",ce=de.createDataChannel("stickman",{ordered:!0}),pe(ce),de.addEventListener("icecandidate",e=>{e.candidate&&ge.push(JSON.stringify(e.candidate))}),de.addEventListener("connectionstatechange",()=>{ue=de.connectionState??"unknown"}),de.addEventListener("datachannel",e=>{fe=e.channel,pe(fe)})),de}function pe(e){e&&(e.addEventListener("open",()=>{ue="connected"}),e.addEventListener("close",()=>{ue="disconnected"}),e.addEventListener("message",e=>{try{(t=JSON.parse(e.data))&&"object"==typeof t&&"playerState"===t.type&&function(e){if(!e||!e.id)return;const t="undefined"!=typeof performance?performance.now():Date.now(),a=F.get(e.id)??{};F.set(e.id,{id:e.id,name:e.name??a.name??"Remote",x:e.x??a.x??0,y:e.y??a.y??S-B(I.standing),facing:e.facing??a.facing??1,commandId:e.commandId??a.commandId??"hold",lastUpdate:t})}({id:t.id,name:t.name,x:t.x,y:t.y,facing:t.facing,commandId:t.commandId})}catch(e){console.warn("Failed to parse P2P payload",e)}var t}))}function xe(){return{id:le,status:ue,localDescription:me,localCandidates:[...ge]}}const we={servers:[],visible:!1,selectedIndex:0,lastFetch:0,fetching:!1,error:null,statusMessage:null,hosting:!1,hostingSessionId:null,hostingLastHeartbeat:0,hostingExpiresAt:0,joinStatus:null,joinError:null,hostingMetrics:{playerCount:1,enemyCount:0,alliesCount:0},p2p:{offer:null,answer:null,pendingOffer:!1,pendingAnswer:!1,pendingCandidates:!1,localCandidates:[],remoteCandidates:[],error:null}};function ve(){return we}function be(e){we.visible=e,e||(we.statusMessage=null,we.error=null)}function ke(e){const t=we.servers[we.selectedIndex]?.id;if(we.servers=Array.isArray(e)?e:[],t){const e=we.servers.findIndex(e=>e.id===t);e>=0&&(we.selectedIndex=e)}we.selectedIndex>=we.servers.length&&(we.selectedIndex=Math.max(0,we.servers.length-1))}function Te(e){we.error=e}function Se(e){we.statusMessage=e}function Me(e){we.joinStatus=e}function Ce(e){we.joinError=e}function Ie(e){we.joinedSessionId=e??null}function Ae(e){we.lastFetch=e}function Pe(e){we.fetching=e}function De({id:e,expiresAt:t}){we.hosting=Boolean(e),we.hostingSessionId=e??null,we.hostingLastHeartbeat=performance.now(),we.hostingExpiresAt=t??0}function Re(){we.hosting=!1,we.hostingSessionId=null,we.hostingExpiresAt=0,we.hostingLastHeartbeat=0,Fe()}function Be(e){we.p2p.answer=e??null}function Ee(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=we.p2p.localCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(we.p2p.localCandidates=t)}function Le(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=we.p2p.remoteCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(we.p2p.remoteCandidates=t)}function Oe(e){we.p2p.error=e??null}function $e({offer:e,answer:t,candidates:a}){"boolean"==typeof e&&(we.p2p.pendingOffer=e),"boolean"==typeof t&&(we.p2p.pendingAnswer=t),"boolean"==typeof a&&(we.p2p.pendingCandidates=a)}function Fe(){we.p2p.offer=null,we.p2p.answer=null,we.p2p.pendingOffer=!1,we.p2p.pendingAnswer=!1,we.p2p.pendingCandidates=!1,we.p2p.localCandidates=[],we.p2p.remoteCandidates=[],we.p2p.error=null}function He(e,t,a){return Math.max(t,Math.min(a,e))}const We={buggy:{label:"Recon Buggy",movementType:"ground",width:132,height:48,wheelRadius:18,wheelBase:76,driverSeat:{x:-6,y:42},exitOffsets:[{x:72,y:0},{x:-72,y:0}],enterRadius:96,acceleration:540,braking:880,maxSpeed:420,idleDrag:320,airDrag:.92,baseHealth:280,colorBody:"#2e3147",colorAccent:"#ffb84d",colorDetail:"#f7f9ff"},raptorHeli:{label:"Raptor Helicopter",movementType:"air",mountedWeapons:[{id:"raptorHeli.noseCannon",label:"Nose Cannon",binding:"primary",offset:{x:32,y:2},muzzles:[{x:46,y:-3},{x:46,y:3}],projectile:{speed:720,damage:14,radius:4,color:"#8cf4ff",gravityFactor:.04,knockback:70},scatter:3.5,fireInterval:.1,flashDuration:.07,flashRadius:12,barrelLength:52,barrelWidth:5,barrelColor:"#8cf4ff"}],width:156,height:54,driverSeat:{x:6,y:44},exitOffsets:[{x:88,y:0},{x:-88,y:0}],enterRadius:128,horizontalAcceleration:320,horizontalMaxSpeed:300,horizontalDrag:180,idleDrag:140,airDrag:.98,liftPower:880,descendPower:620,gravityScale:.3,maxVerticalSpeed:240,verticalDamping:.9,hoverMinAltitude:28,hoverMaxAltitude:260,spawnHover:60,autopilotStrength:5.2,baseHealth:420,colorBody:"#303952",colorAccent:"#8cf4ff",colorDetail:"#f4fbff",rotorSpan:210,rotorThickness:7,tailLength:86},arrowJet:{label:"Arrow Fighter",movementType:"air",mountedWeapons:[{id:"arrowJet.rackRockets",label:"Wing Rockets",binding:"secondary",offset:{x:12,y:-6},muzzles:[{x:52,y:-12},{x:52,y:12}],projectile:{speed:780,damage:24,radius:6,color:"#ff6b80",gravityFactor:.05,knockback:140},scatter:4,fireInterval:.28,flashDuration:.09,flashRadius:15,barrelLength:54,barrelWidth:5,barrelColor:"#ff6b80"}],width:180,height:36,driverSeat:{x:0,y:32},exitOffsets:[{x:96,y:-8},{x:-96,y:-8}],enterRadius:140,horizontalAcceleration:520,horizontalMaxSpeed:520,horizontalDrag:120,idleDrag:80,airDrag:.99,liftPower:780,descendPower:540,gravityScale:.42,maxVerticalSpeed:280,verticalDamping:.92,hoverMinAltitude:80,hoverMaxAltitude:360,spawnHover:120,autopilotStrength:3.8,baseHealth:350,colorBody:"#262c3e",colorAccent:"#ff6b80",colorDetail:"#f8f8ff",wingSpan:230},tideSkiff:{label:"Tide Skiff",movementType:"water",mountedWeapons:[{id:"tideSkiff.prowCannon",label:"Prow Cannon",binding:"primary",offset:{x:28,y:-18},muzzles:[{x:36,y:-4}],projectile:{speed:560,damage:18,radius:6,color:"#ffdd8a",gravityFactor:.08,knockback:110},scatter:2.5,fireInterval:.22,flashDuration:.1,flashRadius:14,barrelLength:46,barrelWidth:6,barrelColor:"#5fd3ff"}],width:150,height:42,driverSeat:{x:-10,y:34},exitOffsets:[{x:92,y:-4},{x:-92,y:-4}],enterRadius:120,waterSurfaceOffset:28,waterAcceleration:260,waterMaxSpeed:240,waterReverseSpeed:140,waterIdleDrag:180,turnDrag:220,bobAmplitude:6,bobSpeed:1.5,buoyancyPoint:.58,splashIntensity:.4,baseHealth:320,colorBody:"#1f2e3f",colorAccent:"#5fd3ff",colorDetail:"#f5fbff"},stormBarge:{label:"Storm Barge",movementType:"water",mountedWeapons:[{id:"stormBarge.deckChaingun",label:"Deck Chaingun",binding:"primary",offset:{x:18,y:-24},muzzles:[{x:58,y:-6},{x:58,y:6}],projectile:{speed:620,damage:16,radius:5,color:"#ffc86d",gravityFactor:.06,knockback:90},scatter:5,fireInterval:.12,flashDuration:.08,flashRadius:16,barrelLength:58,barrelWidth:6,barrelColor:"#ffa94d"}],width:200,height:60,driverSeat:{x:14,y:46},exitOffsets:[{x:110,y:-6},{x:-110,y:-6}],enterRadius:132,waterSurfaceOffset:32,waterAcceleration:180,waterMaxSpeed:180,waterReverseSpeed:110,waterIdleDrag:260,turnDrag:320,bobAmplitude:4,bobSpeed:1.2,buoyancyPoint:.62,splashIntensity:.3,baseHealth:480,colorBody:"#232f3a",colorAccent:"#ffa94d",colorDetail:"#f0f4ff"},abyssSub:{label:"Abyss Sub",movementType:"water",mountedWeapons:[{id:"abyssSub.torpedoLauncher",label:"Twin Torpedoes",binding:"secondary",offset:{x:12,y:-10},muzzles:[{x:40,y:-6},{x:40,y:6}],projectile:{speed:480,damage:28,radius:7,color:"#8c9eff",gravityFactor:.02,knockback:160},scatter:1.5,fireInterval:.6,flashDuration:.12,flashRadius:18,barrelLength:48,barrelWidth:7,barrelColor:"#8c9eff"}],width:132,height:48,driverSeat:{x:0,y:36},exitOffsets:[{x:78,y:-10},{x:-78,y:-10}],enterRadius:110,waterSurfaceOffset:36,waterAcceleration:300,waterMaxSpeed:260,waterReverseSpeed:160,waterIdleDrag:210,turnDrag:240,bobAmplitude:3,bobSpeed:1.1,buoyancyPoint:.5,submergedOffset:18,splashIntensity:.2,baseHealth:360,colorBody:"#182733",colorAccent:"#8c9eff",colorDetail:"#e9f1ff"},scoutDrone:{label:"Scout Drone",movementType:"air",width:72,height:28,driverSeat:{x:0,y:20},exitOffsets:[{x:48,y:0},{x:-48,y:0}],enterRadius:90,horizontalAcceleration:280,horizontalMaxSpeed:260,horizontalDrag:220,idleDrag:200,airDrag:.95,liftPower:660,descendPower:520,gravityScale:.26,maxVerticalSpeed:200,verticalDamping:.88,hoverMinAltitude:24,hoverMaxAltitude:220,spawnHover:48,autopilotStrength:6.2,baseHealth:180,colorBody:"#293444",colorAccent:"#ffe066",colorDetail:"#edf4ff"}};let Ne=0;function je(e,t,a={}){const n=We[e];if(!n)throw new Error(`Unknown vehicle type: ${e}`);const o=n.movementType??"ground",i=.5*n.width,r=k.width-.5*n.width,s=He(t??.5*k.width,i,r);let l,d=!0,c=null,f=a.hover??n.spawnHover??0;if("air"===o){const e=n.hoverMinAltitude??0,t=He(f,e,n.hoverMaxAltitude??e);l=S-n.height-t,d=!1,f=t}else if("water"===o){const e=n.waterSurfaceOffset??24;c=S-e;const t=He(n.buoyancyPoint??.55,.2,.9),a=n.submergedOffset??0;l=c-n.height*t+a,d=!1,f=0}else l=S-n.height;const h={id:`vehicle-${e}-${Ne+=1}`,type:e,x:s,y:l,vx:0,vy:0,tilt:0,facing:1,driverId:null,health:n.baseHealth,maxHealth:n.baseHealth,enterCooldown:0,damageFlash:0,onGround:d,preferredAltitude:"air"===o?f:0,waterLineY:c,bobPhase:Math.random()*Math.PI*2};return h.mounts=(n.mountedWeapons??[]).map((t,a)=>({id:t.id??`${e}-mount-${a}`,cooldown:0,flashTimer:0,muzzleIndex:0,lastMuzzleX:null,lastMuzzleY:null})),h}const ze=[je("buggy",.14*k.width),je("buggy",.28*k.width),je("tideSkiff",.38*k.width),je("raptorHeli",.56*k.width,{hover:140}),je("arrowJet",.64*k.width,{hover:200}),je("stormBarge",.74*k.width),je("abyssSub",.78*k.width),je("scoutDrone",.9*k.width,{hover:100})];function qe(e){return ze.find(t=>t.id===e)??null}function Ye(e,t,a){return Math.max(t,Math.min(a,e))}let Ge=0;function Je(){return Ge}const Ke={player:[{radius:16,offsetX:0,offsetY:-42,color:"#f4f7ff"},{radius:12,offsetX:0,offsetY:-14,color:"#cfd3df"},{radius:10,offsetX:-14,offsetY:6,color:"#f4f7ff"},{radius:10,offsetX:14,offsetY:6,color:"#f4f7ff"},{radius:11,offsetX:-10,offsetY:34,color:"#cfd3df"},{radius:11,offsetX:10,offsetY:34,color:"#cfd3df"}],enemy:[{radius:16,offsetX:0,offsetY:-40,color:"#fa5b4a"},{radius:12,offsetX:0,offsetY:-12,color:"#d94d3f"},{radius:10,offsetX:-12,offsetY:8,color:"#ff9488"},{radius:10,offsetX:12,offsetY:8,color:"#ff9488"},{radius:11,offsetX:-10,offsetY:36,color:"#d94d3f"},{radius:11,offsetX:10,offsetY:36,color:"#d94d3f"}]},Ue=[];function Ve(e,t,a,n=1,o=0,i=0){const r=Ke[e];if(r)for(const e of r)Ue.push({x:t+e.offsetX*n,y:a+e.offsetY,vx:o+n*(40+80*Math.random())+60*(Math.random()-.5),vy:i-(80+140*Math.random()),radius:e.radius,color:e.color,life:1.6+.8*Math.random(),maxLife:1.6+.8*Math.random()})}const Xe=[];function _e(e,t,a){Xe.push({x:e,y:t,value:a,life:.75,maxLife:.75,vx:24*(Math.random()-.5),vy:-60-20*Math.random()})}const Qe=[];function Ze(e){const t=function(){const e=[];W.health>0&&e.push({id:W.id,x:W.x,y:W.y+.5*W.height});for(const t of N)t.health>0&&e.push({id:t.id,x:t.x,y:t.y+.5*t.height,ref:t});return e}();let a=null,n=1/0;for(const o of t){const t=o.x-e.x,i=o.y-(e.y+.4*e.height),r=t*t+i*i;r<=e.range*e.range&&r<n&&(a=o,n=r)}return a}function et(e,t){const a=e.x,n=e.y+.35*e.height,o=t.x-a,i=t.y-n;e.facing=Math.sign(o)||e.facing;const r=Math.hypot(o,i)||1,s=e.projectile.speed,l=o/r*s;Et({x:a,y:n,vx:l,vy:i/r*s,radius:e.projectile.radius,lifetime:e.projectile.lifetime,color:e.projectile.color,damage:e.projectile.damage,knockback:e.projectile.knockback,facing:Math.sign(l)||1,gravityFactor:0}),e.fireTimer=e.fireInterval}const tt={active:!1,tetherLength:0,maxLength:0,targetX:0,targetY:0,duration:0,retracting:!1,cooldown:0,color:"#8cf1ff",travelSpeed:860,pullSpeed:740};function at(){tt.active=!1,tt.retracting=!1,tt.tetherLength=0,tt.maxLength=0}const nt={active:!1,strength:0,maxStrength:0,duration:0,maxDuration:0,radius:90,color:"#7cd6ff",flashTimer:0};function ot(){const e=2*(O.currentPose?.headRadius??16)+(O.currentPose?.bodyLength??34)+(O.currentPose?.legLength??36);return{x:O.x,y:O.y+.5*e}}function it(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function rt(e="expired"){if(!nt.active)return;const t={reason:e,remainingStrength:nt.strength,maxStrength:nt.maxStrength,duration:nt.duration,maxDuration:nt.maxDuration,center:ot(),radius:nt.radius};nt.active=!1,nt.strength=0,nt.duration=0,nt.flashTimer=0,it("shield:end",t)}function st(e){const t=e?.gadget;if(!t)return!1;if((O.gadgetCooldown??0)>0)return!1;switch(t.type??"turret"){case"turret":return function(e){const t=function(e,t){const a=e.height??54,n=e.spawnOffset??{x:64,y:0},o=B(O.currentPose??null)||0,i=Ye(O.x+t*(n.x??64),40,k.width-40),r=O.y+o,s=Math.min(r+(n.y??0),S),l=Math.min(S-a,s-a);return{id:`turret-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:i,y:l,height:a,facing:t,range:e.range??260,fireInterval:Math.max(.1,e.fireInterval??.6),fireTimer:.1,duration:e.duration??8,maxDuration:e.duration??8,projectile:{speed:e.projectile?.speed??520,radius:e.projectile?.radius??5,damage:e.projectile?.damage??10,knockback:e.projectile?.knockback??70,lifetime:e.projectile?.lifetime??1.1,color:e.projectile?.color??"#9ae9ff"},baseColor:e.baseColor??"#7a8bff",headColor:e.headColor??"#cfd8ff"}}(e,O.facing||1),a=Math.max(1,e.maxActive??1);Qe.length>=a&&Qe.shift(),Qe.push(t)}(t),O.gadgetCooldown=t.cooldownSeconds??2.5,!0;case"grapple":return!(tt.active||(O.gadgetCooldown??0)>0||(function(e){const t=e.clamp??{left:80,right:k.width-80},a=e.apex??{y:S-280},n=e.maxLength??320,o=O.facing||1,i=Ye(O.x+o*n,t.left,t.right),r=Math.min(a.y??S-240,O.y-(e.maxRise??260));tt.active=!0,tt.retracting=!1,tt.tetherLength=0,tt.maxLength=Math.hypot(i-O.x,r-O.y),tt.targetX=i,tt.targetY=r,tt.duration=e.duration??.65,tt.cooldown=e.cooldownSeconds??1.6,tt.color=e.color??"#8cf1ff",tt.travelSpeed=e.travelSpeed??860,tt.pullSpeed=e.pullSpeed??740,O.gadgetCooldown=tt.cooldown}(t),0));case"shield":return function(e={}){const t=e.strength??90;!nt.active&&(nt.active=!0,nt.strength=t,nt.maxStrength=t,nt.duration=e.duration??6,nt.maxDuration=nt.duration,nt.radius=e.radius??96,nt.color=e.color??"#7cd6ff",nt.flashTimer=0,O.gadgetCooldown=e.cooldownSeconds??4.5)}(t),!0;default:return!1}}function lt(e){const t=e.damage??0,a=e.knockback??0;W.health=Math.max(0,W.health-t),W.flashTimer=.18,W.shakeTimer=Math.min(.4,W.shakeTimer+.22),W.shakeMagnitude=Math.min(14,W.shakeMagnitude+a/60);const n=W.y+.55*W.height-W.radius-12;_e(W.x,n,t),0===W.health&&W.respawnTimer<=0&&(W.respawnTimer=2.5)}function dt(e,t){if(e.health<=0||e.invulnerability>0)return;const a=t.damage??0,n=t.knockback??0,o=t.launch??0,i=t.facing??O.facing;e.health=Math.max(0,e.health-a),e.flashTimer=.18,e.shakeTimer=Math.min(.5,e.shakeTimer+.24),e.shakeMagnitude=Math.min(18,e.shakeMagnitude+n/55),e.vx+=n*i*.35,o>0&&(e.vy-=.3*o),_e(e.x+14*e.facing,e.y-14,a),e.invulnerability=.15,0===e.health&&(e.respawnTimer<=0&&Ve("enemy",e.x,e.y,i,e.vx,e.vy),e.state="defeated",e.attackCooldown=1.2,e.respawnTimer=3)}function ct(e,t){if(O.invulnerability>0||O.health<=0)return;const a=t?.damage??e.attackDamage??0,n=t?.knockback??e.attackKnockback??0,o=t?.launch??e.attackLaunch??0,i=t?.facing??e.facing??1;let r=function(e){if(!nt.active)return e;const t=e.damage??0;if(t<=0)return e;const a=Math.min(t,nt.strength);nt.strength-=a,nt.flashTimer=Math.max(nt.flashTimer,.2);const n=ot();it("shield:hit",{absorb:a,remainingStrength:Math.max(0,nt.strength),maxStrength:nt.maxStrength,duration:nt.duration,maxDuration:nt.maxDuration,center:n,radius:nt.radius});const o=t-a,i={...e,damage:o};return o<=0&&(i.damage=0,i.knockback=.25*(e.knockback??0),i.launch=.25*(e.launch??0)),nt.strength<=0&&(it("shield:shatter",{reason:"damage",absorb:a,center:n,maxStrength:nt.maxStrength,radius:nt.radius}),rt("shatter")),i}({damage:a,knockback:n,launch:o,facing:i});const s=r?.damage??0,l=r?.knockback??n,d=r?.launch??o,c=r?.facing??i;s>0?(O.health=Math.max(0,O.health-s),O.invulnerability=.6):O.invulnerability=Math.max(O.invulnerability,.2),O.vx+=l*c,O.vy+=d,_e(O.x,O.y+10,Math.max(0,Math.round(s))),s>0&&0===O.health&&O.deadTimer<=0&&(O.deadTimer=2.6,O.attacking=!1,O.activeHitboxes=[],O.comboWindowOpen=!1,O.attackIndex=-1,O.rolling=!1,Ve("player",O.x,O.y,-c,O.vx,O.vy))}const ft={concreteBarrier:{maxHealth:600,width:180,height:110,rubbleHeight:34,material:"concrete",bodyColor:"#4c5564",edgeColor:"#2a313c",accentColor:"#9aa4b4",damageHighlight:"#d5dde8",debrisColor:"#3a424f",smokeDuration:2.4,shakeFactor:16},streetCar:{maxHealth:420,width:168,height:90,rubbleHeight:38,material:"vehicle",bodyColor:"#ba3c38",edgeColor:"#1c1d25",accentColor:"#f4f7fb",glassColor:"#4ac3ff",damageHighlight:"#ffe5dc",debrisColor:"#5a1f1a",smokeDuration:3.4,shakeFactor:22,deathBlast:{radius:140,maxDamage:160,knockback:320,minDamageRatio:.32}},fuelBarrelCluster:{maxHealth:220,width:96,height:96,rubbleHeight:28,material:"volatile",bodyColor:"#c0671c",edgeColor:"#2f1a08",accentColor:"#ffe7ba",stripeColor:"#ffd45f",damageHighlight:"#ffd4a1",debrisColor:"#6e2c05",smokeDuration:4.2,shakeFactor:26,deathBlast:{radius:180,maxDamage:240,knockback:400,minDamageRatio:.4}}},ht=S-26;const ut=[{id:"neo-barrier-west",type:"concreteBarrier",x:260,baseY:S},{id:"neo-barrier-east",type:"concreteBarrier",x:1140,baseY:S},{id:"neo-car-market",type:"streetCar",x:620,baseY:S,facing:-1},{id:"neo-car-docks",type:"streetCar",x:1340,baseY:S,facing:1},{id:"neo-barrels-market",type:"fuelBarrelCluster",x:440,baseY:ht},{id:"neo-barrels-rail",type:"fuelBarrelCluster",x:920,baseY:ht}].map(e=>function(e){const t=ft[e.type];if(!t)throw new Error(`Unknown destructible template: ${e.type}`);const a=e.width??t.width,n=e.height??t.height;return{id:e.id,type:e.type,template:t,x:e.x,y:e.baseY,width:a,height:n,halfWidth:a/2,health:t.maxHealth,maxHealth:t.maxHealth,destroyed:!1,flashTimer:0,shakeTimer:0,shakeMagnitude:0,smokeTimer:0,rubbleLevel:0,deathTriggered:!1,facing:e.facing??1,spawnConfig:{...e}}}(e)),mt=[],gt=[];let yt=!1;function pt(e={}){const t=e.ttl??.4,a={x:e.x??0,y:e.y??0,startRadius:e.startRadius??70,endRadius:e.endRadius??140,color:e.color??"#ffffff",maxTtl:t,ttl:t,lineWidth:e.lineWidth??5};return gt.push(a),a}function xt(e={},t={}){const a=e.center??{x:e.x??0,y:e.y??0};return pt({x:a.x,y:a.y,ttl:t.ttl??.4,startRadius:t.startRadius??e.radius??70,endRadius:t.endRadius??1.25*(e.radius??70),color:t.color??"#7cd6ff",lineWidth:t.lineWidth??5})}function wt(e={}){const t=e.center??{x:0,y:0};for(let e=0;e<9;e+=1){const e=Math.random()*Math.PI*2,a=90+150*Math.random(),n=Math.cos(e)*a,o=Math.sin(e)*a,i=.3+.2*Math.random();mt.push({type:"shield",x:t.x,y:t.y,vx:n,vy:o,ttl:i,maxTtl:i,radius:6+6*Math.random(),color:"#9be9ff"})}xt(e,{ttl:.35,startRadius:.75*(e.radius??72),endRadius:1.15*(e.radius??72),lineWidth:4,color:"#a9f0ff"})}function vt(){yt||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",e=>{!function(e={}){const t=e.x??0,a=e.y??0,n=e.facing??1;for(let e=0;e<6;e+=1){const e=140+120*Math.random(),o=.6*Math.random()-.3+(n>0?0:Math.PI),i=Math.cos(o)*e,r=Math.sin(o)*e,s=.18+.08*Math.random();mt.push({type:"spark",x:t,y:a,vx:i,vy:r,ttl:s,maxTtl:s,radius:4+3*Math.random(),color:"#ffdd9a"})}}(e?.detail??{})}),window.addEventListener("shield:hit",e=>{wt(e?.detail??{})}),window.addEventListener("shield:shatter",e=>{!function(e={}){xt(e,{ttl:.55,startRadius:.9*(e.radius??96),endRadius:1.6*(e.radius??96),lineWidth:7,color:"#7cd6ff"}),wt({center:e.center,radius:e.radius??96})}(e?.detail??{})}),window.addEventListener("throwable:explosion",e=>{bt(e?.detail??{})}),window.addEventListener("throwable:flash-burst",e=>{!function(e={}){const t=e.x??0,a=e.y??0,n=e.radius??140;pt({x:t,y:a,startRadius:.6*n,endRadius:1.35*n,color:"#fff6d0",lineWidth:8,ttl:.32});for(let e=0;e<12;e+=1){const e=Math.random()*Math.PI*2,n=160+140*Math.random(),o=.18+.08*Math.random();mt.push({type:"flash",x:t,y:a,vx:Math.cos(e)*n,vy:Math.sin(e)*n,ttl:o,maxTtl:o,radius:5+3*Math.random(),color:"#fffbe0"})}}(e?.detail??{})}),window.addEventListener("throwable:smoke-spawn",e=>{kt(e?.detail??{})}),window.addEventListener("throwable:smoke-dissipate",e=>{!function(e={}){pt({x:e.x??0,y:e.y??0,startRadius:.8*(e.radius??110),endRadius:1.1*(e.radius??110),color:"#95a8b8",lineWidth:3,ttl:.4})}(e?.detail??{})}),window.addEventListener("destructible:hit",e=>{!function(e={}){const t={concrete:["#dfe6f2","#b9c3d0","#6c7584"],vehicle:["#ffd6c8","#ff9a82","#3a1a1a"],volatile:["#ffd38a","#ff9c3b","#6e2c05"],generic:["#f2f5ff","#c9d0de"]},a=t[e.material??"generic"]??t.generic,n=Math.max(1,e.maxHealth??e.health??1),o=Ye(1-Math.max(0,Math.min(n,e.health??n))/n,0,1),i=Math.max(6,Math.round(6+6*o)),r=160+200*o;for(let t=0;t<i;t+=1){const n=Math.random()*Math.PI*2,o=r*(.45+.65*Math.random());mt.push({type:"debris",x:e.x??0,y:e.y??0,vx:Math.cos(n)*o,vy:Math.sin(n)*o*.7-50,ttl:.45+.3*Math.random(),maxTtl:.45+.3*Math.random(),radius:3+4*Math.random(),color:a[t%a.length]})}}(e?.detail??{})}),yt=!0)}function bt(e={}){const t=e.x??0,a=e.y??0,n=e.radius??110;for(let e=0;e<18;e+=1){const e=Math.random()*Math.PI*2,n=220+220*Math.random(),o=.3+.25*Math.random();mt.push({type:"ember",x:t,y:a,vx:Math.cos(e)*n,vy:Math.sin(e)*n,ttl:o,maxTtl:o,radius:5+4*Math.random(),color:Math.random()>.55?"#ff9c4a":"#ffd56b"})}pt({x:t,y:a,startRadius:.45*n,endRadius:1.05*n,color:"#ffb347",lineWidth:6,ttl:.45})}function kt(e={}){const t=e.x??0,a=e.y??0,n=e.radius??e.maxRadius??120;for(let e=0;e<14;e+=1){const e=Math.random()*Math.PI*2,o=30+60*Math.random(),i=Math.cos(e)*o*.4,r=-40-50*Math.random(),s=.9+.5*Math.random();mt.push({type:"smoke",x:t+Math.cos(e)*n*.2,y:a+Math.sin(e)*n*.1,vx:i,vy:r,ttl:s,maxTtl:s,radius:n*(.15+.18*Math.random()),color:"#aec4d8"})}pt({x:t,y:a,startRadius:.5*n,endRadius:1.2*n,color:"#9db8ca",lineWidth:4,ttl:.5})}function Tt(e,t,a=.25){const n=Ye(1-e/Math.max(1,t),0,1);return Ye(a+n*(1-a),0,1)}function St({x:e,y:t,radius:a,maxDamage:n=0,maxKnockback:o=0,minDamageRatio:i=.25,selfDamageScale:r=1,selfKnockbackScale:s=1,includeTrainingDummy:l=!0,includeEnemies:d=!0,includePlayer:c=!0}){const f={dummyHit:!1,enemiesHit:0,playerHit:!1},h=Math.max(0,n),u=Math.max(0,o??1.2*h),m=Math.max(1,a),g=Ye(i,0,1);if(l&&W.health>0){const a=W.x,n=W.y+.55*W.height,o=Math.hypot(a-e,n-t);if(o<=m){const t=Tt(o,m,g),n=u*t;lt({damage:h*t,knockback:n,launch:.18*n,facing:a>=e?1:-1}),f.dummyHit=!0}}if(d)for(const a of N){if(a.health<=0)continue;const n=a.x,o=a.y+.5*a.height,i=Math.hypot(n-e,o-t);if(i>m)continue;const r=Tt(i,m,g),s=h*r,l=u*r;s<=0&&l<=0||(dt(a,{damage:s,knockback:l,launch:.24*l,facing:n>=e?1:-1}),f.enemiesHit+=1)}if(c&&O.health>0){const a=B(O.currentPose??{headRadius:16,bodyLength:34,legLength:36}),n=O.y+.6*a,o=Math.hypot(O.x-e,n-t);if(o<=m){const t=Tt(o,m,g),a=Math.max(0,h*t*r),n=u*t*s,i=O.x>=e?1:-1;(a>0||n>0)&&(ct(null,{damage:a,knockback:n,launch:.25*n,facing:i}),f.playerHit=!0)}}return f}function Mt(e){const t=e.halfWidth??e.width/2;return{left:e.x-t,right:e.x+t,top:e.y-e.height,bottom:e.y}}function Ct(e,t,a,n){const{left:o,right:i,top:r,bottom:s}=Mt(n),l=e-Ye(e,o,i),d=t-Ye(t,r,s);return l*l+d*d<=a*a}function It(e,t,a){const{left:n,right:o,top:i,bottom:r}=Mt(a),s=Math.max(n-e,0,e-o),l=Math.max(i-t,0,t-r);return Math.hypot(s,l)}function At(e,t={}){if(!e||e.destroyed)return{applied:!1,destroyed:!1};const a=e.template,n=Math.max(0,t.damage??0);if(n<=0)return{applied:!1,destroyed:!1};const o=Math.min(n,e.health);e.health=Math.max(0,e.health-o),e.flashTimer=.2,e.shakeTimer=Math.min(.45,e.shakeTimer+.18+o/e.maxHealth*.3);const i=a?.shakeFactor??14;e.shakeMagnitude=Math.max(.6*e.shakeMagnitude,i*(.35+o/e.maxHealth*1.2)),e.smokeTimer=Math.min(a?.smokeDuration??0,(e.smokeTimer??0)+.5),function(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:hit",{detail:{id:e.id,type:e.type,material:e.template?.material??"generic",cause:t.cause??"impact",x:t.impactX??e.x,y:t.impactY??e.y-.5*e.height,health:e.health,maxHealth:e.maxHealth}}))}(e,t);let r=!1;return e.health<=0&&(e.destroyed=!0,e.rubbleLevel=Math.max(e.rubbleLevel,.05),e.smokeTimer=a?.smokeDuration??0,function(e,t={}){const a=e.template;if(!a||e.deathTriggered)return;e.deathTriggered=!0;const n=t.impactX??e.x,o=t.impactY??e.y-.35*e.height;if(bt({x:n,y:o,radius:.8*Math.max(e.width,e.height)}),kt({x:n,y:o,radius:Math.max(e.width,e.height),maxRadius:.6*(a.deathBlast?.radius??1.2*e.width)}),pt({x:n,y:o,startRadius:.35*e.width,endRadius:1.1*e.width,color:"#ffb347",ttl:.55,lineWidth:5}),a.deathBlast){const t=a.deathBlast;"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:explosion",{detail:{id:e.id,x:n,y:o,radius:t.radius}})),St({x:n,y:o,radius:t.radius,maxDamage:t.maxDamage,maxKnockback:t.knockback,minDamageRatio:t.minDamageRatio??.25}),Pt({x:n,y:o,radius:t.radius,maxDamage:t.maxDamage,minDamageRatio:t.minDamageRatio??.25,sourceId:e.id,cause:"chain-explosion"})}}(e,t),r=!0),{applied:!0,destroyed:r}}function Pt({x:e,y:t,radius:a,maxDamage:n,minDamageRatio:o=.25,sourceId:i=null,cause:r="explosion"}){const s=Math.max(0,n??0);if(s<=0||a<=0)return 0;const l=Ye(o,0,1);let d=0;for(const n of ut){if(n.id===i||n.destroyed&&n.deathTriggered)continue;const o=It(e,t,n);if(o>a)continue;const c=s*Tt(o,a,l);c<=0||At(n,{damage:c,cause:r,impactX:Ye(e,n.x-n.halfWidth,n.x+n.halfWidth),impactY:Ye(t,n.y-n.height,n.y)}).applied&&(d+=1)}return d}function Dt(e){for(const t of ut)if(!t.destroyed&&Ct(e.x,e.y,e.radius,t))return At(t,{damage:e.damage??0,cause:"projectile",impactX:e.x,impactY:e.y}),!0;return!1}function Rt(e){let t=!1;for(const a of ut)a.destroyed||e.hitTargets.has(a.id)||Ct(e.x,e.y,e.radius,a)&&(e.hitTargets.add(a.id),At(a,{damage:e.damage??0,cause:"melee",impactX:e.x,impactY:e.y}),t=!0);return t}const Bt=[];function Et({x:e,y:t,vx:a,vy:n,radius:o=6,lifetime:i=1.4,color:r="#ffcf7a",damage:s=0,knockback:l=0,facing:d=1,gravityFactor:c=.2}){Bt.push({x:e,y:t,vx:a,vy:n,radius:o,life:i,maxLife:i,color:r,damage:s,knockback:l,facing:d,gravityFactor:c,hitTargets:new Set})}function Lt(e,t,a,n,o,i){const r=e-n,s=t-o,l=a+i;return r*r+s*s<=l*l}const Ot=[],$t=[];function Ft(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function Ht(e){if(e.detonated)return;e.detonated=!0,e.explosionTimer=Math.max(e.explosionDuration,.08),e.fuse=0;const t={id:e.id,effectType:e.effectType,x:e.x,y:e.y,radius:e.explosionRadius};switch(e.effectType){case"flash":!function(e){const{x:t,y:a,explosionRadius:n,stunDuration:o,playerStunDuration:i}=e,r=Math.max(.1,o);if(W.health>0){const e=W.x-t,o=W.y+.55*W.height-a;Math.hypot(e,o)<=n&&(W.flashTimer=Math.max(W.flashTimer,.6*r),W.shakeTimer=Math.max(W.shakeTimer,.5*r),W.shakeMagnitude=Math.max(W.shakeMagnitude,14))}for(const e of N){if(e.health<=0)continue;const o=e.x-t,i=e.y+.5*e.height-a;Math.hypot(o,i)<=n&&(e.stunTimer=Math.max(e.stunTimer??0,r),e.flashTimer=Math.max(e.flashTimer,.7*r),e.shakeTimer=Math.max(e.shakeTimer,.4*r),e.shakeMagnitude=Math.max(e.shakeMagnitude,12))}if(i>0&&O.health>0){const e=B(O.currentPose??{headRadius:16,bodyLength:34,legLength:36}),o=O.y+.6*e,r=O.x-t,s=o-a;Math.hypot(r,s)<=n&&(O.flashBlindTimer=Math.max(O.flashBlindTimer??0,i),O.stunTimer=Math.max(O.stunTimer??0,.6*i))}}(e),t.radius=e.explosionRadius,t.stunDuration=e.stunDuration,t.playerStunDuration=e.playerStunDuration,Ft("throwable:flash-burst",{...t,stunDuration:e.stunDuration,playerStunDuration:e.playerStunDuration});break;case"smoke":{const a=function(e){const t=Math.max(.5,e.smokeDuration),a=Math.max(40,e.smokeRadius),n={id:`smoke-${Date.now()}-${Math.random().toString(36).slice(2,5)}`,x:e.x,y:e.y,radius:a,baseRadius:a,maxRadius:a*(e.smokeExpansion??1.1),duration:t,life:t,slowMultiplier:Ye(e.smokeSlowMultiplier??.55,.1,1),tick:e.smokeTickDuration??.5,tickTimer:0};return $t.push(n),Ft("throwable:smoke-spawn",{id:n.id,x:n.x,y:n.y,radius:n.radius,maxRadius:n.maxRadius,duration:n.duration}),n}(e);t.radius=a.maxRadius,t.duration=a.duration,t.cloudId=a.id,Ft("throwable:smoke-detonate",{...t,radius:a.maxRadius,duration:a.duration,cloudId:a.id});break}default:(function(e){const{x:t,y:a,explosionRadius:n,damage:o,knockback:i}=e;St({x:t,y:a,radius:n,maxDamage:o,maxKnockback:i,minDamageRatio:e.damageFalloff??.3,selfDamageScale:e.selfDamageScale??1,selfKnockbackScale:e.selfKnockbackScale??1}),o>0&&Pt({x:t,y:a,radius:n,maxDamage:o,minDamageRatio:e.destructibleFalloff??.35,cause:e.effectType??"explosion"}),function(e={}){const t=e.x??0,a=e.y??0,n=e.count??14,o=(e.radius,e.speed??260),i=e.palette??["#ffdd9a","#f7a24a","#b55628","#5b4340"];for(let r=0;r<n;r+=1){const n=Math.random()*Math.PI*2,s=o*(.45+.65*Math.random()),l=.6*(Math.random()-.5);mt.push({type:"debris",x:t+Math.cos(n)*(e.offsetRadius??0),y:a+Math.sin(n)*(e.offsetRadius??0),vx:Math.cos(n+l)*s,vy:Math.sin(n+l)*s*.7-60,ttl:.4+.3*Math.random(),maxTtl:.4+.3*Math.random(),radius:3+4*Math.random(),color:i[r%i.length]})}}({x:t,y:a,radius:n,count:Math.max(10,Math.round(n/10)),speed:220+.5*Math.max(0,i??0)})})(e),t.damage=e.damage,t.knockback=e.knockback,Ft("throwable:explosion",{...t,damage:e.damage,knockback:e.knockback})}Ft("throwable:detonate",t)}const Wt={ammo:{id:"ammo",label:"Ammo Cache",description:"Refills magazines and reserves for all weapons.",weight:.45,crateColor:"#4d7cff",glowColor:"#b5c8ff"},medkit:{id:"medkit",label:"Field Medkit",description:"Restores health and grants brief damage resistance.",weight:.35,crateColor:"#ff6f6f",glowColor:"#ffb4b4"},heavy:{id:"heavy",label:"Heavy Arsenal",description:"Drops a powerful heavy weapon with fresh ammo.",weight:.2,crateColor:"#ffb347",glowColor:"#ffe0a3",weaponId:"thunderCannon"}},Nt=[],jt={nextDropTimer:18,nextDropTypeId:zt(),incomingMessage:null,incomingTimer:0,incomingDuration:3,rewardMessage:null,rewardTimer:0,rewardDuration:3.5,dropSequence:0};function zt(){const e=Object.values(Wt);if(0===e.length)return null;const t=e.reduce((e,t)=>e+(t.weight??1),0);let a=Math.random()*t;for(const t of e){const e=t.weight??1;if(a<=e)return t.id;a-=e}return e[e.length-1].id}function qt(e){switch(e){case"medkit":O.health=Math.min(O.maxHealth,O.health+70),O.invulnerability=Math.max(O.invulnerability,.4),jt.rewardMessage="Health restored";break;case"heavy":(function(){const e=Wt.heavy,t=e?.weaponId??null;t&&v[t]&&(function(e,{autoEquip:t=!1}={}){if(!e||!v[e])return!1;let a=j.inventory.indexOf(e);-1===a&&(j.inventory.push(e),a=j.inventory.length-1),t?z(a):Y()}(t,{autoEquip:!0}),J(t),V(t))})(),jt.rewardMessage="Heavy weapon acquired";break;default:!function(){const e=q();for(const t of e){const e=J(t);e&&e.capacity!==Number.POSITIVE_INFINITY&&V(t)}O.reloading=!1}(),jt.rewardMessage="Ammo resupply"}jt.rewardTimer=jt.rewardDuration}function Yt(e,t){const a=O.x,n=O.currentPose??POSES.standing,o=O.y+B(n),i=a-e.x,r=o-(e.y+.5*e.height);return Math.hypot(i,r)<=68?(e.highlight=Ye(e.highlight+4*t,0,1),!0):(e.highlight=Ye(e.highlight-2*t,0,1),!1)}function Gt(e){qt(e.typeId),e.state="collected",e.despawnTimer=3.5,e.highlight=1}function Jt(e){jt.nextDropTimer-=e,jt.nextDropTimer<=0&&Nt.length<3&&(function(e){const t=Wt[e]??Wt.ammo,a=Ye(k.width*(.2+.6*Math.random()),31.2,k.width-31.2),n={id:`supply-${jt.dropSequence+=1}`,typeId:t.id,label:t.label,description:t.description,crateColor:t.crateColor??"#4d7cff",glowColor:t.glowColor??"#9ab5ff",width:52,height:42,x:a,y:-280,vx:18*(2*Math.random()-1),vy:0,state:"descending",timer:0,highlight:0,despawnTimer:12,parachutePhase:0};Nt.push(n),jt.incomingMessage=`${t.label} inbound!`,jt.incomingTimer=jt.incomingDuration}(jt.nextDropTypeId),jt.nextDropTimer=26+12*Math.random(),jt.nextDropTypeId=zt()),jt.incomingTimer>0&&(jt.incomingTimer=Math.max(0,jt.incomingTimer-e)),jt.rewardTimer>0&&(jt.rewardTimer=Math.max(0,jt.rewardTimer-e));for(let t=Nt.length-1;t>=0;t-=1){const a=Nt[t];if(a.timer+=e,"descending"===a.state)a.vy=Math.min(180,a.vy+140*e),a.y+=a.vy*e,a.x=Ye(a.x+a.vx*e,.5*a.width,k.width-.5*a.width),a.parachutePhase+=e,a.y>=S-a.height&&(a.y=S-a.height,a.vy=0,a.state="ready",a.timer=0);else if("ready"===a.state){if(Yt(a,e))Gt(a);else if(a.despawnTimer-=e,a.despawnTimer<=0){Nt.splice(t,1);continue}}else if("collected"===a.state&&(a.highlight=Ye(a.highlight-.6*e,0,1),a.despawnTimer-=e,a.despawnTimer<=0)){Nt.splice(t,1);continue}}}function Kt(e){const t="collected"===e.state?Ye(e.despawnTimer/3.5,0,1):1;if(T.save(),T.globalAlpha=t,"descending"===e.state){const t=1.8*e.width,a=.9*e.height;T.fillStyle=e.glowColor,T.beginPath(),T.moveTo(e.x-.5*t,e.y+.2*a),T.quadraticCurveTo(e.x,e.y-.8*a,e.x+.5*t,e.y+.2*a),T.closePath(),T.fill(),T.strokeStyle=e.glowColor,T.lineWidth=2,T.beginPath(),T.moveTo(e.x-.3*t,e.y+.25*a),T.lineTo(e.x-.25*e.width,e.y+.1*e.height),T.moveTo(e.x+.3*t,e.y+.25*a),T.lineTo(e.x+.25*e.width,e.y+.1*e.height),T.stroke()}const a=e.glowColor,n=e.crateColor,o=e.highlight??0;T.fillStyle=n,T.fillRect(e.x-.5*e.width,e.y,e.width,e.height),T.fillStyle=a,T.fillRect(e.x-.5*e.width,e.y-.25*e.height,e.width,.25*e.height),T.strokeStyle="rgba(12, 16, 24, 0.65)",T.lineWidth=3,T.strokeRect(e.x-.5*e.width,e.y,e.width,e.height),o>0&&(T.globalAlpha=.6*o,T.fillStyle=e.glowColor,T.beginPath(),T.arc(e.x,e.y+.5*e.height,68,0,2*Math.PI),T.fill()),T.restore()}function Ut(e,t){const a=e.template;if(!a)return;const n=e.shakeMagnitude??0,o=e.shakeTimer??0,i=8*t+.05*e.x,r=o>0?Math.sin(i)*n*.35:0,s=o>0?Math.cos(.75*i)*n*.22:0;if(T.save(),T.translate(e.x+r,e.y+s),e.destroyed&&function(e,t,a){const n=e.width,o=Math.max(8,(t.rubbleHeight??32)*a),i=t.debrisColor??t.bodyColor??"#4a4a4a";T.fillStyle=i,T.beginPath(),T.moveTo(-n/2,0),T.lineTo(.35*-n,.3*-o),T.lineTo(.12*-n,-o),T.lineTo(.08*n,.65*-o),T.lineTo(.32*n,.9*-o),T.lineTo(n/2,0),T.closePath(),T.fill(),T.fillStyle="rgba(30, 32, 40, 0.6)",T.fillRect(-n/2,0,n,Math.max(6,.2*o))}(e,a,Ye(e.rubbleLevel??0,0,1)),!e.destroyed||(e.rubbleLevel??0)<1)switch(a.material){case"vehicle":!function(e,t){const a=e.width,n=e.height,o=-n,i=e.facing??1,r=Ye(1-e.health/e.maxHealth,0,1);T.save(),T.scale(i,1);const s=t.bodyColor??"#b13d30",l=t.glassColor??"#4ac3ff",d=t.accentColor??"#f7f9ff",c=t.edgeColor??"#1c1d25",f=o+.15*n,h=.55*n,u=Math.max(12,.18*n);T.fillStyle=s,T.beginPath(),T.moveTo(-a/2,f+.1*n),T.lineTo(.42*-a,o+.45*h),T.lineTo(.25*-a,o),T.lineTo(.22*a,o),T.lineTo(.45*a,o+.5*h),T.lineTo(a/2,f+.1*n),T.closePath(),T.fill(),T.fillStyle=l;const m=.55*h;T.fillRect(.28*-a,o+.12*h,.42*a,m),T.fillStyle=d,T.fillRect(-a/2,f+.55*h,a,.2*n),T.fillStyle=c,T.beginPath(),T.arc(.28*-a,-.15*u,u,0,2*Math.PI),T.arc(.28*a,-.15*u,u,0,2*Math.PI),T.fill(),!e.destroyed&&r>.05&&(T.strokeStyle="rgba(0, 0, 0, 0.35)",T.lineWidth=2,T.beginPath(),T.moveTo(.12*-a,o+.8*h),T.lineTo(.22*-a,f+.55*n),T.lineTo(.05*-a,f+.7*n),T.stroke(),T.beginPath(),T.moveTo(.18*a,o+.6*h),T.lineTo(.3*a,f+.4*n),T.lineTo(.12*a,f+.65*n),T.stroke()),T.restore()}(e,a);break;case"volatile":!function(e,t,a){const n=e.width,o=e.height,i=Ye(1-e.health/e.maxHealth,0,1),r=.22*n,s=.48*o,l=-o,d=t.bodyColor??"#c0671c",c=t.stripeColor??t.accentColor??"#ffd45f",f=t.edgeColor??"#2f1a08",h=[{x:.22*-n,y:l+.45*o},{x:.22*n,y:l+.5*o},{x:0,y:l+.1*o}],u=e.destroyed?1:3;for(let e=0;e<u;e+=1){const t=h[e];T.save(),T.translate(t.x,t.y),T.fillStyle=d,T.beginPath(),T.ellipse(0,0,r,.5*s,0,0,2*Math.PI),T.fill(),T.fillRect(-r,.5*-s,2*r,s),T.fillStyle=c,T.fillRect(-r,.12*-s,2*r,.24*s),T.strokeStyle=f,T.lineWidth=3,T.strokeRect(-r,.5*-s,2*r,s),T.restore()}if(!e.destroyed&&i>.2){const t=.2+.3*Math.abs(Math.sin(8*a+.05*e.x))*i;T.fillStyle=`rgba(255, 174, 72, ${t.toFixed(3)})`,T.beginPath(),T.ellipse(0,l+.1*o,.12*n,.18*o,0,0,2*Math.PI),T.fill()}}(e,a,t);break;default:!function(e,t,a){const n=e.width,o=e.height,i=-o,r=t.bodyColor??"#555",s=t.accentColor??"#888",l=t.edgeColor??"#333",d=t.damageHighlight??"#d5dde8",c=Ye(1-e.health/e.maxHealth,0,1);if(T.fillStyle=r,T.fillRect(-n/2,i,n,o),T.fillStyle=s,T.fillRect(-n/2,i,n,Math.max(10,.12*o)),T.fillRect(-n/2,i+.55*o,n,Math.max(8,.1*o)),T.strokeStyle=l,T.lineWidth=4,T.strokeRect(-n/2,i,n,o),c>0){const t=3+Math.floor(3*c),r=3*a+.02*e.x;T.strokeStyle=d,T.lineWidth=2;for(let e=0;e<t;e+=1){const a=.45*-n+n*((e+1)/(t+1)),s=o*(.2+.5*c),l=12*Math.sin(r+1.7*e);T.beginPath(),T.moveTo(a,i+.18*o),T.lineTo(a+.3*l,i+.18*o+.45*s),T.lineTo(a+l,i+.18*o+s),T.stroke()}}}(e,a,t)}if(!e.destroyed&&e.maxHealth>0){const t=Ye(e.health/e.maxHealth,0,1);t<.95&&function(e,t,a){const n=Ye(t,0,1),o=.85*e;T.fillStyle="rgba(0, 0, 0, 0.45)",T.fillRect(-o/2,a,o,5),T.fillStyle=n>.5?"#58ec8c":n>.25?"#ffd15c":"#ff675c",T.fillRect(-o/2,a,o*n,5)}(e.width,t,-e.height-10)}const l=e.flashTimer??0;if(l>0){const t=.45*Ye(l/.2,0,1);T.fillStyle=`rgba(255, 255, 255, ${t.toFixed(3)})`,T.fillRect(-e.width/2,-e.height,e.width,e.height)}!function(e,t,a){if((e.smokeTimer??0)<=0)return;const n=t.smokeDuration??1.5,o=Ye((e.smokeTimer??0)/n,0,1),i=.25+.35*o;for(let t=0;t<4;t+=1){const n=a*(.4+.15*t)+.03*e.x+1.3*t,r=.35*e.width*(1+.6*o+.15*t);T.globalAlpha=Ye(i-.06*t,0,.45),T.fillStyle="#9fb6c8",T.beginPath(),T.arc(Math.sin(n)*e.width*.12,-e.height*(.65+.2*t)-6*Math.cos(.6*n),.3*r,0,2*Math.PI),T.fill()}T.globalAlpha=1}(e,a,t),T.restore()}const Vt=[],Xt=[],_t=[],Qt=[],Zt=[],ea={weapons:!0,shield:!0,throwables:!0},ta={Digit6:"weapons",Digit7:"shield",Digit8:"throwables"};function aa(e,t=1.8){const a=Qt[Qt.length-1];if(a&&a.message===e)return a.ttl=t,a.maxTtl=t,void(a.age=0);for(Qt.push({message:e,ttl:t,maxTtl:t,age:0});Qt.length>6;)Qt.shift()}function na(e,t={},a=.4){const n={type:e,x:t.x??O.x,y:t.y??O.y,radius:t.radius??110,ttl:a,maxTtl:a};return _t.push(n),n}function oa(e){return!1!==ea[e]}function ia(e){if(!e.altKey||e.repeat)return;const t=ta[e.code];t&&("function"==typeof e.preventDefault&&e.preventDefault(),function(e){ea[e]=!ea[e],aa(`Debug filter ${e.charAt(0).toUpperCase()+e.slice(1)} ${ea[e]?"ON":"OFF"}`,1.4),ea[e]||("weapons"===e?(Vt.length=0,Zt.length=0):"shield"===e?Xt.length=0:"throwables"===e&&(_t.length=0))}(t))}function ra(e){if(!oa("weapons"))return;const t=e?.detail??{};Vt.push({weaponId:t.weaponId??"unknown",x:t.x??O.x,y:t.y??O.y,facing:t.facing??O.facing??1,ttl:.12,maxTtl:.12})}function sa(e){if(!oa("weapons"))return;const t=.4,a=(e?.detail??{}).weaponId??"unknown",n=Zt.find(e=>e.weaponId===a);if(n)return n.ttl=t,n.maxTtl=t,void(n.age=0);for(Zt.push({weaponId:a,ttl:t,maxTtl:t,age:0});Zt.length>5;)Zt.shift()}function la(e){oa("weapons")&&aa(`Reloading ${e?.detail?.weaponId??"unknown"}`)}function da(e){oa("weapons")&&aa(`Reload complete ${e?.detail?.weaponId??"unknown"}`,1.4)}function ca(e){if(!oa("weapons"))return;const t=e?.detail??{},a=t.weaponId??"unknown",n=t.recoil?.horizontal??0,o=t.recoil?.vertical??0,i=Math.hypot(n,o);i<=0||aa(`Recoil ${a}: ${i.toFixed(2)}`,1.2)}function fa(e){if(!oa("shield"))return;const t=e?.detail??{},a={x:t.center?.x??O.x,y:t.center?.y??O.y};Xt.push({type:"hit",absorb:t.absorb??0,center:a,ttl:.28,maxTtl:.28}),void 0!==t.absorb&&aa(`Shield absorb ${Math.round(t.absorb)}`,1.2)}function ha(e){if(!oa("shield"))return;const t=e?.detail??{},a={x:t.center?.x??O.x,y:t.center?.y??O.y};Xt.push({type:"shatter",center:a,ttl:.45,maxTtl:.45}),aa(`Shield ${t.reason??"shatter"}`,1.6)}function ua(e){if(!oa("shield"))return;const t=e?.detail?.reason??"ended";"shatter"!==t&&aa(`Shield ${t}`,1.4)}function ma(e){oa("throwables")&&aa(`Throwable thrown (${(e?.detail??{}).effectType??"unknown"})`,1.4)}function ga(e){if(!oa("throwables"))return;const t=e?.detail??{};na("explosion",t,.55),void 0!==t.damage?aa(`Explosion damage ${t.damage}`,1.6):aa("Explosion triggered",1.4)}function ya(e){if(!oa("throwables"))return;const t=e?.detail??{};na("flash",t,.45);const a=t.stunDuration??0;aa(`Flash burst (stun ${"number"==typeof a?a.toFixed(1):String(a)}s)`,1.6)}function pa(e){if(!oa("throwables"))return;const t=e?.detail??{},a=na("smoke",t,.6);a.maxRadius=t.radius??a.radius,aa(`Smoke deployed (${Math.round(10*((t.duration??0)+Number.EPSILON))/10}s)`,1.6)}function xa(e){oa("throwables")&&(na("smoke-fade",e?.detail??{},.4),aa("Smoke dissipated",1.4))}let wa=!1;function va(){wa||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",ra),window.addEventListener("weapon:shot-fired",sa),window.addEventListener("weapon:reload-start",la),window.addEventListener("weapon:reload-finish",da),window.addEventListener("weapon:recoil-kick",ca),window.addEventListener("shield:hit",fa),window.addEventListener("shield:shatter",ha),window.addEventListener("shield:end",ua),window.addEventListener("throwable:thrown",ma),window.addEventListener("throwable:explosion",ga),window.addEventListener("throwable:flash-burst",ya),window.addEventListener("throwable:smoke-detonate",pa),window.addEventListener("throwable:smoke-dissipate",xa),window.addEventListener("keydown",ia),wa=!0)}function ba(e,t){for(let a=e.length-1;a>=0;a-=1){const n=e[a];n.ttl-=t,n.age=(n.age??0)+t,n.ttl<=0&&e.splice(a,1)}}function ka(){return va(),{muzzleFlashes:Vt,shieldBursts:Xt,throwableBursts:_t,notices:Qt,shotIndicators:Zt,filters:{...ea}}}const Ta={horizontalKick:0,verticalKick:0,decay:12,lastShotTime:0};function Sa(e,t,a){const n=t+a;for(const t of A){if(e.vy<0)continue;const o=e.y+a;if(n<=t.y&&o>=t.y&&e.x>=t.x&&e.x<=t.x+t.width)return e.y=t.y-a,e.vy=0,Object.prototype.hasOwnProperty.call(e,"onGround")&&(e.onGround=!0),!0}return!1}const Ma={street:{fill:"#2c2f36",stroke:"#1b1d22"},metro:{fill:"#3d4252",stroke:"#272b37"},rooftop:{fill:"#4c5566",stroke:"#2f3541"},skybridge:{fill:"#596274",stroke:"#323846"},terrace:{fill:"#46505f",stroke:"#2a303b"},balcony:{fill:"#525a6a",stroke:"#2f3540"},median:{fill:"#3a404a",stroke:"#23272f"},plain:{fill:"#36404c",stroke:"#222730"}};function Ca(e){const t=Ma[e.type]??Ma.plain;T.fillStyle=t.fill,T.fillRect(e.x,e.y,e.width,e.height),T.strokeStyle=t.stroke,T.lineWidth=2,T.strokeRect(e.x,e.y,e.width,e.height)}function Ia(){return R[O.squadCommandIndex%R.length]??R[0]}function Aa(e,t){let a=null,n=Number.POSITIVE_INFINITY;for(const o of N){if(o.health<=0)continue;const i=o.x-e,r=o.y+.5*o.height-t,s=Math.hypot(i,r);s<n&&(n=s,a=o)}return a}function Pa(e,t,a,n=1){const o=t-e.x;if(e.vx=0,Math.abs(o)>12){const t=Math.sign(o);e.vx=t*M*n,e.facing=t}}function Da(e,t,a){if(e.fireCooldown=Math.max(0,(e.fireCooldown??0)-a),e.fireCooldown>0)return;e.fireCooldown=.45;const n=t.x>=e.x?1:-1;Et({x:e.x+24*n,y:e.y+.4*B(I.standing),vx:520*n,vy:-20,radius:5,lifetime:.8,color:n>0?"#8cffd4":"#a0ffe1",damage:12,knockback:110,facing:n}),e.flashTimer=.12}function Ra(e,t){const a=Ia(),n=B(I.standing);switch(e.y+n>=S-2&&Math.abs(e.vy)<1&&(e.onGround=!0),e.targetEnemyId=null,a?.id){case"attack":{const a=Aa(e.x,e.y);a&&Math.abs(a.x-O.x)<=640?(Pa(e,a.x-24,0,.95),Da(e,a,t),e.targetEnemyId=a.id):Pa(e,O.x-60,0,.8);break}case"defend":{const a=40*(e.roleIndex??0)-40;Pa(e,O.x+a,0,.7);const n=Aa(e.x,e.y);n&&Math.abs(n.x-O.x)<=180&&(Da(e,n,t),e.targetEnemyId=n.id);break}case"flank":{const a=220*((e.roleIndex??0)%2==0?-1:1);Pa(e,O.x+a,0,.9);const n=Aa(e.x,e.y);n&&(Da(e,n,t),e.targetEnemyId=n.id);break}default:{const t=36*(e.roleIndex??0)-36;Pa(e,O.x+t,0,.6);break}}!function(e,t){e.vy+=C*t;const a=e.y;e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1;const n=B(I.standing);Sa(e,a,n)||e.y+n>=S&&(e.y=S-n,e.vy=0,e.onGround=!0),e.vx=Math.max(-240,Math.min(M,e.vx))}(e,t),e.flashTimer=Math.max(0,(e.flashTimer??0)-t)}function Ba(){return{command:Ia(),cooldown:O.squadCommandCooldown,members:$}}const Ea="player-stickman";function La(){return O.vehicleId?qe(O.vehicleId):null}function Oa(e,t,a){if(t<=0)return;const n=t*a;e.vx>0?e.vx=Math.max(0,e.vx-n):e.vx<0&&(e.vx=Math.min(0,e.vx+n))}function $a(e,t){const a=t.driverSeat??{x:0,y:t.height},n=B(I.standing),o=e.x+a.x,i=e.y+a.y,r=Ye(o,40,k.width-40);O.x=r,O.y=i-n,O.vx=e.vx,O.vy=e.vy;const s=t.movementType??"ground";O.onGround="air"!==s&&("water"===s||e.onGround),O.facing=e.facing??O.facing}function Fa(e,t={}){const a=We[e.type];if(!a)return O.vehicleId=null,void(O.controlMode="onFoot");e.driverId=null,t.skipCooldown||(e.enterCooldown=Math.max(e.enterCooldown,t.cooldown??.35));const n=B(I.standing),o=t.preferDirection??(e.facing>=0?1:-1),i=a.exitOffsets??[],r=o>=0?{x:.6*a.width,y:0}:{x:.6*-a.width,y:0},s=o>=0?i[0]??r:i[1]??r;O.vehicleId=null,O.controlMode="onFoot",O.vehicleCandidateId=null,O.x=Ye(e.x+s.x,40,k.width-40),O.y=S-n,!1===t.inheritVelocity?(O.vx=0,O.vy=0):(O.vx=.5*e.vx,O.vy=Math.min(e.vy,0)),O.onGround=!0,O.facing=o>=0?1:-1}function Ha(e,t,a,n){n?function(e,t,a){const n=p.right&&!p.left,o=p.left&&!p.right,i=n?1:o?-1:0,r=t.acceleration??0,s=t.braking??600,l=t.maxSpeed??360,d=t.idleDrag??0;if(0!==i&&r>0&&(e.vx+=i*r*a),p.down&&e.onGround&&s>0){const t=s*a;e.vx>0?e.vx=Math.max(0,e.vx-t):e.vx<0&&(e.vx=Math.min(0,e.vx+t))}else 0===i&&Oa(e,d,a);l>0&&(e.vx=Ye(e.vx,-l,l)),0!==i?e.facing=i:Math.abs(e.vx)>8&&(e.facing=e.vx>0?1:-1)}(e,t,a):Oa(e,t.idleDrag??0,a);const o=t.airDrag??1;!e.onGround&&o>0&&o<1&&(e.vx*=Math.pow(o,Math.max(0,60*a))),e.vy+=C*a,e.x+=e.vx*a,e.y+=e.vy*a;const i=S-t.height;e.y>=i?(e.y=i,e.vy=0,e.onGround=!0):e.onGround=!1;const r=.5*t.width,s=r+32,l=k.width-r-32;e.x=Ye(e.x,s,l),e.x!==s&&e.x!==l||(e.vx=0);const d=Ye(e.vx/Math.max(1,t.maxSpeed??360)*.12,-.25,.25);e.tilt+=(d-e.tilt)*Math.min(1,10*a)}function Wa(e,t,a,n){const o=t.waterAcceleration??t.acceleration??220,i=t.waterMaxSpeed??t.maxSpeed??220,r=t.waterReverseSpeed??Math.max(80,.6*i),s=t.waterIdleDrag??t.idleDrag??200,l=t.turnDrag??220,d=t.bobAmplitude??4,c=t.bobSpeed??1.4,f=t.splashIntensity??.3,h=e.waterLineY??S-(t.waterSurfaceOffset??24),u=t.buoyancyPoint??.55,m=t.submergedOffset??0,g=n&&p.right&&!p.left,y=n&&p.left&&!p.right,x=g?1:y?-1:0;if(0!==x&&o>0?e.vx+=x*o*a:Oa(e,s,a),n&&p.down){const t=l*a;e.vx>0?e.vx=Math.max(e.vx-t,-r):e.vx<0?e.vx=Math.min(e.vx+t,r):t>0&&(e.vx=Ye(e.vx-e.facing*t*.15,-r,r))}e.vx=Ye(e.vx,-r,i),0!==x?e.facing=x:Math.abs(e.vx)>4&&(e.facing=e.vx>0?1:-1),e.x+=e.vx*a;const w=.5*t.width,v=w+32,b=k.width-w-32;e.x=Ye(e.x,v,b),e.x!==v&&e.x!==b||(e.vx=0),e.vy=0,e.bobPhase=(e.bobPhase??0)+a*(c*(n?1.2:.85));const T=Math.sin(e.bobPhase)*d,M=Math.sin(.5*e.bobPhase+.02*e.x)*f*6,C=h-t.height*u+m+T+M;e.y+=(C-e.y)*Math.min(1,6.5*a),e.onGround=!1;const I=Ye(e.vx/Math.max(1,i)*.22+.05*Math.sin(e.bobPhase+.4*e.facing),-.45,.45);e.tilt+=(I-e.tilt)*Math.min(1,5*a)}function Na(e,t,a,n){const o=t.horizontalAcceleration??t.acceleration??0,i=t.horizontalMaxSpeed??t.maxSpeed??320,r=t.horizontalDrag??t.idleDrag??200,s=t.airDrag??.97,l=t.hoverMinAltitude??0,d=Math.max(l,t.hoverMaxAltitude??l),c=t.altitudeRate??160,f=t.autopilotStrength??4,h=t.verticalDamping??.9,u=t.maxVerticalSpeed??220,m=t.liftPower??0,g=t.descendPower??m,y=n&&p.right&&!p.left,x=n&&p.left&&!p.right,w=y?1:x?-1:0;0!==w&&o>0?e.vx+=w*o*a:Oa(e,r,a),i>0&&(e.vx=Ye(e.vx,-i,i)),0!==w?e.facing=w:Math.abs(e.vx)>6&&(e.facing=e.vx>0?1:-1),e.vx*=Math.pow(s,60*a);const v=C*(t.gravityScale??.25);if(e.vy+=v*a,Number.isFinite(e.preferredAltitude)||(e.preferredAltitude=t.spawnHover??l),n)p.jump&&(e.preferredAltitude+=c*a),p.down&&(e.preferredAltitude-=c*a);else{const n=S-(e.y+t.height);e.preferredAltitude+=(n-e.preferredAltitude)*Math.min(1,.5*a)}e.preferredAltitude=Ye(e.preferredAltitude,l,d);const b=Ye(S-(e.y+t.height),l,d),T=e.preferredAltitude-b;e.vy-=T*f*a,n&&m>0&&(p.jump&&(e.vy-=.25*m*a),p.down&&(e.vy+=.25*g*a)),e.vy*=Math.pow(h,60*a),u>0&&(e.vy=Ye(e.vy,-u,u)),e.x+=e.vx*a,e.y+=e.vy*a;const M=.5*t.width,I=M+32,A=k.width-M-32;e.x=Ye(e.x,I,A),e.x!==I&&e.x!==A||(e.vx=0);const P=Ye(S-(e.y+t.height),l,d);e.y=S-t.height-P,(P===l&&e.vy>0||P===d&&e.vy<0)&&(e.vy=0),e.onGround=!1;const D=Ye(e.vx/Math.max(1,i)*.35-.02*T,-.6,.6);e.tilt+=(D-e.tilt)*Math.min(1,6*a)}function ja(e,t,a,n){const o=!1!==t.followVehicleFacing,i=e.facing??1,r=void 0!==n?n:(t.facing??1)*(o?i:1),s=t.offset?.x??0,l=t.offset?.y??0,d=o?i:1,c=e.x+s*d,f=e.y+l,h=t.muzzles&&t.muzzles.length>0?t.muzzles:[{x:t.muzzle?.x??0,y:t.muzzle?.y??0}],u=a.muzzleIndex??0,m=h[u%h.length];a.muzzleIndex=(u+1)%h.length;const g=c+(m?.x??0)*d,y=f+(m?.y??0),p=t.projectile??{},x=p.speed??600,w=(t.scatter??0)*(Math.PI/180),v=w>0?(Math.random()-.5)*w:0,b=r>=0?1:-1;Et({x:g,y,vx:Math.cos(v)*x*b,vy:Math.sin(v)*x+(p.verticalSpeed??0),radius:p.radius??5,lifetime:p.lifetime??1.3,color:p.color??"#ffd27a",damage:p.damage??12,knockback:p.knockback??80,facing:b,gravityFactor:p.gravityFactor??.12}),a.flashTimer=t.flashDuration??.1,a.lastMuzzleX=g,a.lastMuzzleY=y}function za(e,t,a,n){const o=t.mountedWeapons??[],i=e.mounts??[];if(0===o.length||0===i.length)return;const r=e.facing??1,s=n&&p.attackDown,l=n&&p.throwDown;for(let t=0;t<o.length;t+=1){const d=o[t],c=i[t];if(!d||!c)continue;c.cooldown=Math.max(0,(c.cooldown??0)-a),c.flashTimer=Math.max(0,(c.flashTimer??0)-a);let f=!1;const h=d.binding??"primary";if(n?"primary"===h?f=s:"secondary"===h&&(f=l):d.autoFire&&(f=!0),!f||c.cooldown>0)continue;const u=!1!==d.followVehicleFacing;ja(e,d,c,(d.facing??1)*(u?r:1)),c.cooldown=d.fireInterval??.2}}function qa(){const e=Q(),t=e?.name??"Unarmed",a=q().map(e=>v[e]??{id:e,name:"Unknown"}),n=e?K(e.id):null,o=Ta.horizontalKick,i=Ta.verticalKick;if((O.flashBlindTimer??0)>0){const e=Math.min(.55,(O.flashBlindTimer??0)/1.2);T.fillStyle=`rgba(255, 255, 224, ${e})`,T.fillRect(0,0,T.canvas.width,T.canvas.height)}T.fillStyle="#d0d4de",T.font="16px 'Segoe UI', Arial, sans-serif",T.textAlign="left",T.fillText("Move: WASD/Arrows   Jump: Space   Crouch: S   Roll: Shift   Attack: J or Left Click   Throw: G or Right Click",24,32),T.fillText("Server Browser: L (toggle)  |  Join: Enter  |  Host: H  |  Offer: O  |  Paste: P  |  Apply: I  |  ICE Copy: M  |  ICE Apply: N",24,48);const r=O.attacking&&O.currentAttack?`Combo: ${O.currentAttack.name}`:"Combo: Ready";T.fillText(r,24,52),T.fillText(`Weapon: ${t}`,24,72);let s=92;const l=La();if(l){const e=We[l.type],t=e?.label??l.type,a=e?.movementType??"ground";T.fillStyle="#8cffd4",T.fillText(`Vehicle: ${t} (E to exit)`,24,s),s+=20,T.fillStyle="#9aa2b1","air"===a?T.fillText("Controls: A/D strafe   Space rise   S descend",24,s):"water"===a?T.fillText("Controls: A/D throttle   S brake/reverse",24,s):T.fillText("Controls: A/D drive   S brake",24,s),s+=20;const n=e?.mountedWeapons??[];if(n.length>0)for(const e of n){const t="secondary"===(e.binding??"primary").toLowerCase()?"Secondary":"Primary",a=e.label??e.id??"Mounted Weapon";T.fillStyle="Primary"===t?"#cfe3ff":"#ffd3a3",T.fillText(`${t}: ${a}`,24,s),s+=18}}else if(O.vehicleCandidateId){const e=qe(O.vehicleCandidateId);if(e){const t=We[e.type],a=t?.label??e.type,n=t?.movementType??"ground";T.fillStyle="#ffc66d",T.fillText(`Nearby: ${a} [E to enter]`,24,s),s+=20,T.fillStyle="#9aa2b1","air"===n?(T.fillText("Tip: Space rises, S descends when piloting",24,s),s+=20):"water"===n?(T.fillText("Tip: Boats use A/D throttle, S to brake/reverse",24,s),s+=20):(T.fillText("Tip: Hold S to brake while driving",24,s),s+=20);const o=t?.mountedWeapons??[];if(o.length>0){T.fillStyle="#d6e2ff";for(const e of o){const t="secondary"===(e.binding??"primary").toLowerCase()?"Secondary":"Primary",a=e.label??e.id??"Mounted Weapon";T.fillText(`${t}: ${a}`,24,s),s+=18}}}}T.fillStyle="#d0d4de";const d={timeUntilNext:Math.max(0,jt.nextDropTimer),nextDropLabel:Wt[jt.nextDropTypeId]?.label??null,incomingMessage:jt.incomingTimer>0?jt.incomingMessage:null,incomingAlpha:jt.incomingTimer>0?jt.incomingTimer/jt.incomingDuration:0,rewardMessage:jt.rewardTimer>0?jt.rewardMessage:null,rewardAlpha:jt.rewardTimer>0?jt.rewardTimer/jt.rewardDuration:0,activeCount:Nt.length};if(d){if(d.incomingMessage){const e=Ye(.35+.65*(d.incomingAlpha??0),0,1);T.fillStyle=`rgba(176, 210, 255, ${e})`,T.fillText(d.incomingMessage,24,s),s+=20,T.fillStyle="#d0d4de"}if((d.timeUntilNext??0)>.2&&d.nextDropLabel){const e=d.timeUntilNext;T.fillText(`Next Drop (${d.nextDropLabel}): ${e.toFixed(1)}s`,24,s),s+=20}if((d.activeCount??0)>0&&(T.fillStyle="#8cffd4",T.fillText(`Drops on field: ${d.activeCount}`,24,s),s+=20,T.fillStyle="#d0d4de"),d.rewardMessage){const e=Ye(.3+.7*(d.rewardAlpha??0),0,1);T.fillStyle=`rgba(140, 255, 212, ${e})`,T.fillText(`Reward: ${d.rewardMessage}`,24,s),s+=20,T.fillStyle="#d0d4de"}}const c=Ba();if(c?.command&&(T.fillStyle="#cfe3ff",T.fillText(`Squad: ${c.command.label}`,24,s),s+=18,T.fillStyle="#9aa2b1",T.fillText("Commands: Z Hold   X Defend   C Attack   V Flank   T Cycle",24,s),s+=18,(c.cooldown??0)>.05&&(T.fillText(`Command cooldown: ${c.cooldown.toFixed(1)}s`,24,s),s+=18),Array.isArray(c.members)&&c.members.length>0)){T.fillStyle="#8cffd4";const e=Math.min(3,c.members.length);for(let t=0;t<e;t+=1){const e=c.members[t],a=Math.abs(e.x-O.x),n=e.targetEnemyId?"engaging":"ready";T.fillText(`${e.name??"Ally"}: ${a.toFixed(0)}u (${n})`,24,s),s+=18}T.fillStyle="#d0d4de"}const f=xe?.();if(f&&(T.fillStyle="#b6c9ff",T.fillText(`P2P: ${f.status??"unknown"}`,24,s),s+=18,"connected"!==f.status?(T.fillStyle="#8495c9",T.fillText("Use window.P2P.createOffer() / createAnswer() in console",24,s),s+=18,T.fillText("window.P2P.getLocalDescription() to copy SDP",24,s),s+=18):(T.fillStyle="#8cffd4",T.fillText("Remote peers: "+H().length,24,s),s+=18),T.fillStyle="#d0d4de"),n){const e=n.capacity===Number.POSITIVE_INFINITY;let t=`Ammo: ${e?"INF":`${Math.max(0,n.magazine)}`}/${e?"INF":`${Math.max(0,n.reserve)}`}`;n.reloading&&(t+=` (Reloading ${Math.max(0,n.reloadTimer).toFixed(1)}s)`),T.fillText(t,24,s),s+=20}if(Math.hypot(o??0,i??0)>.05){const e=`Recoil Kick: H ${(o??0).toFixed(2)}  V ${(i??0).toFixed(2)}`;T.fillText(e,24,s),s+=20}T.fillText(`Player HP: ${O.health}/${O.maxHealth}`,24,s),s+=20,T.fillText(`Dummy HP: ${Math.round(W.health)}/${W.maxHealth}`,24,s),s+=20;const h=N.filter(e=>e.health>0).length;if(T.fillText(`Enemies Alive: ${h}`,24,s),s+=20,a.length>0){const t=a.map((t,a)=>{const n=`${a+1}: ${t.name}`;return t.id===e?.id?`[${n}]`:n}).join("   ");T.fillStyle="#9aa2b1",T.fillText(`Loadout ${t}`,24,152)}let u=172;const m=function(){const e={active:nt.active,strength:nt.strength,maxStrength:nt.maxStrength,duration:nt.duration,maxDuration:nt.maxDuration};return{turretCount:Qe.length,grappleActive:tt.active,shieldActive:e.active,shieldStrength:e.strength,shieldMaxStrength:e.maxStrength,gadgetCooldown:O.gadgetCooldown??0}}();if(O.comboWindowOpen&&(T.fillStyle="#ffcf7a",T.fillText("Press attack now to chain!",24,u),u+=20),"throwable"===e?.category){const e=O.throwCooldown<=0,t=e?"Ready":`${O.throwCooldown.toFixed(1)}s`;T.fillStyle=e?"#8cffd4":"#ffcf7a",T.fillText(`Grenade: ${t}`,24,u),u+=20}if("gadget"===e?.category){const e=(m.gadgetCooldown??0)<=.01,t=e?"Ready":`${m.gadgetCooldown.toFixed(1)}s`;T.fillStyle=e?"#8cffd4":"#ffcf7a",T.fillText(`Gadget: ${t}`,24,u),u+=20}if((m.turretCount??0)>0&&(T.fillStyle="#9ae9ff",T.fillText(`Turrets Active: ${m.turretCount}`,24,u),u+=20),m.shieldActive){const e=m.shieldMaxStrength??0,t=Math.max(0,m.shieldStrength??0),a=e>0?Math.max(0,Math.min(1,t/e)):0;T.fillStyle="#7cd6ff";const n=e>0?`${Math.ceil(t)}/${Math.ceil(e)}`:"Active";T.fillText(`Shield: ${n}`,24,u),u+=14;const o=120;T.fillStyle="#2d3c4d",T.fillRect(24,u,o,6),T.fillStyle="#7cd6ff",T.fillRect(24,u,o*a,6),u+=14}(O.stunTimer??0)>0&&(T.fillStyle="#ffb48a",T.fillText(`Stunned: ${O.stunTimer.toFixed(1)}s`,24,u),u+=20),(O.flashBlindTimer??0)>0&&(T.fillStyle="#ffe27a",T.fillText(`Blinded: ${O.flashBlindTimer.toFixed(1)}s`,24,u),u+=20),(O.smokeSlowTimer??0)>0&&(T.fillStyle="#b8c7dd",T.fillText(`In Smoke: ${O.smokeSlowTimer.toFixed(1)}s`,24,u),u+=20),O.health<=0&&(T.fillStyle="#ff8c7a",T.fillText("Respawning soon...",24,u));const g=ka(),y=g.notices.slice(-4).reverse();if(y.length>0||g.shotIndicators.length>0||g.filters){T.save();const e=T.canvas.width-24;T.textAlign="right";let t=32;for(const a of y){const n=a.maxTtl>0?Ye(a.ttl/a.maxTtl,0,1):0;T.globalAlpha=Ye(n,.25,1),T.fillStyle="#c3cdea",T.fillText(a.message,e,t),t+=18}if(g.shotIndicators.length>0){y.length>0&&(t+=6);for(const a of g.shotIndicators){const n=a.maxTtl>0?Ye(a.ttl/a.maxTtl,0,1):0;T.globalAlpha=Ye(n,.3,.85),T.fillStyle="#9aa2b1",T.fillText("Shot: "+a.weaponId,e,t),t+=16}}const a=g.filters;if(a){t>32&&(t+=6),T.globalAlpha=.6,T.fillStyle="#7f8aad",T.fillText("Filters (Alt+6/7/8)",e,t),t+=16;const n=[{label:"Weapons",value:a.weapons},{label:"Shield",value:a.shield},{label:"Throwables",value:a.throwables}];for(const a of n)T.globalAlpha=a.value?.85:.35,T.fillStyle=a.value?"#c3cdea":"#6c7389",T.fillText(a.label+": "+(a.value?"ON":"OFF"),e,t),t+=16}T.globalAlpha=1,T.restore()}}function Ya(){!function(){if(0!==Bt.length){T.save(),T.lineWidth=2;for(const e of Bt){const t=Math.max(0,e.life/e.maxLife);T.fillStyle=`rgba(255, 200, 120, ${t})`,T.beginPath(),T.arc(e.x,e.y,e.radius,0,2*Math.PI),T.fill()}T.restore()}}(),function(){const e=Je();T.save();for(const t of Ot)if(t.detonated){const e=Math.max(t.explosionDuration,.001),a=Ye(1-t.explosionTimer/e,0,1),n=Ye(1-a,0,1);if("flash"===t.effectType){const e=t.explosionRadius*(.8+.5*a),o=Math.max(0,Math.min(1,.75*n+.15));T.fillStyle=`rgba(255, 255, 224, ${o.toFixed(3)})`,T.beginPath(),T.arc(t.x,t.y,e,0,2*Math.PI),T.fill()}else if("smoke"===t.effectType){const e=t.explosionRadius*(.6+.6*a),o=Math.max(0,Math.min(.65,.5*n+.1));T.fillStyle=`rgba(180, 200, 220, ${o.toFixed(3)})`,T.beginPath(),T.arc(t.x,t.y,e,0,2*Math.PI),T.fill()}else{const e=t.explosionRadius*(.65+.4*a),o=Math.max(0,Math.min(1,.7*n));T.strokeStyle=`rgba(255, 196, 120, ${o.toFixed(3)})`,T.lineWidth=6*(1-.6*a),T.beginPath(),T.arc(t.x,t.y,e,0,2*Math.PI),T.stroke();const i=Math.max(0,Math.min(1,.75*n));T.fillStyle=`rgba(255, 118, 64, ${i.toFixed(3)})`,T.beginPath(),T.arc(t.x,t.y,.6*e,0,2*Math.PI),T.fill()}}else{T.globalAlpha=1,T.fillStyle=t.color,T.beginPath(),T.arc(t.x,t.y,t.radius,0,2*Math.PI),T.fill();const a=t.maxFuse>0?Ye(t.fuse/t.maxFuse,0,1):0;T.strokeStyle="rgba(255, 232, 194, 0.85)",T.lineWidth=3,T.beginPath(),T.arc(t.x,t.y,.65*t.radius,-Math.PI/2,-Math.PI/2+2*Math.PI*a),T.stroke();const n=Math.cos(20*e)*t.radius*.4,o=Math.sin(24*e)*t.radius*.2-.8*t.radius;T.fillStyle="rgba(255, 240, 210, 0.9)",T.beginPath(),T.arc(t.x+n,t.y+o,3.2,0,2*Math.PI),T.fill()}T.restore(),function(){if(0!==$t.length){T.save();for(const e of $t){const t=Ye(e.life/e.duration,0,1),a=e.radius,n=T.createRadialGradient(e.x,e.y,.15*a,e.x,e.y,a);n.addColorStop(0,"rgba(172, 196, 216, 0.35)"),n.addColorStop(1,"rgba(40, 52, 64, 0)"),T.globalAlpha=t,T.fillStyle=n,T.beginPath(),T.arc(e.x,e.y,a,0,2*Math.PI),T.fill()}T.restore()}}()}(),function(){if(vt(),0!==mt.length||0!==gt.length){T.save();for(const e of gt){const t=Ye(e.ttl/e.maxTtl,0,1),a=1-t,n=e.startRadius+(e.endRadius-e.startRadius)*a;T.globalAlpha=.6*Ye(t,0,1),T.lineWidth=e.lineWidth,T.strokeStyle=e.color,T.beginPath(),T.arc(e.x,e.y,n,0,2*Math.PI),T.stroke()}for(const e of mt){const t=Ye(e.ttl/e.maxTtl,0,1);let a=Ye(t,0,1);"smoke"===e.type?a*=.55:"flash"===e.type?a=.35+.65*a:"debris"===e.type&&(a=.5+.5*a),T.globalAlpha=a,T.fillStyle=e.color;let n=t;"smoke"===e.type?n=1:"debris"===e.type&&(n=.6+.4*t);const o=Math.max(1.2,e.radius*n);T.beginPath(),T.arc(e.x,e.y,o,0,2*Math.PI),T.fill()}T.restore()}}(),function(){const{muzzleFlashes:e,shieldBursts:t,throwableBursts:a}=ka();if(0!==e.length||0!==t.length||0!==a.length){T.save();for(const t of e){const e=Ye(t.ttl/t.maxTtl,0,1),a=.25+.6*e,n=12+14*(1-e),o=(t.facing??1)*(10+6*(1-e));T.globalAlpha=a,T.fillStyle="#ffd27a",T.beginPath(),T.arc(t.x+o,t.y,n,0,2*Math.PI),T.fill()}for(const e of t){const t=Ye(e.ttl/e.maxTtl,0,1),a=("shatter"===e.type?.55:.35)*t;if(a<=0)continue;const n=("shatter"===e.type?120:80)*(1-.35*t);T.globalAlpha=a,T.lineWidth="shatter"===e.type?6:3,T.strokeStyle="shatter"===e.type?"#7cd6ff":"#9be9ff",T.beginPath(),T.arc(e.center.x,e.center.y,n,0,2*Math.PI),T.stroke()}for(const e of a){const t=Ye(e.ttl/e.maxTtl,0,1);if(t<=0)continue;let a="#ffb347";"flash"===e.type?a="#fff6d0":"smoke"!==e.type&&"smoke-fade"!==e.type||(a="#9db8ca");const n=e.radius*(1+.35*(1-t));T.globalAlpha=("smoke-fade"===e.type?.3:.45)*t,T.lineWidth="flash"===e.type?5:4,T.strokeStyle=a,T.beginPath(),T.arc(e.x,e.y,n,0,2*Math.PI),T.stroke()}T.restore()}}()}function Ga(e){const t=Q(),a=(t?.attackChain??[])[e];a&&(O.attacking=!0,O.attackIndex=e,O.currentAttack=a,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.nextAttackQueued=!1,O.hitboxSpawned=!1,O.attackInstanceId+=1)}function Ja(e){O.activeHitboxes.push({id:O.attackInstanceId,attackIndex:O.attackIndex,remaining:e.active,duration:e.active,offsetX:e.range,heightOffset:e.heightOffset,radius:e.radius,damage:e.damage,knockback:e.knockback,launch:e.launch,ownerFacing:O.facing,hitTargets:new Set,x:0,y:0})}function Ka(){const e=Q();if(!e||!e.category?.startsWith("ranged"))return;if(!function(e){const t=J(e);return!(t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.reloading||t.magazine<=0||(t.magazine-=1,0)))}(e.id))return void(U(e.id)&&(O.attacking=!1,O.currentAttack=null,O.attackIndex=-1,"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:reload-start",{detail:{weaponId:e.id}}))));const t=e.projectile??{},a=t.speed??460,n=O.facing,o=n*a,i=t.initialVy??-12,r=Math.hypot(o,i),s=Math.atan2(i,o)+function(e){const t=J(e),a=t?.spreadDef;if(!t||!a)return 0;t.spread||(t.spread={current:a.base??0});const n=t.spread,o=a.base??0,i=Math.max(o,n.current??o),r=a.max??i,s=Math.min(r,i),l=s*(Math.PI/180),d=l>0?(2*Math.random()-1)*l:0,c=a.perShot??0;return n.current=Math.min(r,s+c),d}(e.id),l=Math.cos(s)*r,d=Math.sin(s)*r;var c;e.recoil&&(c=e.recoil,Ta.horizontalKick+=c?.horizontal??0,Ta.verticalKick+=c?.vertical??0,Ta.decay=c?.decay??Ta.decay,Ta.lastShotTime=Je(),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:recoil-kick",{detail:{weaponId:e.id,recoil:e.recoil}}))),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:muzzle-flash",{detail:{weaponId:e.id,x:O.x+34*n,y:O.y+20,facing:n}})),Et({x:O.x+34*n,y:O.y+20,vx:l,vy:d,radius:t.radius??5,lifetime:t.lifetime??.9,color:t.color??"#ffca7a",damage:t.damage??10,knockback:t.knockback??60,facing:n,gravityFactor:t.gravityFactor??.2}),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:shot-fired",{detail:{weaponId:e.id}}))}function Ua(e,t){if(e.invulnerability=Math.max(0,e.invulnerability-t),e.attackCooldown=Math.max(0,e.attackCooldown-t),e.stunTimer=Math.max(0,(e.stunTimer??0)-t),e.smokeSlowTimer=Math.max(0,(e.smokeSlowTimer??0)-t),e.smokeSlowTimer<=0&&(e.smokeSlowStrength=1),e.flashTimer>0&&(e.flashTimer=Math.max(0,e.flashTimer-t)),e.shakeTimer>0&&(e.shakeTimer=Math.max(0,e.shakeTimer-t)),e.shakeMagnitude=Math.max(0,e.shakeMagnitude-20*t),e.health<=0)return e.respawnTimer=Math.max(0,e.respawnTimer-t),void(0===e.respawnTimer&&(e.health=e.maxHealth,e.x=e.spawnX,e.y=e.spawnY,e.vx=0,e.vy=0,e.state="patrol",e.stateTimer=1+Math.random(),e.attackCooldown=.6,e.onGround=!0,e.stunTimer=0,e.smokeSlowTimer=0,e.smokeSlowStrength=1));const a=O.x-e.x,n=Math.abs(a);e.facing=a>=0?1:-1;const o=e.stunTimer>0,i=e.smokeSlowTimer>0?Math.max(.2,Math.min(1,e.smokeSlowStrength??1)):1,r=e.moveSpeed*i,s=e.aggressionRange*(e.smokeSlowTimer>0?.85:1),l=!o&&n<s;if(n>1.8*s)return e.vx=0,void(e.state="idle");if(o?(e.state="stunned",e.vx=0,e.attackWindup=0,e.attackActive=0,e.stateTimer=Math.max(e.stateTimer,e.stunTimer),e.attackCooldown=Math.max(e.attackCooldown,e.stunTimer+.2)):"stunned"===e.state&&(e.state="idle",e.stateTimer=.6),!o)switch(e.state){case"idle":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state="patrol",e.stateTimer=1.2+Math.random(),e.facing=Math.random()<.5?-1:1),l&&(e.state="chase");break;case"patrol":e.vx=r*e.facing,e.x<=e.patrolRange.min?e.facing=1:e.x>=e.patrolRange.max&&(e.facing=-1),e.stateTimer-=t,e.stateTimer<=0&&(e.state="idle",e.stateTimer=1+Math.random(),e.vx=0),l&&(e.state="chase");break;case"chase":if(!l){e.state="patrol";break}const o=a>=0?1:-1;e.vx=r*o,n<=e.attackRange&&e.attackCooldown<=0&&(e.state="attack-windup",e.attackWindup=.35,e.attackActive=.16,e.vx=0);break;case"attack-windup":e.vx=0,e.attackWindup-=t,e.attackWindup<=0&&(e.state="attack-active",e.attackActive=.16);break;case"attack-active":e.vx=.35*r*e.facing,e.attackActive-=t,e.attackActive<=0&&(e.state="recover",e.stateTimer=.4,e.attackCooldown=1.2);break;case"recover":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state=l?"chase":"idle",e.stateTimer=.9+.4*Math.random());break;default:e.vx=0}const d=e.y;e.vy+=C*t,e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1,!Sa(e,d,e.height)&&e.y+e.height>=S&&(e.y=S-e.height,e.vy=0,e.onGround=!0),e.x=Math.max(60,Math.min(k.width-60,e.x))}function Va(e){if(e.health<=0)return;if("attack-active"!==e.state)return;const t=e.attackRange+e.radius,a=O.x-e.x,n=O.y-e.y;a*a+n*n<=t*t&&ct(e)}const Xa={timer:2.2,seeded:!1};function _a(e){for(let t=0;t<e&&!(N.length>=100);t+=1){const e=80,t=e+Math.random()*(k.width-2*e),a=E(t);a.spawnX=t,a.spawnY=a.y,a.respawnTimer=0,N.push(a)}}function Qa(){return"https://projectstickfightinggame.onrender.com".replace(/\/$/,"")}function Za(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`session-${Math.random().toString(36).slice(2,10)}`}function en(e){return"string"!=typeof e?"":e.trim()}async function tn(e){if(!e||"undefined"==typeof navigator||!navigator.clipboard?.writeText)return!1;try{return await navigator.clipboard.writeText(e),!0}catch(e){return console.warn("Clipboard write failed",e),!1}}function an(e){return Array.isArray(e)?e.map(e=>function(e){if("string"==typeof e)return en(e);if(e&&"object"==typeof e)try{return en(JSON.stringify(e))}catch{return""}return""}(e)).filter(e=>e.length>0):[]}function nn(){let e;try{e=se()}catch{return Ee([]),[]}if(!e?.getLocalCandidates)return Ee([]),[];const t=an(e.getLocalCandidates()??[]);return Ee(t),t}async function on({silent:e=!1}={}){try{$e({candidates:!0});const t=nn();if(0===t.length)return e||Se("No ICE candidates yet. Wait a moment after generating offer/answer."),{copied:!1,count:0};const a=t.join("\n"),n=await tn(a);return e||Se(n?`Copied ${t.length} ICE candidate${1===t.length?"":"s"}.`:"Candidates ready. Copy manually if clipboard access is blocked."),{copied:n,count:t.length,payload:a}}catch(e){throw Oe(e?.message??"Failed to copy ICE candidates"),e}finally{$e({candidates:!1})}}async function rn(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=ve(),t=(e.p2p.remoteCandidates??[]).join("\n"),a=window.prompt("Paste remote ICE candidates (JSON array or newline separated)",t);if(null==a)return Se("Candidate entry cancelled."),null;const n=function(e){const t=en(e);if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e))return an(e);if(e&&"object"==typeof e)return an([e]);if("string"==typeof e)return an([e])}catch{}return an(t.split(/\r?\n+/).map(e=>e.trim()).filter(e=>e.length>0))}(a);if(0===n.length)throw Se("No valid ICE candidates detected."),new Error("No ICE candidates provided");const o=sn();Oe(null),$e({candidates:!0});try{for(const e of n)await o.addRemoteCandidate(e);const t=function(e,t){const a=[...e,...t],n=new Set,o=[];for(const e of a)n.has(e)||(n.add(e),o.push(e));return o}(e.p2p.remoteCandidates??[],n);return Le(t),Se(`Applied ${n.length} ICE candidate${1===n.length?"":"s"}.`),n}catch(e){throw Oe(e?.message??"Failed to apply ICE candidates"),e}finally{$e({candidates:!1})}}function sn(){try{return se()}catch(e){throw Oe(e?.message??"P2P subsystem unavailable"),e}}function ln(e,t){const a=e?.playerCount??t;return{playerCount:a,enemyCount:e?.enemyCount??0,alliesCount:e?.alliesCount??Math.max(0,a-1)}}async function dn(){const e=Qa();if(!e)return Te("Server list URL not configured"),void ke([]);Pe(!0),Se("Fetching server list...");try{const t=await fetch(`${e}/sessions`,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.json(),n=(Array.isArray(a)?a:Array.isArray(a?.servers)?a.servers:[]).map(e=>{const t=e.metadata??{};return{id:e.id,name:e.name??e.id,map:e.map??t.map??"Unknown",players:t.playerCount??e.playerCount??e.players??0,maxPlayers:e.maxPlayers??t.maxPlayers??0,region:e.region??t.region??"--",mode:e.mode??t.mode??"",enemyCount:t.enemyCount??null,alliesCount:t.alliesCount??null,updatedAt:e.updatedAt??null,signal:{hostOffer:e.signal?.hostOffer??null,hostCandidates:Array.isArray(e.signal?.hostCandidates)?e.signal.hostCandidates.slice():[],joinAnswer:e.signal?.joinAnswer??null,joinCandidates:Array.isArray(e.signal?.joinCandidates)?e.signal.joinCandidates.slice():[]}}}),o=Math.max(3e4,Math.round(165e3)),i=Date.now(),r=n.filter(e=>{if(!e.updatedAt)return!0;const t=Date.parse(e.updatedAt);return!!Number.isNaN(t)||i-t<=o});ke(r),Te(null),Se(0===r.length?"No active sessions.":"Fetched session list.")}catch(e){ke([]),Te(`Failed to fetch servers: ${e.message}`),Se("Unable to reach session service.")}finally{Pe(!1)}}async function cn({id:e=Za(),name:t="ProjectStickFightingGame Lobby",region:a="na-west",map:n="Neo District",playerCount:o=1,maxPlayers:i=4,mode:r="freeplay",signal:s=null}={}){const l=Qa(),d="sk-stickman-host-123456789987654321";if(!l)throw new Error("Server API base not configured");const c=ve(),f=c.hostingMetrics??{},h=f.playerCount??o,u=s??{hostOffer:c.p2p.offer??null,hostCandidates:c.p2p.localCandidates??[]},m=await fetch(`${l}/sessions`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":d},body:JSON.stringify({id:e,name:t,region:a,map:n,mode:r,playerCount:h,maxPlayers:i,ttlSeconds:150,metadata:ln(f,h),signal:{hostOffer:u.hostOffer??null,hostCandidates:Array.isArray(u.hostCandidates)?u.hostCandidates:[]}})});if(!m.ok)throw new Error(`Failed to host session (HTTP ${m.status})`);const g=await m.json();return Ee(Array.isArray(u.hostCandidates)?u.hostCandidates:[]),De({id:e,expiresAt:Date.now()+1e3*(g?.ttlSeconds??150)}),Se(`Hosting ${t}`),{id:e,ttlSeconds:g?.ttlSeconds??150}}async function fn(){const e=Qa(),t="sk-stickman-host-123456789987654321",a=ve();if(!(a.hosting&&a.hostingSessionId&&e&&t))return;const n=a.hostingMetrics??{},o=n.playerCount??1;try{const r=await fetch(`${e}/sessions/${a.hostingSessionId}/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":t},body:JSON.stringify({playerCount:o,ttlSeconds:150,metadata:ln(n,o),signal:{hostOffer:a.p2p.offer??null,hostCandidates:Array.isArray(a.p2p.localCandidates)?a.p2p.localCandidates:[]}})});if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();i=performance.now(),we.hostingLastHeartbeat=i,s?.ttlSeconds&&De({id:a.hostingSessionId,expiresAt:Date.now()+1e3*s.ttlSeconds})}catch(e){console.warn("Heartbeat failed",e),Se("Heartbeat failed; hosting paused."),Re()}var i}async function hn(){const e=Qa(),t="sk-stickman-host-123456789987654321",a=ve();if(a.hosting&&a.hostingSessionId&&e&&t)try{await fetch(`${e}/sessions/${a.hostingSessionId}`,{method:"DELETE",headers:{"x-session-secret":t}})}catch(e){console.warn("Failed to stop hosting",e)}finally{Re()}else Re()}async function un(e,t={}){const a=Qa();if(!a)throw new Error("Server API base not configured");Me("Contacting host..."),Ce(null);const n=`${a}/sessions/${e}/join`,o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const e=`Join failed (HTTP ${o.status})`;throw Me(null),Ce(e),new Error(e)}const i=await o.json(),r=i?.session?.name??e;return Fe(),Me(`Joined ${r}`),Se("Joined lobby. Press P to paste the host offer."),i}async function mn({forceRegenerate:e=!1}={}){const t=ve();if(!e&&t.p2p.offer)return nn(),t.p2p.offer;const a=sn();Oe(null),$e({offer:!0});try{const e=await a.createOffer();return function(e){we.p2p.offer=e??null}(e),nn(),e}catch(e){throw Oe(e?.message??"Failed to create offer"),e}finally{$e({offer:!1})}}async function gn({forceRegenerate:e=!1,silent:t=!1}={}){const a=await mn({forceRegenerate:e}),n=await tn(a);return t||Se(n?"Offer copied. Share it with your party.":"Offer ready. Copy it manually if clipboard access is blocked."),{offer:a,copied:n}}async function yn(e,{autoCopyAnswer:t=!0}={}){const a=en(e);if(!a)throw new Error("Offer empty");let n;try{n=JSON.stringify(JSON.parse(a))}catch(e){throw Oe("Offer must be valid JSON"),e}const o=sn();Oe(null),$e({answer:!0});try{const e=await o.createAnswer(n);return Be(e),nn(),Se(t?await tn(e)?"Answer copied. Send it back to the host.":"Answer ready. Copy it manually for the host.":"Answer ready. Share it with the host."),e}catch(e){throw Oe(e?.message??"Failed to build answer"),e}finally{$e({answer:!1})}}async function pn(e){const t=en(e);if(!t)throw new Error("Answer empty");let a;try{a=JSON.stringify(JSON.parse(t))}catch(e){throw Oe("Answer must be valid JSON"),e}const n=sn();Oe(null);try{await n.acceptRemoteDescription(a),Be(a),Se("Answer applied. Waiting for connection...")}catch(e){throw Oe(e?.message??"Failed to accept answer"),e}}function xn(e){if(!Array.isArray(e)||0===e.length)return;const t=an(e);if(0===t.length)return;let a;try{a=sn()}catch(e){return void console.warn("P2P unavailable while applying candidates",e)}const n=ve(),o=Array.isArray(n.p2p.remoteCandidates)?n.p2p.remoteCandidates:[],i=new Set(o),r=o.slice();for(const e of t)if(!i.has(e))try{a.addRemoteCandidate(e),r.push(e),i.add(e)}catch(e){console.warn("Failed to add ICE candidate",e)}Le(r)}function wn(){const e=ve();if(e.hosting&&e.hostingSessionId){const t=e.servers.find(t=>t.id===e.hostingSessionId),a=t?.signal??null;a&&(a.joinAnswer&&e.p2p.answer!==a.joinAnswer&&pn(a.joinAnswer).catch(e=>{console.warn("Failed to apply joiner answer",e)}),Array.isArray(a.joinCandidates)&&a.joinCandidates.length>0&&xn(a.joinCandidates),a.joinAnswer&&(e.hostingMetrics?.playerCount??1)<2&&(setHostingMetrics({playerCount:Math.max(2,e.hostingMetrics?.playerCount??1)}),fn().catch(e=>console.warn("Heartbeat update failed",e))))}if(e.joinedSessionId){const t=e.servers.find(t=>t.id===e.joinedSessionId),a=t?.signal??null;a&&Array.isArray(a.hostCandidates)&&a.hostCandidates.length>0?xn(a.hostCandidates):t||Ie(null)}}async function vn(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the host offer JSON","");if(null==e)return Se("Offer entry cancelled."),null;try{return await yn(e,{autoCopyAnswer:!0})}catch(e){throw Se("Invalid offer. Please try again."),e}}async function bn(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the player's answer JSON","");if(null==e)return Se("Answer entry cancelled."),null;try{return await pn(e),e}catch(e){throw Se("Invalid answer. Ask the player to resend it."),e}}function kn(){const e=ve();return e.hosting?(Se("Already hosting."),Promise.resolve({alreadyHosting:!0})):(Fe(),Ie(null),Se("Preparing host offer..."),Te(null),mn({forceRegenerate:!0}).then(t=>cn({signal:{hostOffer:t,hostCandidates:nn()}}).then(t=>(Se(`Hosting ${e.hostingSessionId??t.id}`),t))).catch(e=>{throw Te("string"==typeof e?.message?e.message:"Host failed"),Se(null),e}))}function Tn(){return ve().hosting?(Se("Stopping session..."),Te(null),hn().then(()=>{Se("Hosting stopped."),Ie(null)}).catch(e=>{throw Te("string"==typeof e?.message?e.message:"Stop failed"),e})):(Se("Not hosting any session."),Promise.resolve({alreadyStopped:!0}))}function Sn(e){return e?(()=>{const t=e.signal??{};return t.hostOffer?(console.debug(`[serverBrowser] using cached signal for ${e.id}`),Promise.resolve({server:e,signal:t})):(console.debug(`[serverBrowser] cached signal missing for ${e.id}, fetching detail`),Se("Syncing host signal..."),async function(e){const t=Qa();if(!t)throw new Error("Server API base not configured");console.debug(`[serverBrowser] fetching session detail for ${e}`);const a=await fetch(`${t}/sessions/${e}`);if(404===a.status)return console.warn(`[serverBrowser] session ${e} no longer exists (404)`),{notFound:!0};if(!a.ok)throw console.warn(`[serverBrowser] session detail request failed ${a.status} for ${e}`),new Error(`Session lookup failed (HTTP ${a.status})`);const n=await a.json();return console.debug(`[serverBrowser] received session detail for ${e}`),n}(e.id).then(t=>{if(t?.notFound){console.warn(`[serverBrowser] session ${e.id} vanished before join`);const t=ve(),a=t.servers.findIndex(t=>t.id===e.id);throw a>=0&&t.servers.splice(a,1),Ie(null),new Error("Session no longer available")}const a=t?.session,n=a?.signal??{};if(!n.hostOffer)throw new Error("Host offer unavailable. Ask the host to refresh.");const o=ve(),i={...e,signal:{hostOffer:n.hostOffer??null,hostCandidates:Array.isArray(n.hostCandidates)?n.hostCandidates.slice():[],joinAnswer:n.joinAnswer??null,joinCandidates:Array.isArray(n.joinCandidates)?n.joinCandidates.slice():[]},updatedAt:a?.updatedAt??e.updatedAt},r=o.servers.findIndex(t=>t.id===e.id);return r>=0&&(o.servers[r]=i),console.debug(`[serverBrowser] refreshed signal for ${e.id}`),{server:i,signal:i.signal}}))})().then(({server:e,signal:t})=>(Fe(),Ie(null),Ce(null),console.debug(`[serverBrowser] applying host offer for ${e.id}`),Se(`Connecting to ${e.name??e.id}...`),Te(null),yn(t.hostOffer,{autoCopyAnswer:!1}).then(t=>{const a=nn();return console.debug(`[serverBrowser] posting join payload for ${e.id}`),un(e.id,{signalAnswer:t,signalCandidates:a}).then(t=>(Ie(e.id),Array.isArray(t?.session?.signal?.hostCandidates)&&xn(t.session.signal.hostCandidates),Se(`Joined ${t?.session?.name??e.name??e.id}`),t))}))).catch(t=>{const a="string"==typeof t?.message?t.message:"Join failed";throw console.warn(`[serverBrowser] join failed for ${e.id}: ${a}`),Ce(a),Se(null),t}):(Ce("No server selected."),Promise.reject(new Error("No server selected")))}function Mn(){O.x=Math.max(40,Math.min(k.width-40,O.x))}function Cn(e){!function(e){Ge+=e}(e),O.invulnerability=Math.max(0,O.invulnerability-e),O.throwCooldown=Math.max(0,O.throwCooldown-e),O.gadgetCooldown=Math.max(0,(O.gadgetCooldown??0)-e),O.stunTimer=Math.max(0,(O.stunTimer??0)-e),O.flashBlindTimer=Math.max(0,(O.flashBlindTimer??0)-e),O.smokeSlowTimer=Math.max(0,(O.smokeSlowTimer??0)-e),O.smokeSlowTimer<=0&&(O.smokeSlowStrength=1);const t=p.interactBuffered;p.interactBuffered=!1;const a=p.squadCommandCycleBuffered,n=p.squadCommandSelect,o=p.serverBrowserToggleBuffered,i=p.serverBrowserNavigate,r=p.serverBrowserJoinBuffered,s=p.serverBrowserHostBuffered,l=p.serverBrowserStopHostBuffered,d=p.serverBrowserCopyOfferBuffered,c=p.serverBrowserPasteOfferBuffered,f=p.serverBrowserAcceptAnswerBuffered,h=p.serverBrowserCopyCandidatesBuffered,u=p.serverBrowserPasteCandidatesBuffered;p.squadCommandCycleBuffered=!1,p.squadCommandSelect=null,p.serverBrowserToggleBuffered=!1,p.serverBrowserNavigate=0,p.serverBrowserJoinBuffered=!1,p.serverBrowserHostBuffered=!1,p.serverBrowserStopHostBuffered=!1,p.serverBrowserCopyOfferBuffered=!1,p.serverBrowserPasteOfferBuffered=!1,p.serverBrowserAcceptAnswerBuffered=!1;const m=O.health>0&&p.attackBuffered,g=O.health>0&&p.throwBuffered,y=O.health>0&&p.reloadBuffered;p.attackBuffered=!1,p.throwBuffered=!1,p.reloadBuffered=!1;const x=p.roll;if(p.roll=!1,function(e){if(O.vehicleId){O.vehicleCandidateId=null;const t=La();return void(e&&t&&t.enterCooldown<=.01&&Fa(t,{preferDirection:t.facing}))}if(O.health<=0)return void(O.vehicleCandidateId=null);let t=null,a=Number.POSITIVE_INFINITY;const n=B(I.standing),o=O.y+n;for(const e of ze){const n=We[e.type];if(!n)continue;if(e.driverId)continue;if(e.enterCooldown>0)continue;const i=Math.abs(O.x-e.x);if(i>(n.enterRadius??64))continue;const r=e.y+n.height,s=Math.abs(o-r),l=n.movementType??"ground";let d;if(d="air"===l?Math.max(120,(n.hoverMinAltitude??0)+80):"water"===l?Math.max(90,(n.waterSurfaceOffset??24)+70):80,s>d)continue;const c=i+.5*s;c<a&&(a=c,t=e)}O.vehicleCandidateId=t?.id??null,e&&t&&function(e){const t=We[e.type];t&&(e.driverId=Ea,e.enterCooldown=.45,O.vehicleId=e.id,O.controlMode="vehicle",O.vehicleCandidateId=null,O.attacking=!1,O.currentAttack=null,O.attackIndex=-1,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.nextAttackQueued=!1,O.hitboxSpawned=!1,O.activeHitboxes.length=0,O.crouching=!1,O.rolling=!1,$a(e,t))}(t)}(t),a&&function(){if(O.squadCommandCooldown>0)return Ia();O.squadCommandIndex=(O.squadCommandIndex+1)%R.length;const e=Ia();O.squadCommandId=e?.id??O.squadCommandId,O.squadCommandCooldown=1.4}(),n&&function(e){const t=R.findIndex(t=>t.id===e);t>=0&&(O.squadCommandIndex=t,O.squadCommandId=e,O.squadCommandCooldown=1.4)}(n),o&&(ve().visible?be(!1):(be(!0),Ae(0),dn())),0!==i&&ve().visible&&function(e){0!==we.servers.length&&(we.selectedIndex=(we.selectedIndex+e+we.servers.length)%we.servers.length)}(i),r){const e=ve(),t=e.visible?e.servers[e.selectedIndex]:null;t&&Sn(t).catch(e=>console.warn("Join failed",e))}if(s&&ve().visible&&kn().catch(e=>console.warn("Host failed",e)),l&&ve().visible&&Tn().catch(e=>console.warn("Stop hosting failed",e)),d){const e=ve();e.visible&&e.hosting&&gn({forceRegenerate:!1,silent:!1}).catch(e=>console.warn("Offer copy failed",e))}if(c&&ve().visible&&vn().catch(e=>console.warn("Offer accept failed",e)),f){const e=ve();e.visible&&e.hosting&&bn().catch(e=>console.warn("Answer apply failed",e))}if(h){const e=ve();e.visible&&e.hosting&&on({silent:!1}).catch(e=>console.warn("Candidate copy failed",e))}u&&ve().visible&&rn().catch(e=>console.warn("Candidate apply failed",e));let w=La(),b=Boolean(w);O.health<=0&&b&&(function(e={}){const t=La();if(!t)return O.vehicleId=null,void(O.controlMode="onFoot");Fa(t,{skipCooldown:!0,inheritVelocity:!1,...e})}({preferDirection:w?.facing}),w=null,b=!1),x&&O.health>0&&!b&&function(e){if(O.vehicleId)return;if(!O.onGround||O.rolling||O.attacking||O.health<=0||(O.stunTimer??0)>0)return;const{left:t,right:a}=e;t&&!a?O.facing=-1:a&&!t&&(O.facing=1),O.rolling=!0,O.rollTimer=.32,O.crouching=!1,O.vy=0}({left:p.left,right:p.right}),b||"vehicle"!==O.controlMode||(O.controlMode="onFoot");const A=!b&&O.stunTimer<=0&&!O.reloading,P=!!A&&m,D=!!A&&g,E=!!A&&y;O.health>0?b?function(){const e=La();if(!e)return O.vehicleId=null,void(O.controlMode="onFoot");O.controlMode="vehicle",O.crouching=!1,O.rolling=!1,O.onGround=e.onGround||null!=e.waterLineY}():function(e){if(O.vehicleId)return;if(O.crouching=p.down&&O.onGround&&!O.rolling&&!O.attacking,O.rolling)O.vx=420*O.facing,O.vy=0,O.rollTimer-=e,O.rollTimer<=0&&(O.rolling=!1);else{let t=M;if(O.crouching&&(t*=.55),O.attacking&&(t*=.7),O.reloading&&(t*=.8),O.smokeSlowTimer>0){const e=O.smokeSlowStrength??.6;t*=Math.max(.1,Math.min(1,e))}O.stunTimer>0&&(t*=.25),O.vx=0,p.left&&(O.vx-=t,O.facing=-1),p.right&&(O.vx+=t,O.facing=1);const a=O.stunTimer<=0;O.onGround&&a&&p.jump&&!O.crouching&&!O.attacking&&(O.vy=-460,O.onGround=!1),O.vy+=C*e}const t=O.y;O.x+=O.vx*e,O.y+=O.vy*e,O.onGround=!1;const a=B(I.standing);Sa(O,t,a)||O.y+a>=S&&(O.y=S-a,O.vy=0,O.onGround=!0),Mn()}(e):function(e){const t=B(I.standing);O.vehicleId=null,O.controlMode="onFoot",O.vehicleCandidateId=null,O.deadTimer=Math.max(0,O.deadTimer-e),O.vx*=.9,O.vy+=C*e,O.x+=O.vx*e,O.y+=O.vy*e,O.y+t>=S&&(O.y=S-t,O.vy=0,O.onGround=!0),Mn(),0===O.deadTimer&&(O.health=O.maxHealth,O.invulnerability=1.2,O.throwCooldown=0,O.gadgetCooldown=0,O.reloading=!1,O.stunTimer=0,O.flashBlindTimer=0,O.smokeSlowTimer=0,O.smokeSlowStrength=1,Qe.length=0,rt("cleared"),at(),O.x=.5*k.width,O.y=S-t,O.vx=0,O.vy=0,O.onGround=!0)}(e),O.currentPose=O.rolling?I.rolling:O.crouching?I.crouching:I.standing;const L=B(O.currentPose);!function(e={}){Number.isFinite(e.playerCount)&&(we.hostingMetrics.playerCount=Math.max(1,Math.round(e.playerCount))),Number.isFinite(e.enemyCount)&&(we.hostingMetrics.enemyCount=Math.max(0,Math.round(e.enemyCount))),Number.isFinite(e.alliesCount)&&(we.hostingMetrics.alliesCount=Math.max(0,Math.round(e.alliesCount)))}({playerCount:1+H().length,enemyCount:N.reduce((e,t)=>e+(t.health>0?1:0),0),alliesCount:$.reduce((e,t)=>e+(t&&"defeated"!==t.state?1:0),0)});const j="undefined"!=typeof performance?performance.now():Date.now();!function(e){for(const t of ze){const a=We[t.type];if(!a)continue;t.enterCooldown=Math.max(0,t.enterCooldown-e),t.damageFlash=Math.max(0,t.damageFlash-e);const n=t.driverId===Ea,o=a.movementType??"ground";"air"===o?Na(t,a,e,n):"water"===o?Wa(t,a,e,n):Ha(t,a,e,n),za(t,a,e,n),n?$a(t,a):"ground"===o&&(t.tilt+=(0-t.tilt)*Math.min(1,10*e))}}(e),Jt(e),function(e){for(const t of ut)t.flashTimer=Math.max(0,(t.flashTimer??0)-e),t.shakeTimer=Math.max(0,(t.shakeTimer??0)-e),t.smokeTimer=Math.max(0,(t.smokeTimer??0)-e),t.shakeMagnitude*=t.shakeTimer>0?.92:.6,t.destroyed?t.rubbleLevel=Math.min(1,(t.rubbleLevel??0)+2.2*e):t.rubbleLevel=Math.max(0,(t.rubbleLevel??0)-.8*e)}(e),function(e){if(function(){if(Xa.seeded)return;Xa.seeded=!0;const e=Math.max(24-N.length,0);e<=0||_a(e)}(),N.length>=100)Xa.timer=2.2;else if(Xa.timer-=e,Xa.timer<=0){const e=Math.max(24-N.length,0),t=Math.min(6,100-N.length);_a(Math.max(t,e)),Xa.timer=2.2}}(e),function(e,t){const a=ve();if(wn(),a.visible){if(nn(),t-a.lastFetch>=15e3&&!a.fetching&&(Ae(t),dn()),a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&fn()}wn()}else if(a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&fn()}}(0,j),function(){if(function(e=6e3){const t="undefined"!=typeof performance?performance.now():Date.now();for(const[a,n]of F.entries())t-(n.lastUpdate??t)>e&&F.delete(a)}(),ye(),!ce||"open"!==ce.readyState)return;const e="undefined"!=typeof performance?performance.now():Date.now();if(e-he<60)return;he=e;const t={type:"playerState",id:le,name:"Remote",x:O.x,y:O.y,facing:O.facing,commandId:O.squadCommandId};try{ce.send(JSON.stringify(t))}catch{}}(),function(e){O.squadCommandCooldown=Math.max(0,O.squadCommandCooldown-e);let t=0;for(const a of $)a.roleIndex=t,t+=1,Ra(a,e)}(e),w=La(),b=Boolean(w),b&&(O.controlMode="vehicle"),A||(O.attacking=!1,O.currentAttack=null,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.nextAttackQueued=!1,O.hitboxSpawned=!1,O.attackIndex=-1,O.activeHitboxes.length=0);const z=Q(),q=z?.category??"",Y=(z?.attackChain??[]).length>0,J=q.startsWith("ranged"),V="throwable"===q;if("gadget"===q)(P||D)&&st(z),O.activeHitboxes.length=0;else if(V)(P||D)&&function(){const e=Q();if((O.stunTimer??0)>0)return!1;if(!e||"throwable"!==e.category)return!1;if(O.throwCooldown>0||O.health<=0||O.rolling)return!1;const t=e.throwable??{},a=O.facing||1,n=t.arcVelocity??{vx:260,vy:-420},o=t.spawnOffset??{x:22,y:12};O.throwCooldown=t.cooldownSeconds??.9;const i={id:`grenade-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:O.x+a*(o.x??22),y:O.y+(o.y??12),vx:a*(n.vx??260),vy:n.vy??-420,radius:t.radius??16,fuse:t.fuseSeconds??1.5,maxFuse:t.fuseSeconds??1.5,explosionRadius:t.explosionRadius??120,damage:t.damage??45,knockback:t.knockback??260,gravityFactor:t.gravityFactor??.5,bounciness:Ye(t.bounciness??.45,0,.95),color:t.color??"#ffb347",explosionDuration:t.explosionDuration??.32,selfDamageScale:Ye(t.selfDamageScale??.65,0,1),selfKnockbackScale:Ye(t.selfKnockbackScale??.6,0,1),effectType:t.effectType??"explosive",stunDuration:t.stunDuration??0,playerStunDuration:t.playerStunDuration??0,smokeDuration:t.smokeDuration??0,smokeRadius:t.smokeRadius??t.explosionRadius??120,smokeExpansion:t.smokeExpansion??1.1,smokeSlowMultiplier:Ye(t.smokeSlowMultiplier??.55,.1,1),smokeTickDuration:t.smokeTickDuration??.5,detonated:!1,explosionTimer:0};Ot.push(i),Ft("throwable:thrown",{id:i.id,effectType:i.effectType,x:i.x,y:i.y,radius:i.explosionRadius,fuse:i.fuse})}(),O.activeHitboxes.length=0;else if(J&&!Y){if(O.activeHitboxes.length=0,z){const e=K(z.id);E&&U(z.id)&&(O.attacking=!1,O.currentAttack=null,O.attackIndex=-1),P&&Ka(),e&&e.magazine<=0&&e.reserve>0&&!e.reloading&&U(z.id)}}else Y?(P&&function(){if(O.vehicleId)return;if(O.rolling||O.health<=0||(O.stunTimer??0)>0||O.reloading)return;const e=Q(),t=e?.attackChain??[];0!==t.length&&(O.attacking?O.comboWindowOpen&&O.attackIndex+1<t.length&&(O.nextAttackQueued=!0):Ga(0))}(),O.attacking&&function(e,t){if(O.vehicleId)return O.attacking=!1,O.currentAttack=null,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.hitboxSpawned=!1,void(O.attackIndex=-1);const a=O.currentAttack;if(!a)return;if((O.stunTimer??0)>0||O.reloading)return O.attacking=!1,O.currentAttack=null,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,void(O.hitboxSpawned=!1);O.attackElapsed+=e,!O.hitboxSpawned&&O.attackElapsed>=a.windup&&(t(a),O.hitboxSpawned=!0),!O.comboWindowOpen&&O.attackElapsed>=a.comboStart&&(O.comboWindowOpen=!0,O.comboWindowTimer=a.comboWindow),O.comboWindowOpen&&(O.comboWindowTimer-=e,O.comboWindowTimer<=0&&(O.comboWindowOpen=!1));const n=Q(),o=n?.attackChain??[];if(O.attackElapsed>=a.windup+a.active+a.recovery){const e=O.attackIndex+1,t=O.nextAttackQueued&&e<o.length;O.attacking=!1,O.currentAttack=null,O.attackElapsed=0,O.comboWindowOpen=!1,O.comboWindowTimer=0,O.hitboxSpawned=!1,O.nextAttackQueued=!1,t?Ga(e):O.attackIndex=-1}}(e,Ja),function(e,t){O.activeHitboxes=O.activeHitboxes.filter(a=>(a.remaining-=e,a.ownerFacing=O.facing,a.x=O.x+O.facing*a.offsetX,a.y=O.y+t+a.heightOffset,a.remaining>0))}(e,L),function(){for(const e of O.activeHitboxes){if(W.health>0&&!e.hitTargets.has(W.id)){const t=e.x-W.x,a=e.y-(W.y+.55*W.height);Math.hypot(t,a)<=e.radius+W.radius&&(e.hitTargets.add(W.id),lt({damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}for(const t of N){if(t.health<=0||e.hitTargets.has(t.id))continue;const a=e.x-t.x,n=e.y-(t.y+.5*t.height);Math.hypot(a,n)<=e.radius+t.radius&&(e.hitTargets.add(t.id),dt(t,{damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}Rt(e)}}()):(O.activeHitboxes.length=0,J&&P&&Ka());!function(e){W.flashTimer>0&&(W.flashTimer=Math.max(0,W.flashTimer-e)),W.shakeTimer>0&&(W.shakeTimer=Math.max(0,W.shakeTimer-e)),W.shakeMagnitude=Math.max(0,W.shakeMagnitude-20*e),W.health<=0&&(W.respawnTimer=Math.max(0,W.respawnTimer-e),0===W.respawnTimer&&(W.health=W.maxHealth,W.flashTimer=0,W.shakeTimer=0,W.shakeMagnitude=0))}(e),function(e){const t=T.canvas.width;for(const a of Ot)a.detonated?a.explosionTimer-=e:(a.fuse-=e,a.vy+=C*a.gravityFactor*e,a.x+=a.vx*e,a.y+=a.vy*e,a.y+a.radius>=S&&(a.y=S-a.radius,a.vy>0&&(a.vy=-a.vy*a.bounciness),a.vx*=.7,Math.abs(a.vy)<36&&(a.vy=0)),(a.x-a.radius<=0||a.x+a.radius>=t)&&(a.x=Ye(a.x,a.radius,t-a.radius),a.vx=.45*-a.vx),a.fuse<=0&&Ht(a));for(let e=Ot.length-1;e>=0;e-=1)Ot[e].detonated&&Ot[e].explosionTimer<=0&&Ot.splice(e,1);!function(e){for(const t of $t){t.life=Math.max(0,t.life-e);const a=1-t.life/t.duration;if(t.radius=Ye(t.baseRadius+(t.maxRadius-t.baseRadius)*Ye(a,0,1),t.baseRadius,t.maxRadius),t.tickTimer-=e,t.tickTimer<=0){t.tickTimer=t.tick;const e=t.radius;for(const a of N){if(a.health<=0)continue;const n=a.x-t.x,o=a.y+.5*a.height-t.y;Math.hypot(n,o)<=e&&(a.smokeSlowTimer=Math.max(a.smokeSlowTimer??0,t.tick+.4),a.smokeSlowStrength=Math.min(a.smokeSlowStrength??1,t.slowMultiplier))}const a=B(O.currentPose??{headRadius:16,bodyLength:34,legLength:36}),n=O.y+.6*a,o=O.x-t.x,i=n-t.y;Math.hypot(o,i)<=e&&(O.smokeSlowTimer=Math.max(O.smokeSlowTimer??0,t.tick+.4),O.smokeSlowStrength=Math.min(O.smokeSlowStrength??1,t.slowMultiplier+.1))}}for(let e=$t.length-1;e>=0;e-=1)if($t[e].life<=0){const t=$t.splice(e,1)[0];Ft("throwable:smoke-dissipate",{id:t.id,x:t.x,y:t.y,radius:t.maxRadius??t.radius})}}(e)}(e),function(e){!function(e){for(const t of Qe){t.duration-=e,t.fireTimer-=e;const a=Ze(t);a&&t.fireTimer<=0&&et(t,a)}for(let e=Qe.length-1;e>=0;e-=1)Qe[e].duration<=0&&Qe.splice(e,1)}(e),function(e){nt.active&&(nt.duration-=e,nt.flashTimer=Math.max(0,nt.flashTimer-e),nt.duration<=0?rt("expired"):nt.strength<=0&&(it("shield:shatter",{reason:"decayed",center:ot(),maxStrength:nt.maxStrength,radius:nt.radius}),rt("shatter")))}(e)}(e),function(e){!function(e){tt.cooldown>0&&(tt.cooldown=Math.max(0,tt.cooldown-e)),function(e){if(!tt.active)return;const t=tt.travelSpeed??860,a=tt.pullSpeed??740,n=(tt.retracting?a:t)*e;if(tt.retracting){tt.duration-=e;const t=tt.targetX-O.x,o=tt.targetY-O.y,i=Math.hypot(t,o);if(i>12){const n=Math.min(i,a*e);O.vx=t/i*n/e,O.vy=o/i*n/e,O.x+=t/i*n,O.y+=o/i*n}tt.tetherLength=Math.max(0,tt.tetherLength-n),(tt.duration<=0||tt.tetherLength<=0)&&at()}else tt.tetherLength+=n,tt.tetherLength>=tt.maxLength&&(tt.tetherLength=tt.maxLength,tt.retracting=!0)}(e)}(e)}(e),function(e,t){const a=[];for(const[t,n]of G.entries())if(v[t]){if(n.reloading&&(n.reloadTimer=Math.max(0,n.reloadTimer-e),n.reloadTimer<=0)){if(n.capacity!==Number.POSITIVE_INFINITY){const e=n.capacity-n.magazine;if(e>0){const t=Math.min(e,n.reserve);n.magazine+=t,n.reserve-=t}}n.reloading=!1,n.reloadTimer=0,a.push(t)}if(n.spread&&n.spreadDef){const t=n.spreadDef.base??0,a=n.spreadDef.recovery??0;n.spread.current=a>0?Math.max(t,n.spread.current-a*e):Math.max(t,n.spread.current??t)}}else G.delete(t);if(t){const e=G.get(t);O.reloading=e?.reloading??!1}else O.reloading=!1;if("undefined"!=typeof window)for(const e of a)window.dispatchEvent(new CustomEvent("weapon:reload-finish",{detail:{weaponId:e}}))}(e,z?.id??null),function(e){const t=Ta.decay??12,a=Math.max(0,1-t*e);Ta.horizontalKick*=a,Ta.verticalKick*=a}(e),function(e){for(const t of Xe)t.life-=e,t.x+=t.vx*e,t.y+=t.vy*e,t.vy-=40*e;for(let e=Xe.length-1;e>=0;e-=1)Xe[e].life<=0&&Xe.splice(e,1)}(e),function(e){vt();for(let t=mt.length-1;t>=0;t-=1){const a=mt[t];if(a.ttl-=e,a.ttl<=0){mt.splice(t,1);continue}const n=Ye(a.ttl/a.maxTtl,0,1);a.x+=a.vx*e,a.y+=a.vy*e,"shield"===a.type?(a.vx*=.88,a.vy*=.88,a.radius*=.96+.04*n):"smoke"===a.type?(a.vx*=.9,a.vy=.9*(a.vy??0)-24*e,a.radius*=.995+.02*n):"ember"===a.type?(a.vx*=.94,a.vy*=.94):"debris"===a.type?(a.vy+=520*e,a.vx*=.88,a.vy*=.9,a.radius*=.95):"flash"===a.type?(a.vx*=.8,a.vy*=.8,a.radius*=.9+.08*n):(a.vx*=.86,a.vy*=.86)}for(let t=gt.length-1;t>=0;t-=1){const a=gt[t];a.ttl-=e,a.ttl<=0&&gt.splice(t,1)}}(e),function(e){va(),ba(Vt,e),ba(Xt,e),ba(_t,e),ba(Qt,e),ba(Zt,e)}(e),function(e){for(const t of Bt)if(t.life-=e,t.vy+=C*e*t.gravityFactor,t.x+=t.vx*e,t.y+=t.vy*e,t.y+t.radius>=S)t.life=0;else if(W.health>0&&!t.hitTargets.has(W.id)&&Lt(t.x,t.y,t.radius,W.x,W.y+.55*W.height,W.radius))t.hitTargets.add(W.id),lt({damage:t.damage,knockback:t.knockback,facing:t.facing}),t.life=0;else{for(const e of N)if(!(e.health<=0||t.hitTargets.has(e.id))&&Lt(t.x,t.y,t.radius,e.x,e.y+.5*e.height,e.radius)){t.hitTargets.add(e.id),dt(e,{damage:t.damage,knockback:t.knockback,launch:0,facing:t.facing}),t.life=0;break}t.life>0&&Dt(t)&&(t.life=0)}for(let e=Bt.length-1;e>=0;e-=1)Bt[e].life<=0&&Bt.splice(e,1)}(e),function(e,t){for(const a of Ue)a.life-=e,a.vy+=C*e*.9,a.x+=a.vx*e,a.y+=a.vy*e,a.vx*=.96,a.y+a.radius>=t&&(a.y=t-a.radius,a.vy=.35*-a.vy,a.vx*=.7,Math.abs(a.vy)<20&&(a.vy=0));for(let e=Ue.length-1;e>=0;e-=1)Ue[e].life<=.05&&Ue.splice(e,1)}(e,S),function(e){for(const t of N)Ua(t,e);for(const e of N)Va(e)}(e)}"undefined"!=typeof window&&(window.ServerBrowser={fetch:dn,host:cn,join:un,stop:hn,attemptHost:kn,attemptStop:Tn,attemptJoin:Sn,copyOffer:gn,regenerateOffer:()=>gn({forceRegenerate:!0,silent:!0}),promptOffer:vn,promptAnswer:bn,copyCandidates:on,promptCandidates:rn,syncCandidates:nn,state:ve}),x||(window.addEventListener("keydown",e=>w(!0,e)),window.addEventListener("keyup",e=>w(!1,e)),window.addEventListener("mousedown",function(e){0===e.button?(p.attackBuffered=!0,p.attackDown=!0,e.preventDefault()):2===e.button&&(p.throwBuffered=!0,p.throwDown=!0,e.preventDefault())}),window.addEventListener("mouseup",function(e){0===e.button?(p.attackDown=!1,e.preventDefault()):2===e.button&&(p.throwDown=!1,e.preventDefault())}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("blur",function(){p.left=!1,p.right=!1,p.jump=!1,p.down=!1,p.roll=!1,p.attackBuffered=!1,p.throwBuffered=!1,p.reloadBuffered=!1,p.interactBuffered=!1,p.attackDown=!1,p.throwDown=!1,p.squadCommandCycleBuffered=!1,p.squadCommandSelect=null,p.serverBrowserToggleBuffered=!1,p.serverBrowserNavigate=0,p.serverBrowserJoinBuffered=!1,p.serverBrowserHostBuffered=!1,p.serverBrowserStopHostBuffered=!1,p.serverBrowserCopyOfferBuffered=!1,p.serverBrowserPasteOfferBuffered=!1,p.serverBrowserAcceptAnswerBuffered=!1,p.serverBrowserCopyCandidatesBuffered=!1,p.serverBrowserPasteCandidatesBuffered=!1}),x=!0),X||(window.addEventListener("keydown",function(e){const t=(a=e.code).startsWith("Digit")?Number.parseInt(a.slice(5),10):a.startsWith("Numpad")?Number.parseInt(a.slice(6),10):Number.NaN;var a;!Number.isNaN(t)&&t>=1&&(Z(t-1),e.preventDefault())}),X=!0),te||"undefined"==typeof window||(te=!0,oe(),Object.keys(ne).forEach(function(e){const t=ne[e];t&&window.addEventListener(e,e=>{!function(e,t){const a=oe();if(!a)return;ie();const n=performance.now(),o=e.cooldown??80,i=e;if(n-(ae.get(i)??0)<o)return;ae.set(i,n);const r=a.createOscillator();r.type=e.shape??"sine";const s="function"==typeof e.frequency?e.frequency(t):e.frequency;r.frequency.setValueAtTime(Math.max(40,s??440),a.currentTime);const l=a.createGain(),d=Math.max(.001,e.gain??.05),c=Math.max(.05,e.duration??.12);l.gain.setValueAtTime(d,a.currentTime),l.gain.exponentialRampToValueAtTime(1e-4,a.currentTime+c),r.connect(l),l.connect(a.destination),r.start(),r.stop(a.currentTime+c)}(t,e?.detail??{})})}),window.addEventListener("pointerdown",re),window.addEventListener("keydown",re)),ye(),"undefined"!=typeof window&&(window.P2P={createOffer:async function(){ye();const e=await de.createOffer();return await de.setLocalDescription(e),me=JSON.stringify(e),me},createAnswer:async function(e){ye();const t=JSON.parse(e);await de.setRemoteDescription(new RTCSessionDescription(t));const a=await de.createAnswer();return await de.setLocalDescription(a),me=JSON.stringify(a),me},acceptRemoteDescription:async function(e){ye();const t=JSON.parse(e);await de.setRemoteDescription(new RTCSessionDescription(t))},addRemoteCandidate:async function(e){if(!e)return;ye();const t=new RTCIceCandidate(JSON.parse(e));await de.addIceCandidate(t)},getLocalDescription:function(){return me},getLocalCandidates:function(){return[...ge]},getStatus:xe,close:function(){ce&&(ce.close(),ce=null),fe&&(fe.close(),fe=null),de&&(de.close(),de=null),ue="disconnected"}});let In=performance.now();window.requestAnimationFrame(function e(t){const a=Math.min((t-In)/1e3,.1);In=t,Cn(a),function(){const e=T.createLinearGradient(0,0,0,T.canvas.height);e.addColorStop(0,"#111a2c"),e.addColorStop(.4,"#182439"),e.addColorStop(.75,"#1f2d44"),e.addColorStop(1,"#232f49"),T.fillStyle=e,T.fillRect(0,0,T.canvas.width,T.canvas.height),T.fillStyle="#1a2437",T.beginPath(),T.moveTo(0,S-220),T.lineTo(220,S-260),T.lineTo(420,S-210),T.lineTo(640,S-280),T.lineTo(820,S-230),T.lineTo(1040,S-260),T.lineTo(1220,S-210),T.lineTo(1380,S-260),T.lineTo(T.canvas.width,S-200),T.lineTo(T.canvas.width,S),T.lineTo(0,S),T.closePath(),T.fill();const t=T.createLinearGradient(0,S-120,0,S-40);t.addColorStop(0,"rgba(46, 86, 126, 0.25)"),t.addColorStop(1,"rgba(28, 52, 84, 0)"),T.fillStyle=t,T.fillRect(0,S-140,T.canvas.width,120),T.fillStyle="#1b2231",T.fillRect(0,S,T.canvas.width,T.canvas.height-S)}(),function(){!function(){for(const e of P){const t=T.createLinearGradient(e.x,e.top,e.x,e.top+e.depth);t.addColorStop(0,"rgba(54, 98, 144, 0.88)"),t.addColorStop(.7,"rgba(36, 72, 112, 0.9)"),t.addColorStop(1,"rgba(24, 50, 84, 0.95)"),T.fillStyle=t,T.fillRect(e.x,e.top,e.width,e.depth),T.fillStyle="rgba(255, 204, 112, 0.25)",T.fillRect(e.x-10,e.top+2,e.width+20,4),T.strokeStyle="rgba(255, 255, 255, 0.12)",T.lineWidth=1.6;for(let t=0;t<e.width;t+=40){const a=e.top+6+3*Math.sin(.03*(t+e.top));T.beginPath(),T.moveTo(e.x+t,a),T.quadraticCurveTo(e.x+t+10,a+3,e.x+t+20,a),T.stroke()}}}();for(const e of A)Ca(e);!function(){for(const e of D)switch(e.type){case"building":{T.save(),T.fillStyle="#2a3240",T.fillRect(e.x,e.y,e.width,e.height),T.fillStyle="#4a6076";const t=Math.max(3,Math.floor(e.height/60));for(let a=0;a<t;a+=1){const n=e.y+20+a*(e.height/t);T.fillRect(e.x+10,n,e.width-20,8)}T.restore();break}case"billboard":T.save(),T.fillStyle="#1f2330",T.fillRect(e.x-e.width/2,e.y-e.height,e.width,e.height),T.fillStyle="#ffc851",T.font="18px 'Segoe UI', Arial, sans-serif",T.textAlign="center",T.fillText(e.text??"Ad",e.x,e.y-e.height/2),T.strokeStyle="#ffa940",T.lineWidth=3,T.strokeRect(e.x-e.width/2,e.y-e.height,e.width,e.height),T.restore();break;case"streetlight":T.save(),T.strokeStyle="#707789",T.lineWidth=4,T.beginPath(),T.moveTo(e.x,e.y+140),T.lineTo(e.x,e.y+30),T.stroke(),T.fillStyle="#ffd97a",T.beginPath(),T.arc(e.x,e.y+12,10,0,2*Math.PI),T.fill(),T.restore();break;case"hovercar":T.save(),T.fillStyle="#5d8fff",T.beginPath(),T.ellipse(e.x,e.y,46,16,0,0,2*Math.PI),T.fill(),T.fillStyle="#1f2536",T.fillRect(e.x-26,e.y-8,52,16),T.restore()}}()}(),function(){const e=Je(),t=ut;if(t&&0!==t.length){T.save();for(const a of t)Ut(a,e);T.restore()}}(),function(){const e=La(),t=O.vehicleCandidateId;for(const a of ze){const n=We[a.type];if(!n)continue;const o=e?.id===a.id,i=!o&&t===a.id,r=n.width??120,s=n.height??48,l=n.colorBody??"#2c3245",d=n.colorAccent??"#f0b239";T.save(),T.translate(a.x,a.y),T.rotate((a.tilt??0)*Math.PI/180),T.fillStyle=l,T.fillRect(-r/2,-s/2,r,s),T.fillStyle=d,T.fillRect(-r/2,-s/2-6,.6*r,8),T.restore(),(o||i)&&(T.save(),T.lineWidth=o?4:3,T.strokeStyle=o?"#8cffd4":"#ffc66d",T.setLineDash(o?[]:[8,8]),T.strokeRect(a.x-r/2-10,a.y-s/2-12,r+20,s+24),T.restore())}}(),function(){const e=Nt;if(0!==e.length){T.save(),T.textAlign="center",T.font="15px 'Segoe UI', Arial, sans-serif";for(const t of e){Kt(t);const e=Wt[t.typeId];"descending"!==t.state&&(T.fillStyle=t.glowColor,T.globalAlpha=.9,T.fillText(e?.label??t.label??"Supply Drop",t.x,t.y-16))}T.restore()}}(),function(){const e=H();for(const t of e){const e=I.standing,a=e.headRadius,n=e.bodyLength,o=e.legLength,i=e.armLength;T.save(),T.strokeStyle="#ff9cf7",T.lineWidth=4;const r=t.y+a;T.beginPath(),T.arc(t.x,r,a,0,2*Math.PI),T.stroke();const s=t.y+2*a,l=s+n;T.beginPath(),T.moveTo(t.x,s),T.lineTo(t.x,l),T.stroke(),T.beginPath(),T.moveTo(t.x,s+4),T.lineTo(t.x-i,s+.8*i),T.moveTo(t.x,s+4),T.lineTo(t.x+i,s+.6*i),T.stroke();const d=Math.max(.7*i,14),c=Math.min(S,l+o),f=Math.min(S,l+.95*o);T.beginPath(),T.moveTo(t.x,l),T.lineTo(t.x-d,c),T.moveTo(t.x,l),T.lineTo(t.x+d,f),T.stroke(),T.fillStyle="#ffd6ff",T.font="13px 'Segoe UI', Arial, sans-serif",T.textAlign="center",T.fillText(t.name??t.id??"Peer",t.x,t.y-16),T.restore()}}(),function(){const e=ve();if(!e.visible)return;const t=420,a=.5*T.canvas.width-240,n=.5*T.canvas.height-210;T.save(),T.fillStyle="rgba(12, 16, 24, 0.82)",T.fillRect(a,n,480,t),T.strokeStyle="#6f7fa0",T.lineWidth=3,T.strokeRect(a,n,480,t),T.fillStyle="#cfe3ff",T.font="18px 'Segoe UI', Arial, sans-serif",T.textAlign="left",T.fillText("Server Browser",a+20,n+32),T.font="13px 'Segoe UI', Arial, sans-serif",T.fillStyle="#9aa9c7",T.fillText("Join: Enter  |  Navigate: [ / ]  |  Close: L",a+20,n+52),T.fillText("Host: H  |  Stop: U  |  Offer: O  |  Paste Offer: P  |  Answer: I  |  ICE Copy: M  |  ICE Apply: N",a+20,n+68);let o=n+88;e.error&&(T.fillStyle="#ff8080",T.fillText(e.error,a+20,o),o+=18),e.statusMessage&&(T.fillStyle="#8cffd4",T.fillText(e.statusMessage,a+20,o),o+=18),e.joinError&&(T.fillStyle="#ff9a9a",T.fillText(e.joinError,a+20,o),o+=18),e.joinStatus&&(T.fillStyle="#cfe3ff",T.fillText(e.joinStatus,a+20,o),o+=18);const i=o+12,r=n+t-140,s=e.servers??[],l=Math.max(0,Math.floor((r-i)/34)),d=Math.min(s.length,Math.min(l,8));T.font="14px 'Segoe UI', Arial, sans-serif";for(let t=0;t<d;t+=1){const n=s[t],o=i+34*t;t===e.selectedIndex&&(T.fillStyle="rgba(108, 132, 220, 0.4)",T.fillRect(a+12,o-6,456,30)),T.fillStyle="#e4ecff",T.fillText(n.name??n.id??"Server",a+24,o+8),T.fillStyle="#9aa9c7";const r=`${n.map??"Unknown"} | ${n.players??"?"}/${n.maxPlayers??"?"} | ${n.region??"--"}`;T.fillText(r,a+24,o+22)}0===s.length&&(T.fillStyle="#a6b2cf",T.fillText("No servers available.",a+24,i+16));const c=(e,t=64)=>"string"!=typeof e?"":e.length>t?`${e.slice(0,t)}...`:e,f=e.p2p??{};let h=n+t-120;T.font="12px 'Segoe UI', Arial, sans-serif",T.fillStyle="#9aa9c7",T.fillText("P2P Handshake",a+20,h),h+=16,f.error&&(T.fillStyle="#ff8080",T.fillText(f.error,a+20,h),h+=16),e.hosting?(f.pendingOffer?(T.fillStyle="#ffd27f",T.fillText("Generating offer...",a+20,h),h+=16):f.offer?(T.fillStyle="#8cffd4",T.fillText("Offer ready (press O to copy).",a+20,h),h+=16,T.fillStyle="#9aa9c7",T.fillText(c(f.offer),a+20,h),h+=16):(T.fillStyle="#9aa9c7",T.fillText("Press O to generate an offer for peers.",a+20,h),h+=16),f.pendingAnswer&&(T.fillStyle="#ffd27f",T.fillText("Waiting for a joiner answer...",a+20,h),h+=16)):f.pendingAnswer?(T.fillStyle="#ffd27f",T.fillText("Generating answer...",a+20,h),h+=16):f.answer?(T.fillStyle="#8cffd4",T.fillText("Answer ready. Share it with the host.",a+20,h),h+=16,T.fillStyle="#9aa9c7",T.fillText(c(f.answer),a+20,h),h+=16):(T.fillStyle="#9aa9c7",T.fillText("Press P after copying the host offer JSON.",a+20,h),h+=16);const u=Array.isArray(f.localCandidates)?f.localCandidates:[],m=Array.isArray(f.remoteCandidates)?f.remoteCandidates:[];f.pendingCandidates&&(T.fillStyle="#ffd27f",T.fillText("Processing ICE candidates...",a+20,h),h+=16);const g="Local ICE ready: "+u.length+"  |  Remote applied: "+m.length;if(T.fillStyle="#9aa9c7",T.fillText(g,a+20,h),h+=16,u.length>0){const e="Last local: "+c(u[u.length-1],54);T.fillStyle="#6f86d0",T.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(T.fillStyle="#9aa9c7",T.fillText("Local ICE will appear shortly after offer/answer.",a+20,h),h+=16);if(m.length>0){const e="Last remote: "+c(m[m.length-1],54);T.fillStyle="#6fd0c5",T.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(T.fillStyle="#9aa9c7",e.hosting?T.fillText("Press N after players send their ICE (M).",a+20,h):T.fillText("Press M to copy your ICE and send it to the host.",a+20,h),h+=16);T.restore()}(),function(){const e=Ba(),t=e?.command?.id??"hold",a={hold:"#8cffd4",defend:"#66b3ff",attack:"#ff9f7a",flank:"#ffdd6f"};for(const e of $){const n=I.standing,o=n.headRadius,i=n.bodyLength,r=n.legLength,s=n.armLength;T.save();const l=a[t]??"#8cffd4";T.strokeStyle=l,T.lineWidth=4,T.lineCap="round";const d=e.y+o;T.beginPath(),T.arc(e.x,d,o,0,2*Math.PI),T.stroke();const c=e.y+2*o,f=c+i;T.beginPath(),T.moveTo(e.x,c),T.lineTo(e.x,f),T.stroke(),T.beginPath(),T.moveTo(e.x,c+4),T.lineTo(e.x-s,c+.8*s),T.moveTo(e.x,c+4),T.lineTo(e.x+s,c+.6*s),T.stroke();const h=Math.max(.7*s,14),u=Math.min(S,f+r),m=Math.min(S,f+.95*r);if(T.beginPath(),T.moveTo(e.x,f),T.lineTo(e.x-h,u),T.moveTo(e.x,f),T.lineTo(e.x+h,m),T.stroke(),(e.flashTimer??0)>0){const t=Math.min(1,e.flashTimer/.12);T.fillStyle=`rgba(140, 255, 212, ${t})`,T.beginPath(),T.arc(e.x+30*e.facing,c+.2*s,12,0,2*Math.PI),T.fill()}T.fillStyle=l,T.font="14px 'Segoe UI', Arial, sans-serif",T.textAlign="center",T.fillText(e.name??"Ally",e.x,e.y-12),T.restore()}}(),function(){const e=W,t=Je(),a=e.y,n=e.shakeTimer>0?Math.sin(40*t)*e.shakeMagnitude*Ye(e.shakeTimer/.4,0,1):0,o=e.health>0?n:0,i=e.health>0?e.flashTimer>0?"#ffe3af":"#9ca4b8":"#3b3f49";T.lineWidth=5,T.strokeStyle=i,T.lineCap="round";const r=e.x+o;T.beginPath(),T.arc(r,a+20,20,0,2*Math.PI),T.stroke(),T.beginPath(),T.moveTo(r,a+40),T.lineTo(r,S-20),T.stroke(),T.beginPath(),T.moveTo(r,S-20),T.lineTo(r-28,S),T.moveTo(r,S-20),T.lineTo(r+28,S),T.stroke();const s=a+48;T.beginPath(),T.moveTo(r,s),T.lineTo(r-36,s+18),T.moveTo(r,s),T.lineTo(r+36,s+18),T.stroke();const l=r-70,d=a-24;T.fillStyle="#23262d",T.fillRect(l,d,140,10);const c=e.health/e.maxHealth;T.fillStyle=e.health>0?"#5fffb5":"#44474f",T.fillRect(l,d,140*Ye(c,0,1),10),T.strokeStyle="#50535b",T.strokeRect(l,d,140,10),T.fillStyle="#cfd3df",T.font="14px 'Segoe UI', Arial, sans-serif",T.textAlign="center";const f=e.health>0?`Training Dummy ${Math.round(e.health)}/${e.maxHealth}`:"Respawning...";T.fillText(f,r,d-6),T.textAlign="left"}(),function(){const e=Je();for(const t of N){if(t.health<=0)continue;const a=t.shakeTimer>0?Math.sin(32*e)*t.shakeMagnitude*Ye(t.shakeTimer/.4,0,1):0,n=t.x+a,o=18,i=t.stunTimer>0?"#ffd166":t.flashTimer>0?"#ff9488":"#fa5b4a";T.lineWidth=5,T.strokeStyle=i,T.lineCap="round";const r=t.y;T.beginPath(),T.arc(n,r+o,o,0,2*Math.PI),T.stroke(),T.beginPath(),T.moveTo(n,r+2*o),T.lineTo(n,r+t.height-24),T.stroke(),T.beginPath(),T.moveTo(n,r+2.4*o),T.lineTo(n-30,r+3*o),T.moveTo(n,r+2.4*o),T.lineTo(n+30,r+3*o),T.stroke(),T.beginPath(),T.moveTo(n,t.y+t.height-26),T.lineTo(n-24,t.y+t.height),T.moveTo(n,t.y+t.height-26),T.lineTo(n+24,t.y+t.height),T.stroke();const s=110,l=8,d=n-s/2,c=r-20;T.fillStyle="#230c0a",T.fillRect(d,c,s,l);const f=t.health/t.maxHealth;T.fillStyle="#ff6f61",T.fillRect(d,c,s*Ye(f,0,1),l),T.strokeStyle="#5c3029",T.strokeRect(d,c,s,l)}}(),function(){if(!nt.active)return;T.save();const e=Ye(nt.flashTimer>0?.45:.25+nt.strength/Math.max(1,nt.maxStrength)*.35,.15,.6);T.strokeStyle=nt.color,T.lineWidth=4,T.globalAlpha=e,T.beginPath();const t=ot();T.arc(t.x,t.y,nt.radius,0,2*Math.PI),T.stroke(),T.globalAlpha=.4*e,T.fillStyle=nt.color,T.beginPath(),T.arc(t.x,t.y,.9*nt.radius,0,2*Math.PI),T.fill(),T.restore()}(),function(){if(0!==Qe.length){T.save();for(const e of Qe){const t=40,a=.4*e.height,n=Ye(e.duration/(e.maxDuration||1),0,1);T.fillStyle=e.baseColor,T.fillRect(e.x-.5*t,e.y+e.height-a,t,a);const o=.6*e.height;T.fillStyle=e.headColor,T.fillRect(e.x-.3*t,e.y,.6*t,o),T.fillStyle="#ffd66d",T.fillRect(e.x-.3*t,e.y-6,.6*t*n,4)}T.restore()}}(),function(){if(!tt.active)return;T.save(),T.strokeStyle=tt.color,T.lineWidth=3,T.beginPath(),T.moveTo(O.x,O.y);const e=tt.tetherLength/(tt.maxLength||1),t=O.x+(tt.targetX-O.x)*e,a=O.y+(tt.targetY-O.y)*e;T.lineTo(t,a),T.stroke(),T.restore()}(),function(){T.save();for(const e of Ue){const t=Ye(e.life/e.maxLife,0,1);T.globalAlpha=.85*t,T.fillStyle=e.color,T.beginPath(),T.arc(e.x,e.y,e.radius,0,2*Math.PI),T.fill()}T.restore()}(),function(){if(O.health<=0||O.vehicleId)return;const e=O.currentPose||I.standing,t=O.currentAttack,{headRadius:a,bodyLength:n,legLength:o,armLength:i,strideMultiplier:r,armSwingAmplitude:s,legSwingAmplitude:l}=e,d=Je(),c=Math.min(1,Math.abs(O.vx)/M)*r;let f=Math.sin(8*d)*s*c;if(O.attacking&&t){const e=t.windup+t.active+t.recovery,a=Ye(O.attackElapsed/e,0,1);f+=28*Math.sin(a*Math.PI)*O.facing}T.lineWidth=4,T.strokeStyle="#f4f7ff",T.lineCap="round";const h=O.y+a;T.beginPath(),T.arc(O.x,h,a,0,2*Math.PI),T.stroke();const u=O.y+2*a,m=u+n;T.beginPath(),T.moveTo(O.x,u),T.lineTo(O.x,m),T.stroke(),T.beginPath(),T.moveTo(O.x,u+6),T.lineTo(O.x-i,u+i+f),T.moveTo(O.x,u+6),T.lineTo(O.x+i,u+i-f),T.stroke();const g=Math.PI/2,y=Math.sin(8*d+g)*l*c,p=Math.max(.7*i,14),x=Math.min(S,m+o+y),w=Math.min(S,m+o-y);T.beginPath(),T.moveTo(O.x,m),T.lineTo(O.x-p,x),T.moveTo(O.x,m),T.lineTo(O.x+p,w),T.stroke(),O.rolling&&(T.strokeStyle="#9aa2b1",T.beginPath(),T.arc(O.x,m-.5*o,a+4,0,2*Math.PI),T.stroke(),T.strokeStyle="#f4f7ff")}(),function(){for(const e of O.activeHitboxes){const t=Ye(e.remaining/e.duration,0,1);T.fillStyle=`rgba(255, 153, 102, ${.2*t})`,T.beginPath(),T.arc(e.x,e.y,e.radius,0,2*Math.PI),T.fill(),T.strokeStyle=`rgba(255, 198, 141, ${t})`,T.lineWidth=2,T.beginPath(),T.arc(e.x,e.y,e.radius,0,2*Math.PI),T.stroke()}}(),Ya(),function(){T.save(),T.font="18px 'Segoe UI', Arial, sans-serif",T.textAlign="center";for(const e of Xe){const t=Ye(e.life/e.maxLife,0,1);T.fillStyle=`rgba(255, 214, 102, ${t})`,T.fillText(`-${Math.round(e.value)}`,e.x,e.y)}T.restore()}(),qa(),window.requestAnimationFrame(e)})})();
//# sourceMappingURL=bundle.411e286a61d9d8c04202.js.map
</script></body></html>