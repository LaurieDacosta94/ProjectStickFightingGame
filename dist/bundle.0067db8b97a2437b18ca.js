(()=>{"use strict";var e={56:(e,t,a)=>{e.exports=function(e){var t=a.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function a(e){for(var a=-1,o=0;o<t.length;o++)if(t[o].identifier===e){a=o;break}return a}function o(e,o){for(var i={},r=[],s=0;s<e.length;s++){var l=e[s],c=o.base?l[0]+o.base:l[0],d=i[c]||0,f="".concat(c," ").concat(d);i[c]=d+1;var h=a(f),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==h)t[h].references++,t[h].updater(u);else{var g=n(u,o);o.byIndex=s,t.splice(s,0,{identifier:f,updater:g,references:1})}r.push(f)}return r}function n(e,t){var a=t.domAPI(t);return a.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;a.update(e=t)}else a.remove()}}e.exports=function(e,n){var i=o(e=e||[],n=n||{});return function(e){e=e||[];for(var r=0;r<i.length;r++){var s=a(i[r]);t[s].references--}for(var l=o(e,n),c=0;c<i.length;c++){var d=a(i[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}i=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a="",o=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),o&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),o&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a}).join("")},t.i=function(e,a,o,n,i){"string"==typeof e&&(e=[[null,e,void 0]]);var r={};if(o)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(r[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&r[d[0]]||(void 0!==i&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=i),a&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=a):d[2]=a),n&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=n):d[4]="".concat(n)),t.push(d))}},t}},354:e=>{e.exports=function(e){var t=e[1],a=e[3];if(!a)return t;if("function"==typeof btoa){var o=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),n="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),i="/*# ".concat(n," */");return[t].concat([i]).join("\n")}return[t].join("\n")}},365:(e,t,a)=>{a.d(t,{A:()=>s});var o=a(354),n=a.n(o),i=a(314),r=a.n(i)()(n());r.push([e.id,'* {\n  box-sizing: border-box;\n}\n\nbody {\n  margin: 0;\n  background-color: #0f1115;\n  color: #f0f3f7;\n  font-family: "Segoe UI", Arial, sans-serif;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 100vh;\n}\n\ncanvas {\n  border: 2px solid #2a2d34;\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\n  width: min(90vw, 960px);\n  max-width: 100%;\n  height: auto;\n}\n',"",{version:3,sources:["webpack://./src/styles.css"],names:[],mappings:"AAAA;EACE,sBAAsB;AACxB;;AAEA;EACE,SAAS;EACT,yBAAyB;EACzB,cAAc;EACd,0CAA0C;EAC1C,aAAa;EACb,mBAAmB;EACnB,uBAAuB;EACvB,iBAAiB;AACnB;;AAEA;EACE,yBAAyB;EACzB,6DAA6D;EAC7D,uBAAuB;EACvB,eAAe;EACf,YAAY;AACd",sourcesContent:['* {\r\n  box-sizing: border-box;\r\n}\r\n\r\nbody {\r\n  margin: 0;\r\n  background-color: #0f1115;\r\n  color: #f0f3f7;\r\n  font-family: "Segoe UI", Arial, sans-serif;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  min-height: 100vh;\r\n}\r\n\r\ncanvas {\r\n  border: 2px solid #2a2d34;\r\n  background: linear-gradient(180deg, #1d2129 0%, #14161c 100%);\r\n  width: min(90vw, 960px);\r\n  max-width: 100%;\r\n  height: auto;\r\n}\r\n'],sourceRoot:""}]);const s=r},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},659:e=>{var t={};e.exports=function(e,a){var o=function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}t[e]=a}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(a)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(a){!function(e,t,a){var o="";a.supports&&(o+="@supports (".concat(a.supports,") {")),a.media&&(o+="@media ".concat(a.media," {"));var n=void 0!==a.layer;n&&(o+="@layer".concat(a.layer.length>0?" ".concat(a.layer):""," {")),o+=a.css,n&&(o+="}"),a.media&&(o+="}"),a.supports&&(o+="}");var i=a.sourceMap;i&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,a)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function a(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={id:o,exports:{}};return e[o](i,i.exports,a),i.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var o in t)a.o(t,o)&&!a.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nc=void 0;var o=a(72),n=a.n(o),i=a(825),r=a.n(i),s=a(659),l=a.n(s),c=a(56),d=a.n(c),f=a(540),h=a.n(f),u=a(113),g=a.n(u),m=a(365),y={};y.styleTagTransform=g(),y.setAttributes=d(),y.insert=l().bind(null,"head"),y.domAPI=r(),y.insertStyleElement=h(),n()(m.A,y),m.A&&m.A.locals&&m.A.locals;const p=document.getElementById("game-canvas"),x=p.getContext("2d");if(!x)throw new Error("Canvas 2D context not available.");const w=p.height-60,b=4*p.width,v=w;function k(e){return"number"==typeof e?4*e:e}function S(e){return e.map(e=>({...e,x:k(e.x),width:k(e.width)}))}function T(e){return e.map(e=>({...e,x:k(e.x),width:k(e.width)}))}function C(e){return e.map(e=>{const t={...e};return"number"==typeof t.x&&(t.x=k(t.x)),"number"==typeof t.baseX&&(t.baseX=k(t.baseX)),"number"==typeof t.width&&(t.width=k(t.width)),Array.isArray(t.points)&&(t.points=t.points.map(e=>({...e,x:k(e.x)}))),t})}function M(e){return e.map(e=>({...e,x:k(e.x)}))}function I(e){return e.map(e=>({...e,x:k(e.x),minX:k(e.minX),maxX:k(e.maxX)}))}function A(e){return e.map(e=>({...e,x:k(e.x),radius:"number"==typeof e.radius?4*e.radius:e.radius}))}function P(e,t={}){const a=t.widthRatio??.05,o=b*a,n=.5*b-o/2,i=t.topOffset??18,r=t.depth??26;return[...e,{x:n,width:o,top:v-i,depth:r,highlight:t.highlight,highlightColor:t.highlightColor,topColor:t.topColor,midColor:t.midColor,bottomColor:t.bottomColor,rippleColor:t.rippleColor}]}const D=S([{x:-240,y:v-26,width:520,height:26,type:"street"},{x:320,y:v-26,width:420,height:26,type:"street"},{x:820,y:v-26,width:380,height:26,type:"street"},{x:1220,y:v-26,width:520,height:26,type:"street"},{x:40,y:v-120,width:260,height:18,type:"metro"},{x:360,y:v-180,width:280,height:16,type:"rooftop"},{x:680,y:v-240,width:220,height:16,type:"skybridge"},{x:960,y:v-180,width:320,height:18,type:"rooftop"},{x:1240,y:v-140,width:280,height:16,type:"terrace"},{x:1460,y:v-220,width:200,height:14,type:"balcony"},{x:600,y:v-88,width:260,height:14,type:"median"},{x:980,y:v-96,width:320,height:14,type:"median"}]),R=P(T([{x:580,width:220,top:v-16,depth:18}]),{topOffset:20,depth:28,topColor:"rgba(60, 112, 168, 0.88)",midColor:"rgba(36, 76, 128, 0.92)",bottomColor:"rgba(20, 48, 92, 0.95)",rippleColor:"rgba(190, 220, 255, 0.2)",highlightColor:"rgba(255, 236, 180, 0.25)"}),B=C([{type:"building",x:-120,y:v-360,width:220,height:360},{type:"building",x:220,y:v-420,width:180,height:420},{type:"building",x:520,y:v-360,width:260,height:360},{type:"building",x:860,y:v-440,width:220,height:440},{type:"building",x:1120,y:v-400,width:260,height:400},{type:"building",x:1400,y:v-360,width:200,height:360},{type:"billboard",x:320,y:v-210,width:180,height:90,text:"Neo District"},{type:"billboard",x:1040,y:v-230,width:200,height:96,text:"Rail 7"},{type:"streetlight",x:180,y:v-160},{type:"streetlight",x:760,y:v-160},{type:"streetlight",x:1280,y:v-160},{type:"hovercar",x:560,y:v-120},{type:"hovercar",x:1180,y:v-150}]),E=M([{id:"neo-barrier-west",type:"concreteBarrier",x:260,baseY:v},{id:"neo-barrier-east",type:"concreteBarrier",x:1140,baseY:v},{id:"neo-car-market",type:"streetCar",x:620,baseY:v,facing:-1},{id:"neo-car-docks",type:"streetCar",x:1340,baseY:v,facing:1},{id:"neo-barrels-market",type:"fuelBarrelCluster",x:440,baseY:v-26},{id:"neo-barrels-rail",type:"fuelBarrelCluster",x:920,baseY:v-26}]),O=I([{id:"neo-crate-market",type:"pushCrate",x:480,baseY:v-26,minX:200,maxX:860},{id:"neo-crate-rooftop",type:"pushCrate",x:520,baseY:v-180,minX:380,maxX:620},{id:"neo-barrel-metro",type:"kickBarrel",x:180,baseY:v-120,minX:60,maxX:280},{id:"neo-barrel-skybridge",type:"kickBarrel",x:780,baseY:v-240,minX:700,maxX:880},{id:"neo-trap-median",type:"shockTrap",x:680,baseY:v-88},{id:"neo-trap-gate",type:"shockTrap",x:1260,baseY:v-26}]),L=A([{id:"neo-street-0",type:"point",x:180,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12},{id:"neo-street-1",type:"point",x:760,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12},{id:"neo-street-2",type:"point",x:1280,y:v-160,radius:220,intensity:.55,color:"#8faaff",smoothing:6,flicker:.12}]),$=S([{x:-280,y:v-24,width:520,height:24,type:"jungleFloor"},{x:320,y:v-24,width:420,height:24,type:"jungleFloor"},{x:820,y:v-30,width:380,height:24,type:"jungleFloor"},{x:1220,y:v-36,width:420,height:26,type:"jungleFloor"},{x:120,y:v-150,width:260,height:18,type:"stone"},{x:460,y:v-210,width:280,height:16,type:"canopy"},{x:780,y:v-190,width:240,height:16,type:"branch"},{x:1120,y:v-250,width:220,height:14,type:"branch"}]),W=P(T([{x:240,width:280,top:v-16,depth:14},{x:940,width:210,top:v-12,depth:12}]),{topOffset:18,depth:24,topColor:"rgba(56, 128, 92, 0.85)",midColor:"rgba(40, 96, 72, 0.88)",bottomColor:"rgba(24, 64, 52, 0.93)",rippleColor:"rgba(200, 255, 214, 0.22)",highlightColor:"rgba(144, 255, 200, 0.22)"}),H=C([{type:"palm",baseX:-60,baseY:v,height:220},{type:"palm",baseX:220,baseY:v-8,height:210},{type:"palm",baseX:520,baseY:v-12,height:240},{type:"palm",baseX:960,baseY:v-10,height:220},{type:"ruin",x:440,y:v-220,width:160,height:190},{type:"ruin",x:1080,y:v-240,width:180,height:210},{type:"vineArch",x:760,y:v-170,width:200,height:140},{type:"glowPlant",x:320,y:v-60},{type:"glowPlant",x:980,y:v-58},{type:"waterfall",x:1180,y:v-60,width:90,height:220}]),F=M([{id:"wilds-timber-west",type:"timberWall",x:260,baseY:v},{id:"wilds-timber-east",type:"timberWall",x:1220,baseY:v},{id:"wilds-spore-cell",type:"plasmaCell",x:520,baseY:v-120,templateOverrides:{bodyColor:"#2e9a63",accentColor:"#8cffc1",stripeColor:"#6bffad",damageHighlight:"#b6ffd6",debrisColor:"#1c5e3a"}},{id:"wilds-cache",type:"sandbagLine",x:880,baseY:v-24,templateOverrides:{bodyColor:"#4b6036",accentColor:"#92b56a",damageHighlight:"#c8e8a4",debrisColor:"#2e4125"}}]),N=I([{id:"wilds-crate-lower",type:"pushCrate",x:360,baseY:v-24,minX:160,maxX:560,templateOverrides:{bodyColor:"#5f7a45",edgeColor:"#2f4022",braceColor:"#9fbd67",highlightColor:"#d9ff8a"}},{id:"wilds-crate-canopy",type:"pushCrate",x:540,baseY:v-210,minX:420,maxX:640,templateOverrides:{bodyColor:"#4e6d3a",edgeColor:"#283b1c",braceColor:"#8fb76a",highlightColor:"#c8ff99"}},{id:"wilds-barrel",type:"kickBarrel",x:200,baseY:v-24,minX:80,maxX:360,templateOverrides:{bodyColor:"#2f8f5d",stripeColor:"#7dff9e",edgeColor:"#174027",topColor:"#44b574"}},{id:"wilds-trap",type:"shockTrap",x:700,baseY:v-24,templateOverrides:{bodyColor:"#1d3b2c",accentColor:"#59ffbd",glowColor:"#86ffd7"}}]),j=A([{id:"wilds-glow-0",type:"point",x:320,y:v-80,radius:220,intensity:.85,color:"#78ffbf",smoothing:6,flicker:.35},{id:"wilds-glow-1",type:"point",x:980,y:v-76,radius:210,intensity:.82,color:"#78ffbf",smoothing:6,flicker:.32},{id:"wilds-falls",type:"point",x:1180,y:v-120,radius:260,intensity:.9,color:"#6ed8ff",smoothing:8,flicker:.25}]),Y=[{x:-260,y:v-20,width:540,height:20,type:"sand"},{x:360,y:v-24,width:340,height:18,type:"sand"},{x:760,y:v-28,width:380,height:20,type:"sand"},{x:1180,y:v-26,width:480,height:22,type:"sand"},{x:120,y:v-140,width:260,height:16,type:"cliff"},{x:520,y:v-200,width:260,height:14,type:"plateau"},{x:900,y:v-180,width:310,height:14,type:"plateau"},{x:1280,y:v-240,width:240,height:12,type:"plateau"}],z=P(T([{x:520,width:180,top:v-18,depth:12}]),{topOffset:22,depth:24,topColor:"rgba(68, 156, 188, 0.85)",midColor:"rgba(40, 124, 168, 0.9)",bottomColor:"rgba(24, 74, 120, 0.95)",rippleColor:"rgba(240, 255, 214, 0.18)",highlightColor:"rgba(255, 204, 128, 0.26)"}),X=C([{type:"dune",baseX:120,baseY:v,width:320,height:120},{type:"dune",baseX:620,baseY:v,width:280,height:100},{type:"dune",baseX:1080,baseY:v,width:340,height:110},{type:"rockSpire",baseX:420,baseY:v,height:260},{type:"rockSpire",baseX:1160,baseY:v,height:230},{type:"campfire",baseX:660,baseY:v-20},{type:"antenna",x:920,y:v-300,height:320}]),q=M([{id:"dune-sandbag-west",type:"sandbagLine",x:280,baseY:v,templateOverrides:{bodyColor:"#c8a070",accentColor:"#edd0a0",damageHighlight:"#ffe8b2",debrisColor:"#8f6d45"}},{id:"dune-sandbag-east",type:"sandbagLine",x:1180,baseY:v,templateOverrides:{bodyColor:"#c8a070",accentColor:"#edd0a0",damageHighlight:"#ffe8b2",debrisColor:"#8f6d45"}},{id:"dune-rover",type:"roverWreck",x:760,baseY:v-24,facing:-1,templateOverrides:{bodyColor:"#d1c296",accentColor:"#fdf4c7",glassColor:"#ffe8a1",damageHighlight:"#fff0c1",debrisColor:"#8f7b4a"}},{id:"dune-cell",type:"plasmaCell",x:540,baseY:v-200,templateOverrides:{bodyColor:"#f07f1f",accentColor:"#ffd9a1",stripeColor:"#ffeab9",damageHighlight:"#fff1cb",debrisColor:"#a95312"}}]),G=I([{id:"dune-crate",type:"pushCrate",x:360,baseY:v-24,minX:180,maxX:520,templateOverrides:{bodyColor:"#bf9a62",edgeColor:"#6f4f2f",braceColor:"#dcb678",highlightColor:"#ffe0a8"}},{id:"dune-barrel",type:"kickBarrel",x:820,baseY:v-28,minX:720,maxX:960,templateOverrides:{bodyColor:"#c7672d",stripeColor:"#ffe49a",edgeColor:"#531f05",topColor:"#e4883d"}},{id:"dune-trap",type:"shockTrap",x:1020,baseY:v-26,templateOverrides:{bodyColor:"#3a2a14",accentColor:"#ffcc6e",glowColor:"#ffe9a6"}}]),J=A([{id:"dune-fire",type:"point",x:660,y:v-36,radius:240,intensity:1.2,color:"#ffb36d",smoothing:6,flicker:.55},{id:"dune-beacon",type:"point",x:920,y:v-200,radius:260,intensity:.9,color:"#8cc9ff",smoothing:8,flicker:.35}]),K=S([{x:-200,y:v-40,width:540,height:18,type:"deck"},{x:340,y:v-40,width:360,height:18,type:"deck"},{x:720,y:v-40,width:400,height:18,type:"deck"},{x:1200,y:v-40,width:420,height:18,type:"deck"},{x:160,y:v-160,width:260,height:14,type:"catwalk"},{x:520,y:v-220,width:320,height:14,type:"catwalk"},{x:920,y:v-200,width:300,height:14,type:"maglev"},{x:1280,y:v-260,width:260,height:12,type:"maglev"}]),U=(P(T([]),{topOffset:24,depth:30,topColor:"rgba(86, 128, 220, 0.82)",midColor:"rgba(70, 104, 210, 0.88)",bottomColor:"rgba(48, 72, 180, 0.94)",rippleColor:"rgba(148, 208, 255, 0.28)",highlightColor:"rgba(160, 220, 255, 0.3)"}),C([{type:"spire",baseX:260,baseY:v,height:300},{type:"spire",baseX:640,baseY:v,height:340},{type:"spire",baseX:1100,baseY:v,height:320},{type:"holoBillboard",x:820,y:v-220,width:200,height:100,text:"SYN-42"},{type:"energyCoil",baseX:520,baseY:v-20,height:180},{type:"energyCoil",baseX:1260,baseY:v-20,height:200},{type:"hovercar",x:420,y:v-160},{type:"hovercar",x:1180,y:v-150}])),V=M([{id:"orbital-barrier-west",type:"sandbagLine",x:320,baseY:v,templateOverrides:{bodyColor:"#3b4b63",accentColor:"#6c82b8",damageHighlight:"#a9c4ff",debrisColor:"#243145"}},{id:"orbital-barrier-east",type:"sandbagLine",x:1260,baseY:v,templateOverrides:{bodyColor:"#3b4b63",accentColor:"#6c82b8",damageHighlight:"#a9c4ff",debrisColor:"#243145"}},{id:"orbital-reactor",type:"plasmaCell",x:760,baseY:v-40,templateOverrides:{bodyColor:"#4a9fff",accentColor:"#c4f5ff",stripeColor:"#9ef7ff",damageHighlight:"#d4fcff"}},{id:"orbital-rover",type:"roverWreck",x:540,baseY:v-220,facing:1,templateOverrides:{bodyColor:"#6f86ff",accentColor:"#dfe6ff",glassColor:"#9ffbff",damageHighlight:"#bcd3ff",debrisColor:"#3e4f9a"}}]),_=I([{id:"orbital-crate-lower",type:"pushCrate",x:360,baseY:v-40,minX:200,maxX:520,templateOverrides:{bodyColor:"#4b5b87",edgeColor:"#1b233a",braceColor:"#7f96e8",highlightColor:"#a8c2ff"}},{id:"orbital-crate-upper",type:"pushCrate",x:1080,baseY:v-200,minX:960,maxX:1180,templateOverrides:{bodyColor:"#566dac",edgeColor:"#243154",braceColor:"#8da4ff",highlightColor:"#c3d1ff"}},{id:"orbital-barrel",type:"kickBarrel",x:680,baseY:v-40,minX:620,maxX:880,templateOverrides:{bodyColor:"#3d7cff",stripeColor:"#8df5ff",edgeColor:"#1c2550",topColor:"#64a1ff"}},{id:"orbital-trap",type:"shockTrap",x:920,baseY:v-40,templateOverrides:{bodyColor:"#1f2850",accentColor:"#86a6ff",glowColor:"#b4ceff"}}]),Q=A([{id:"orbital-coil-0",type:"point",x:520,y:v-120,radius:280,intensity:1.3,color:"#7ce7ff",smoothing:10,flicker:.35},{id:"orbital-coil-1",type:"point",x:1260,y:v-120,radius:280,intensity:1.3,color:"#7ce7ff",smoothing:10,flicker:.35},{id:"orbital-spire",type:"cone",x:260,y:v-320,radius:320,intensity:.9,color:"#55d9ff",direction:0,fov:.4*Math.PI,stretch:.6,smoothing:14}]),Z={neoDistrict:{id:"neoDistrict",name:"Neo District",theme:"urban",width:b,background:{gradientStops:[{offset:0,color:"#111a2c"},{offset:.4,color:"#182439"},{offset:.75,color:"#1f2d44"},{offset:1,color:"#232f49"}],horizonBand:{start:v-140,height:120,topColor:"rgba(46, 86, 126, 0.25)",bottomColor:"rgba(28, 52, 84, 0)"},groundColor:"#1b2231",silhouettes:[{color:"#1a2437",points:[{x:0,y:v-220},{x:k(220),y:v-260},{x:k(420),y:v-210},{x:k(640),y:v-280},{x:k(820),y:v-230},{x:k(1040),y:v-260},{x:k(1220),y:v-210},{x:k(1380),y:v-260},{x:b,y:v-200},{x:b,y:v},{x:0,y:v}]}]},platforms:D,waterZones:R,decor:B,destructibles:E,interactables:O,ambientLights:L,spawn:{player:{x:.5*b},trainingDummy:{x:.75*b},squadOffsets:[-120,40,120],enemies:[.24*b,.68*b]}},verdantWilds:{id:"verdantWilds",name:"Verdant Wilds",theme:"jungle",width:b,background:{gradientStops:[{offset:0,color:"#0b1613"},{offset:.45,color:"#123020"},{offset:.8,color:"#1d4a37"},{offset:1,color:"#1c2d1f"}],horizonBand:{start:v-160,height:140,topColor:"rgba(34, 84, 58, 0.32)",bottomColor:"rgba(18, 42, 31, 0)"},groundColor:"#1c2519",silhouettes:[{color:"#152718",points:[{x:0,y:v-200},{x:k(160),y:v-230},{x:k(360),y:v-210},{x:k(540),y:v-250},{x:k(760),y:v-220},{x:k(980),y:v-240},{x:b,y:v-210},{x:b,y:v},{x:0,y:v}]}]},platforms:$,waterZones:W,decor:H,destructibles:F,interactables:N,ambientLights:j,spawn:{player:{x:.45*b},trainingDummy:{x:.8*b},squadOffsets:[-140,-10,120],enemies:[.2*b,.7*b]}},sunsetDunes:{id:"sunsetDunes",name:"Sunset Dunes",theme:"desert",width:b,background:{gradientStops:[{offset:0,color:"#32140c"},{offset:.45,color:"#5c2814"},{offset:.78,color:"#b35a1c"},{offset:1,color:"#d08b3e"}],horizonBand:{start:v-150,height:120,topColor:"rgba(206, 124, 50, 0.28)",bottomColor:"rgba(128, 68, 24, 0)"},groundColor:"#3c2717",silhouettes:[{color:"#2a1b10",points:[{x:0,y:v-180},{x:k(220),y:v-200},{x:k(480),y:v-190},{x:k(720),y:v-210},{x:k(980),y:v-200},{x:b,y:v-190},{x:b,y:v},{x:0,y:v}]}]},platforms:Y,waterZones:z,decor:X,destructibles:q,interactables:G,ambientLights:J,spawn:{player:{x:.46*b},trainingDummy:{x:.78*b},squadOffsets:[-140,-30,110],enemies:[.22*b,.68*b]}},orbitalSpire:{id:"orbitalSpire",name:"Orbital Spire",theme:"sci-fi",width:b,background:{gradientStops:[{offset:0,color:"#0d0f2a"},{offset:.5,color:"#141a3d"},{offset:.82,color:"#1c2856"},{offset:1,color:"#1e1f2c"}],horizonBand:{start:v-160,height:140,topColor:"rgba(70, 120, 220, 0.22)",bottomColor:"rgba(30, 40, 90, 0)"},groundColor:"#151726",silhouettes:[{color:"#1a2650",points:[{x:0,y:v-240},{x:k(200),y:v-320},{x:k(280),y:v-200},{x:k(520),y:v-340},{x:k(720),y:v-260},{x:k(900),y:v-320},{x:k(1080),y:v-220},{x:k(1280),y:v-340},{x:b,y:v-240},{x:b,y:v},{x:0,y:v}]}]},platforms:K,waterZones:[],decor:U,destructibles:V,interactables:_,ambientLights:Q,spawn:{player:{x:.5*b},trainingDummy:{x:.82*b},squadOffsets:[-130,-20,120],enemies:[.3*b,.7*b]}}},ee=["neoDistrict","verdantWilds","sunsetDunes","orbitalSpire"],te={materials:120,pickups:[]};let ae=1;function oe(){return te.materials}function ne(e,t=""){Number.isFinite(e)&&0!==e&&(te.materials=Math.max(0,te.materials+Math.round(e)))}function ie({x:e=0,y:t=0,amount:a=10,vx:o=80*(Math.random()-.5),vy:n=-120,ttl:i=6}={}){const r={id:"salvage-"+ae++,x:e,y:t,vx:o,vy:n,amount:Math.max(1,Math.round(a??1)),ttl:i,maxTtl:i,collected:!1};return te.pickups.push(r),r}let re=ee[0]??Object.keys(Z)[0];const se=new Set;let le=!1;function ce(e=re){const t=Z[e];if(t)return t;const a=ee[0]??Object.keys(Z)[0];return re=a,Z[a]}function de(){const e=ce();return"number"==typeof e?.width?e.width:p.width}function fe(){const e=ce();return Array.isArray(e?.platforms)?e.platforms:[]}function he(){const e=ce();return e?.spawn??{}}function ue(e,t={}){return"function"!=typeof e?()=>{}:(se.add(e),!1!==t.immediate&&e(ce()),()=>{se.delete(e)})}const ge={x:.5*p.width,targetX:.5*p.width};function me(){return.5*p.width}function ye(e){const t=me(),a=de();return a<=p.width?.5*p.width:Math.min(Math.max(e,t),a-t)}function pe(){var e;e=.5*de(),ge.x=ye(e),ge.targetX=ge.x}ue(()=>{pe()}),pe();const xe=Object.seal({left:!1,right:!1,jump:!1,down:!1,roll:!1,attackBuffered:!1,throwBuffered:!1,reloadBuffered:!1,interactBuffered:!1,attackDown:!1,throwDown:!1,squadCommandCycleBuffered:!1,squadCommandSelect:null,serverBrowserToggleBuffered:!1,serverBrowserNavigate:0,serverBrowserJoinBuffered:!1,serverBrowserHostBuffered:!1,serverBrowserStopHostBuffered:!1,serverBrowserCopyOfferBuffered:!1,serverBrowserPasteOfferBuffered:!1,serverBrowserAcceptAnswerBuffered:!1,serverBrowserCopyCandidatesBuffered:!1,serverBrowserPasteCandidatesBuffered:!1,buildToggleBuffered:!1,buildCycleBuffered:0,buildConfirmBuffered:!1,buildCancelBuffered:!1,survivalToggleBuffered:!1});let we=!1;function be(e,t){switch(t.code){case"ArrowLeft":case"KeyA":xe.left=e,t.preventDefault();break;case"ArrowRight":case"KeyD":xe.right=e,t.preventDefault();break;case"ArrowUp":case"KeyW":case"Space":xe.jump=e,t.preventDefault();break;case"ArrowDown":case"KeyS":xe.down=e,t.preventDefault();break;case"Comma":e&&(xe.buildCycleBuffered=-1,t.preventDefault());break;case"Period":e&&(xe.buildCycleBuffered=1,t.preventDefault());break;case"Escape":e&&(xe.buildCancelBuffered=!0,t.preventDefault());case"ShiftLeft":case"ShiftRight":e&&(xe.roll=!0,t.preventDefault());break;case"KeyB":e&&(xe.buildToggleBuffered=!0,t.preventDefault());break;case"KeyY":e&&(xe.survivalToggleBuffered=!0,t.preventDefault());break;case"KeyJ":case"KeyF":e?(xe.attackBuffered=!0,xe.attackDown=!0,t.preventDefault()):(xe.attackDown=!1,t.preventDefault());break;case"KeyG":e?(xe.throwBuffered=!0,xe.throwDown=!0,t.preventDefault()):(xe.throwDown=!1,t.preventDefault());break;case"KeyR":e&&(xe.reloadBuffered=!0,t.preventDefault());break;case"KeyE":e&&(xe.interactBuffered=!0,t.preventDefault());break;case"KeyT":e&&(xe.squadCommandCycleBuffered=!0,t.preventDefault());break;case"KeyZ":e&&(xe.squadCommandSelect="hold",t.preventDefault());break;case"KeyX":e&&(xe.squadCommandSelect="defend",t.preventDefault());break;case"KeyC":e&&(xe.squadCommandSelect="attack",t.preventDefault());break;case"KeyV":e&&(xe.squadCommandSelect="flank",t.preventDefault());break;case"KeyL":e&&(xe.serverBrowserToggleBuffered=!0,t.preventDefault());break;case"BracketLeft":e&&(xe.serverBrowserNavigate=-1,t.preventDefault());break;case"BracketRight":case"Slash":e&&(xe.serverBrowserNavigate=1,t.preventDefault());break;case"Enter":e&&(xe.serverBrowserJoinBuffered=!0,t.preventDefault());break;case"KeyH":e&&(xe.serverBrowserHostBuffered=!0,t.preventDefault());break;case"KeyU":e&&(xe.serverBrowserStopHostBuffered=!0,t.preventDefault());break;case"KeyO":e&&(xe.serverBrowserCopyOfferBuffered=!0,t.preventDefault());break;case"KeyP":e&&(xe.serverBrowserPasteOfferBuffered=!0,t.preventDefault());break;case"KeyI":e&&(xe.serverBrowserAcceptAnswerBuffered=!0,t.preventDefault());break;case"KeyM":e&&(xe.serverBrowserCopyCandidatesBuffered=!0,t.preventDefault());break;case"KeyN":e&&(xe.serverBrowserPasteCandidatesBuffered=!0,t.preventDefault())}}const ve={combatFists:{id:"combatFists",name:"Combat Fists",description:"Baseline martial arts combo with balanced speed and control.",category:"melee-short",attackChain:[{name:"Quick Jab",windup:.06,active:.12,recovery:.14,comboStart:.12,comboWindow:.18,range:74,heightOffset:-46,radius:26,damage:8,knockback:140,launch:0},{name:"Cross Strike",windup:.08,active:.12,recovery:.18,comboStart:.18,comboWindow:.2,range:82,heightOffset:-40,radius:28,damage:12,knockback:180,launch:0},{name:"Rising Kick",windup:.1,active:.14,recovery:.24,comboStart:.24,comboWindow:.2,range:68,heightOffset:-64,radius:30,damage:16,knockback:220,launch:160}]},shockBaton:{id:"shockBaton",name:"Shock Baton",description:"Electrified staff built for crowd control and guard breaks.",category:"melee-mid",attackChain:[{name:"Jab Feint",windup:.06,active:.08,recovery:.14,comboStart:.14,comboWindow:.16,range:68,heightOffset:-30,radius:26,damage:9,knockback:90,launch:0},{name:"Slide Sweep",windup:.1,active:.12,recovery:.2,comboStart:.2,comboWindow:.18,range:86,heightOffset:-12,radius:34,damage:16,knockback:180,launch:30},{name:"Arc Burst",windup:.16,active:.2,recovery:.32,comboStart:.32,comboWindow:.2,range:94,heightOffset:-28,radius:42,damage:26,knockback:280,launch:160}]},strikerPistol:{id:"strikerPistol",name:"Striker Pistol",description:"Semi-auto sidearm. Tap fire for consistent ranged pressure.",category:"ranged-short",attackChain:[],projectile:{radius:6,speed:520,damage:14,knockback:90,lifetime:.9,gravityFactor:.25,color:"#ffca7a"},ammo:{magazine:12,reserve:48,reloadSeconds:1.3}},vectorSmg:{id:"vectorSmg",name:"Vector SMG",description:"Rapid PDW prototype tuned for controllable spray.",category:"ranged-mid",attackChain:[],projectile:{radius:5,speed:620,damage:10,knockback:70,lifetime:.85,gravityFactor:.18,color:"#98d8ff"},ammo:{magazine:32,reserve:160,reloadSeconds:2.1},recoil:{horizontal:.6,vertical:1.4,decay:10},spread:{base:1.5,perShot:.6,max:6.5,recovery:3.2}},fragGrenade:{id:"fragGrenade",name:"Frag Grenade",description:"Timed explosive. Toss, bounce, and detonate in a wide area.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.6,explosionRadius:120,damage:45,knockback:260,arcVelocity:{vx:280,vy:-420},gravityFactor:.5,bounciness:.45,color:"#ffb347",radius:16,cooldownSeconds:1.05,explosionDuration:.32,selfDamageScale:.55,selfKnockbackScale:.5,effectType:"explosive"}},flashBang:{id:"flashBang",name:"Flashbang",description:"Blinding charge that staggers enemies caught in the burst.",category:"throwable",attackChain:[],throwable:{fuseSeconds:1.2,explosionRadius:160,damage:0,knockback:0,arcVelocity:{vx:260,vy:-420},gravityFactor:.45,bounciness:.4,color:"#f9f2c7",radius:14,cooldownSeconds:1.4,explosionDuration:.24,effectType:"flash",stunDuration:1.8,playerStunDuration:.9}},smokeCanister:{id:"smokeCanister",name:"Smoke Canister",description:"Rapid-deploy screen that slows foes and softens line of sight.",category:"throwable",attackChain:[],throwable:{fuseSeconds:.9,explosionRadius:80,damage:0,knockback:0,arcVelocity:{vx:220,vy:-360},gravityFactor:.52,bounciness:.35,color:"#aeb9c6",radius:18,cooldownSeconds:2.3,explosionDuration:.2,effectType:"smoke",smokeDuration:4.6,smokeRadius:150,smokeExpansion:1.35,smokeSlowMultiplier:.55,smokeTickDuration:.45}},turretDrone:{id:"turretDrone",name:"Deployable Turret",description:"Drops an auto-targeting sentry that covers a lane with suppressive fire.",category:"gadget",attackChain:[],gadget:{type:"turret",cooldownSeconds:3.2,duration:8.5,range:260,fireInterval:.55,maxActive:2,height:54,spawnOffset:{x:70,y:0},baseColor:"#6f7bff",headColor:"#d6dcff",projectile:{speed:540,radius:4,damage:9,knockback:80,lifetime:1.1,color:"#9ae9ff"}}},grappleRig:{id:"grappleRig",name:"Grapple Rig",description:"Launch, latch, and zip to an overhead anchor for quick repositioning.",category:"gadget",attackChain:[],gadget:{type:"grapple",cooldownSeconds:1.8,duration:.6,maxLength:320,maxRise:260,travelSpeed:900,pullSpeed:760,color:"#8cf1ff"}},thunderCannon:{id:"thunderCannon",name:"Thunder Cannon",description:"Supply drop-exclusive launcher that fires high-impact bolts.",category:"ranged-heavy",attackChain:[],projectile:{radius:10,speed:620,damage:42,knockback:260,lifetime:1.2,gravityFactor:.18,color:"#ffd76a"},ammo:{magazine:4,reserve:12,reloadSeconds:2.9},recoil:{horizontal:2.2,vertical:5.4,recovery:6.5},spread:{base:1.5,max:6,increase:1.1,recovery:3.5}},shieldBubble:{id:"shieldBubble",name:"Shield Bubble",description:"Pop a temporary energy shell that soaks damage and keeps you grounded.",category:"gadget",attackChain:[],gadget:{type:"shield",cooldownSeconds:4.5,duration:6,strength:90,radius:96,color:"#7cd6ff"}}},ke=["combatFists","shockBaton","strikerPistol","fragGrenade","flashBang","smokeCanister","turretDrone","grappleRig","shieldBubble"],Se=240,Te=1400,Ce={standing:{headRadius:16,bodyLength:34,legLength:36,armLength:28,strideMultiplier:1,armSwingAmplitude:12,legSwingAmplitude:12},crouching:{headRadius:16,bodyLength:24,legLength:24,armLength:22,strideMultiplier:.6,armSwingAmplitude:6,legSwingAmplitude:6},rolling:{headRadius:16,bodyLength:18,legLength:18,armLength:18,strideMultiplier:0,armSwingAmplitude:0,legSwingAmplitude:0}},Me=[{id:"hold",label:"Hold",description:"Regroup on you and stay close.",order:0},{id:"defend",label:"Defend",description:"Form a defensive ring and cover your position.",order:1},{id:"attack",label:"Attack",description:"Press the nearest enemy with ranged fire.",order:2},{id:"flank",label:"Flank",description:"Split wide and pressure the enemy from the side.",order:3}];function Ie(e){return 2*e.headRadius+e.bodyLength+e.legLength}function Ae(e,t={}){const a=he(),o=Array.isArray(a?.enemies)?a.enemies:[],n="number"==typeof e?e:o[0]??.25*de(),i=a?.enemyY??w-118,r=t.context??"sandbox",s=t.autoRespawn??"survival"!==r,l=t.spawnSide??null,c=t.facing??1;return{id:`grunt-${Math.random().toString(36).slice(2,8)}`,spawnX:n,spawnY:i,x:n,y:i,vx:0,vy:0,radius:22,height:118,facing:c,onGround:!0,state:"patrol",stateTimer:1+Math.random(),patrolRange:{min:n-100,max:n+220},aggressionRange:360,attackRange:86,moveSpeed:160,health:120,maxHealth:120,attackCooldown:0,attackWindup:0,attackActive:0,attackDamage:12,attackKnockback:120,attackLaunch:-80,flashTimer:0,shakeTimer:0,shakeMagnitude:0,invulnerability:0,respawnTimer:0,stunTimer:0,smokeSlowTimer:0,smokeSlowStrength:1,spawnContext:r,autoRespawn:s,spawnSide:l,active:!0}}function Pe(e=0,t="Ally",a=.5*de()){const o=a+e,n=w-Ie(Ce.standing);return{id:`squad-${Math.random().toString(36).slice(2,8)}`,name:t,x:o,y:n,vx:0,vy:0,facing:1,onGround:!0,state:"follow",fireCooldown:0,commandTimer:0,targetEnemyId:null,flashTimer:0,highlight:0,structureShieldTimer:0,structureShieldStrength:0,roleIndex:0}}const De=he(),Re=Ie(Ce.standing),Be=De?.player?.x??.5*de(),Ee={x:Be,y:De?.player?.y??w-Re,vx:0,vy:0,facing:1,onGround:!0,controlMode:"onFoot",vehicleId:null,vehicleCandidateId:null,squadCommandIndex:0,squadCommandId:Me[0]?.id??"hold",squadCommandCooldown:0,rolling:!1,rollTimer:0,crouching:!1,currentPose:Ce.standing,attacking:!1,attackIndex:-1,currentAttack:null,attackElapsed:0,attackInstanceId:0,comboWindowOpen:!1,comboWindowTimer:0,nextAttackQueued:!1,hitboxSpawned:!1,activeHitboxes:[],health:100,maxHealth:100,invulnerability:0,deadTimer:0,throwCooldown:0,gadgetCooldown:0,reloading:!1,stunTimer:0,flashBlindTimer:0,smokeSlowTimer:0,smokeSlowStrength:1,structureShieldTimer:0,structureShieldStrength:0,equippedWeaponId:"combatFists"},Oe=Array.isArray(De?.squadOffsets)?De.squadOffsets:[-120,40,120],Le=[Pe(Oe[0]??-120,"Sparrow",Be),Pe(Oe[1]??40,"Rook",Be),Pe(Oe[2]??120,"Viper",Be)],$e=new Map;function We(){return Array.from($e.values())}const He={id:"training-dummy",x:De?.trainingDummy?.x??.75*de(),y:De?.trainingDummy?.y??w-120,height:120,radius:26,maxHealth:150,health:150,flashTimer:0,shakeTimer:0,shakeMagnitude:0,respawnTimer:0},Fe=Array.isArray(De?.enemies)?De.enemies:[.24*de(),.68*de()],Ne=[Ae(Fe[0],{context:"sandbox",autoRespawn:!0,spawnSide:0,facing:1}),Ae(Fe[1],{context:"sandbox",autoRespawn:!0,spawnSide:1,facing:-1})];Ne.forEach((e,t)=>{!function(e,t){e.spawnSide=t,e.spawnContext=e.spawnContext??"sandbox",e.autoRespawn=e.autoRespawn??!0,e.facing=0===t?1:-1}(e,t)}),ue(e=>{!function(e){const t=e?.spawn??{},a=t.player?.x??.5*de(),o=Ie(Ee.currentPose??Ce.standing),n=t.player?.y??w-o;Ee.x=a,Ee.y=n,Ee.vx=0,Ee.vy=0,Ee.onGround=!0,Ee.controlMode="onFoot",Ee.vehicleId=null,Ee.vehicleCandidateId=null,Ee.rollTimer=0,Ee.crouching=!1,Ee.attacking=!1,Ee.attackIndex=-1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.nextAttackQueued=!1,Ee.hitboxSpawned=!1,Ee.activeHitboxes.length=0,Ee.deadTimer=0,Ee.health=Ee.maxHealth,Ee.structureShieldTimer=0,Ee.structureShieldStrength=0,Ee.invulnerability=0;const i=Array.isArray(t.squadOffsets)?t.squadOffsets:Oe;Le.forEach((e,t)=>{const o=i[t]??80*(t-1),n=a+o,r=w-Ie(Ce.standing);e.x=n,e.y=r,e.vx=0,e.vy=0,e.onGround=!0,e.state="follow",e.flashTimer=0,e.highlight=0,e.structureShieldTimer=0,e.structureShieldStrength=0}),He.x=t.trainingDummy?.x??.75*de(),He.y=t.trainingDummy?.y??w-He.height,He.health=He.maxHealth,He.flashTimer=0,He.shakeTimer=0,He.shakeMagnitude=0,He.respawnTimer=0,function(e,t){const a=Array.isArray(e.enemies)?e.enemies:[],o=Math.max(2,a.length||0),n=Ne.filter(e=>"sandbox"===e.spawnContext),i=new Set(n.map(e=>e.spawnSide??n.indexOf(e)));for(let e=0;e<o;e+=1)if(!i.has(e)){const o=t+(0===e?-320:320),r=Ae("number"==typeof a[e]?a[e]:o,{context:"sandbox",autoRespawn:!0,spawnSide:e,facing:0===e?1:-1});Ne.push(r),n.push(r),i.add(e)}for(const o of n){const n=o.spawnSide??0,i=t+(0===n?-320:320),r="number"==typeof a[n]?a[n]:i,s=e.enemyY??w-o.height;o.spawnSide=n,o.spawnContext="sandbox",o.autoRespawn=!0,o.spawnX=r,o.spawnY=s,o.x=r,o.y=s,o.vx=0,o.vy=0,o.health=o.maxHealth,o.invulnerability=0,o.flashTimer=0,o.shakeTimer=0,o.shakeMagnitude=0,o.respawnTimer=0,o.state="patrol",o.stateTimer=1+Math.random(),o.patrolRange={min:r-100,max:r+220},o.onGround=!0,o.facing=0===n?1:-1}}(t,a)}(e)});const je={inventory:[...ke],activeIndex:0};function Ye(e){return!!function(e){return e>=0&&e<je.inventory.length}(e)&&(je.activeIndex=e,Ee.equippedWeaponId=je.inventory[e],!0)}function ze(){return je.inventory.slice()}function Xe(){const e=je.inventory.indexOf(Ee.equippedWeaponId);e>=0?je.activeIndex=e:(je.inventory[0]=je.inventory[0]??ke[0],je.activeIndex=0,Ee.equippedWeaponId=je.inventory[0])}Xe();const qe=new Map;function Ge(e){if(!e)return null;const t=ve[e];if(!t)return qe.delete(e),null;const a=t.ammo,o=t.spread,n=void 0!==a,i=n?Math.max(0,a.magazine??0):Number.POSITIVE_INFINITY,r=n?Math.max(0,a.reserve??0):Number.POSITIVE_INFINITY,s=n?Math.max(.1,a.reloadSeconds??1.2):0;let l=qe.get(e);return l?(l.capacity=i,i===Number.POSITIVE_INFINITY?l.magazine=Number.POSITIVE_INFINITY:l.magazine=n?Math.min(l.magazine,i):i,l.reserve=r,l.reloadSeconds=s,l.spreadDef=o??null,!l.spread&&o&&(l.spread={current:o.base??0}),o||(l.spread=null)):(l={capacity:i,magazine:i===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:i,reserve:r,reloadSeconds:s,reloadTimer:0,reloading:!1,spreadDef:o??null,spread:o?{current:o.base??0}:null},qe.set(e,l)),l}function Je(e){const t=Ge(e);return t?{magazine:t.magazine,reserve:t.reserve,capacity:t.capacity,reloading:t.reloading,reloadTimer:t.reloadTimer,reloadSeconds:t.reloadSeconds}:null}function Ke(e){const t=Ge(e);return!(!t||t.capacity===Number.POSITIVE_INFINITY||t.reloading||t.magazine>=t.capacity||t.reserve<=0||(t.reloading=!0,t.reloadTimer=t.reloadSeconds,Ee.equippedWeaponId===e&&(Ee.reloading=!0),0))}function Ue(e){const t=Ge(e);t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.magazine=t.capacity,t.reserve=ve[e]?.ammo?.reserve??t.reserve,t.reloading=!1,t.reloadTimer=0)}let Ve=!1;const _e={id:Ee.equippedWeaponId};function Qe(){const e=je.inventory[je.activeIndex];return ve[e]??null}function Ze(e){const t=Ee.equippedWeaponId;if(!Ye(e))return!1;t&&t!==Ee.equippedWeaponId&&function(e){const t=qe.get(e);t&&(t.reloading=!1,t.reloadTimer=0,Ee.equippedWeaponId===e&&(Ee.reloading=!1))}(t),Ge(Ee.equippedWeaponId),Ee.attacking=!1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.attackIndex=-1,Ee.hitboxSpawned=!1;const a=Je(Ee.equippedWeaponId);return Ee.reloading=a?.reloading??!1,_e.id=Ee.equippedWeaponId,!0}Ze(je.activeIndex);let et=null,tt=!1;const at=new Map,ot={"weapon:shot-fired":{frequency:()=>880+220*Math.random(),duration:.08,gain:.05,shape:"square",cooldown:40},"weapon:muzzle-flash":{frequency:()=>760+120*Math.random(),duration:.06,gain:.045,shape:"sawtooth",cooldown:35},"weapon:reload-start":{frequency:210,duration:.18,gain:.08,shape:"triangle",cooldown:120},"weapon:reload-finish":{frequency:320,duration:.16,gain:.09,shape:"triangle",cooldown:120},"weapon:recoil-kick":{frequency:e=>480+60*(e?.recoil?.horizontal??0),duration:.12,gain:.045,shape:"sine",cooldown:90},"shield:hit":{frequency:140,duration:.22,gain:.1,shape:"sine",cooldown:140},"shield:shatter":{frequency:90,duration:.4,gain:.14,shape:"sawtooth",cooldown:260},"shield:end":{frequency:260,duration:.16,gain:.05,shape:"triangle",cooldown:200},"throwable:explosion":{frequency:180,duration:.35,gain:.12,shape:"sawtooth",cooldown:240},"throwable:flash-burst":{frequency:()=>960+180*Math.random(),duration:.18,gain:.07,shape:"triangle",cooldown:220},"throwable:smoke-detonate":{frequency:220,duration:.32,gain:.055,shape:"sine",cooldown:260},"throwable:smoke-dissipate":{frequency:150,duration:.36,gain:.035,shape:"sine",cooldown:320}};function nt(){if(et||"undefined"==typeof window)return et;const e=window.AudioContext||window.webkitAudioContext;return e?(et=new e,et):null}function it(){et&&"suspended"===et.state&&"function"==typeof et.resume&&et.resume().catch(()=>{})}function rt(){it(),window.removeEventListener("pointerdown",rt),window.removeEventListener("keydown",rt)}function st(){if("undefined"==typeof window||!window.P2P){const e=new Error("P2P module not loaded");throw e.code="P2P_NOT_AVAILABLE",e}return window.P2P}const lt=`peer-${Math.random().toString(36).slice(2,8)}`;let ct=null,dt=null,ft=null,ht=0,ut="disconnected",gt=null;const mt=[];function yt(){return ct||"undefined"==typeof window||!window.RTCPeerConnection||(ct=new RTCPeerConnection({iceServers:[]}),ut="connecting",dt=ct.createDataChannel("stickman",{ordered:!0}),pt(dt),ct.addEventListener("icecandidate",e=>{e.candidate&&mt.push(JSON.stringify(e.candidate))}),ct.addEventListener("connectionstatechange",()=>{ut=ct.connectionState??"unknown"}),ct.addEventListener("datachannel",e=>{ft=e.channel,pt(ft)})),ct}function pt(e){e&&(e.addEventListener("open",()=>{ut="connected"}),e.addEventListener("close",()=>{ut="disconnected"}),e.addEventListener("message",e=>{try{(t=JSON.parse(e.data))&&"object"==typeof t&&"playerState"===t.type&&function(e){if(!e||!e.id)return;const t="undefined"!=typeof performance?performance.now():Date.now(),a=$e.get(e.id)??{};$e.set(e.id,{id:e.id,name:e.name??a.name??"Remote",x:e.x??a.x??0,y:e.y??a.y??w-Re,facing:e.facing??a.facing??1,commandId:e.commandId??a.commandId??"hold",lastUpdate:t})}({id:t.id,name:t.name,x:t.x,y:t.y,facing:t.facing,commandId:t.commandId})}catch(e){console.warn("Failed to parse P2P payload",e)}var t}))}function xt(){return{id:lt,status:ut,localDescription:gt,localCandidates:[...mt]}}const wt={servers:[],visible:!1,selectedIndex:0,lastFetch:0,fetching:!1,error:null,statusMessage:null,hosting:!1,hostingSessionId:null,hostingLastHeartbeat:0,hostingExpiresAt:0,joinStatus:null,joinError:null,hostingMetrics:{playerCount:1,enemyCount:0,alliesCount:0},p2p:{offer:null,answer:null,pendingOffer:!1,pendingAnswer:!1,pendingCandidates:!1,localCandidates:[],remoteCandidates:[],error:null}};function bt(){return wt}function vt(e){wt.visible=e,e||(wt.statusMessage=null,wt.error=null)}function kt(e){const t=wt.servers[wt.selectedIndex]?.id;if(wt.servers=Array.isArray(e)?e:[],t){const e=wt.servers.findIndex(e=>e.id===t);e>=0&&(wt.selectedIndex=e)}wt.selectedIndex>=wt.servers.length&&(wt.selectedIndex=Math.max(0,wt.servers.length-1))}function St(e){wt.error=e}function Tt(e){wt.statusMessage=e}function Ct(e){wt.joinStatus=e}function Mt(e){wt.joinError=e}function It(e){wt.joinedSessionId=e??null}function At(e){wt.lastFetch=e}function Pt(e){wt.fetching=e}function Dt({id:e,expiresAt:t}){wt.hosting=Boolean(e),wt.hostingSessionId=e??null,wt.hostingLastHeartbeat=performance.now(),wt.hostingExpiresAt=t??0}function Rt(){wt.hosting=!1,wt.hostingSessionId=null,wt.hostingExpiresAt=0,wt.hostingLastHeartbeat=0,Ht()}function Bt(e={}){Number.isFinite(e.playerCount)&&(wt.hostingMetrics.playerCount=Math.max(1,Math.round(e.playerCount))),Number.isFinite(e.enemyCount)&&(wt.hostingMetrics.enemyCount=Math.max(0,Math.round(e.enemyCount))),Number.isFinite(e.alliesCount)&&(wt.hostingMetrics.alliesCount=Math.max(0,Math.round(e.alliesCount)))}function Et(e){wt.p2p.answer=e??null}function Ot(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=wt.p2p.localCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(wt.p2p.localCandidates=t)}function Lt(e){Array.isArray(e)||(e=[]);const t=e.slice(),a=wt.p2p.remoteCandidates||[];a.length===t.length&&a.every((e,a)=>e===t[a])||(wt.p2p.remoteCandidates=t)}function $t(e){wt.p2p.error=e??null}function Wt({offer:e,answer:t,candidates:a}){"boolean"==typeof e&&(wt.p2p.pendingOffer=e),"boolean"==typeof t&&(wt.p2p.pendingAnswer=t),"boolean"==typeof a&&(wt.p2p.pendingCandidates=a)}function Ht(){wt.p2p.offer=null,wt.p2p.answer=null,wt.p2p.pendingOffer=!1,wt.p2p.pendingAnswer=!1,wt.p2p.pendingCandidates=!1,wt.p2p.localCandidates=[],wt.p2p.remoteCandidates=[],wt.p2p.error=null}function Ft(e,t,a){return Math.max(t,Math.min(a,e))}const Nt={buggy:{label:"Recon Buggy",movementType:"ground",width:132,height:48,wheelRadius:18,wheelBase:76,driverSeat:{x:-6,y:42},exitOffsets:[{x:72,y:0},{x:-72,y:0}],enterRadius:96,acceleration:540,braking:880,maxSpeed:420,idleDrag:320,airDrag:.92,baseHealth:280,colorBody:"#2e3147",colorAccent:"#ffb84d",colorDetail:"#f7f9ff"},raptorHeli:{label:"Raptor Helicopter",movementType:"air",mountedWeapons:[{id:"raptorHeli.noseCannon",label:"Nose Cannon",binding:"primary",offset:{x:32,y:2},muzzles:[{x:46,y:-3},{x:46,y:3}],projectile:{speed:720,damage:14,radius:4,color:"#8cf4ff",gravityFactor:.04,knockback:70},scatter:3.5,fireInterval:.1,flashDuration:.07,flashRadius:12,barrelLength:52,barrelWidth:5,barrelColor:"#8cf4ff"}],width:156,height:54,driverSeat:{x:6,y:44},exitOffsets:[{x:88,y:0},{x:-88,y:0}],enterRadius:128,horizontalAcceleration:320,horizontalMaxSpeed:300,horizontalDrag:180,idleDrag:140,airDrag:.98,liftPower:880,descendPower:620,gravityScale:.3,maxVerticalSpeed:240,verticalDamping:.9,hoverMinAltitude:28,hoverMaxAltitude:260,spawnHover:60,autopilotStrength:5.2,baseHealth:420,colorBody:"#303952",colorAccent:"#8cf4ff",colorDetail:"#f4fbff",rotorSpan:210,rotorThickness:7,tailLength:86},arrowJet:{label:"Arrow Fighter",movementType:"air",mountedWeapons:[{id:"arrowJet.rackRockets",label:"Wing Rockets",binding:"secondary",offset:{x:12,y:-6},muzzles:[{x:52,y:-12},{x:52,y:12}],projectile:{speed:780,damage:24,radius:6,color:"#ff6b80",gravityFactor:.05,knockback:140},scatter:4,fireInterval:.28,flashDuration:.09,flashRadius:15,barrelLength:54,barrelWidth:5,barrelColor:"#ff6b80"}],width:180,height:36,driverSeat:{x:0,y:32},exitOffsets:[{x:96,y:-8},{x:-96,y:-8}],enterRadius:140,horizontalAcceleration:520,horizontalMaxSpeed:520,horizontalDrag:120,idleDrag:80,airDrag:.99,liftPower:780,descendPower:540,gravityScale:.42,maxVerticalSpeed:280,verticalDamping:.92,hoverMinAltitude:80,hoverMaxAltitude:360,spawnHover:120,autopilotStrength:3.8,baseHealth:350,colorBody:"#262c3e",colorAccent:"#ff6b80",colorDetail:"#f8f8ff",wingSpan:230},tideSkiff:{label:"Tide Skiff",movementType:"water",mountedWeapons:[{id:"tideSkiff.prowCannon",label:"Prow Cannon",binding:"primary",offset:{x:28,y:-18},muzzles:[{x:36,y:-4}],projectile:{speed:560,damage:18,radius:6,color:"#ffdd8a",gravityFactor:.08,knockback:110},scatter:2.5,fireInterval:.22,flashDuration:.1,flashRadius:14,barrelLength:46,barrelWidth:6,barrelColor:"#5fd3ff"}],width:150,height:42,driverSeat:{x:-10,y:34},exitOffsets:[{x:92,y:-4},{x:-92,y:-4}],enterRadius:120,waterSurfaceOffset:28,waterAcceleration:260,waterMaxSpeed:240,waterReverseSpeed:140,waterIdleDrag:180,turnDrag:220,bobAmplitude:6,bobSpeed:1.5,buoyancyPoint:.58,splashIntensity:.4,baseHealth:320,colorBody:"#1f2e3f",colorAccent:"#5fd3ff",colorDetail:"#f5fbff"},stormBarge:{label:"Storm Barge",movementType:"water",mountedWeapons:[{id:"stormBarge.deckChaingun",label:"Deck Chaingun",binding:"primary",offset:{x:18,y:-24},muzzles:[{x:58,y:-6},{x:58,y:6}],projectile:{speed:620,damage:16,radius:5,color:"#ffc86d",gravityFactor:.06,knockback:90},scatter:5,fireInterval:.12,flashDuration:.08,flashRadius:16,barrelLength:58,barrelWidth:6,barrelColor:"#ffa94d"}],width:200,height:60,driverSeat:{x:14,y:46},exitOffsets:[{x:110,y:-6},{x:-110,y:-6}],enterRadius:132,waterSurfaceOffset:32,waterAcceleration:180,waterMaxSpeed:180,waterReverseSpeed:110,waterIdleDrag:260,turnDrag:320,bobAmplitude:4,bobSpeed:1.2,buoyancyPoint:.62,splashIntensity:.3,baseHealth:480,colorBody:"#232f3a",colorAccent:"#ffa94d",colorDetail:"#f0f4ff"},abyssSub:{label:"Abyss Sub",movementType:"water",mountedWeapons:[{id:"abyssSub.torpedoLauncher",label:"Twin Torpedoes",binding:"secondary",offset:{x:12,y:-10},muzzles:[{x:40,y:-6},{x:40,y:6}],projectile:{speed:480,damage:28,radius:7,color:"#8c9eff",gravityFactor:.02,knockback:160},scatter:1.5,fireInterval:.6,flashDuration:.12,flashRadius:18,barrelLength:48,barrelWidth:7,barrelColor:"#8c9eff"}],width:132,height:48,driverSeat:{x:0,y:36},exitOffsets:[{x:78,y:-10},{x:-78,y:-10}],enterRadius:110,waterSurfaceOffset:36,waterAcceleration:300,waterMaxSpeed:260,waterReverseSpeed:160,waterIdleDrag:210,turnDrag:240,bobAmplitude:3,bobSpeed:1.1,buoyancyPoint:.5,submergedOffset:18,splashIntensity:.2,baseHealth:360,colorBody:"#182733",colorAccent:"#8c9eff",colorDetail:"#e9f1ff"},scoutDrone:{label:"Scout Drone",movementType:"air",width:72,height:28,driverSeat:{x:0,y:20},exitOffsets:[{x:48,y:0},{x:-48,y:0}],enterRadius:90,horizontalAcceleration:280,horizontalMaxSpeed:260,horizontalDrag:220,idleDrag:200,airDrag:.95,liftPower:660,descendPower:520,gravityScale:.26,maxVerticalSpeed:200,verticalDamping:.88,hoverMinAltitude:24,hoverMaxAltitude:220,spawnHover:48,autopilotStrength:6.2,baseHealth:180,colorBody:"#293444",colorAccent:"#ffe066",colorDetail:"#edf4ff"}};let jt=0;function Yt(e,t,a={}){const o=Nt[e];if(!o)throw new Error(`Unknown vehicle type: ${e}`);const n=o.movementType??"ground",i=.5*o.width,r=de(),s=Ft(t??.5*r,i,Math.max(i,r-.5*o.width));let l,c=!0,d=null,f=a.hover??o.spawnHover??0;if("air"===n){const e=o.hoverMinAltitude??0,t=Ft(f,e,o.hoverMaxAltitude??e);l=w-o.height-t,c=!1,f=t}else if("water"===n){const e=o.waterSurfaceOffset??24;d=w-e;const t=Ft(o.buoyancyPoint??.55,.2,.9),a=o.submergedOffset??0;l=d-o.height*t+a,c=!1,f=0}else l=w-o.height;const h={id:`vehicle-${e}-${jt+=1}`,type:e,x:s,y:l,vx:0,vy:0,tilt:0,facing:1,driverId:null,health:o.baseHealth,maxHealth:o.baseHealth,enterCooldown:0,damageFlash:0,onGround:c,preferredAltitude:"air"===n?f:0,waterLineY:d,bobPhase:Math.random()*Math.PI*2};return h.mounts=(o.mountedWeapons??[]).map((t,a)=>({id:t.id??`${e}-mount-${a}`,cooldown:0,flashTimer:0,muzzleIndex:0,lastMuzzleX:null,lastMuzzleY:null})),h}const zt=[Yt("buggy",.14*de()),Yt("buggy",.28*de()),Yt("tideSkiff",.38*de()),Yt("raptorHeli",.56*de(),{hover:140}),Yt("arrowJet",.64*de(),{hover:200}),Yt("stormBarge",.74*de()),Yt("abyssSub",.78*de()),Yt("scoutDrone",.9*de(),{hover:100})];function Xt(e){return zt.find(t=>t.id===e)??null}function qt(e,t,a){return Math.max(t,Math.min(a,e))}let Gt=0;function Jt(){return Gt}const Kt={active:!1,stage:"idle",timer:0,wave:0,enemiesAlive:0,lastReward:0};function Ut(e,t=0){Kt.stage=e,Kt.timer=Math.max(0,t??0)}function Vt(e){Kt.lastReward=Math.max(0,Math.round(e??0))}function _t(){return Kt}ue(()=>{Kt.active=!1,Kt.stage="idle",Kt.timer=0,Kt.wave=0,Kt.enemiesAlive=0,Kt.lastReward=0});const Qt={player:[{radius:16,offsetX:0,offsetY:-42,color:"#f4f7ff"},{radius:12,offsetX:0,offsetY:-14,color:"#cfd3df"},{radius:10,offsetX:-14,offsetY:6,color:"#f4f7ff"},{radius:10,offsetX:14,offsetY:6,color:"#f4f7ff"},{radius:11,offsetX:-10,offsetY:34,color:"#cfd3df"},{radius:11,offsetX:10,offsetY:34,color:"#cfd3df"}],enemy:[{radius:16,offsetX:0,offsetY:-40,color:"#fa5b4a"},{radius:12,offsetX:0,offsetY:-12,color:"#d94d3f"},{radius:10,offsetX:-12,offsetY:8,color:"#ff9488"},{radius:10,offsetX:12,offsetY:8,color:"#ff9488"},{radius:11,offsetX:-10,offsetY:36,color:"#d94d3f"},{radius:11,offsetX:10,offsetY:36,color:"#d94d3f"}]},Zt=[];function ea(e,t,a,o=1,n=0,i=0){const r=Qt[e];if(r)for(const e of r)Zt.push({x:t+e.offsetX*o,y:a+e.offsetY,vx:n+o*(40+80*Math.random())+60*(Math.random()-.5),vy:i-(80+140*Math.random()),radius:e.radius,color:e.color,life:1.6+.8*Math.random(),maxLife:1.6+.8*Math.random()})}const ta=[];function aa(e,t,a){ta.push({x:e,y:t,value:a,life:.75,maxLife:.75,vx:24*(Math.random()-.5),vy:-60-20*Math.random()})}const oa=[];function na(e){const t=function(){const e=[];He.health>0&&e.push({id:He.id,x:He.x,y:He.y+.5*He.height});for(const t of Ne)t.health>0&&e.push({id:t.id,x:t.x,y:t.y+.5*t.height,ref:t});return e}();let a=null,o=1/0;for(const n of t){const t=n.x-e.x,i=n.y-(e.y+.4*e.height),r=t*t+i*i;r<=e.range*e.range&&r<o&&(a=n,o=r)}return a}function ia(e,t){const a=e.x,o=e.y+.35*e.height,n=t.x-a,i=t.y-o;e.facing=Math.sign(n)||e.facing;const r=Math.hypot(n,i)||1,s=e.projectile.speed,l=n/r*s;no({x:a,y:o,vx:l,vy:i/r*s,radius:e.projectile.radius,lifetime:e.projectile.lifetime,color:e.projectile.color,damage:e.projectile.damage,knockback:e.projectile.knockback,facing:Math.sign(l)||1,gravityFactor:0}),e.fireTimer=e.fireInterval}const ra={active:!1,tetherLength:0,maxLength:0,targetX:0,targetY:0,duration:0,retracting:!1,cooldown:0,color:"#8cf1ff",travelSpeed:860,pullSpeed:740};function sa(){ra.active=!1,ra.retracting=!1,ra.tetherLength=0,ra.maxLength=0}const la={active:!1,strength:0,maxStrength:0,duration:0,maxDuration:0,radius:90,color:"#7cd6ff",flashTimer:0};function ca(){const e=2*(Ee.currentPose?.headRadius??16)+(Ee.currentPose?.bodyLength??34)+(Ee.currentPose?.legLength??36);return{x:Ee.x,y:Ee.y+.5*e}}function da(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function fa(e="expired"){if(!la.active)return;const t={reason:e,remainingStrength:la.strength,maxStrength:la.maxStrength,duration:la.duration,maxDuration:la.maxDuration,center:ca(),radius:la.radius};la.active=!1,la.strength=0,la.duration=0,la.flashTimer=0,da("shield:end",t)}function ha(e){const t=e?.gadget;if(!t)return!1;if((Ee.gadgetCooldown??0)>0)return!1;switch(t.type??"turret"){case"turret":return function(e){const t=function(e,t){const a=e.height??54,o=e.spawnOffset??{x:64,y:0},n=Ie(Ee.currentPose??null)||0,i=de(),r=qt(Ee.x+t*(o.x??64),40,i-40),s=Ee.y+n,l=Math.min(s+(o.y??0),w),c=Math.min(w-a,l-a);return{id:`turret-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:r,y:c,height:a,facing:t,range:e.range??260,fireInterval:Math.max(.1,e.fireInterval??.6),fireTimer:.1,duration:e.duration??8,maxDuration:e.duration??8,projectile:{speed:e.projectile?.speed??520,radius:e.projectile?.radius??5,damage:e.projectile?.damage??10,knockback:e.projectile?.knockback??70,lifetime:e.projectile?.lifetime??1.1,color:e.projectile?.color??"#9ae9ff"},baseColor:e.baseColor??"#7a8bff",headColor:e.headColor??"#cfd8ff"}}(e,Ee.facing||1),a=Math.max(1,e.maxActive??1);oa.length>=a&&oa.shift(),oa.push(t)}(t),Ee.gadgetCooldown=t.cooldownSeconds??2.5,!0;case"grapple":return!(ra.active||(Ee.gadgetCooldown??0)>0||(function(e){const t=de(),a=e.clamp??{left:80,right:t-80},o=e.apex??{y:w-280},n=e.maxLength??320,i=Ee.facing||1,r=qt(Ee.x+i*n,a.left,a.right),s=Math.min(o.y??w-240,Ee.y-(e.maxRise??260));ra.active=!0,ra.retracting=!1,ra.tetherLength=0,ra.maxLength=Math.hypot(r-Ee.x,s-Ee.y),ra.targetX=r,ra.targetY=s,ra.duration=e.duration??.65,ra.cooldown=e.cooldownSeconds??1.6,ra.color=e.color??"#8cf1ff",ra.travelSpeed=e.travelSpeed??860,ra.pullSpeed=e.pullSpeed??740,Ee.gadgetCooldown=ra.cooldown}(t),0));case"shield":return function(e={}){const t=e.strength??90;!la.active&&(la.active=!0,la.strength=t,la.maxStrength=t,la.duration=e.duration??6,la.maxDuration=la.duration,la.radius=e.radius??96,la.color=e.color??"#7cd6ff",la.flashTimer=0,Ee.gadgetCooldown=e.cooldownSeconds??4.5)}(t),!0;default:return!1}}function ua(e){const t=e.damage??0,a=e.knockback??0;He.health=Math.max(0,He.health-t),He.flashTimer=.18,He.shakeTimer=Math.min(.4,He.shakeTimer+.22),He.shakeMagnitude=Math.min(14,He.shakeMagnitude+a/60);const o=He.y+.55*He.height-He.radius-12;aa(He.x,o,t),0===He.health&&He.respawnTimer<=0&&(He.respawnTimer=2.5)}function ga(e,t){if(e.health<=0||e.invulnerability>0)return;const a=t.damage??0,o=t.knockback??0,n=t.launch??0,i=t.facing??Ee.facing;if(e.health=Math.max(0,e.health-a),e.flashTimer=.18,e.shakeTimer=Math.min(.5,e.shakeTimer+.24),e.shakeMagnitude=Math.min(18,e.shakeMagnitude+o/55),e.vx+=o*i*.35,n>0&&(e.vy-=.3*n),aa(e.x+14*e.facing,e.y-14,a),e.invulnerability=.15,0===e.health&&(e.respawnTimer<=0&&ea("enemy",e.x,e.y,i,e.vx,e.vy),e.state="defeated",e.attackCooldown=1.2,e.respawnTimer=3,Kt.active)){const e=3;e>0&&ne(e)}}function ma(e,t){if(Ee.invulnerability>0||Ee.health<=0)return;const a=t?.damage??e.attackDamage??0,o=t?.knockback??e.attackKnockback??0,n=t?.launch??e.attackLaunch??0,i=t?.facing??e.facing??1;let r=function(e){if(!la.active)return e;const t=e.damage??0;if(t<=0)return e;const a=Math.min(t,la.strength);la.strength-=a,la.flashTimer=Math.max(la.flashTimer,.2);const o=ca();da("shield:hit",{absorb:a,remainingStrength:Math.max(0,la.strength),maxStrength:la.maxStrength,duration:la.duration,maxDuration:la.maxDuration,center:o,radius:la.radius});const n=t-a,i={...e,damage:n};return n<=0&&(i.damage=0,i.knockback=.25*(e.knockback??0),i.launch=.25*(e.launch??0)),la.strength<=0&&(da("shield:shatter",{reason:"damage",absorb:a,center:o,maxStrength:la.maxStrength,radius:la.radius}),fa("shatter")),i}({damage:a,knockback:o,launch:n,facing:i}),s=r?.damage??0,l=r?.knockback??o,c=r?.launch??n;const d=r?.facing??i,f=Math.max(0,Math.min(.9,Ee.structureShieldStrength??0));f>0&&(s*=1-f,l*=1-.5*f,c*=1-.5*f),s>0?(Ee.health=Math.max(0,Ee.health-s),Ee.invulnerability=.6):Ee.invulnerability=Math.max(Ee.invulnerability,.2),Ee.vx+=l*d,Ee.vy+=c,aa(Ee.x,Ee.y+10,Math.max(0,Math.round(s))),s>0&&0===Ee.health&&Ee.deadTimer<=0&&(Ee.deadTimer=2.6,Ee.attacking=!1,Ee.activeHitboxes=[],Ee.comboWindowOpen=!1,Ee.attackIndex=-1,Ee.rolling=!1,ea("player",Ee.x,Ee.y,-d,Ee.vx,Ee.vy))}const ya={concreteBarrier:{maxHealth:600,width:180,height:110,rubbleHeight:34,material:"concrete",bodyColor:"#4c5564",edgeColor:"#2a313c",accentColor:"#9aa4b4",damageHighlight:"#d5dde8",debrisColor:"#3a424f",smokeDuration:2.4,shakeFactor:16,salvage:12},streetCar:{maxHealth:420,width:168,height:90,rubbleHeight:38,material:"vehicle",bodyColor:"#ba3c38",edgeColor:"#1c1d25",accentColor:"#f4f7fb",glassColor:"#4ac3ff",damageHighlight:"#ffe5dc",debrisColor:"#5a1f1a",smokeDuration:3.4,shakeFactor:22,salvage:18,deathBlast:{radius:140,maxDamage:160,knockback:320,minDamageRatio:.32}},fuelBarrelCluster:{maxHealth:220,width:96,height:96,rubbleHeight:28,material:"volatile",bodyColor:"#c0671c",edgeColor:"#2f1a08",accentColor:"#ffe7ba",stripeColor:"#ffd45f",damageHighlight:"#ffd4a1",debrisColor:"#6e2c05",smokeDuration:4.2,shakeFactor:26,salvage:22,deathBlast:{radius:180,maxDamage:240,knockback:400,minDamageRatio:.4}},timberWall:{maxHealth:540,width:172,height:102,rubbleHeight:32,material:"concrete",bodyColor:"#5c4b2d",edgeColor:"#362a18",accentColor:"#8b7344",damageHighlight:"#f5d6a4",debrisColor:"#3a2d1a",smokeDuration:2.1,shakeFactor:18,salvage:16},sandbagLine:{maxHealth:520,width:200,height:88,rubbleHeight:30,material:"concrete",bodyColor:"#c2a274",edgeColor:"#7a6142",accentColor:"#e3cc9b",damageHighlight:"#ffe8b8",debrisColor:"#8a6d48",smokeDuration:1.9,shakeFactor:14,salvage:14},roverWreck:{maxHealth:380,width:176,height:96,rubbleHeight:36,material:"vehicle",bodyColor:"#8d9fb4",edgeColor:"#1f2a35",accentColor:"#f5f9ff",glassColor:"#9be9ff",damageHighlight:"#d6e2ff",debrisColor:"#46586a",smokeDuration:3.1,shakeFactor:20,salvage:20,deathBlast:{radius:120,maxDamage:120,knockback:240,minDamageRatio:.28}},plasmaCell:{maxHealth:260,width:102,height:102,rubbleHeight:26,material:"volatile",bodyColor:"#3b89ff",edgeColor:"#15213a",accentColor:"#8bd4ff",stripeColor:"#62f5ff",damageHighlight:"#b0f0ff",debrisColor:"#1c3c66",smokeDuration:4.6,shakeFactor:30,salvage:26,deathBlast:{radius:220,maxDamage:280,knockback:420,minDamageRatio:.45}}};function pa(){return function(){const e=ce();return Array.isArray(e?.destructibles)?e.destructibles:[]}().map(e=>function(e){const t=ya[e.type];if(!t)throw new Error(`Unknown destructible template: ${e.type}`);const a=e.templateOverrides??{},o={...t,...a},n=e.width??o.width??t.width,i=e.height??o.height??t.height,r=n/2,s=o.maxHealth??t.maxHealth??100,l={id:e.id,type:e.type,template:o,x:e.x,y:e.baseY,width:n,height:i,halfWidth:r,health:s,maxHealth:s,destroyed:!1,flashTimer:0,shakeTimer:0,shakeMagnitude:0,smokeTimer:0,rubbleLevel:0,deathTriggered:!1,facing:e.facing??1,spawnConfig:{...e}};return e.overrides&&"object"==typeof e.overrides&&Object.assign(l,e.overrides),l}(e))}const xa=pa();ue(()=>{!function(){xa.length=0;const e=pa();for(const t of e)xa.push(t)}()});const wa=[],ba=[];let va=!1;function ka(e={}){const t=e.ttl??.4,a={x:e.x??0,y:e.y??0,startRadius:e.startRadius??70,endRadius:e.endRadius??140,color:e.color??"#ffffff",maxTtl:t,ttl:t,lineWidth:e.lineWidth??5};return ba.push(a),a}function Sa(e={},t={}){const a=e.center??{x:e.x??0,y:e.y??0};return ka({x:a.x,y:a.y,ttl:t.ttl??.4,startRadius:t.startRadius??e.radius??70,endRadius:t.endRadius??1.25*(e.radius??70),color:t.color??"#7cd6ff",lineWidth:t.lineWidth??5})}function Ta(e={}){const t=e.center??{x:0,y:0};for(let e=0;e<9;e+=1){const e=Math.random()*Math.PI*2,a=90+150*Math.random(),o=Math.cos(e)*a,n=Math.sin(e)*a,i=.3+.2*Math.random();wa.push({type:"shield",x:t.x,y:t.y,vx:o,vy:n,ttl:i,maxTtl:i,radius:6+6*Math.random(),color:"#9be9ff"})}Sa(e,{ttl:.35,startRadius:.75*(e.radius??72),endRadius:1.15*(e.radius??72),lineWidth:4,color:"#a9f0ff"})}function Ca(){va||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",e=>{!function(e={}){const t=e.x??0,a=e.y??0,o=e.facing??1;for(let e=0;e<6;e+=1){const e=140+120*Math.random(),n=.6*Math.random()-.3+(o>0?0:Math.PI),i=Math.cos(n)*e,r=Math.sin(n)*e,s=.18+.08*Math.random();wa.push({type:"spark",x:t,y:a,vx:i,vy:r,ttl:s,maxTtl:s,radius:4+3*Math.random(),color:"#ffdd9a"})}}(e?.detail??{})}),window.addEventListener("shield:hit",e=>{Ta(e?.detail??{})}),window.addEventListener("shield:shatter",e=>{!function(e={}){Sa(e,{ttl:.55,startRadius:.9*(e.radius??96),endRadius:1.6*(e.radius??96),lineWidth:7,color:"#7cd6ff"}),Ta({center:e.center,radius:e.radius??96})}(e?.detail??{})}),window.addEventListener("throwable:explosion",e=>{Ma(e?.detail??{})}),window.addEventListener("throwable:flash-burst",e=>{!function(e={}){const t=e.x??0,a=e.y??0,o=e.radius??140;ka({x:t,y:a,startRadius:.6*o,endRadius:1.35*o,color:"#fff6d0",lineWidth:8,ttl:.32});for(let e=0;e<12;e+=1){const e=Math.random()*Math.PI*2,o=160+140*Math.random(),n=.18+.08*Math.random();wa.push({type:"flash",x:t,y:a,vx:Math.cos(e)*o,vy:Math.sin(e)*o,ttl:n,maxTtl:n,radius:5+3*Math.random(),color:"#fffbe0"})}}(e?.detail??{})}),window.addEventListener("throwable:smoke-spawn",e=>{Ia(e?.detail??{})}),window.addEventListener("throwable:smoke-dissipate",e=>{!function(e={}){ka({x:e.x??0,y:e.y??0,startRadius:.8*(e.radius??110),endRadius:1.1*(e.radius??110),color:"#95a8b8",lineWidth:3,ttl:.4})}(e?.detail??{})}),window.addEventListener("destructible:hit",e=>{!function(e={}){const t={concrete:["#dfe6f2","#b9c3d0","#6c7584"],vehicle:["#ffd6c8","#ff9a82","#3a1a1a"],volatile:["#ffd38a","#ff9c3b","#6e2c05"],generic:["#f2f5ff","#c9d0de"]},a=t[e.material??"generic"]??t.generic,o=Math.max(1,e.maxHealth??e.health??1),n=qt(1-Math.max(0,Math.min(o,e.health??o))/o,0,1),i=Math.max(6,Math.round(6+6*n)),r=160+200*n;for(let t=0;t<i;t+=1){const o=Math.random()*Math.PI*2,n=r*(.45+.65*Math.random());wa.push({type:"debris",x:e.x??0,y:e.y??0,vx:Math.cos(o)*n,vy:Math.sin(o)*n*.7-50,ttl:.45+.3*Math.random(),maxTtl:.45+.3*Math.random(),radius:3+4*Math.random(),color:a[t%a.length]})}}(e?.detail??{})}),va=!0)}function Ma(e={}){const t=e.x??0,a=e.y??0,o=e.radius??110;for(let e=0;e<18;e+=1){const e=Math.random()*Math.PI*2,o=220+220*Math.random(),n=.3+.25*Math.random();wa.push({type:"ember",x:t,y:a,vx:Math.cos(e)*o,vy:Math.sin(e)*o,ttl:n,maxTtl:n,radius:5+4*Math.random(),color:Math.random()>.55?"#ff9c4a":"#ffd56b"})}ka({x:t,y:a,startRadius:.45*o,endRadius:1.05*o,color:"#ffb347",lineWidth:6,ttl:.45})}function Ia(e={}){const t=e.x??0,a=e.y??0,o=e.radius??e.maxRadius??120;for(let e=0;e<14;e+=1){const e=Math.random()*Math.PI*2,n=30+60*Math.random(),i=Math.cos(e)*n*.4,r=-40-50*Math.random(),s=.9+.5*Math.random();wa.push({type:"smoke",x:t+Math.cos(e)*o*.2,y:a+Math.sin(e)*o*.1,vx:i,vy:r,ttl:s,maxTtl:s,radius:o*(.15+.18*Math.random()),color:"#aec4d8"})}ka({x:t,y:a,startRadius:.5*o,endRadius:1.2*o,color:"#9db8ca",lineWidth:4,ttl:.5})}function Aa(e,t,a=.25){const o=qt(1-e/Math.max(1,t),0,1);return qt(a+o*(1-a),0,1)}function Pa({x:e,y:t,radius:a,maxDamage:o=0,maxKnockback:n=0,minDamageRatio:i=.25,selfDamageScale:r=1,selfKnockbackScale:s=1,includeTrainingDummy:l=!0,includeEnemies:c=!0,includePlayer:d=!0}){const f={dummyHit:!1,enemiesHit:0,playerHit:!1},h=Math.max(0,o),u=Math.max(0,n??1.2*h),g=Math.max(1,a),m=qt(i,0,1);if(l&&He.health>0){const a=He.x,o=He.y+.55*He.height,n=Math.hypot(a-e,o-t);if(n<=g){const t=Aa(n,g,m),o=u*t;ua({damage:h*t,knockback:o,launch:.18*o,facing:a>=e?1:-1}),f.dummyHit=!0}}if(c)for(const a of Ne){if(a.health<=0)continue;const o=a.x,n=a.y+.5*a.height,i=Math.hypot(o-e,n-t);if(i>g)continue;const r=Aa(i,g,m),s=h*r,l=u*r;s<=0&&l<=0||(ga(a,{damage:s,knockback:l,launch:.24*l,facing:o>=e?1:-1}),f.enemiesHit+=1)}if(d&&Ee.health>0){const a=Ie(Ee.currentPose??{headRadius:16,bodyLength:34,legLength:36}),o=Ee.y+.6*a,n=Math.hypot(Ee.x-e,o-t);if(n<=g){const t=Aa(n,g,m),a=Math.max(0,h*t*r),o=u*t*s,i=Ee.x>=e?1:-1;(a>0||o>0)&&(ma(null,{damage:a,knockback:o,launch:.25*o,facing:i}),f.playerHit=!0)}}return f}function Da(e){const t=e.halfWidth??e.width/2;return{left:e.x-t,right:e.x+t,top:e.y-e.height,bottom:e.y}}function Ra(e,t,a,o){const{left:n,right:i,top:r,bottom:s}=Da(o),l=e-qt(e,n,i),c=t-qt(t,r,s);return l*l+c*c<=a*a}function Ba(e,t,a){const{left:o,right:n,top:i,bottom:r}=Da(a),s=Math.max(o-e,0,e-n),l=Math.max(i-t,0,t-r);return Math.hypot(s,l)}function Ea(e,t={}){if(!e||e.destroyed)return{applied:!1,destroyed:!1};const a=e.template,o=Math.max(0,t.damage??0);if(o<=0)return{applied:!1,destroyed:!1};const n=Math.min(o,e.health);e.health=Math.max(0,e.health-n),e.flashTimer=.2,e.shakeTimer=Math.min(.45,e.shakeTimer+.18+n/e.maxHealth*.3);const i=a?.shakeFactor??14;e.shakeMagnitude=Math.max(.6*e.shakeMagnitude,i*(.35+n/e.maxHealth*1.2)),e.smokeTimer=Math.min(a?.smokeDuration??0,(e.smokeTimer??0)+.5),function(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:hit",{detail:{id:e.id,type:e.type,material:e.template?.material??"generic",cause:t.cause??"impact",x:t.impactX??e.x,y:t.impactY??e.y-.5*e.height,health:e.health,maxHealth:e.maxHealth}}))}(e,t);let r=!1;return e.health<=0&&(e.destroyed=!0,e.rubbleLevel=Math.max(e.rubbleLevel,.05),e.smokeTimer=a?.smokeDuration??0,function(e,t={}){const a=e.template;if(!a||e.deathTriggered)return;e.deathTriggered=!0;const o=t.impactX??e.x,n=t.impactY??e.y-.35*e.height;if(Ma({x:o,y:n,radius:.8*Math.max(e.width,e.height)}),Ia({x:o,y:n,radius:Math.max(e.width,e.height),maxRadius:.6*(a.deathBlast?.radius??1.2*e.width)}),ka({x:o,y:n,startRadius:.35*e.width,endRadius:1.1*e.width,color:"#ffb347",ttl:.55,lineWidth:5}),a.deathBlast){const t=a.deathBlast;"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("destructible:explosion",{detail:{id:e.id,x:o,y:n,radius:t.radius}})),Pa({x:o,y:n,radius:t.radius,maxDamage:t.maxDamage,maxKnockback:t.knockback,minDamageRatio:t.minDamageRatio??.25}),Oa({x:o,y:n,radius:t.radius,maxDamage:t.maxDamage,minDamageRatio:t.minDamageRatio??.25,sourceId:e.id,cause:"chain-explosion"})}const i=a.salvage??Math.round((e.maxHealth??200)/25);if(i>0){const t=Math.max(1,Math.round(i/10)),a=Math.max(1,Math.round(i/t));for(let i=0;i<t;i+=1)ie({x:o+(Math.random()-.5)*(e.width??120)*.4,y:n,amount:a,vy:-120-60*Math.random()})}}(e,t),r=!0),{applied:!0,destroyed:r}}function Oa({x:e,y:t,radius:a,maxDamage:o,minDamageRatio:n=.25,sourceId:i=null,cause:r="explosion"}){const s=Math.max(0,o??0);if(s<=0||a<=0)return 0;const l=qt(n,0,1);let c=0;for(const o of xa){if(o.id===i||o.destroyed&&o.deathTriggered)continue;const n=Ba(e,t,o);if(n>a)continue;const d=s*Aa(n,a,l);d<=0||Ea(o,{damage:d,cause:r,impactX:qt(e,o.x-o.halfWidth,o.x+o.halfWidth),impactY:qt(t,o.y-o.height,o.y)}).applied&&(c+=1)}return c}function La(e){for(const t of xa)if(!t.destroyed&&Ra(e.x,e.y,e.radius,t))return Ea(t,{damage:e.damage??0,cause:"projectile",impactX:e.x,impactY:e.y}),!0;return!1}function $a(e){let t=!1;for(const a of xa)a.destroyed||e.hitTargets.has(a.id)||Ra(e.x,e.y,e.radius,a)&&(e.hitTargets.add(a.id),Ea(a,{damage:e.damage??0,cause:"melee",impactX:e.x,impactY:e.y}),t=!0);return t}const Wa={barricade:{id:"barricade",name:"Reinforced Barricade",width:160,height:96,maxHealth:600,cost:40,color:"#4f5a6c",accentColor:"#8ea0ba",strokeColor:"#273041",blocking:!0},watchtower:{id:"watchtower",name:"Scout Tower",width:120,height:200,maxHealth:520,cost:65,color:"#6c5b3f",accentColor:"#a7824f",strokeColor:"#2f2415",turret:{range:420,cooldown:1.25,projectile:{speed:520,damage:18,color:"#ffd57a"}}},shieldEmitter:{id:"shieldEmitter",name:"Shield Emitter",width:110,height:110,maxHealth:360,cost:55,color:"#2a3b58",accentColor:"#6fb7ff",strokeColor:"#152032",shield:{radius:220,damageReduction:.4,buffDuration:.6},ambient:{radius:260,intensity:.9,color:"#7cd6ff",flicker:.35}},shockTrap:{id:"shockTrap",name:"Shock Trap",width:100,height:28,maxHealth:280,cost:30,color:"#2b2f3c",accentColor:"#9af0ff",strokeColor:"#181b26",trap:{radius:140,damage:24,stun:.8,cooldown:2.6},ambient:{radius:180,intensity:.6,color:"#8cf2ff",flicker:.4}}},Ha=[],Fa={active:!1,blueprintIndex:0,lastPreview:{x:0,y:0,valid:!1}};function Na(){return Object.values(Wa)}function ja(e=0){const t=Na();return 0===t.length?null:t[(e%t.length+t.length)%t.length]}function Ya(){Ha.length=0}function za(){return Ha}function Xa(){return Fa}ue(()=>{Ya(),Fa.active=!1,Fa.lastPreview={...Fa.lastPreview,valid:!1}});const qa=new Map,Ga=[];let Ja=!1,Ka=function(){const e=ce();return Array.isArray(e?.ambientLights)?e.ambientLights:[]}();function Ua(e){return qt(e,0,3)}function Va(e,t){const{r:a,g:o,b:n}=function(e){if("string"!=typeof e)return{r:255,g:255,b:255};const t=e.trim();if(t.startsWith("#")){let e=t.slice(1);if(3===e.length&&(e=e.split("").map(e=>e+e).join("")),6===e.length){const t=Number.parseInt(e,16);if(!Number.isNaN(t))return{r:t>>16&255,g:t>>8&255,b:255&t}}}const a=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);return a?{r:Number.parseInt(a[1],10),g:Number.parseInt(a[2],10),b:Number.parseInt(a[3],10)}:{r:255,g:255,b:255}}(e);return`rgba(${a}, ${o}, ${n}, ${qt(t,0,1.2)})`}function _a(e,t){let a=qa.get(e);a||(a={id:e,intensity:0,targetIntensity:Ua(t.intensity??1),type:t.type??"point",smoothing:t.smoothing??10},qa.set(e,a)),a.type=t.type??a.type??"point",a.x=t.x??a.x??0,a.y=t.y??a.y??0,a.radius=t.radius??a.radius??180,a.fov=t.fov??a.fov??Math.PI/2,a.direction=t.direction??a.direction??0,a.color=t.color??a.color??"#ffffff",a.stretch=t.stretch??a.stretch??1,a.flicker=t.flicker??a.flicker??0,a.smoothing=t.smoothing??a.smoothing??10,a.targetIntensity=Ua(t.intensity??a.targetIntensity??1),a.active=!0}function Qa(e={}){Za();const t=Math.max(.016,e.ttl??.3);Ga.push({type:e.type??"point",x:e.x??0,y:e.y??0,radius:e.radius??160,intensity:Ua(e.intensity??1),color:e.color??"#ffffff",direction:e.direction??0,fov:e.fov??Math.PI/2,stretch:e.stretch??1,flicker:e.flicker??0,decay:qt(e.decay??1,.3,4),ttl:t,maxTtl:t})}function Za(){Ja||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",e=>{const t=e?.detail??{};Qa({type:"point",x:t.x??0,y:t.y??0,radius:t.radius?1.2*t.radius:140,intensity:1.2,color:"#ffe4b0",ttl:.12,flicker:.35,decay:.7}),"number"==typeof t.facing&&0!==t.facing&&Qa({type:"cone",x:t.x??0,y:t.y??0,radius:200,intensity:.9,color:"#fff7d4",direction:t.facing>0?0:Math.PI,fov:Math.PI/5,stretch:.4,ttl:.12,flicker:.25,decay:.8})}),window.addEventListener("throwable:explosion",e=>{const t=e?.detail??{},a=t.radius?1.6*t.radius:240;Qa({type:"point",x:t.x??0,y:t.y??0,radius:a,intensity:1.7,color:"#ffbf6b",ttl:.45,flicker:.45,decay:.7})}),window.addEventListener("throwable:flash-burst",e=>{const t=e?.detail??{};Qa({type:"point",x:t.x??0,y:t.y??0,radius:1.4*(t.radius??220),intensity:2,color:"#ffffff",ttl:.35,flicker:.6,decay:.6})}),window.addEventListener("throwable:smoke-spawn",e=>{const t=e?.detail??{};Qa({type:"point",x:t.x??0,y:t.y??0,radius:1.1*(t.radius??160),intensity:.5,color:"#7ad4ff",ttl:.5,flicker:.2,decay:1.4})}),window.addEventListener("throwable:smoke-dissipate",e=>{const t=e?.detail??{};Qa({type:"point",x:t.x??0,y:t.y??0,radius:1.3*(t.radius??160),intensity:.35,color:"#a4f1ff",ttl:.4,flicker:.18,decay:1.6})}),window.addEventListener("destructible:hit",e=>{const t=e?.detail??{};Qa({type:"point",x:t.impactX??t.x??0,y:t.impactY??t.y??0,radius:140,intensity:.55,color:"#ffe1a4",ttl:.18,flicker:.3,decay:1.1})}),Ja=!0)}function eo(e){const t=e.radius??0;if(t<=0)return!1;const a=x.canvas.width,o=x.canvas.height;return e.x+t>=0&&e.x-t<=a&&e.y+t>=0&&e.y-t<=o}function to(e,t){if(!eo(e))return;const a=e.radius??160,o=x.createRadialGradient(e.x,e.y,0,e.x,e.y,a);o.addColorStop(0,Va(e.color,qt(1.05*t,0,1.1))),o.addColorStop(.4,Va(e.color,qt(.6*t,0,.9))),o.addColorStop(1,Va(e.color,0)),x.fillStyle=o,x.beginPath(),x.arc(e.x,e.y,a,0,2*Math.PI),x.fill()}function ao(e,t){if(!eo(e))return;const a=e.radius??200,o=qt(e.fov??Math.PI/3,Math.PI/12,Math.PI),n=qt(e.stretch??.5,.2,1.2);x.save(),x.translate(e.x,e.y),x.rotate(e.direction??0),x.scale(1,n);const i=x.createRadialGradient(0,0,0,0,0,a);i.addColorStop(0,Va(e.color,qt(t,0,1))),i.addColorStop(.45,Va(e.color,qt(.6*t,0,.8))),i.addColorStop(1,Va(e.color,0)),x.fillStyle=i,x.beginPath();const r=o/2;x.moveTo(0,0),x.arc(0,0,a,-r,r),x.closePath(),x.fill(),x.restore()}ue(e=>{Ka=Array.isArray(e?.ambientLights)?e.ambientLights:[],qa.clear()});const oo=[];function no({x:e,y:t,vx:a,vy:o,radius:n=6,lifetime:i=1.4,color:r="#ffcf7a",damage:s=0,knockback:l=0,facing:c=1,gravityFactor:d=.2}){oo.push({x:e,y:t,vx:a,vy:o,radius:n,life:i,maxLife:i,color:r,damage:s,knockback:l,facing:c,gravityFactor:d,lightCooldown:0,hitTargets:new Set})}function io(e,t,a,o,n,i){const r=e-o,s=t-n,l=a+i;return r*r+s*s<=l*l}const ro=[],so=[];function lo(e,t={}){"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent(e,{detail:t}))}function co(e){if(e.detonated)return;e.detonated=!0,e.explosionTimer=Math.max(e.explosionDuration,.08),e.fuse=0;const t={id:e.id,effectType:e.effectType,x:e.x,y:e.y,radius:e.explosionRadius};switch(e.effectType){case"flash":!function(e){const{x:t,y:a,explosionRadius:o,stunDuration:n,playerStunDuration:i}=e,r=Math.max(.1,n);if(He.health>0){const e=He.x-t,n=He.y+.55*He.height-a;Math.hypot(e,n)<=o&&(He.flashTimer=Math.max(He.flashTimer,.6*r),He.shakeTimer=Math.max(He.shakeTimer,.5*r),He.shakeMagnitude=Math.max(He.shakeMagnitude,14))}for(const e of Ne){if(e.health<=0)continue;const n=e.x-t,i=e.y+.5*e.height-a;Math.hypot(n,i)<=o&&(e.stunTimer=Math.max(e.stunTimer??0,r),e.flashTimer=Math.max(e.flashTimer,.7*r),e.shakeTimer=Math.max(e.shakeTimer,.4*r),e.shakeMagnitude=Math.max(e.shakeMagnitude,12))}if(i>0&&Ee.health>0){const e=Ie(Ee.currentPose??{headRadius:16,bodyLength:34,legLength:36}),n=Ee.y+.6*e,r=Ee.x-t,s=n-a;Math.hypot(r,s)<=o&&(Ee.flashBlindTimer=Math.max(Ee.flashBlindTimer??0,i),Ee.stunTimer=Math.max(Ee.stunTimer??0,.6*i))}}(e),t.radius=e.explosionRadius,t.stunDuration=e.stunDuration,t.playerStunDuration=e.playerStunDuration,lo("throwable:flash-burst",{...t,stunDuration:e.stunDuration,playerStunDuration:e.playerStunDuration});break;case"smoke":{const a=function(e){const t=Math.max(.5,e.smokeDuration),a=Math.max(40,e.smokeRadius),o={id:`smoke-${Date.now()}-${Math.random().toString(36).slice(2,5)}`,x:e.x,y:e.y,radius:a,baseRadius:a,maxRadius:a*(e.smokeExpansion??1.1),duration:t,life:t,slowMultiplier:qt(e.smokeSlowMultiplier??.55,.1,1),tick:e.smokeTickDuration??.5,tickTimer:0};return so.push(o),lo("throwable:smoke-spawn",{id:o.id,x:o.x,y:o.y,radius:o.radius,maxRadius:o.maxRadius,duration:o.duration}),o}(e);t.radius=a.maxRadius,t.duration=a.duration,t.cloudId=a.id,lo("throwable:smoke-detonate",{...t,radius:a.maxRadius,duration:a.duration,cloudId:a.id});break}default:(function(e){const{x:t,y:a,explosionRadius:o,damage:n,knockback:i}=e;Pa({x:t,y:a,radius:o,maxDamage:n,maxKnockback:i,minDamageRatio:e.damageFalloff??.3,selfDamageScale:e.selfDamageScale??1,selfKnockbackScale:e.selfKnockbackScale??1}),n>0&&Oa({x:t,y:a,radius:o,maxDamage:n,minDamageRatio:e.destructibleFalloff??.35,cause:e.effectType??"explosion"}),function(e={}){const t=e.x??0,a=e.y??0,o=e.count??14,n=(e.radius,e.speed??260),i=e.palette??["#ffdd9a","#f7a24a","#b55628","#5b4340"];for(let r=0;r<o;r+=1){const o=Math.random()*Math.PI*2,s=n*(.45+.65*Math.random()),l=.6*(Math.random()-.5);wa.push({type:"debris",x:t+Math.cos(o)*(e.offsetRadius??0),y:a+Math.sin(o)*(e.offsetRadius??0),vx:Math.cos(o+l)*s,vy:Math.sin(o+l)*s*.7-60,ttl:.4+.3*Math.random(),maxTtl:.4+.3*Math.random(),radius:3+4*Math.random(),color:i[r%i.length]})}}({x:t,y:a,radius:o,count:Math.max(10,Math.round(o/10)),speed:220+.5*Math.max(0,i??0)})})(e),t.damage=e.damage,t.knockback=e.knockback,lo("throwable:explosion",{...t,damage:e.damage,knockback:e.knockback})}lo("throwable:detonate",t)}const fo={ammo:{id:"ammo",label:"Ammo Cache",description:"Refills magazines and reserves for all weapons.",weight:.45,crateColor:"#4d7cff",glowColor:"#b5c8ff",materialsReward:20},medkit:{id:"medkit",label:"Field Medkit",description:"Restores health and grants brief damage resistance.",weight:.35,crateColor:"#ff6f6f",glowColor:"#ffb4b4",materialsReward:25},heavy:{id:"heavy",label:"Heavy Arsenal",description:"Drops a powerful heavy weapon with fresh ammo.",weight:.2,crateColor:"#ffb347",glowColor:"#ffe0a3",weaponId:"thunderCannon",materialsReward:35,weaponId:"thunderCannon"}},ho=[],uo={nextDropTimer:18,nextDropTypeId:go(),incomingMessage:null,incomingTimer:0,incomingDuration:3,rewardMessage:null,rewardTimer:0,rewardDuration:3.5,dropSequence:0};function go(){const e=Object.values(fo);if(0===e.length)return null;const t=e.reduce((e,t)=>e+(t.weight??1),0);let a=Math.random()*t;for(const t of e){const e=t.weight??1;if(a<=e)return t.id;a-=e}return e[e.length-1].id}function mo(e){switch(e){case"medkit":Ee.health=Math.min(Ee.maxHealth,Ee.health+70),Ee.invulnerability=Math.max(Ee.invulnerability,.4),uo.rewardMessage="Health restored";break;case"heavy":(function(){const e=fo.heavy,t=e?.weaponId??null;t&&ve[t]&&(function(e,{autoEquip:t=!1}={}){if(!e||!ve[e])return!1;let a=je.inventory.indexOf(e);-1===a&&(je.inventory.push(e),a=je.inventory.length-1),t?Ye(a):Xe()}(t,{autoEquip:!0}),Ge(t),Ue(t))})(),uo.rewardMessage="Heavy weapon acquired";break;default:!function(){const e=ze();for(const t of e){const e=Ge(t);e&&e.capacity!==Number.POSITIVE_INFINITY&&Ue(t)}Ee.reloading=!1}(),uo.rewardMessage="Ammo resupply"}uo.rewardTimer=uo.rewardDuration;const t=fo[e];if(t?.materialsReward){const e=Math.max(0,Math.round(.7*t.materialsReward));e>0&&(ne(e),uo.rewardMessage=`${uo.rewardMessage} (+${e} materials)`)}}function yo(e,t){const a=Ee.x,o=Ee.currentPose??POSES.standing,n=Ee.y+Ie(o),i=a-e.x,r=n-(e.y+.5*e.height);return Math.hypot(i,r)<=68?(e.highlight=qt(e.highlight+4*t,0,1),!0):(e.highlight=qt(e.highlight-2*t,0,1),!1)}function po(e){mo(e.typeId),e.state="collected",e.despawnTimer=3.5,e.highlight=1;const t=fo[e.typeId]?.materialsReward??0;if(t>0){const a=Math.max(0,Math.round(.3*t));if(a>0){const t=Math.max(1,Math.round(a/12)),o=Math.max(1,Math.round(a/t));for(let a=0;a<t;a+=1){const t=60*(Math.random()-.5);ie({x:e.x+t,y:e.y,amount:o,vy:-160-60*Math.random()})}}}}function xo(e){uo.nextDropTimer<=0&&ho.length<3&&(function(e){const t=fo[e]??fo.ammo,a=getEnvironmentWidth(),o=Math.max(31.2,.05*a),n=(Math.max(0,a-2*o),qt(a*(.2+.6*Math.random()),o,a-o)),i={id:`supply-${uo.dropSequence+=1}`,typeId:t.id,label:t.label,description:t.description,crateColor:t.crateColor??"#4d7cff",glowColor:t.glowColor??"#9ab5ff",width:52,height:42,x:n,y:-280,vx:18*(2*Math.random()-1),vy:0,state:"descending",timer:0,highlight:0,despawnTimer:12,parachutePhase:0};ho.push(i),uo.incomingMessage=`${t.label} inbound!`,uo.incomingTimer=uo.incomingDuration}(uo.nextDropTypeId),uo.nextDropTimer=26+12*Math.random(),uo.nextDropTypeId=go()),uo.incomingTimer>0&&(uo.incomingTimer=Math.max(0,uo.incomingTimer-e)),uo.rewardTimer>0&&(uo.rewardTimer=Math.max(0,uo.rewardTimer-e));for(let t=ho.length-1;t>=0;t-=1){const a=ho[t];if(a.timer+=e,"descending"===a.state){a.vy=Math.min(180,a.vy+140*e),a.y+=a.vy*e;const t=getEnvironmentWidth();a.x=qt(a.x+a.vx*e,.5*a.width,t-.5*a.width),a.parachutePhase+=e,a.y>=w-a.height&&(a.y=w-a.height,a.vy=0,a.state="ready",a.timer=0)}else if("ready"===a.state){if(yo(a,e))po(a);else if(a.despawnTimer-=e,a.despawnTimer<=0){ho.splice(t,1);continue}}else if("collected"===a.state&&(a.highlight=qt(a.highlight-.6*e,0,1),a.despawnTimer-=e,a.despawnTimer<=0)){ho.splice(t,1);continue}}}function wo(e){const t="collected"===e.state?qt(e.despawnTimer/3.5,0,1):1;if(x.save(),x.globalAlpha=t,"descending"===e.state){const t=1.8*e.width,a=.9*e.height;x.fillStyle=e.glowColor,x.beginPath(),x.moveTo(e.x-.5*t,e.y+.2*a),x.quadraticCurveTo(e.x,e.y-.8*a,e.x+.5*t,e.y+.2*a),x.closePath(),x.fill(),x.strokeStyle=e.glowColor,x.lineWidth=2,x.beginPath(),x.moveTo(e.x-.3*t,e.y+.25*a),x.lineTo(e.x-.25*e.width,e.y+.1*e.height),x.moveTo(e.x+.3*t,e.y+.25*a),x.lineTo(e.x+.25*e.width,e.y+.1*e.height),x.stroke()}const a=e.glowColor,o=e.crateColor,n=e.highlight??0;x.fillStyle=o,x.fillRect(e.x-.5*e.width,e.y,e.width,e.height),x.fillStyle=a,x.fillRect(e.x-.5*e.width,e.y-.25*e.height,e.width,.25*e.height),x.strokeStyle="rgba(12, 16, 24, 0.65)",x.lineWidth=3,x.strokeRect(e.x-.5*e.width,e.y,e.width,e.height),n>0&&(x.globalAlpha=.6*n,x.fillStyle=e.glowColor,x.beginPath(),x.arc(e.x,e.y+.5*e.height,68,0,2*Math.PI),x.fill()),x.restore()}function bo(e,t){const a=e.template;if(!a)return;const o=e.shakeMagnitude??0,n=e.shakeTimer??0,i=8*t+.05*e.x,r=n>0?Math.sin(i)*o*.35:0,s=n>0?Math.cos(.75*i)*o*.22:0;if(x.save(),x.translate(e.x+r,e.y+s),e.destroyed&&function(e,t,a){const o=e.width,n=Math.max(8,(t.rubbleHeight??32)*a),i=t.debrisColor??t.bodyColor??"#4a4a4a";x.fillStyle=i,x.beginPath(),x.moveTo(-o/2,0),x.lineTo(.35*-o,.3*-n),x.lineTo(.12*-o,-n),x.lineTo(.08*o,.65*-n),x.lineTo(.32*o,.9*-n),x.lineTo(o/2,0),x.closePath(),x.fill(),x.fillStyle="rgba(30, 32, 40, 0.6)",x.fillRect(-o/2,0,o,Math.max(6,.2*n))}(e,a,qt(e.rubbleLevel??0,0,1)),!e.destroyed||(e.rubbleLevel??0)<1)switch(a.material){case"vehicle":!function(e,t){const a=e.width,o=e.height,n=-o,i=e.facing??1,r=qt(1-e.health/e.maxHealth,0,1);x.save(),x.scale(i,1);const s=t.bodyColor??"#b13d30",l=t.glassColor??"#4ac3ff",c=t.accentColor??"#f7f9ff",d=t.edgeColor??"#1c1d25",f=n+.15*o,h=.55*o,u=Math.max(12,.18*o);x.fillStyle=s,x.beginPath(),x.moveTo(-a/2,f+.1*o),x.lineTo(.42*-a,n+.45*h),x.lineTo(.25*-a,n),x.lineTo(.22*a,n),x.lineTo(.45*a,n+.5*h),x.lineTo(a/2,f+.1*o),x.closePath(),x.fill(),x.fillStyle=l;const g=.55*h;x.fillRect(.28*-a,n+.12*h,.42*a,g),x.fillStyle=c,x.fillRect(-a/2,f+.55*h,a,.2*o),x.fillStyle=d,x.beginPath(),x.arc(.28*-a,-.15*u,u,0,2*Math.PI),x.arc(.28*a,-.15*u,u,0,2*Math.PI),x.fill(),!e.destroyed&&r>.05&&(x.strokeStyle="rgba(0, 0, 0, 0.35)",x.lineWidth=2,x.beginPath(),x.moveTo(.12*-a,n+.8*h),x.lineTo(.22*-a,f+.55*o),x.lineTo(.05*-a,f+.7*o),x.stroke(),x.beginPath(),x.moveTo(.18*a,n+.6*h),x.lineTo(.3*a,f+.4*o),x.lineTo(.12*a,f+.65*o),x.stroke()),x.restore()}(e,a);break;case"volatile":!function(e,t,a){const o=e.width,n=e.height,i=qt(1-e.health/e.maxHealth,0,1),r=.22*o,s=.48*n,l=-n,c=t.bodyColor??"#c0671c",d=t.stripeColor??t.accentColor??"#ffd45f",f=t.edgeColor??"#2f1a08",h=[{x:.22*-o,y:l+.45*n},{x:.22*o,y:l+.5*n},{x:0,y:l+.1*n}],u=e.destroyed?1:3;for(let e=0;e<u;e+=1){const t=h[e];x.save(),x.translate(t.x,t.y),x.fillStyle=c,x.beginPath(),x.ellipse(0,0,r,.5*s,0,0,2*Math.PI),x.fill(),x.fillRect(-r,.5*-s,2*r,s),x.fillStyle=d,x.fillRect(-r,.12*-s,2*r,.24*s),x.strokeStyle=f,x.lineWidth=3,x.strokeRect(-r,.5*-s,2*r,s),x.restore()}if(!e.destroyed&&i>.2){const t=.2+.3*Math.abs(Math.sin(8*a+.05*e.x))*i;x.fillStyle=`rgba(255, 174, 72, ${t.toFixed(3)})`,x.beginPath(),x.ellipse(0,l+.1*n,.12*o,.18*n,0,0,2*Math.PI),x.fill()}}(e,a,t);break;default:!function(e,t,a){const o=e.width,n=e.height,i=-n,r=t.bodyColor??"#555",s=t.accentColor??"#888",l=t.edgeColor??"#333",c=t.damageHighlight??"#d5dde8",d=qt(1-e.health/e.maxHealth,0,1);if(x.fillStyle=r,x.fillRect(-o/2,i,o,n),x.fillStyle=s,x.fillRect(-o/2,i,o,Math.max(10,.12*n)),x.fillRect(-o/2,i+.55*n,o,Math.max(8,.1*n)),x.strokeStyle=l,x.lineWidth=4,x.strokeRect(-o/2,i,o,n),d>0){const t=3+Math.floor(3*d),r=3*a+.02*e.x;x.strokeStyle=c,x.lineWidth=2;for(let e=0;e<t;e+=1){const a=.45*-o+o*((e+1)/(t+1)),s=n*(.2+.5*d),l=12*Math.sin(r+1.7*e);x.beginPath(),x.moveTo(a,i+.18*n),x.lineTo(a+.3*l,i+.18*n+.45*s),x.lineTo(a+l,i+.18*n+s),x.stroke()}}}(e,a,t)}if(!e.destroyed&&e.maxHealth>0){const t=qt(e.health/e.maxHealth,0,1);t<.95&&function(e,t,a){const o=qt(t,0,1),n=.85*e;x.fillStyle="rgba(0, 0, 0, 0.45)",x.fillRect(-n/2,a,n,5),x.fillStyle=o>.5?"#58ec8c":o>.25?"#ffd15c":"#ff675c",x.fillRect(-n/2,a,n*o,5)}(e.width,t,-e.height-10)}const l=e.flashTimer??0;if(l>0){const t=.45*qt(l/.2,0,1);x.fillStyle=`rgba(255, 255, 255, ${t.toFixed(3)})`,x.fillRect(-e.width/2,-e.height,e.width,e.height)}!function(e,t,a){if((e.smokeTimer??0)<=0)return;const o=t.smokeDuration??1.5,n=qt((e.smokeTimer??0)/o,0,1),i=.25+.35*n;for(let t=0;t<4;t+=1){const o=a*(.4+.15*t)+.03*e.x+1.3*t,r=.35*e.width*(1+.6*n+.15*t);x.globalAlpha=qt(i-.06*t,0,.45),x.fillStyle="#9fb6c8",x.beginPath(),x.arc(Math.sin(o)*e.width*.12,-e.height*(.65+.2*t)-6*Math.cos(.6*o),.3*r,0,2*Math.PI),x.fill()}x.globalAlpha=1}(e,a,t),x.restore()}function vo(){const e=Xa(),t=ja(e.blueprintIndex);if(!t)return e.lastPreview.valid=!1,e.lastPreview;const a=(t.width??120)/2,o=(n=Ee.x+Ee.facing*Math.max(140,a+30),20*Math.round(n/20));var n;const i=de(),r=Math.max(a+30,Math.min(i-a-30,o)),s=function(e,t){let a=w;const o=fe();for(const n of o){const o=n.x-t,i=n.x+n.width+t;e>=o&&e<=i&&n.y<a&&(a=n.y)}return a}(r,a),l=t.cost??0;return e.lastPreview={x:r,y:s,width:t.width,height:t.height,blueprintId:t.id,cost:l,color:t.color,accentColor:t.accentColor,strokeColor:t.strokeColor,ambient:t.ambient??null,valid:oe()>=l},e.lastPreview}function ko(){const e=Xa(),t=vo();if(!t.valid)return!1;const a=ja(e.blueprintIndex);if(!a)return!1;if(!function(e){const t=Math.round(e??0);return t<=0||!!function(e){return te.materials>=(e??0)}(t)&&(te.materials-=t,!0)}(a.cost??0))return e.lastPreview.valid=!1,!1;const o=function(e,t){return{id:`${e.id}-${Date.now().toString(36)}-${Math.floor(1e3*Math.random())}`,type:e.id,x:t.x,y:t.y,width:e.width,height:e.height,health:e.maxHealth,maxHealth:e.maxHealth,color:e.color,accentColor:e.accentColor,strokeColor:e.strokeColor,ambient:e.ambient??null,blocking:e.blocking??!1,turret:e.turret??null,shield:e.shield??null,trap:e.trap??null,fireCooldown:0,trapCooldown:0,flashTimer:0}}(a,t);return function(e){Ha.push(e)}(o),ka({x:o.x,y:o.y-(o.height??80),startRadius:20,endRadius:Math.max(90,o.width??120),color:a.accentColor??"#8cffd4",ttl:.35}),!0}function So(e){const t=Xa();t.active="boolean"==typeof e?e:!t.active,t.active?vo():t.lastPreview.valid=!1}function To(e,t){!e||t<=0||(e.health=Math.max(0,e.health-t),e.flashTimer=.25)}function Co(e,t,a){ka({x:a.x,y:a.y-(a.height??80),startRadius:30,endRadius:Math.max(120,1.4*(a.width??120)),color:a.accentColor??"#ffb347",ttl:.4}),e.splice(t,1);const o=Math.max(5,Math.round((a.maxHealth??200)/15));ie({x:a.x,y:a.y-(a.height??80),amount:o,vy:-150})}function Mo(e,t){const a=e.turret;if(!a)return;if(e.fireCooldown=Math.max(0,(e.fireCooldown??0)-t),e.fireCooldown>0)return;let o=null,n=Number.POSITIVE_INFINITY;const i=e.y-(e.height??100)+24;for(const t of Ne){if(t.health<=0)continue;const r=t.x-e.x,s=t.y+.5*t.height-i,l=Math.hypot(r,s);l>(a.range??420)||l<n&&(n=l,o=t)}if(!o)return;const r=o.x-e.x,s=o.y+.5*o.height-i,l=Math.max(1,Math.hypot(r,s)),c=a.projectile?.speed??520,d=r/l*c,f=s/l*c;no({x:e.x,y:i,vx:d,vy:f,radius:a.projectile?.radius??6,lifetime:1.4,damage:a.projectile?.damage??18,color:a.projectile?.color??"#ffd57a",facing:Math.sign(r)||1,gravityFactor:.05}),e.fireCooldown=a.cooldown??1.2}function Io(e,t){const a=e.shield;if(!a)return;const o=a.radius??220,n=e.y-.6*(e.height??100),i=[Ee,...Le];for(const t of i){if(!t||t.health<=0)continue;const i=t.x-e.x,r=t.y+t.height-n;Math.hypot(i,r)<=o&&(t.structureShieldTimer=Math.max(t.structureShieldTimer??0,a.buffDuration??.6),t.structureShieldStrength=Math.max(t.structureShieldStrength??0,a.damageReduction??.4))}}function Ao(e,t){const a=e.trap;if(!a)return;if(e.trapCooldown=Math.max(0,(e.trapCooldown??0)-t),e.trapCooldown>0)return;const o=a.radius??140,n=e.y-.5*(e.height??24);let i=!1;for(const t of Ne){if(t.health<=0)continue;const r=t.x-e.x,s=t.y+.5*t.height-n;Math.hypot(r,s)<=o&&(ga(t,{damage:a.damage??24,knockback:160,launch:0,facing:Math.sign(r)||1}),t.stunTimer=Math.max(t.stunTimer??0,a.stun??.6),i=!0)}i&&(e.trapCooldown=a.cooldown??2.6,Qa({type:"point",x:e.x,y:n,radius:1.2*o,intensity:1.4,color:a.color??"#9af0ff",ttl:.25,flicker:.5,decay:1.2}),ka({x:e.x,y:n,startRadius:.6*o,endRadius:1.3*o,color:a.color??"#9af0ff",ttl:.3,lineWidth:5}))}function Po(e,t){const a=(e.width??120)/2,o=e.y-(e.height??80);for(const n of Ne){if(n.health<=0)continue;const i=Math.abs(n.x-e.x)-(a+n.radius-6),r=n.y+n.height-o;i<=0&&r>-40&&(To(e,(n.attackDamage??12)*t),n.vx*=.2,n.stateTimer=Math.max(n.stateTimer??0,.2))}}function Do(e){!function(){const e=Xa();if(xe.buildToggleBuffered&&(So(),xe.buildToggleBuffered=!1),!e.active)return xe.buildCycleBuffered=0,xe.buildConfirmBuffered=!1,void(xe.buildCancelBuffered=!1);0!==xe.buildCycleBuffered&&(function(e){const t=Xa();t.blueprintIndex=function(e){const t=Na();return 0===t.length?0:(e%t.length+t.length)%t.length}(t.blueprintIndex+e)}(xe.buildCycleBuffered),xe.buildCycleBuffered=0,vo()),xe.buildCancelBuffered&&(So(!1),xe.buildCancelBuffered=!1),(xe.buildConfirmBuffered||xe.attackBuffered)&&(ko()?(xe.buildConfirmBuffered=!1,xe.attackBuffered=!1,xe.attackDown=!1,vo()):(xe.buildConfirmBuffered=!1,xe.attackBuffered=!1))}(),function(e){const t=za();for(let a=t.length-1;a>=0;a-=1){const o=t[a];o.flashTimer=Math.max(0,(o.flashTimer??0)-e),Po(o,e),Mo(o,e),Io(o),Ao(o,e),o.health<=0&&Co(t,a,o)}}(e),Xa().active&&vo()}Ya();function Ro(e){const t=_t();if(xe.survivalToggleBuffered&&(xe.survivalToggleBuffered=!1,t.active||(function(){for(let e=Ne.length-1;e>=0;e-=1)"sandbox"===Ne[e].spawnContext&&Ne.splice(e,1)}(),Kt.active=!0,Kt.wave=0,Kt.lastReward=0,Ut("countdown",6))),!t.active)return;var a;a=Math.max(0,t.timer-e),Kt.timer=Math.max(0,a??0);for(let e=Ne.length-1;e>=0;e-=1){const t=Ne[e];"survival"===t.spawnContext&&t.health<=0&&!1===t.autoRespawn&&Ne.splice(e,1)}const o=Ne.reduce((e,t)=>e+("survival"===t.spawnContext&&t.health>0?1:0),0);var n;switch(n=o,Kt.enemiesAlive=Math.max(0,Math.floor(n??0)),t.stage){case"countdown":t.timer<=0&&(Kt.wave+=1,function(e,t={}){const a=t.context??"sandbox",o=t.autoRespawn??"survival"!==a,n=function(){const e=de(),t=he(),a=Array.isArray(t?.enemies)?t.enemies.slice(0,2):[];return a.length>=2?a:[.25*e,.75*e]}(),i=Math.min(n.length,2);let r=0;for(let t=0;t<n.length&&!(r>=e||Ne.length>=2);t+=1){if("survival"===a){const e=Ne.some(e=>"survival"===e.spawnContext&&e.spawnSide===t&&e.health>0);if(e)continue}const e=n[t],s=Ae(e,{context:a,autoRespawn:o,spawnSide:t,facing:0===t?1:-1});if(s.spawnX=e,s.spawnY=s.y,s.respawnTimer=0,Ne.push(s),r+=1,r>=i)break}}(2+0*(t.wave-1),{context:"survival"}),Ut("wave",0));break;case"wave":if(0===o){const e=25+8*(t.wave-1);e>0?(ne(e),Vt(e)):Vt(0),Ut("rest",12)}break;case"rest":t.timer<=0&&Ut("countdown",6)}}const Bo={pushCrate:{category:"movable",width:96,height:72,mass:3.2,friction:3.6,maxSpeed:160,pushImpulse:360,hitImpulse:520,bodyColor:"#8b6f4a",edgeColor:"#4a3b28",braceColor:"#c59b61",highlightColor:"#ffd89a"},kickBarrel:{category:"rolling",radius:30,height:78,mass:1.1,friction:1.8,maxSpeed:320,pushImpulse:280,hitImpulse:680,bodyColor:"#a33b32",stripeColor:"#ffd45f",edgeColor:"#3a1c18",topColor:"#c95b4f"},shockTrap:{category:"trap",width:110,height:20,damage:24,knockback:90,launch:-160,cooldown:2.8,stunDuration:.75,bodyColor:"#2a374b",accentColor:"#6ddcff",glowColor:"#8cf7ff"}};function Eo(){return function(){const e=ce();return Array.isArray(e?.interactables)?e.interactables:[]}().map(e=>function(e){const t=Bo[e.type];if(!t)throw new Error(`Unknown interactable template: ${e.type}`);const a=e.templateOverrides??{},o={...t,...a},n=e.width??o.width??(o.radius?2*o.radius:64),i=e.height??o.height??48,r=e.radius??o.radius??.5*Math.max(n,i),s={id:e.id,type:e.type,template:o,x:e.x,y:e.baseY,vx:0,vy:0,width:n,height:i,radius:r,state:o.initialState??"idle",timer:0,cooldown:0,highlight:0,triggered:!1,flashTimer:0,smokeTimer:0,mass:o.mass??1,friction:o.friction??2,maxSpeed:o.maxSpeed??240,pushImpulse:o.pushImpulse??240,hitImpulse:o.hitImpulse??o.pushImpulse??320,facing:e.facing??1,minX:e.minX??null,maxX:e.maxX??null};return e.overrides&&"object"==typeof e.overrides&&Object.assign(s,e.overrides),s}(e))}const Oo=Eo();function Lo(e,t){const a=e.template??{};switch(a.category){case"movable":!function(e,t,a){const o=(e.width??96)/2,n=e.height??72,i=(e.y,Math.sin(4*a+.02*e.x)*(e.vx??0)*.002);x.save(),x.translate(e.x,e.y),x.rotate(i),x.fillStyle=t.bodyColor??"#8b6f4a",x.fillRect(-o,-n,2*o,n),x.strokeStyle=t.edgeColor??"#4a3b28",x.lineWidth=4,x.strokeRect(-o,-n,2*o,n),x.strokeStyle=t.braceColor??"#c59b61",x.lineWidth=3;const r=.4*o;x.beginPath(),x.moveTo(-o,8-n),x.lineTo(-r,.4*n-n),x.moveTo(o,8-n),x.lineTo(r,.4*n-n),x.moveTo(-o,.55*n-n),x.lineTo(-r,-8),x.moveTo(o,.55*n-n),x.lineTo(r,-8),x.stroke(),x.restore()}(e,a,t);break;case"rolling":!function(e,t,a){const o=e.radius??30,n=e.height??2.2*o,i=e.y-n,r=Math.sin(6*a+.05*e.x)*(e.vx??0)*.003;x.save(),x.translate(e.x,i+n/2),x.rotate(r),x.fillStyle=t.bodyColor??"#a33b32",x.beginPath(),x.ellipse(0,0,o,.5*n,0,0,2*Math.PI),x.fill(),x.fillStyle=t.topColor??"#c95b4f",x.beginPath(),x.ellipse(0,.5*-n,.95*o,.55*o,0,0,2*Math.PI),x.fill(),x.fillStyle=t.edgeColor??"#3a1c18",x.beginPath(),x.ellipse(0,.5*n,.95*o,.55*o,0,0,2*Math.PI),x.fill(),x.strokeStyle=t.stripeColor??"#ffd45f",x.lineWidth=5,x.beginPath(),x.moveTo(.85*-o,.25*-n),x.lineTo(.85*o,.1*-n),x.moveTo(.85*-o,.05*n),x.lineTo(.85*o,.2*n),x.stroke(),x.restore()}(e,a,t);break;case"trap":!function(e,t,a){const o=(e.width??110)/2,n=e.height??20,i=e.y-n,r=t.glowColor??"#8cf7ff",s=t.accentColor??"#6ddcff",l=t.bodyColor??"#2a374b",c=.15*Math.sin(5*a+.04*e.x)+.35+(e.cooldown>0?.1:.35);x.save(),x.translate(e.x,0),x.fillStyle=l,x.fillRect(-o,i,2*o,n),x.fillStyle=s,x.fillRect(.9*-o,i+.25*n,1.8*o,.35*n),x.globalAlpha=qt(c,0,1),x.fillStyle=r,x.fillRect(-o,i-6,2*o,.2*n),x.fillRect(-o,i+n-4,2*o,.2*n),x.globalAlpha=1,x.restore()}(e,a,t)}const o=e.flashTimer??0;if(o>0){const t=.4*qt(o/.2,0,1),a=e.width?e.width/2:e.radius,n=e.height??1.4*a;x.save(),x.fillStyle=`rgba(255, 255, 255, ${t.toFixed(3)})`,x.translate(e.x,e.y),x.fillRect(-a,-n,2*a,n),x.restore()}const n=qt(e.highlight??0,0,1);if(n>.01){const t=a.highlightColor??a.accentColor??"#ffd89a",o=e.width?e.width/2:e.radius,i=e.height??1.4*o;x.save(),x.globalAlpha=.45*n,x.fillStyle=t,x.translate(e.x,e.y),x.fillRect(1.15*-o,1.05*-i,2.3*o,1.3*i),x.restore()}}ue(()=>{!function(){Oo.length=0;const e=Eo();for(const t of e)Oo.push(t)}()});const $o=[],Wo=[],Ho=[],Fo=[],No=[],jo={weapons:!0,shield:!0,throwables:!0},Yo={Digit6:"weapons",Digit7:"shield",Digit8:"throwables"};function zo(e,t=1.8){const a=Fo[Fo.length-1];if(a&&a.message===e)return a.ttl=t,a.maxTtl=t,void(a.age=0);for(Fo.push({message:e,ttl:t,maxTtl:t,age:0});Fo.length>6;)Fo.shift()}function Xo(e,t={},a=.4){const o={type:e,x:t.x??Ee.x,y:t.y??Ee.y,radius:t.radius??110,ttl:a,maxTtl:a};return Ho.push(o),o}function qo(e){return!1!==jo[e]}function Go(e){if(!e.altKey||e.repeat)return;const t=Yo[e.code];t&&("function"==typeof e.preventDefault&&e.preventDefault(),function(e){jo[e]=!jo[e],zo(`Debug filter ${e.charAt(0).toUpperCase()+e.slice(1)} ${jo[e]?"ON":"OFF"}`,1.4),jo[e]||("weapons"===e?($o.length=0,No.length=0):"shield"===e?Wo.length=0:"throwables"===e&&(Ho.length=0))}(t))}function Jo(e){if(!qo("weapons"))return;const t=e?.detail??{};$o.push({weaponId:t.weaponId??"unknown",x:t.x??Ee.x,y:t.y??Ee.y,facing:t.facing??Ee.facing??1,ttl:.12,maxTtl:.12})}function Ko(e){if(!qo("weapons"))return;const t=.4,a=(e?.detail??{}).weaponId??"unknown",o=No.find(e=>e.weaponId===a);if(o)return o.ttl=t,o.maxTtl=t,void(o.age=0);for(No.push({weaponId:a,ttl:t,maxTtl:t,age:0});No.length>5;)No.shift()}function Uo(e){qo("weapons")&&zo(`Reloading ${e?.detail?.weaponId??"unknown"}`)}function Vo(e){qo("weapons")&&zo(`Reload complete ${e?.detail?.weaponId??"unknown"}`,1.4)}function _o(e){if(!qo("weapons"))return;const t=e?.detail??{},a=t.weaponId??"unknown",o=t.recoil?.horizontal??0,n=t.recoil?.vertical??0,i=Math.hypot(o,n);i<=0||zo(`Recoil ${a}: ${i.toFixed(2)}`,1.2)}function Qo(e){const t=e?.detail?.environment,a=t?.name??t?.id;a&&zo(`Environment set to ${a}`,2.2)}function Zo(e){if(!qo("shield"))return;const t=e?.detail??{},a={x:t.center?.x??Ee.x,y:t.center?.y??Ee.y};Wo.push({type:"hit",absorb:t.absorb??0,center:a,ttl:.28,maxTtl:.28}),void 0!==t.absorb&&zo(`Shield absorb ${Math.round(t.absorb)}`,1.2)}function en(e){if(!qo("shield"))return;const t=e?.detail??{},a={x:t.center?.x??Ee.x,y:t.center?.y??Ee.y};Wo.push({type:"shatter",center:a,ttl:.45,maxTtl:.45}),zo(`Shield ${t.reason??"shatter"}`,1.6)}function tn(e){if(!qo("shield"))return;const t=e?.detail?.reason??"ended";"shatter"!==t&&zo(`Shield ${t}`,1.4)}function an(e){qo("throwables")&&zo(`Throwable thrown (${(e?.detail??{}).effectType??"unknown"})`,1.4)}function on(e){if(!qo("throwables"))return;const t=e?.detail??{};Xo("explosion",t,.55),void 0!==t.damage?zo(`Explosion damage ${t.damage}`,1.6):zo("Explosion triggered",1.4)}function nn(e){if(!qo("throwables"))return;const t=e?.detail??{};Xo("flash",t,.45);const a=t.stunDuration??0;zo(`Flash burst (stun ${"number"==typeof a?a.toFixed(1):String(a)}s)`,1.6)}function rn(e){if(!qo("throwables"))return;const t=e?.detail??{},a=Xo("smoke",t,.6);a.maxRadius=t.radius??a.radius,zo(`Smoke deployed (${Math.round(10*((t.duration??0)+Number.EPSILON))/10}s)`,1.6)}function sn(e){qo("throwables")&&(Xo("smoke-fade",e?.detail??{},.4),zo("Smoke dissipated",1.4))}let ln=!1;function cn(){ln||"undefined"==typeof window||(window.addEventListener("weapon:muzzle-flash",Jo),window.addEventListener("weapon:shot-fired",Ko),window.addEventListener("weapon:reload-start",Uo),window.addEventListener("weapon:reload-finish",Vo),window.addEventListener("weapon:recoil-kick",_o),window.addEventListener("shield:hit",Zo),window.addEventListener("shield:shatter",en),window.addEventListener("shield:end",tn),window.addEventListener("throwable:thrown",an),window.addEventListener("throwable:explosion",on),window.addEventListener("throwable:flash-burst",nn),window.addEventListener("throwable:smoke-detonate",rn),window.addEventListener("throwable:smoke-dissipate",sn),window.addEventListener("environment:changed",Qo),window.addEventListener("keydown",Go),ln=!0)}function dn(e,t){for(let a=e.length-1;a>=0;a-=1){const o=e[a];o.ttl-=t,o.age=(o.age??0)+t,o.ttl<=0&&e.splice(a,1)}}function fn(){return cn(),{muzzleFlashes:$o,shieldBursts:Wo,throwableBursts:Ho,notices:Fo,shotIndicators:No,filters:{...jo}}}const hn={horizontalKick:0,verticalKick:0,decay:12,lastShotTime:0};function un(e,t,a){const o=t+a,n=fe();for(const t of n){if(e.vy<0)continue;const n=e.y+a;if(o<=t.y&&n>=t.y&&e.x>=t.x&&e.x<=t.x+t.width)return e.y=t.y-a,e.vy=0,Object.prototype.hasOwnProperty.call(e,"onGround")&&(e.onGround=!0),!0}return!1}const gn={street:{fill:"#2c2f36",stroke:"#1b1d22"},metro:{fill:"#3d4252",stroke:"#272b37"},rooftop:{fill:"#4c5566",stroke:"#2f3541"},skybridge:{fill:"#596274",stroke:"#323846"},terrace:{fill:"#46505f",stroke:"#2a303b"},balcony:{fill:"#525a6a",stroke:"#2f3540"},median:{fill:"#3a404a",stroke:"#23272f"},jungleFloor:{fill:"#314629",stroke:"#1c2917"},stone:{fill:"#4c5f4c",stroke:"#2a3628"},canopy:{fill:"#3f5e3a",stroke:"#23361f"},branch:{fill:"#594427",stroke:"#2e2010"},sand:{fill:"#cfa665",stroke:"#8a6a3a"},cliff:{fill:"#8b6b42",stroke:"#5b4426"},plateau:{fill:"#b78b4f",stroke:"#7f6032"},deck:{fill:"#303a4c",stroke:"#1d2431"},catwalk:{fill:"#3c4a63",stroke:"#212a39"},maglev:{fill:"#2a315a",stroke:"#181d33"},plain:{fill:"#36404c",stroke:"#222730"}};function mn(e){const t=gn[e.type]??gn.plain;x.fillStyle=t.fill,x.fillRect(e.x,e.y,e.width,e.height),x.strokeStyle=t.stroke,x.lineWidth=2,x.strokeRect(e.x,e.y,e.width,e.height)}function yn(e){x.save(),x.fillStyle="#2a3240",x.fillRect(e.x,e.y,e.width,e.height),x.fillStyle="#4a6076";const t=Math.max(3,Math.floor(e.height/60));for(let a=0;a<t;a+=1){const o=e.y+20+a*(e.height/t);x.fillRect(e.x+10,o,e.width-20,8)}x.restore()}function pn(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w,o=e.height??220;x.save(),x.translate(t,a),x.strokeStyle="#3c2d1b",x.lineWidth=8,x.beginPath(),x.moveTo(0,0),x.lineTo(0,-o),x.stroke(),x.lineWidth=6,x.beginPath(),x.moveTo(0,-o),x.quadraticCurveTo(18,24-o,32,58-o),x.moveTo(0,-o),x.quadraticCurveTo(-18,24-o,-32,58-o),x.stroke(),x.fillStyle="#3f8f4a";for(let e=-2;e<=2;e+=1)x.beginPath(),x.ellipse(12*e,40-o,40,16,Math.PI/8*e,0,2*Math.PI),x.fill();x.restore()}function xn(e){x.save(),x.fillStyle="#484f3d",x.fillRect(e.x,e.y,e.width,e.height),x.fillStyle="#2f3526";const t=Math.max(2,Math.floor(e.height/40));for(let a=0;a<t;a+=1){const o=e.y+a*(e.height/t);x.fillRect(e.x+4,o+6,e.width-8,6)}x.strokeStyle="#9db27e",x.lineWidth=3,x.setLineDash([6,10]),x.strokeRect(e.x+6,e.y+6,e.width-12,e.height-12),x.setLineDash([]),x.restore()}function wn(e){x.save(),x.strokeStyle="#3a5c35",x.lineWidth=10;const t=e.x,a=e.y,o=e.width??180,n=e.height??120;x.beginPath(),x.arc(t,a,o/2,Math.PI,0,!1),x.stroke(),x.lineWidth=4,x.strokeStyle="#5f8d4a",x.beginPath(),x.arc(t,a,o/2-10,Math.PI,0,!1),x.stroke(),x.fillStyle="#7fcf6a";for(let e=-3;e<=3;e+=1)x.beginPath(),x.ellipse(t+18*e,a-.4*n,12,20,Math.PI/6,0,2*Math.PI),x.fill();x.restore()}function bn(e){const t=e.x,a=e.y;x.save();const o=x.createRadialGradient(t,a,0,t,a,26);o.addColorStop(0,"rgba(120, 255, 191, 0.8)"),o.addColorStop(1,"rgba(120, 255, 191, 0)"),x.fillStyle=o,x.beginPath(),x.arc(t,a,26,0,2*Math.PI),x.fill(),x.fillStyle="#63ffbd",x.beginPath(),x.arc(t,a,8,0,2*Math.PI),x.fill(),x.restore()}function vn(e){const t=e.width??80,a=e.height??200,o=e.x-t/2,n=e.y-a,i=x.createLinearGradient(o,n,o,n+a);i.addColorStop(0,"rgba(110, 216, 255, 0.5)"),i.addColorStop(1,"rgba(110, 216, 255, 0.1)"),x.fillStyle=i,x.fillRect(o,n,t,a),x.strokeStyle="rgba(173, 245, 255, 0.6)",x.lineWidth=2;for(let e=0;e<t;e+=16)x.beginPath(),x.moveTo(o+e+4,n),x.lineTo(o+e+8,n+a),x.stroke()}function kn(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w,o=e.width??260,n=e.height??100;x.save(),x.fillStyle=e.color??"#d59c5a",x.beginPath(),x.moveTo(t-o/2,a),x.quadraticCurveTo(t,a-n,t+o/2,a),x.closePath(),x.fill(),x.fillStyle="rgba(255, 226, 170, 0.35)",x.beginPath(),x.moveTo(t-.3*o,a-.25*n),x.quadraticCurveTo(t,a-.65*n,t+.35*o,a-.28*n),x.lineTo(t+.3*o,a-.18*n),x.fill(),x.restore()}function Sn(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w,o=e.height??240;x.save(),x.fillStyle="#7d6040",x.beginPath(),x.moveTo(t-18,a),x.lineTo(t+18,a),x.lineTo(t+6,a-o),x.lineTo(t-12,a-.65*o),x.closePath(),x.fill(),x.strokeStyle="#c6a37c",x.lineWidth=3,x.beginPath(),x.moveTo(t-4,a-.3*o),x.lineTo(t+6,a-.6*o),x.stroke(),x.restore()}function Tn(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w-20;x.save(),x.strokeStyle="#5b3e24",x.lineWidth=5,x.beginPath(),x.moveTo(t-16,a+12),x.lineTo(t+12,a-4),x.moveTo(t+16,a+12),x.lineTo(t-12,a-4),x.stroke();const o=x.createRadialGradient(t,a-10,0,t,a-10,36);o.addColorStop(0,"rgba(255, 174, 72, 0.95)"),o.addColorStop(.5,"rgba(255, 116, 32, 0.6)"),o.addColorStop(1,"rgba(255, 116, 32, 0)"),x.fillStyle=o,x.beginPath(),x.arc(t,a-10,36,0,2*Math.PI),x.fill(),x.restore()}function Cn(e){const t=e.x,a=e.y,o=e.height??300;x.save(),x.strokeStyle="#b89c6d",x.lineWidth=4,x.beginPath(),x.moveTo(t,a+o),x.lineTo(t,a),x.stroke(),x.strokeStyle="#ffe6ac",x.lineWidth=2;for(let e=0;e<4;e+=1){const n=(e+1)*(o/5);x.beginPath(),x.moveTo(t-18,a+n),x.lineTo(t+18,a+n-12),x.stroke()}x.fillStyle="#ffe89a",x.beginPath(),x.arc(t,a,10,0,2*Math.PI),x.fill(),x.restore()}function Mn(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w,o=e.height??320;x.save(),x.fillStyle="#3f5ac9",x.beginPath(),x.moveTo(t-28,a),x.lineTo(t+28,a),x.lineTo(t+8,a-o),x.lineTo(t-12,a-.6*o),x.closePath(),x.fill(),x.fillStyle="rgba(120, 200, 255, 0.35)",x.beginPath(),x.moveTo(t,a-.92*o),x.lineTo(t+16,a-.4*o),x.lineTo(t-4,a-.32*o),x.closePath(),x.fill(),x.restore()}function In(e){x.save();const t=e.x-e.width/2,a=e.y-e.height,o=x.createLinearGradient(t,a,t+e.width,a+e.height);o.addColorStop(0,"rgba(85, 170, 255, 0.4)"),o.addColorStop(1,"rgba(170, 120, 255, 0.7)"),x.fillStyle=o,x.fillRect(t,a,e.width,e.height),x.strokeStyle="#8bd4ff",x.lineWidth=3,x.strokeRect(t,a,e.width,e.height),x.fillStyle="#e5f5ff",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(e.text??"HOLO",e.x,e.y-e.height/2),x.restore()}function An(e){const t=e.baseX??e.x??0,a=e.baseY??e.y??w-20,o=e.height??180;x.save(),x.strokeStyle="#3d4e88",x.lineWidth=6,x.beginPath(),x.moveTo(t-14,a),x.lineTo(t-14,a-o),x.moveTo(t+14,a),x.lineTo(t+14,a-o),x.stroke(),x.strokeStyle="#7ce7ff",x.lineWidth=3;for(let e=0;e<=o;e+=32)x.beginPath(),x.moveTo(t-14,a-e),x.quadraticCurveTo(t,a-e-12,t+14,a-e-2),x.stroke();x.fillStyle="#9ef5ff",x.beginPath(),x.arc(t,a-o-14,18,0,2*Math.PI),x.fill(),x.restore()}function Pn(e){x.save(),x.fillStyle="#5d8fff",x.beginPath(),x.ellipse(e.x,e.y,46,16,0,0,2*Math.PI),x.fill(),x.fillStyle="#1f2536",x.fillRect(e.x-26,e.y-8,52,16),x.restore()}function Dn(){return Me[Ee.squadCommandIndex%Me.length]??Me[0]}function Rn(e,t){let a=null,o=Number.POSITIVE_INFINITY;for(const n of Ne){if(n.health<=0)continue;const i=n.x-e,r=n.y+.5*n.height-t,s=Math.hypot(i,r);s<o&&(o=s,a=n)}return a}function Bn(e,t,a,o=1){const n=t-e.x;if(e.vx=0,Math.abs(n)>12){const t=Math.sign(n);e.vx=t*Se*o,e.facing=t}}function En(e,t,a){if(e.fireCooldown=Math.max(0,(e.fireCooldown??0)-a),e.fireCooldown>0)return;e.fireCooldown=.45;const o=t.x>=e.x?1:-1;no({x:e.x+24*o,y:e.y+.4*Ie(Ce.standing),vx:520*o,vy:-20,radius:5,lifetime:.8,color:o>0?"#8cffd4":"#a0ffe1",damage:12,knockback:110,facing:o}),e.flashTimer=.12}function On(e,t){const a=Dn(),o=Ie(Ce.standing);switch(e.y+o>=w-2&&Math.abs(e.vy)<1&&(e.onGround=!0),e.targetEnemyId=null,a?.id){case"attack":{const a=Rn(e.x,e.y);a&&Math.abs(a.x-Ee.x)<=640?(Bn(e,a.x-24,0,.95),En(e,a,t),e.targetEnemyId=a.id):Bn(e,Ee.x-60,0,.8);break}case"defend":{const a=40*(e.roleIndex??0)-40;Bn(e,Ee.x+a,0,.7);const o=Rn(e.x,e.y);o&&Math.abs(o.x-Ee.x)<=180&&(En(e,o,t),e.targetEnemyId=o.id);break}case"flank":{const a=220*((e.roleIndex??0)%2==0?-1:1);Bn(e,Ee.x+a,0,.9);const o=Rn(e.x,e.y);o&&(En(e,o,t),e.targetEnemyId=o.id);break}default:{const t=36*(e.roleIndex??0)-36;Bn(e,Ee.x+t,0,.6);break}}!function(e,t){e.vy+=Te*t;const a=e.y;e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1;const o=Ie(Ce.standing);un(e,a,o)||e.y+o>=w&&(e.y=w-o,e.vy=0,e.onGround=!0),e.vx=Math.max(-240,Math.min(Se,e.vx))}(e,t),e.flashTimer=Math.max(0,(e.flashTimer??0)-t)}function Ln(){return{command:Dn(),cooldown:Ee.squadCommandCooldown,members:Le}}const $n="player-stickman";function Wn(){return Ee.vehicleId?Xt(Ee.vehicleId):null}function Hn(e,t,a){if(t<=0)return;const o=t*a;e.vx>0?e.vx=Math.max(0,e.vx-o):e.vx<0&&(e.vx=Math.min(0,e.vx+o))}function Fn(e,t){const a=t.driverSeat??{x:0,y:t.height},o=Ie(Ce.standing),n=e.x+a.x,i=e.y+a.y,r=qt(n,40,de()-40);Ee.x=r,Ee.y=i-o,Ee.vx=e.vx,Ee.vy=e.vy;const s=t.movementType??"ground";Ee.onGround="air"!==s&&("water"===s||e.onGround),Ee.facing=e.facing??Ee.facing}function Nn(e,t={}){const a=Nt[e.type];if(!a)return Ee.vehicleId=null,void(Ee.controlMode="onFoot");e.driverId=null,t.skipCooldown||(e.enterCooldown=Math.max(e.enterCooldown,t.cooldown??.35));const o=Ie(Ce.standing),n=t.preferDirection??(e.facing>=0?1:-1),i=a.exitOffsets??[],r=n>=0?{x:.6*a.width,y:0}:{x:.6*-a.width,y:0},s=n>=0?i[0]??r:i[1]??r;Ee.vehicleId=null,Ee.controlMode="onFoot",Ee.vehicleCandidateId=null;const l=de();Ee.x=qt(e.x+s.x,40,l-40),Ee.y=w-o,!1===t.inheritVelocity?(Ee.vx=0,Ee.vy=0):(Ee.vx=.5*e.vx,Ee.vy=Math.min(e.vy,0)),Ee.onGround=!0,Ee.facing=n>=0?1:-1}function jn(e,t,a,o){o?function(e,t,a){const o=xe.right&&!xe.left,n=xe.left&&!xe.right,i=o?1:n?-1:0,r=t.acceleration??0,s=t.braking??600,l=t.maxSpeed??360,c=t.idleDrag??0;if(0!==i&&r>0&&(e.vx+=i*r*a),xe.down&&e.onGround&&s>0){const t=s*a;e.vx>0?e.vx=Math.max(0,e.vx-t):e.vx<0&&(e.vx=Math.min(0,e.vx+t))}else 0===i&&Hn(e,c,a);l>0&&(e.vx=qt(e.vx,-l,l)),0!==i?e.facing=i:Math.abs(e.vx)>8&&(e.facing=e.vx>0?1:-1)}(e,t,a):Hn(e,t.idleDrag??0,a);const n=t.airDrag??1;!e.onGround&&n>0&&n<1&&(e.vx*=Math.pow(n,Math.max(0,60*a))),e.vy+=Te*a,e.x+=e.vx*a,e.y+=e.vy*a;const i=w-t.height;e.y>=i?(e.y=i,e.vy=0,e.onGround=!0):e.onGround=!1;const r=.5*t.width,s=r+32,l=de()-r-32;e.x=qt(e.x,s,l),e.x!==s&&e.x!==l||(e.vx=0);const c=qt(e.vx/Math.max(1,t.maxSpeed??360)*.12,-.25,.25);e.tilt+=(c-e.tilt)*Math.min(1,10*a)}function Yn(e,t,a,o){const n=t.waterAcceleration??t.acceleration??220,i=t.waterMaxSpeed??t.maxSpeed??220,r=t.waterReverseSpeed??Math.max(80,.6*i),s=t.waterIdleDrag??t.idleDrag??200,l=t.turnDrag??220,c=t.bobAmplitude??4,d=t.bobSpeed??1.4,f=t.splashIntensity??.3,h=e.waterLineY??w-(t.waterSurfaceOffset??24),u=t.buoyancyPoint??.55,g=t.submergedOffset??0,m=o&&xe.right&&!xe.left,y=o&&xe.left&&!xe.right,p=m?1:y?-1:0;if(0!==p&&n>0?e.vx+=p*n*a:Hn(e,s,a),o&&xe.down){const t=l*a;e.vx>0?e.vx=Math.max(e.vx-t,-r):e.vx<0?e.vx=Math.min(e.vx+t,r):t>0&&(e.vx=qt(e.vx-e.facing*t*.15,-r,r))}e.vx=qt(e.vx,-r,i),0!==p?e.facing=p:Math.abs(e.vx)>4&&(e.facing=e.vx>0?1:-1),e.x+=e.vx*a;const x=.5*t.width,b=x+32,v=de()-x-32;e.x=qt(e.x,b,v),e.x!==b&&e.x!==v||(e.vx=0),e.vy=0,e.bobPhase=(e.bobPhase??0)+a*(d*(o?1.2:.85));const k=Math.sin(e.bobPhase)*c,S=Math.sin(.5*e.bobPhase+.02*e.x)*f*6,T=h-t.height*u+g+k+S;e.y+=(T-e.y)*Math.min(1,6.5*a),e.onGround=!1;const C=qt(e.vx/Math.max(1,i)*.22+.05*Math.sin(e.bobPhase+.4*e.facing),-.45,.45);e.tilt+=(C-e.tilt)*Math.min(1,5*a)}function zn(e,t,a,o){const n=t.horizontalAcceleration??t.acceleration??0,i=t.horizontalMaxSpeed??t.maxSpeed??320,r=t.horizontalDrag??t.idleDrag??200,s=t.airDrag??.97,l=t.hoverMinAltitude??0,c=Math.max(l,t.hoverMaxAltitude??l),d=t.altitudeRate??160,f=t.autopilotStrength??4,h=t.verticalDamping??.9,u=t.maxVerticalSpeed??220,g=t.liftPower??0,m=t.descendPower??g,y=o&&xe.right&&!xe.left,p=o&&xe.left&&!xe.right,x=y?1:p?-1:0;0!==x&&n>0?e.vx+=x*n*a:Hn(e,r,a),i>0&&(e.vx=qt(e.vx,-i,i)),0!==x?e.facing=x:Math.abs(e.vx)>6&&(e.facing=e.vx>0?1:-1),e.vx*=Math.pow(s,60*a);const b=Te*(t.gravityScale??.25);if(e.vy+=b*a,Number.isFinite(e.preferredAltitude)||(e.preferredAltitude=t.spawnHover??l),o)xe.jump&&(e.preferredAltitude+=d*a),xe.down&&(e.preferredAltitude-=d*a);else{const o=w-(e.y+t.height);e.preferredAltitude+=(o-e.preferredAltitude)*Math.min(1,.5*a)}e.preferredAltitude=qt(e.preferredAltitude,l,c);const v=qt(w-(e.y+t.height),l,c),k=e.preferredAltitude-v;e.vy-=k*f*a,o&&g>0&&(xe.jump&&(e.vy-=.25*g*a),xe.down&&(e.vy+=.25*m*a)),e.vy*=Math.pow(h,60*a),u>0&&(e.vy=qt(e.vy,-u,u)),e.x+=e.vx*a,e.y+=e.vy*a;const S=.5*t.width,T=S+32,C=de()-S-32;e.x=qt(e.x,T,C),e.x!==T&&e.x!==C||(e.vx=0);const M=qt(w-(e.y+t.height),l,c);e.y=w-t.height-M,(M===l&&e.vy>0||M===c&&e.vy<0)&&(e.vy=0),e.onGround=!1;const I=qt(e.vx/Math.max(1,i)*.35-.02*k,-.6,.6);e.tilt+=(I-e.tilt)*Math.min(1,6*a)}function Xn(e,t,a,o){const n=!1!==t.followVehicleFacing,i=e.facing??1,r=void 0!==o?o:(t.facing??1)*(n?i:1),s=t.offset?.x??0,l=t.offset?.y??0,c=n?i:1,d=e.x+s*c,f=e.y+l,h=t.muzzles&&t.muzzles.length>0?t.muzzles:[{x:t.muzzle?.x??0,y:t.muzzle?.y??0}],u=a.muzzleIndex??0,g=h[u%h.length];a.muzzleIndex=(u+1)%h.length;const m=d+(g?.x??0)*c,y=f+(g?.y??0),p=t.projectile??{},x=p.speed??600,w=(t.scatter??0)*(Math.PI/180),b=w>0?(Math.random()-.5)*w:0,v=r>=0?1:-1;no({x:m,y,vx:Math.cos(b)*x*v,vy:Math.sin(b)*x+(p.verticalSpeed??0),radius:p.radius??5,lifetime:p.lifetime??1.3,color:p.color??"#ffd27a",damage:p.damage??12,knockback:p.knockback??80,facing:v,gravityFactor:p.gravityFactor??.12}),a.flashTimer=t.flashDuration??.1,a.lastMuzzleX=m,a.lastMuzzleY=y}function qn(e,t,a,o){const n=t.mountedWeapons??[],i=e.mounts??[];if(0===n.length||0===i.length)return;const r=e.facing??1,s=o&&xe.attackDown,l=o&&xe.throwDown;for(let t=0;t<n.length;t+=1){const c=n[t],d=i[t];if(!c||!d)continue;d.cooldown=Math.max(0,(d.cooldown??0)-a),d.flashTimer=Math.max(0,(d.flashTimer??0)-a);let f=!1;const h=c.binding??"primary";if(o?"primary"===h?f=s:"secondary"===h&&(f=l):c.autoFire&&(f=!0),!f||d.cooldown>0)continue;const u=!1!==c.followVehicleFacing;Xn(e,c,d,(c.facing??1)*(u?r:1)),d.cooldown=c.fireInterval??.2}}function Gn(){const e=Qe(),t=e?.name??"Unarmed",a=ze().map(e=>ve[e]??{id:e,name:"Unknown"}),o=e?Je(e.id):null,n=hn.horizontalKick,i=hn.verticalKick;if((Ee.flashBlindTimer??0)>0){const e=Math.min(.55,(Ee.flashBlindTimer??0)/1.2);x.fillStyle=`rgba(255, 255, 224, ${e})`,x.fillRect(0,0,x.canvas.width,x.canvas.height)}x.fillStyle="#d0d4de",x.font="16px 'Segoe UI', Arial, sans-serif",x.textAlign="left",x.fillText("Move: WASD/Arrows   Jump: Space   Crouch: S   Roll: Shift   Attack: J or Left Click   Throw: G or Right Click   Build: B toggle, ,/. cycle, Left Click place",24,32),x.fillText("Cancel Build: Esc",24,48),x.fillText("Server Browser: L (toggle)  |  Join: Enter  |  Host: H  |  Offer: O  |  Paste: P  |  Apply: I  |  ICE Copy: M  |  ICE Apply: N",24,64);const r=x.canvas.width-24;let s=32;if(x.save(),x.textAlign="right",x.fillStyle="#d0d4de",x.fillText(`Weapon: ${t}`,r,s),s+=18,o){const e=o.capacity===Number.POSITIVE_INFINITY;let t=`Ammo: ${e?"INF":`${Math.max(0,o.magazine)}`}/${e?"INF":`${Math.max(0,o.reserve)}`}`;o.reloading&&(t+=` (Reloading ${Math.max(0,o.reloadTimer).toFixed(1)}s)`),x.fillText(t,r,s),s+=18}const l=function(){const e={active:la.active,strength:la.strength,maxStrength:la.maxStrength,duration:la.duration,maxDuration:la.maxDuration};return{turretCount:oa.length,grappleActive:ra.active,shieldActive:e.active,shieldStrength:e.strength,shieldMaxStrength:e.maxStrength,gadgetCooldown:Ee.gadgetCooldown??0}}();if(l){x.fillStyle=l.ready?"#8cffd4":"#d0d4de";const e=l.label??l.id??"Gadget",t=l.cooldown>0?` (${l.cooldown.toFixed(1)}s)`:"";x.fillText(`${e}${t}`,r,s),s+=18}x.restore();const c=Ee.attacking&&Ee.currentAttack?`Combo: ${Ee.currentAttack.name}`:"Combo: Ready";let d=84;const f=function(){const e=_t();return{active:e.active,stage:e.stage,timer:e.timer,wave:e.wave,enemiesAlive:e.enemiesAlive,lastReward:e.lastReward}}();if(f&&f.active){const e=f.stage??"wave",t=Math.max(1,"countdown"===e?f.wave+1:f.wave||1);x.fillStyle="#ffd66c",x.fillText(`Survival Wave ${t}`,24,d),d+=18,x.fillStyle="#d0d4de","countdown"===e?(x.fillText(`Next wave in ${f.timer.toFixed(1)}s`,24,d),d+=18):"wave"===e?(x.fillText(`Enemies remaining: ${f.enemiesAlive}`,24,d),d+=18):"rest"===e&&(x.fillText(`Resupply time: ${f.timer.toFixed(1)}s`,24,d),d+=18),(f.lastReward??0)>0&&(x.fillStyle="#8cffd4",x.fillText(`Last reward: +${f.lastReward} materials`,24,d),d+=18,x.fillStyle="#d0d4de")}else x.fillStyle="#9aa2b1",x.fillText("Survival Mode: Press Y to begin waves",24,d),d+=18,x.fillStyle="#d0d4de";x.fillText(c,24,d),d+=20;let h=d;const u=function(){const e=Xa(),t=ja(e.blueprintIndex);return{active:e.active,resources:oe(),blueprintName:t?.name??"None",cost:t?.cost??0,valid:e.lastPreview.valid}}();u&&(u.active?(x.fillStyle=u.valid?"#8cffd4":"#ff9c9c",x.fillText(`Building: ${u.blueprintName} (Cost ${u.cost||0})`,24,h),h+=18,x.fillStyle="#d0d4de",x.fillText(`Materials: ${u.resources}`,24,h),h+=20):(x.fillStyle="#9aa2b1",x.fillText(`Materials: ${u.resources}   (Press B to build)`,24,h),h+=20),x.fillStyle="#d0d4de");const g=Wn();if(g){const e=Nt[g.type],t=e?.label??g.type,a=e?.movementType??"ground";x.fillStyle="#8cffd4",x.fillText(`Vehicle: ${t} (E to exit)`,24,h),h+=20,x.fillStyle="#9aa2b1","air"===a?x.fillText("Controls: A/D strafe   Space rise   S descend",24,h):"water"===a?x.fillText("Controls: A/D throttle   S brake/reverse",24,h):x.fillText("Controls: A/D drive   S brake",24,h),h+=20;const o=e?.mountedWeapons??[];if(o.length>0)for(const e of o){const t="secondary"===(e.binding??"primary").toLowerCase()?"Secondary":"Primary",a=e.label??e.id??"Mounted Weapon";x.fillStyle="Primary"===t?"#cfe3ff":"#ffd3a3",x.fillText(`${t}: ${a}`,24,h),h+=18}}else if(Ee.vehicleCandidateId){const e=Xt(Ee.vehicleCandidateId);if(e){const t=Nt[e.type],a=t?.label??e.type,o=t?.movementType??"ground";x.fillStyle="#ffc66d",x.fillText(`Nearby: ${a} [E to enter]`,24,h),h+=20,x.fillStyle="#9aa2b1","air"===o?(x.fillText("Tip: Space rises, S descends when piloting",24,h),h+=20):"water"===o?(x.fillText("Tip: Boats use A/D throttle, S to brake/reverse",24,h),h+=20):(x.fillText("Tip: Hold S to brake while driving",24,h),h+=20);const n=t?.mountedWeapons??[];if(n.length>0){x.fillStyle="#d6e2ff";for(const e of n){const t="secondary"===(e.binding??"primary").toLowerCase()?"Secondary":"Primary",a=e.label??e.id??"Mounted Weapon";x.fillText(`${t}: ${a}`,24,h),h+=18}}}}x.fillStyle="#d0d4de";const m={timeUntilNext:Math.max(0,uo.nextDropTimer),nextDropLabel:fo[uo.nextDropTypeId]?.label??null,incomingMessage:uo.incomingTimer>0?uo.incomingMessage:null,incomingAlpha:uo.incomingTimer>0?uo.incomingTimer/uo.incomingDuration:0,rewardMessage:uo.rewardTimer>0?uo.rewardMessage:null,rewardAlpha:uo.rewardTimer>0?uo.rewardTimer/uo.rewardDuration:0,activeCount:ho.length};if(m){if(m.incomingMessage){const e=qt(.35+.65*(m.incomingAlpha??0),0,1);x.fillStyle=`rgba(176, 210, 255, ${e})`,x.fillText(m.incomingMessage,24,h),h+=20,x.fillStyle="#d0d4de"}if((m.timeUntilNext??0)>.2&&m.nextDropLabel){const e=m.timeUntilNext;x.fillText(`Next Drop (${m.nextDropLabel}): ${e.toFixed(1)}s`,24,h),h+=20}if((m.activeCount??0)>0&&(x.fillStyle="#8cffd4",x.fillText(`Drops on field: ${m.activeCount}`,24,h),h+=20,x.fillStyle="#d0d4de"),m.rewardMessage){const e=qt(.3+.7*(m.rewardAlpha??0),0,1);x.fillStyle=`rgba(140, 255, 212, ${e})`,x.fillText(`Reward: ${m.rewardMessage}`,24,h),h+=20,x.fillStyle="#d0d4de"}}const y=Ln();if(y?.command&&(x.fillStyle="#cfe3ff",x.fillText(`Squad: ${y.command.label}`,24,h),h+=18,x.fillStyle="#9aa2b1",x.fillText("Commands: Z Hold   X Defend   C Attack   V Flank   T Cycle",24,h),h+=18,(y.cooldown??0)>.05&&(x.fillText(`Command cooldown: ${y.cooldown.toFixed(1)}s`,24,h),h+=18),Array.isArray(y.members)&&y.members.length>0)){x.fillStyle="#8cffd4";const e=Math.min(3,y.members.length);for(let t=0;t<e;t+=1){const e=y.members[t],a=Math.abs(e.x-Ee.x),o=e.targetEnemyId?"engaging":"ready";x.fillText(`${e.name??"Ally"}: ${a.toFixed(0)}u (${o})`,24,h),h+=18}x.fillStyle="#d0d4de"}const p=xt?.();if(p&&(x.fillStyle="#b6c9ff",x.fillText(`P2P: ${p.status??"unknown"}`,24,h),h+=18,"connected"!==p.status?(x.fillStyle="#8495c9",x.fillText("Use window.P2P.createOffer() / createAnswer() in console",24,h),h+=18,x.fillText("window.P2P.getLocalDescription() to copy SDP",24,h),h+=18):(x.fillStyle="#8cffd4",x.fillText("Remote peers: "+We().length,24,h),h+=18),x.fillStyle="#d0d4de"),o){const e=o.capacity===Number.POSITIVE_INFINITY;let t=`Ammo: ${e?"INF":`${Math.max(0,o.magazine)}`}/${e?"INF":`${Math.max(0,o.reserve)}`}`;o.reloading&&(t+=` (Reloading ${Math.max(0,o.reloadTimer).toFixed(1)}s)`),x.fillText(t,24,h),h+=20}if(Math.hypot(n??0,i??0)>.05){const e=`Recoil Kick: H ${(n??0).toFixed(2)}  V ${(i??0).toFixed(2)}`;x.fillText(e,24,h),h+=20}x.fillText(`Player HP: ${Ee.health}/${Ee.maxHealth}`,24,h),h+=20,x.fillText(`Dummy HP: ${Math.round(He.health)}/${He.maxHealth}`,24,h),h+=20;const w=Ne.filter(e=>e.health>0).length;if(x.fillText(`Enemies Alive: ${w}`,24,h),h+=20,a.length>0){const t=a.map((t,a)=>{const o=`${a+1}: ${t.name}`;return t.id===e?.id?`[${o}]`:o}).join("   ");x.fillStyle="#9aa2b1",x.fillText(`Loadout ${t}`,24,152)}let b=172;if(Ee.comboWindowOpen&&(x.fillStyle="#ffcf7a",x.fillText("Press attack now to chain!",24,b),b+=20),"throwable"===e?.category){const e=Ee.throwCooldown<=0,t=e?"Ready":`${Ee.throwCooldown.toFixed(1)}s`;x.fillStyle=e?"#8cffd4":"#ffcf7a",x.fillText(`Grenade: ${t}`,24,b),b+=20}if("gadget"===e?.category){const e=(l.gadgetCooldown??0)<=.01,t=e?"Ready":`${l.gadgetCooldown.toFixed(1)}s`;x.fillStyle=e?"#8cffd4":"#ffcf7a",x.fillText(`Gadget: ${t}`,24,b),b+=20}if((l.turretCount??0)>0&&(x.fillStyle="#9ae9ff",x.fillText(`Turrets Active: ${l.turretCount}`,24,b),b+=20),l.shieldActive){const e=l.shieldMaxStrength??0,t=Math.max(0,l.shieldStrength??0),a=e>0?Math.max(0,Math.min(1,t/e)):0;x.fillStyle="#7cd6ff";const o=e>0?`${Math.ceil(t)}/${Math.ceil(e)}`:"Active";x.fillText(`Shield: ${o}`,24,b),b+=14;const n=120;x.fillStyle="#2d3c4d",x.fillRect(24,b,n,6),x.fillStyle="#7cd6ff",x.fillRect(24,b,n*a,6),b+=14}(Ee.stunTimer??0)>0&&(x.fillStyle="#ffb48a",x.fillText(`Stunned: ${Ee.stunTimer.toFixed(1)}s`,24,b),b+=20),(Ee.flashBlindTimer??0)>0&&(x.fillStyle="#ffe27a",x.fillText(`Blinded: ${Ee.flashBlindTimer.toFixed(1)}s`,24,b),b+=20),(Ee.smokeSlowTimer??0)>0&&(x.fillStyle="#b8c7dd",x.fillText(`In Smoke: ${Ee.smokeSlowTimer.toFixed(1)}s`,24,b),b+=20),Ee.health<=0&&(x.fillStyle="#ff8c7a",x.fillText("Respawning soon...",24,b));const v=fn(),k=v.notices.slice(-4).reverse();if(k.length>0||v.shotIndicators.length>0||v.filters){x.save();const e=x.canvas.width-24;x.textAlign="right";let t=32;for(const a of k){const o=a.maxTtl>0?qt(a.ttl/a.maxTtl,0,1):0;x.globalAlpha=qt(o,.25,1),x.fillStyle="#c3cdea",x.fillText(a.message,e,t),t+=18}if(v.shotIndicators.length>0){k.length>0&&(t+=6);for(const a of v.shotIndicators){const o=a.maxTtl>0?qt(a.ttl/a.maxTtl,0,1):0;x.globalAlpha=qt(o,.3,.85),x.fillStyle="#9aa2b1",x.fillText("Shot: "+a.weaponId,e,t),t+=16}}const a=v.filters;if(a){t>32&&(t+=6),x.globalAlpha=.6,x.fillStyle="#7f8aad",x.fillText("Filters (Alt+6/7/8)",e,t),t+=16;const o=[{label:"Weapons",value:a.weapons},{label:"Shield",value:a.shield},{label:"Throwables",value:a.throwables}];for(const a of o)x.globalAlpha=a.value?.85:.35,x.fillStyle=a.value?"#c3cdea":"#6c7389",x.fillText(a.label+": "+(a.value?"ON":"OFF"),e,t),t+=16}x.globalAlpha=1,x.restore()}}function Jn(){!function(){if(0!==oo.length){x.save(),x.lineWidth=2;for(const e of oo){const t=Math.max(0,e.life/e.maxLife);x.fillStyle=`rgba(255, 200, 120, ${t})`,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill()}x.restore()}}(),function(){const e=Jt();x.save();for(const t of ro)if(t.detonated){const e=Math.max(t.explosionDuration,.001),a=qt(1-t.explosionTimer/e,0,1),o=qt(1-a,0,1);if("flash"===t.effectType){const e=t.explosionRadius*(.8+.5*a),n=Math.max(0,Math.min(1,.75*o+.15));x.fillStyle=`rgba(255, 255, 224, ${n.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.fill()}else if("smoke"===t.effectType){const e=t.explosionRadius*(.6+.6*a),n=Math.max(0,Math.min(.65,.5*o+.1));x.fillStyle=`rgba(180, 200, 220, ${n.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.fill()}else{const e=t.explosionRadius*(.65+.4*a),n=Math.max(0,Math.min(1,.7*o));x.strokeStyle=`rgba(255, 196, 120, ${n.toFixed(3)})`,x.lineWidth=6*(1-.6*a),x.beginPath(),x.arc(t.x,t.y,e,0,2*Math.PI),x.stroke();const i=Math.max(0,Math.min(1,.75*o));x.fillStyle=`rgba(255, 118, 64, ${i.toFixed(3)})`,x.beginPath(),x.arc(t.x,t.y,.6*e,0,2*Math.PI),x.fill()}}else{x.globalAlpha=1,x.fillStyle=t.color,x.beginPath(),x.arc(t.x,t.y,t.radius,0,2*Math.PI),x.fill();const a=t.maxFuse>0?qt(t.fuse/t.maxFuse,0,1):0;x.strokeStyle="rgba(255, 232, 194, 0.85)",x.lineWidth=3,x.beginPath(),x.arc(t.x,t.y,.65*t.radius,-Math.PI/2,-Math.PI/2+2*Math.PI*a),x.stroke();const o=Math.cos(20*e)*t.radius*.4,n=Math.sin(24*e)*t.radius*.2-.8*t.radius;x.fillStyle="rgba(255, 240, 210, 0.9)",x.beginPath(),x.arc(t.x+o,t.y+n,3.2,0,2*Math.PI),x.fill()}x.restore(),function(){if(0!==so.length){x.save();for(const e of so){const t=qt(e.life/e.duration,0,1),a=e.radius,o=x.createRadialGradient(e.x,e.y,.15*a,e.x,e.y,a);o.addColorStop(0,"rgba(172, 196, 216, 0.35)"),o.addColorStop(1,"rgba(40, 52, 64, 0)"),x.globalAlpha=t,x.fillStyle=o,x.beginPath(),x.arc(e.x,e.y,a,0,2*Math.PI),x.fill()}x.restore()}}()}(),function(){if(Ca(),0!==wa.length||0!==ba.length){x.save();for(const e of ba){const t=qt(e.ttl/e.maxTtl,0,1),a=1-t,o=e.startRadius+(e.endRadius-e.startRadius)*a;x.globalAlpha=.6*qt(t,0,1),x.lineWidth=e.lineWidth,x.strokeStyle=e.color,x.beginPath(),x.arc(e.x,e.y,o,0,2*Math.PI),x.stroke()}for(const e of wa){const t=qt(e.ttl/e.maxTtl,0,1);let a=qt(t,0,1);"smoke"===e.type?a*=.55:"flash"===e.type?a=.35+.65*a:"debris"===e.type&&(a=.5+.5*a),x.globalAlpha=a,x.fillStyle=e.color;let o=t;"smoke"===e.type?o=1:"debris"===e.type&&(o=.6+.4*t);const n=Math.max(1.2,e.radius*o);x.beginPath(),x.arc(e.x,e.y,n,0,2*Math.PI),x.fill()}x.restore()}}(),function(){const{muzzleFlashes:e,shieldBursts:t,throwableBursts:a}=fn();if(0!==e.length||0!==t.length||0!==a.length){x.save();for(const t of e){const e=qt(t.ttl/t.maxTtl,0,1),a=.25+.6*e,o=12+14*(1-e),n=(t.facing??1)*(10+6*(1-e));x.globalAlpha=a,x.fillStyle="#ffd27a",x.beginPath(),x.arc(t.x+n,t.y,o,0,2*Math.PI),x.fill()}for(const e of t){const t=qt(e.ttl/e.maxTtl,0,1),a=("shatter"===e.type?.55:.35)*t;if(a<=0)continue;const o=("shatter"===e.type?120:80)*(1-.35*t);x.globalAlpha=a,x.lineWidth="shatter"===e.type?6:3,x.strokeStyle="shatter"===e.type?"#7cd6ff":"#9be9ff",x.beginPath(),x.arc(e.center.x,e.center.y,o,0,2*Math.PI),x.stroke()}for(const e of a){const t=qt(e.ttl/e.maxTtl,0,1);if(t<=0)continue;let a="#ffb347";"flash"===e.type?a="#fff6d0":"smoke"!==e.type&&"smoke-fade"!==e.type||(a="#9db8ca");const o=e.radius*(1+.35*(1-t));x.globalAlpha=("smoke-fade"===e.type?.3:.45)*t,x.lineWidth="flash"===e.type?5:4,x.strokeStyle=a,x.beginPath(),x.arc(e.x,e.y,o,0,2*Math.PI),x.stroke()}x.restore()}}()}function Kn(e){const t=Qe(),a=(t?.attackChain??[])[e];a&&(Ee.attacking=!0,Ee.attackIndex=e,Ee.currentAttack=a,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.nextAttackQueued=!1,Ee.hitboxSpawned=!1,Ee.attackInstanceId+=1)}function Un(e,t={}){if(!e)return null;const a=t.pose??(e===Ee?Ee.currentPose??Ce.standing:Ce.standing),o=t.height??e.height??Ie(a),n=t.halfWidth??e.radius??22,i=t.vx??e.vx??0,r=t.onGround??e.onGround??!0;return{ref:e,x:e.x,y:e.y,vx:i,onGround:r,facing:e.facing??1,height:o,halfWidth:n}}function Vn(e,t,a,o){if(!a||"movable"!==t.category&&"rolling"!==t.category)return;const n=a.y+a.height;if(Math.abs(n-e.y)>.6*e.height+.25*a.height+24)return;const i=e.width?e.width/2:e.radius,r=a.x-e.x;if(a.halfWidth+i-Math.abs(r)<=0)return;const s=r>=0?1:-1,l=t.pushImpulse??260,c=a.ref===Ee,d=(l+Math.abs(a.vx)*(c?.7:.45))*o;e.vx+=s*d;const f=t.maxSpeed??e.maxSpeed??240;e.vx=qt(e.vx,-f,f);const h=e.x+s*(i+a.halfWidth+.5);if(a.ref.x=s>0?Math.min(a.ref.x,h):Math.max(a.ref.x,h),a.ref===Ee){const e=de();Ee.x=qt(Ee.x,40,e-40)}e.flashTimer=Math.max(e.flashTimer,.12),e.state="rolling"===t.category?"rolling":"pushed"}function _n(e,t){const a=e.template??{};e.flashTimer=Math.max(0,(e.flashTimer??0)-t),e.timer=Math.max(0,(e.timer??0)-t);const o=Ie(Ee.currentPose??Ce.standing),n=Ee.y+o,i=Math.abs(n-e.y),r=Math.abs(Ee.x-e.x),s=i<e.height+.25*o+32&&r<(e.width?e.width:2*e.radius)+120?1:0;if(e.highlight+=(s-e.highlight)*qt(6*t,0,1),e.highlight=qt(e.highlight,0,1),"trap"===a.category)return void function(e,t,a){if(e.cooldown=Math.max(0,(e.cooldown??0)-a),e.cooldown>0)return;const o=e.width?e.width/2:e.radius,n=o+26,i=t.damage??0,r=t.knockback??80,s=t.launch??-140,l=t.stunDuration??.6;let c=!1;const d=[];d.push(Un(Ee,{halfWidth:22,vx:Ee.vx}));for(const e of Ne)e.health>0&&d.push(Un(e,{halfWidth:24}));for(const t of d){if(!t)continue;const a=t.y+t.height;if(Math.abs(a-e.y)>.8*e.height+.35*t.height)continue;const o=t.x-e.x;if(Math.abs(o)>n+t.halfWidth)continue;const d=o>=0?1:-1;c=!0,t.ref===Ee?(ma({attackDamage:i,attackKnockback:r,attackLaunch:s,facing:d},{damage:i,knockback:r,launch:s,facing:d}),Ee.stunTimer=Math.max(Ee.stunTimer??0,l)):(ga(t.ref,{damage:i,knockback:r,launch:Math.abs(s),facing:d}),t.ref.stunTimer=Math.max(t.ref.stunTimer??0,.8*l))}c&&(e.cooldown=t.cooldown??2.4,e.flashTimer=.25,e.state="triggered",e.timer=t.cooldown??2.4,ka({x:e.x,y:e.y-.5*e.height,startRadius:.6*o,endRadius:1.6*o,color:t.glowColor??"#96f7ff",ttl:.35,lineWidth:6}),Ia({x:e.x,y:e.y-.5*e.height,radius:1.2*o,maxRadius:1.8*o,ttl:.4}),Qa({type:"point",x:e.x,y:e.y,radius:3*o,intensity:1.4,color:t.glowColor??"#8cf7ff",ttl:.22,flicker:.5,decay:.8}))}(e,a,t);const l=(e.friction??2)*("rolling"===a.category?24:32);var c,d;e.vx=(d=l*t,(c=e.vx)>0?Math.max(0,c-d):c<0?Math.min(0,c+d):0),Math.abs(e.vx)<2&&(e.vx=0),e.x+=e.vx*t;const f=e.width?e.width/2:e.radius,h=de();let u=e.minX??f+24,g=e.maxX??h-f-24;if(u>g){const e=(u+g)/2;u=e,g=e}e.x<=u&&(e.x=u,e.vx=Math.max(0,e.vx)),e.x>=g&&(e.x=g,e.vx=Math.min(0,e.vx)),Vn(e,a,Un(Ee,{halfWidth:22,vx:Ee.vx}),t);for(const o of Le)o&&"defeated"!==o.state&&Vn(e,a,Un(o,{halfWidth:20}),t)}function Qn(e){let t=!1;for(const a of Oo){const o=a.template??{};if("movable"!==o.category&&"rolling"!==o.category)continue;if(e.hitTargets.has(a.id))continue;const n=a.radius??(a.width?a.width/2:32),i=a.y-(a.height??n),r=e.x-a.x,s=e.y-i;if(Math.hypot(r,s)>e.radius+n)continue;e.hitTargets.add(a.id);const l=r>=0?1:-1,c=o.hitImpulse??a.hitImpulse??420;a.vx+=l*c;const d=o.maxSpeed??a.maxSpeed??260;a.vx=qt(a.vx,-d,d),a.flashTimer=Math.max(a.flashTimer,.16),a.state="rolling"===o.category?"rolling":"nudged",t=!0}return t}function Zn(e){Ee.activeHitboxes.push({id:Ee.attackInstanceId,attackIndex:Ee.attackIndex,remaining:e.active,duration:e.active,offsetX:e.range,heightOffset:e.heightOffset,radius:e.radius,damage:e.damage,knockback:e.knockback,launch:e.launch,ownerFacing:Ee.facing,hitTargets:new Set,x:0,y:0})}function ei(){const e=Qe();if(!e||!e.category?.startsWith("ranged"))return;if(!function(e){const t=Ge(e);return!(t&&t.capacity!==Number.POSITIVE_INFINITY&&(t.reloading||t.magazine<=0||(t.magazine-=1,0)))}(e.id))return void(Ke(e.id)&&(Ee.attacking=!1,Ee.currentAttack=null,Ee.attackIndex=-1,"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:reload-start",{detail:{weaponId:e.id}}))));const t=e.projectile??{},a=t.speed??460,o=Ee.facing,n=o*a,i=t.initialVy??-12,r=Math.hypot(n,i),s=Math.atan2(i,n)+function(e){const t=Ge(e),a=t?.spreadDef;if(!t||!a)return 0;t.spread||(t.spread={current:a.base??0});const o=t.spread,n=a.base??0,i=Math.max(n,o.current??n),r=a.max??i,s=Math.min(r,i),l=s*(Math.PI/180),c=l>0?(2*Math.random()-1)*l:0,d=a.perShot??0;return o.current=Math.min(r,s+d),c}(e.id),l=Math.cos(s)*r,c=Math.sin(s)*r;var d;e.recoil&&(d=e.recoil,hn.horizontalKick+=d?.horizontal??0,hn.verticalKick+=d?.vertical??0,hn.decay=d?.decay??hn.decay,hn.lastShotTime=Jt(),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:recoil-kick",{detail:{weaponId:e.id,recoil:e.recoil}}))),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:muzzle-flash",{detail:{weaponId:e.id,x:Ee.x+34*o,y:Ee.y+20,facing:o}})),no({x:Ee.x+34*o,y:Ee.y+20,vx:l,vy:c,radius:t.radius??5,lifetime:t.lifetime??.9,color:t.color??"#ffca7a",damage:t.damage??10,knockback:t.knockback??60,facing:o,gravityFactor:t.gravityFactor??.2}),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("weapon:shot-fired",{detail:{weaponId:e.id}}))}function ti(e,t){if(e.invulnerability=Math.max(0,e.invulnerability-t),e.attackCooldown=Math.max(0,e.attackCooldown-t),e.stunTimer=Math.max(0,(e.stunTimer??0)-t),e.smokeSlowTimer=Math.max(0,(e.smokeSlowTimer??0)-t),e.smokeSlowTimer<=0&&(e.smokeSlowStrength=1),e.flashTimer>0&&(e.flashTimer=Math.max(0,e.flashTimer-t)),e.shakeTimer>0&&(e.shakeTimer=Math.max(0,e.shakeTimer-t)),e.shakeMagnitude=Math.max(0,e.shakeMagnitude-20*t),e.health<=0)return e.respawnTimer=Math.max(0,e.respawnTimer-t),void(0===e.respawnTimer&&(e.health=e.maxHealth,e.x=e.spawnX,e.y=e.spawnY,e.vx=0,e.vy=0,e.state="patrol",e.stateTimer=1+Math.random(),e.attackCooldown=.6,e.onGround=!0,e.stunTimer=0,e.smokeSlowTimer=0,e.smokeSlowStrength=1));const a=Ee.x-e.x,o=Math.abs(a);e.facing=a>=0?1:-1;const n=e.stunTimer>0,i=e.smokeSlowTimer>0?Math.max(.2,Math.min(1,e.smokeSlowStrength??1)):1,r=e.moveSpeed*i,s=e.aggressionRange*(e.smokeSlowTimer>0?.85:1),l=!n&&o<s;if(o>1.8*s)return e.vx=0,void(e.state="idle");if(n?(e.state="stunned",e.vx=0,e.attackWindup=0,e.attackActive=0,e.stateTimer=Math.max(e.stateTimer,e.stunTimer),e.attackCooldown=Math.max(e.attackCooldown,e.stunTimer+.2)):"stunned"===e.state&&(e.state="idle",e.stateTimer=.6),!n)switch(e.state){case"idle":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state="patrol",e.stateTimer=1.2+Math.random(),e.facing=Math.random()<.5?-1:1),l&&(e.state="chase");break;case"patrol":e.vx=r*e.facing,e.x<=e.patrolRange.min?e.facing=1:e.x>=e.patrolRange.max&&(e.facing=-1),e.stateTimer-=t,e.stateTimer<=0&&(e.state="idle",e.stateTimer=1+Math.random(),e.vx=0),l&&(e.state="chase");break;case"chase":if(!l){e.state="patrol";break}const n=a>=0?1:-1;e.vx=r*n,o<=e.attackRange&&e.attackCooldown<=0&&(e.state="attack-windup",e.attackWindup=.35,e.attackActive=.16,e.vx=0);break;case"attack-windup":e.vx=0,e.attackWindup-=t,e.attackWindup<=0&&(e.state="attack-active",e.attackActive=.16);break;case"attack-active":e.vx=.35*r*e.facing,e.attackActive-=t,e.attackActive<=0&&(e.state="recover",e.stateTimer=.4,e.attackCooldown=1.2);break;case"recover":e.vx=0,e.stateTimer-=t,e.stateTimer<=0&&(e.state=l?"chase":"idle",e.stateTimer=.9+.4*Math.random());break;default:e.vx=0}const c=e.y;e.vy+=Te*t,e.x+=e.vx*t,e.y+=e.vy*t,e.onGround=!1,!un(e,c,e.height)&&e.y+e.height>=w&&(e.y=w-e.height,e.vy=0,e.onGround=!0);const d=de();e.x=Math.max(60,Math.min(d-60,e.x))}function ai(e){if(e.health<=0)return;if("attack-active"!==e.state)return;const t=e.attackRange+e.radius,a=Ee.x-e.x,o=Ee.y-e.y;a*a+o*o<=t*t&&ma(e)}let oi=0,ni=0,ii=[],ri=[],si=null,li=null,ci=null;function di(){return"https://projectstickfightinggame.onrender.com".replace(/\/$/,"")}function fi(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`session-${Math.random().toString(36).slice(2,10)}`}function hi(e){return"string"!=typeof e?"":e.trim()}async function ui(e){if(!e||"undefined"==typeof navigator||!navigator.clipboard?.writeText)return!1;try{return await navigator.clipboard.writeText(e),!0}catch(e){return console.warn("Clipboard write failed",e),!1}}function gi(e){return Array.isArray(e)?e.map(e=>function(e){if("string"==typeof e)return hi(e);if(e&&"object"==typeof e)try{return hi(JSON.stringify(e))}catch{return""}return""}(e)).filter(e=>e.length>0):[]}function mi(e=[],t=[]){if(e.length!==t.length)return!1;for(let a=0;a<e.length;a+=1)if(e[a]!==t[a])return!1;return!0}function yi(e){if(!e||"object"!=typeof e)return null;const t=e.metadata??{};return{id:e.id,name:e.name??e.id,map:e.map??t.map??"Unknown",players:t.playerCount??e.playerCount??e.players??0,maxPlayers:e.maxPlayers??t.maxPlayers??0,region:e.region??t.region??"--",mode:e.mode??t.mode??"",enemyCount:t.enemyCount??null,alliesCount:t.alliesCount??null,updatedAt:e.updatedAt??null,signal:{hostOffer:e.signal?.hostOffer??null,hostCandidates:Array.isArray(e.signal?.hostCandidates)?e.signal.hostCandidates.slice():[],joinAnswer:e.signal?.joinAnswer??null,joinCandidates:Array.isArray(e.signal?.joinCandidates)?e.signal.joinCandidates.slice():[]}}}function pi(e){const t=yi(e);if(!t)return;const a=bt(),o=a.servers.findIndex(e=>e.id===t.id);o>=0?a.servers[o]=t:a.servers.push(t)}function xi(){ii=[],ri=[],oi=0,ni=0,si&&(clearTimeout(si),si=null),li&&(clearTimeout(li),li=null),ci=null}function wi(){const e=bt();e.hosting&&e.hostingSessionId&&(oi=Date.now(),Pi().catch(e=>console.warn("[serverBrowser] heartbeat update failed",e)))}function bi(e){const t=bt();t.joinedSessionId&&Array.isArray(e)&&0!==e.length&&(ni=Date.now(),async function(e,t={}){const a=di();if(a&&e&&t&&0!==Object.keys(t).length)try{const o=await fetch(`${a}/sessions/${e}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok)throw new Error(`HTTP ${o.status}`);const n=await o.json();n?.session&&(pi(n.session),Array.isArray(n.session.signal?.hostCandidates)&&n.session.signal.hostCandidates.length>0&&$i(n.session.signal.hostCandidates))}catch(t){console.warn(`[serverBrowser] joiner update failed for ${e}`,t)}}(t.joinedSessionId,{signalCandidates:e}).catch(e=>{console.warn("[serverBrowser] failed to publish joiner candidates",e)}))}function vi(e){const t=bt();t.hosting||(ii=[]),t.joinedSessionId||(ri=[]),Array.isArray(e)&&0!==e.length?(t.hosting&&t.hostingSessionId&&!mi(ii,e)&&(ii=e.slice(),function(){const e=bt();if(!e.hosting||!e.hostingSessionId)return;const t=Date.now(),a=Math.max(0,1e3-(t-oi));a>0?si||(si=setTimeout(()=>{si=null,wi()},a)):wi()}()),t.joinedSessionId&&!mi(ri,e)&&(ri=e.slice(),function(e){if(!bt().joinedSessionId||!Array.isArray(e)||0===e.length)return;const t=Date.now(),a=Math.max(0,1e3-(t-ni));if(a>0)return ci=e.slice(),void(li||(li=setTimeout(()=>{const e=ci;li=null,ci=null,bi(e)},a)));bi(e)}(e.slice()))):t.hosting||t.joinedSessionId||(xi(),It(null))}function ki(){const e=bt();let t;try{t=st()}catch{return(e.p2p?.localCandidates??[]).length>0&&(Ot([]),vi([])),[]}if(!t?.getLocalCandidates)return(e.p2p?.localCandidates??[]).length>0&&(Ot([]),vi([])),[];const a=Array.isArray(e.p2p?.localCandidates)?e.p2p.localCandidates.slice():[],o=gi(t.getLocalCandidates()??[]);return mi(a,o)||(Ot(o),vi(o)),o}async function Si({silent:e=!1}={}){try{Wt({candidates:!0});const t=ki();if(0===t.length)return e||Tt("No ICE candidates yet. Wait a moment after generating offer/answer."),{copied:!1,count:0};const a=t.join("\n"),o=await ui(a);return e||Tt(o?`Copied ${t.length} ICE candidate${1===t.length?"":"s"}.`:"Candidates ready. Copy manually if clipboard access is blocked."),{copied:o,count:t.length,payload:a}}catch(e){throw $t(e?.message??"Failed to copy ICE candidates"),e}finally{Wt({candidates:!1})}}async function Ti(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=bt(),t=(e.p2p.remoteCandidates??[]).join("\n"),a=window.prompt("Paste remote ICE candidates (JSON array or newline separated)",t);if(null==a)return Tt("Candidate entry cancelled."),null;const o=function(e){const t=hi(e);if(!t)return[];try{const e=JSON.parse(t);if(Array.isArray(e))return gi(e);if(e&&"object"==typeof e)return gi([e]);if("string"==typeof e)return gi([e])}catch{}return gi(t.split(/\r?\n+/).map(e=>e.trim()).filter(e=>e.length>0))}(a);if(0===o.length)throw Tt("No valid ICE candidates detected."),new Error("No ICE candidates provided");const n=Ci();$t(null),Wt({candidates:!0});try{for(const e of o)await n.addRemoteCandidate(e);const t=function(e,t){const a=[...e,...t],o=new Set,n=[];for(const e of a)o.has(e)||(o.add(e),n.push(e));return n}(e.p2p.remoteCandidates??[],o);return Lt(t),Tt(`Applied ${o.length} ICE candidate${1===o.length?"":"s"}.`),o}catch(e){throw $t(e?.message??"Failed to apply ICE candidates"),e}finally{Wt({candidates:!1})}}function Ci(){try{return st()}catch(e){throw $t(e?.message??"P2P subsystem unavailable"),e}}function Mi(e,t){const a=e?.playerCount??t;return{playerCount:a,enemyCount:e?.enemyCount??0,alliesCount:e?.alliesCount??Math.max(0,a-1)}}async function Ii({silent:e=!1}={}){const t=di();if(!t)return St("Server list URL not configured"),void kt([]);Pt(!0),e||Tt("Fetching server list...");try{const a=await fetch(`${t}/sessions`,{headers:{Accept:"application/json"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);const o=await a.json(),n=(Array.isArray(o)?o:Array.isArray(o?.servers)?o.servers:[]).map(e=>yi(e)).filter(Boolean),i=Math.max(3e4,Math.round(165e3)),r=Date.now(),s=n.filter(e=>{if(!e.updatedAt)return!0;const t=Date.parse(e.updatedAt);return!!Number.isNaN(t)||r-t<=i});kt(s),St(null),e||Tt(0===s.length?"No active sessions.":"Fetched session list.")}catch(t){kt([]),St(`Failed to fetch servers: ${t.message}`),e||Tt("Unable to reach session service.")}finally{Pt(!1)}}async function Ai({id:e=fi(),name:t="ProjectStickFightingGame Lobby",region:a="na-west",map:o="Neo District",playerCount:n=1,maxPlayers:i=4,mode:r="freeplay",signal:s=null}={}){const l=di(),c="sk-stickman-host-123456789987654321";if(!l)throw new Error("Server API base not configured");const d=bt(),f=d.hostingMetrics??{},h=f.playerCount??n,u=s??{hostOffer:d.p2p.offer??null,hostCandidates:d.p2p.localCandidates??[]},g=await fetch(`${l}/sessions`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":c},body:JSON.stringify({id:e,name:t,region:a,map:o,mode:r,playerCount:h,maxPlayers:i,ttlSeconds:150,metadata:Mi(f,h),signal:{hostOffer:u.hostOffer??null,hostCandidates:Array.isArray(u.hostCandidates)?u.hostCandidates:[]}})});if(!g.ok)throw new Error(`Failed to host session (HTTP ${g.status})`);const m=await g.json();return Ot(Array.isArray(u.hostCandidates)?u.hostCandidates:[]),Dt({id:e,expiresAt:Date.now()+1e3*(m?.ttlSeconds??150)}),Tt(`Hosting ${t}`),{id:e,ttlSeconds:m?.ttlSeconds??150}}async function Pi(){const e=di(),t="sk-stickman-host-123456789987654321",a=bt();if(!(a.hosting&&a.hostingSessionId&&e&&t))return;const o=a.hostingMetrics??{},n=o.playerCount??1;try{const r=await fetch(`${e}/sessions/${a.hostingSessionId}/heartbeat`,{method:"POST",headers:{"Content-Type":"application/json","x-session-secret":t},body:JSON.stringify({playerCount:n,ttlSeconds:150,metadata:Mi(o,n),signal:{hostOffer:a.p2p.offer??null,hostCandidates:Array.isArray(a.p2p.localCandidates)?a.p2p.localCandidates:[]}})});if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();i=performance.now(),wt.hostingLastHeartbeat=i,s?.ttlSeconds&&Dt({id:a.hostingSessionId,expiresAt:Date.now()+1e3*s.ttlSeconds})}catch(e){console.warn("Heartbeat failed",e),Tt("Heartbeat failed; hosting paused."),Rt(),xi()}var i}async function Di(){const e=di(),t="sk-stickman-host-123456789987654321",a=bt();if(!(a.hosting&&a.hostingSessionId&&e&&t))return Rt(),void xi();try{await fetch(`${e}/sessions/${a.hostingSessionId}`,{method:"DELETE",headers:{"x-session-secret":t}})}catch(e){console.warn("Failed to stop hosting",e)}finally{Rt(),xi()}}async function Ri(e,t={}){const a=di();if(!a)throw new Error("Server API base not configured");Ct("Contacting host..."),Mt(null);const o=`${a}/sessions/${e}/join`,n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=`Join failed (HTTP ${n.status})`;throw Ct(null),Mt(e),new Error(e)}const i=await n.json(),r=i?.session?.name??e;return Ht(),xi(),pi(i?.session),Ct(`Joined ${r}`),Tt("Joined lobby. Establishing connection..."),i}async function Bi({forceRegenerate:e=!1}={}){const t=bt();if(!e&&t.p2p.offer)return ki(),t.p2p.offer;const a=Ci();$t(null),Wt({offer:!0});try{const e=await a.createOffer();return function(e){wt.p2p.offer=e??null}(e),ki(),e}catch(e){throw $t(e?.message??"Failed to create offer"),e}finally{Wt({offer:!1})}}async function Ei({forceRegenerate:e=!1,silent:t=!1}={}){const a=await Bi({forceRegenerate:e}),o=await ui(a);return t||Tt(o?"Offer copied. Share it with your party.":"Offer ready. Copy it manually if clipboard access is blocked."),{offer:a,copied:o}}async function Oi(e,{autoCopyAnswer:t=!0}={}){const a=hi(e);if(!a)throw new Error("Offer empty");let o;try{o=JSON.stringify(JSON.parse(a))}catch(e){throw $t("Offer must be valid JSON"),e}const n=Ci();$t(null),Wt({answer:!0});try{const e=await n.createAnswer(o);return Et(e),ki(),Tt(t?await ui(e)?"Answer copied. Send it back to the host.":"Answer ready. Copy it manually for the host.":"Answer ready. Share it with the host."),e}catch(e){throw $t(e?.message??"Failed to build answer"),e}finally{Wt({answer:!1})}}async function Li(e){const t=hi(e);if(!t)throw new Error("Answer empty");let a;try{a=JSON.stringify(JSON.parse(t))}catch(e){throw $t("Answer must be valid JSON"),e}const o=Ci();$t(null);try{await o.acceptRemoteDescription(a),Et(a),Tt("Answer applied. Waiting for connection...")}catch(e){throw $t(e?.message??"Failed to accept answer"),e}}function $i(e){if(!Array.isArray(e)||0===e.length)return;const t=gi(e);if(0===t.length)return;let a;try{a=Ci()}catch(e){return void console.warn("P2P unavailable while applying candidates",e)}const o=bt(),n=Array.isArray(o.p2p.remoteCandidates)?o.p2p.remoteCandidates:[],i=new Set(n),r=n.slice();for(const e of t)if(!i.has(e))try{a.addRemoteCandidate(e),r.push(e),i.add(e)}catch(e){console.warn("Failed to add ICE candidate",e)}Lt(r)}function Wi(){const e=bt();if(e.hosting&&e.hostingSessionId){const t=e.servers.find(t=>t.id===e.hostingSessionId),a=t?.signal??null;a&&(a.joinAnswer&&e.p2p.answer!==a.joinAnswer&&Li(a.joinAnswer).catch(e=>{console.warn("Failed to apply joiner answer",e)}),Array.isArray(a.joinCandidates)&&a.joinCandidates.length>0&&$i(a.joinCandidates),a.joinAnswer&&(e.hostingMetrics?.playerCount??1)<2&&(Bt({playerCount:Math.max(2,e.hostingMetrics?.playerCount??1)}),Pi().catch(e=>console.warn("Heartbeat update failed",e))))}if(e.joinedSessionId){const t=e.servers.find(t=>t.id===e.joinedSessionId),a=t?.signal??null;a&&Array.isArray(a.hostCandidates)&&a.hostCandidates.length>0?$i(a.hostCandidates):t||It(null)}}async function Hi(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the host offer JSON","");if(null==e)return Tt("Offer entry cancelled."),null;try{return await Oi(e,{autoCopyAnswer:!0})}catch(e){throw Tt("Invalid offer. Please try again."),e}}async function Fi(){if("undefined"==typeof window||"function"!=typeof window.prompt)throw new Error("Prompts unavailable in this environment");const e=window.prompt("Paste the player's answer JSON","");if(null==e)return Tt("Answer entry cancelled."),null;try{return await Li(e),e}catch(e){throw Tt("Invalid answer. Ask the player to resend it."),e}}function Ni(){const e=bt();return e.hosting?(Tt("Already hosting."),Promise.resolve({alreadyHosting:!0})):(Ht(),xi(),It(null),Tt("Preparing host offer..."),St(null),Bi({forceRegenerate:!0}).then(t=>Ai({signal:{hostOffer:t,hostCandidates:ki()}}).then(t=>(Tt(`Hosting ${e.hostingSessionId??t.id}`),t))).catch(e=>{throw St("string"==typeof e?.message?e.message:"Host failed"),Tt(null),e}))}function ji(){return bt().hosting?(Tt("Stopping session..."),St(null),Di().then(()=>{Tt("Hosting stopped."),It(null)}).catch(e=>{throw St("string"==typeof e?.message?e.message:"Stop failed"),e})):(Tt("Not hosting any session."),Promise.resolve({alreadyStopped:!0}))}function Yi(e){return e?(()=>{const t=e.signal??{};return t.hostOffer?(console.debug(`[serverBrowser] using cached signal for ${e.id}`),Promise.resolve({server:e,signal:t})):(console.debug(`[serverBrowser] cached signal missing for ${e.id}, fetching detail`),Tt("Syncing host signal..."),async function(e){const t=di();if(!t)throw new Error("Server API base not configured");console.debug(`[serverBrowser] fetching session detail for ${e}`);const a=await fetch(`${t}/sessions/${e}`);if(404===a.status)return console.warn(`[serverBrowser] session ${e} no longer exists (404)`),{notFound:!0};if(!a.ok)throw console.warn(`[serverBrowser] session detail request failed ${a.status} for ${e}`),new Error(`Session lookup failed (HTTP ${a.status})`);const o=await a.json();return console.debug(`[serverBrowser] received session detail for ${e}`),o}(e.id).then(t=>{if(t?.notFound){console.warn(`[serverBrowser] session ${e.id} vanished before join`);const t=bt(),a=t.servers.findIndex(t=>t.id===e.id);throw a>=0&&t.servers.splice(a,1),It(null),new Error("Session no longer available")}const a=t?.session,o=a?.signal??{};if(!o.hostOffer)throw new Error("Host offer unavailable. Ask the host to refresh.");const n=bt(),i={...e,signal:{hostOffer:o.hostOffer??null,hostCandidates:Array.isArray(o.hostCandidates)?o.hostCandidates.slice():[],joinAnswer:o.joinAnswer??null,joinCandidates:Array.isArray(o.joinCandidates)?o.joinCandidates.slice():[]},updatedAt:a?.updatedAt??e.updatedAt},r=n.servers.findIndex(t=>t.id===e.id);return r>=0&&(n.servers[r]=i),console.debug(`[serverBrowser] refreshed signal for ${e.id}`),{server:i,signal:i.signal}}))})().then(({server:e,signal:t})=>(Ht(),xi(),Mt(null),console.debug(`[serverBrowser] applying host offer for ${e.id}`),Tt(`Connecting to ${e.name??e.id}...`),St(null),Oi(t.hostOffer,{autoCopyAnswer:!1}).then(t=>{const a=ki();return console.debug(`[serverBrowser] posting join payload for ${e.id}`),Ri(e.id,{signalAnswer:t,signalCandidates:a}).then(t=>(It(e.id),Array.isArray(t?.session?.signal?.hostCandidates)&&$i(t.session.signal.hostCandidates),Tt(`Joined ${t?.session?.name??e.name??e.id}`),t))}))).catch(t=>{const a="string"==typeof t?.message?t.message:"Join failed";throw console.warn(`[serverBrowser] join failed for ${e.id}: ${a}`),Mt(a),Tt(null),t}):(Mt("No server selected."),Promise.reject(new Error("No server selected")))}function zi(){const e=de(),t=Math.max(40,e-40);Ee.x=Math.max(40,Math.min(t,Ee.x))}function Xi(e){!function(e){Gt+=e}(e),Do(e),function(e){const t=te;for(let a=t.pickups.length-1;a>=0;a-=1){const o=t.pickups[a];if(!o){t.pickups.splice(a,1);continue}if(o.ttl-=e,o.ttl<=0){t.pickups.splice(a,1);continue}o.vy=(o.vy??-80)+520*e,o.x+=(o.vx??0)*e,o.y+=o.vy*e,o.y>=w-12&&(o.y=w-12,o.vx=.65*(o.vx??0),o.vy*=-.35);const n=o.x-Ee.x,i=o.y-(Ee.y+Ee.currentPose?.headRadius??16);Math.hypot(n,i)<38&&(ne(o.amount??5),ka({x:o.x,y:o.y,startRadius:12,endRadius:46,color:"#a9ffd1",ttl:.28}),t.pickups.splice(a,1))}}(e),Ro(e),Ee.invulnerability=Math.max(0,Ee.invulnerability-e),Ee.structureShieldTimer=Math.max(0,(Ee.structureShieldTimer??0)-e),Ee.structureShieldTimer<=0&&(Ee.structureShieldStrength=0),Ee.throwCooldown=Math.max(0,Ee.throwCooldown-e),Ee.gadgetCooldown=Math.max(0,(Ee.gadgetCooldown??0)-e),Ee.stunTimer=Math.max(0,(Ee.stunTimer??0)-e),Ee.flashBlindTimer=Math.max(0,(Ee.flashBlindTimer??0)-e),Ee.smokeSlowTimer=Math.max(0,(Ee.smokeSlowTimer??0)-e),Ee.smokeSlowTimer<=0&&(Ee.smokeSlowStrength=1);const t=xe.interactBuffered;xe.interactBuffered=!1;const a=xe.squadCommandCycleBuffered,o=xe.squadCommandSelect,n=xe.serverBrowserToggleBuffered,i=xe.serverBrowserNavigate,r=xe.serverBrowserJoinBuffered,s=xe.serverBrowserHostBuffered,l=xe.serverBrowserStopHostBuffered,c=xe.serverBrowserCopyOfferBuffered,d=xe.serverBrowserPasteOfferBuffered,f=xe.serverBrowserAcceptAnswerBuffered,h=xe.serverBrowserCopyCandidatesBuffered,u=xe.serverBrowserPasteCandidatesBuffered;xe.squadCommandCycleBuffered=!1,xe.squadCommandSelect=null,xe.serverBrowserToggleBuffered=!1,xe.serverBrowserNavigate=0,xe.serverBrowserJoinBuffered=!1,xe.serverBrowserHostBuffered=!1,xe.serverBrowserStopHostBuffered=!1,xe.serverBrowserCopyOfferBuffered=!1,xe.serverBrowserPasteOfferBuffered=!1,xe.serverBrowserAcceptAnswerBuffered=!1;const g=Ee.health>0&&xe.attackBuffered,m=Ee.health>0&&xe.throwBuffered,y=Ee.health>0&&xe.reloadBuffered;xe.attackBuffered=!1,xe.throwBuffered=!1,xe.reloadBuffered=!1;const p=xe.roll;if(xe.roll=!1,function(e){if(Ee.vehicleId){Ee.vehicleCandidateId=null;const t=Wn();return void(e&&t&&t.enterCooldown<=.01&&Nn(t,{preferDirection:t.facing}))}if(Ee.health<=0)return void(Ee.vehicleCandidateId=null);let t=null,a=Number.POSITIVE_INFINITY;const o=Ie(Ce.standing),n=Ee.y+o;for(const e of zt){const o=Nt[e.type];if(!o)continue;if(e.driverId)continue;if(e.enterCooldown>0)continue;const i=Math.abs(Ee.x-e.x);if(i>(o.enterRadius??64))continue;const r=e.y+o.height,s=Math.abs(n-r),l=o.movementType??"ground";let c;if(c="air"===l?Math.max(120,(o.hoverMinAltitude??0)+80):"water"===l?Math.max(90,(o.waterSurfaceOffset??24)+70):80,s>c)continue;const d=i+.5*s;d<a&&(a=d,t=e)}Ee.vehicleCandidateId=t?.id??null,e&&t&&function(e){const t=Nt[e.type];t&&(e.driverId=$n,e.enterCooldown=.45,Ee.vehicleId=e.id,Ee.controlMode="vehicle",Ee.vehicleCandidateId=null,Ee.attacking=!1,Ee.currentAttack=null,Ee.attackIndex=-1,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.nextAttackQueued=!1,Ee.hitboxSpawned=!1,Ee.activeHitboxes.length=0,Ee.crouching=!1,Ee.rolling=!1,Fn(e,t))}(t)}(t),a&&function(){if(Ee.squadCommandCooldown>0)return Dn();Ee.squadCommandIndex=(Ee.squadCommandIndex+1)%Me.length;const e=Dn();Ee.squadCommandId=e?.id??Ee.squadCommandId,Ee.squadCommandCooldown=1.4}(),o&&function(e){const t=Me.findIndex(t=>t.id===e);t>=0&&(Ee.squadCommandIndex=t,Ee.squadCommandId=e,Ee.squadCommandCooldown=1.4)}(o),n&&(bt().visible?vt(!1):(vt(!0),At(0),Ii())),0!==i&&bt().visible&&function(e){0!==wt.servers.length&&(wt.selectedIndex=(wt.selectedIndex+e+wt.servers.length)%wt.servers.length)}(i),r){const e=bt(),t=e.visible?e.servers[e.selectedIndex]:null;t&&Yi(t).catch(e=>console.warn("Join failed",e))}if(s&&bt().visible&&Ni().catch(e=>console.warn("Host failed",e)),l&&bt().visible&&ji().catch(e=>console.warn("Stop hosting failed",e)),c){const e=bt();e.visible&&e.hosting&&Ei({forceRegenerate:!1,silent:!1}).catch(e=>console.warn("Offer copy failed",e))}if(d&&bt().visible&&Hi().catch(e=>console.warn("Offer accept failed",e)),f){const e=bt();e.visible&&e.hosting&&Fi().catch(e=>console.warn("Answer apply failed",e))}if(h){const e=bt();e.visible&&e.hosting&&Si({silent:!1}).catch(e=>console.warn("Candidate copy failed",e))}u&&bt().visible&&Ti().catch(e=>console.warn("Candidate apply failed",e));let x=Wn(),b=Boolean(x);Ee.health<=0&&b&&(function(e={}){const t=Wn();if(!t)return Ee.vehicleId=null,void(Ee.controlMode="onFoot");Nn(t,{skipCooldown:!0,inheritVelocity:!1,...e})}({preferDirection:x?.facing}),x=null,b=!1),p&&Ee.health>0&&!b&&function(e){if(Ee.vehicleId)return;if(!Ee.onGround||Ee.rolling||Ee.attacking||Ee.health<=0||(Ee.stunTimer??0)>0)return;const{left:t,right:a}=e;t&&!a?Ee.facing=-1:a&&!t&&(Ee.facing=1),Ee.rolling=!0,Ee.rollTimer=.32,Ee.crouching=!1,Ee.vy=0}({left:xe.left,right:xe.right}),b||"vehicle"!==Ee.controlMode||(Ee.controlMode="onFoot");const v=!b&&Ee.stunTimer<=0&&!Ee.reloading,k=!!v&&g,S=!!v&&m,T=!!v&&y;Ee.health>0?b?function(){const e=Wn();if(!e)return Ee.vehicleId=null,void(Ee.controlMode="onFoot");Ee.controlMode="vehicle",Ee.crouching=!1,Ee.rolling=!1,Ee.onGround=e.onGround||null!=e.waterLineY}():function(e){if(Ee.vehicleId)return;if(Ee.crouching=xe.down&&Ee.onGround&&!Ee.rolling&&!Ee.attacking,Ee.rolling)Ee.vx=420*Ee.facing,Ee.vy=0,Ee.rollTimer-=e,Ee.rollTimer<=0&&(Ee.rolling=!1);else{let t=Se;if(Ee.crouching&&(t*=.55),Ee.attacking&&(t*=.7),Ee.reloading&&(t*=.8),Ee.smokeSlowTimer>0){const e=Ee.smokeSlowStrength??.6;t*=Math.max(.1,Math.min(1,e))}Ee.stunTimer>0&&(t*=.25),Ee.vx=0,xe.left&&(Ee.vx-=t,Ee.facing=-1),xe.right&&(Ee.vx+=t,Ee.facing=1);const a=Ee.stunTimer<=0;Ee.onGround&&a&&xe.jump&&!Ee.crouching&&!Ee.attacking&&(Ee.vy=-460,Ee.onGround=!1),Ee.vy+=Te*e}const t=Ee.y;Ee.x+=Ee.vx*e,Ee.y+=Ee.vy*e,Ee.onGround=!1;const a=Ie(Ce.standing);un(Ee,t,a)||Ee.y+a>=w&&(Ee.y=w-a,Ee.vy=0,Ee.onGround=!0),zi()}(e):function(e){const t=Ie(Ce.standing);if(Ee.vehicleId=null,Ee.controlMode="onFoot",Ee.vehicleCandidateId=null,Ee.deadTimer=Math.max(0,Ee.deadTimer-e),Ee.vx*=.9,Ee.vy+=Te*e,Ee.x+=Ee.vx*e,Ee.y+=Ee.vy*e,Ee.y+t>=w&&(Ee.y=w-t,Ee.vy=0,Ee.onGround=!0),zi(),0===Ee.deadTimer){Ee.health=Ee.maxHealth,Ee.invulnerability=1.2,Ee.throwCooldown=0,Ee.gadgetCooldown=0,Ee.reloading=!1,Ee.stunTimer=0,Ee.flashBlindTimer=0,Ee.smokeSlowTimer=0,Ee.smokeSlowStrength=1,oa.length=0,fa("cleared"),sa();const e=de();Ee.x=.5*e,Ee.y=w-t,Ee.vx=0,Ee.vy=0,Ee.onGround=!0}}(e),Ee.currentPose=Ee.rolling?Ce.rolling:Ee.crouching?Ce.crouching:Ce.standing;const C=Ie(Ee.currentPose);Bt({playerCount:1+We().length,enemyCount:Ne.reduce((e,t)=>e+(t.health>0?1:0),0),alliesCount:Le.reduce((e,t)=>e+(t&&"defeated"!==t.state?1:0),0)});const M="undefined"!=typeof performance?performance.now():Date.now();!function(e){for(const t of zt){const a=Nt[t.type];if(!a)continue;t.enterCooldown=Math.max(0,t.enterCooldown-e),t.damageFlash=Math.max(0,t.damageFlash-e);const o=t.driverId===$n,n=a.movementType??"ground";"air"===n?zn(t,a,e,o):"water"===n?Yn(t,a,e,o):jn(t,a,e,o),qn(t,a,e,o),o?Fn(t,a):"ground"===n&&(t.tilt+=(0-t.tilt)*Math.min(1,10*e))}}(e),xo(e),function(e){for(const t of xa)t.flashTimer=Math.max(0,(t.flashTimer??0)-e),t.shakeTimer=Math.max(0,(t.shakeTimer??0)-e),t.smokeTimer=Math.max(0,(t.smokeTimer??0)-e),t.shakeMagnitude*=t.shakeTimer>0?.92:.6,t.destroyed?t.rubbleLevel=Math.min(1,(t.rubbleLevel??0)+2.2*e):t.rubbleLevel=Math.max(0,(t.rubbleLevel??0)-.8*e)}(e),function(e){if(!(e<=0))for(const t of Oo)_n(t,e)}(e),function(e,t){const a=bt();Wi(),ki();const o=Math.min(15e3,3e3),n=a.visible?15e3:o;if((a.visible||a.hosting||Boolean(a.joinedSessionId))&&t-a.lastFetch>=n&&!a.fetching&&(At(t),Ii({silent:!a.visible})),a.visible){if(a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&Pi()}Wi()}else if(a.hosting){const e=45e3;t-a.hostingLastHeartbeat>=e&&Pi()}}(0,M),function(){if(function(e=6e3){const t="undefined"!=typeof performance?performance.now():Date.now();for(const[a,o]of $e.entries())t-(o.lastUpdate??t)>e&&$e.delete(a)}(),yt(),!dt||"open"!==dt.readyState)return;const e="undefined"!=typeof performance?performance.now():Date.now();if(e-ht<60)return;ht=e;const t={type:"playerState",id:lt,name:"Remote",x:Ee.x,y:Ee.y,facing:Ee.facing,commandId:Ee.squadCommandId};try{dt.send(JSON.stringify(t))}catch{}}(),function(e){Ee.squadCommandCooldown=Math.max(0,Ee.squadCommandCooldown-e);let t=0;for(const a of Le)a.roleIndex=t,t+=1,On(a,e)}(e);for(const t of Le)t&&(t.structureShieldTimer=Math.max(0,(t.structureShieldTimer??0)-e),t.structureShieldTimer<=0&&(t.structureShieldStrength=0));x=Wn(),b=Boolean(x),b&&(Ee.controlMode="vehicle"),v||(Ee.attacking=!1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.nextAttackQueued=!1,Ee.hitboxSpawned=!1,Ee.attackIndex=-1,Ee.activeHitboxes.length=0);const I=Qe(),A=I?.category??"",P=(I?.attackChain??[]).length>0,D=A.startsWith("ranged"),R="throwable"===A;if("gadget"===A)(k||S)&&ha(I),Ee.activeHitboxes.length=0;else if(R)(k||S)&&function(){const e=Qe();if((Ee.stunTimer??0)>0)return!1;if(!e||"throwable"!==e.category)return!1;if(Ee.throwCooldown>0||Ee.health<=0||Ee.rolling)return!1;const t=e.throwable??{},a=Ee.facing||1,o=t.arcVelocity??{vx:260,vy:-420},n=t.spawnOffset??{x:22,y:12},i=de();Ee.throwCooldown=t.cooldownSeconds??.9;const r={id:`grenade-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,x:qt(Ee.x+a*(n.x??22),40,i-40),y:Ee.y+(n.y??12),vx:a*(o.vx??260),vy:o.vy??-420,radius:t.radius??16,fuse:t.fuseSeconds??1.5,maxFuse:t.fuseSeconds??1.5,explosionRadius:t.explosionRadius??120,damage:t.damage??45,knockback:t.knockback??260,gravityFactor:t.gravityFactor??.5,bounciness:qt(t.bounciness??.45,0,.95),color:t.color??"#ffb347",explosionDuration:t.explosionDuration??.32,selfDamageScale:qt(t.selfDamageScale??.65,0,1),selfKnockbackScale:qt(t.selfKnockbackScale??.6,0,1),effectType:t.effectType??"explosive",stunDuration:t.stunDuration??0,playerStunDuration:t.playerStunDuration??0,smokeDuration:t.smokeDuration??0,smokeRadius:t.smokeRadius??t.explosionRadius??120,smokeExpansion:t.smokeExpansion??1.1,smokeSlowMultiplier:qt(t.smokeSlowMultiplier??.55,.1,1),smokeTickDuration:t.smokeTickDuration??.5,detonated:!1,explosionTimer:0};ro.push(r),lo("throwable:thrown",{id:r.id,effectType:r.effectType,x:r.x,y:r.y,radius:r.explosionRadius,fuse:r.fuse})}(),Ee.activeHitboxes.length=0;else if(D&&!P){if(Ee.activeHitboxes.length=0,I){const e=Je(I.id);T&&Ke(I.id)&&(Ee.attacking=!1,Ee.currentAttack=null,Ee.attackIndex=-1),k&&ei(),e&&e.magazine<=0&&e.reserve>0&&!e.reloading&&Ke(I.id)}}else P?(k&&function(){if(Ee.vehicleId)return;if(Ee.rolling||Ee.health<=0||(Ee.stunTimer??0)>0||Ee.reloading)return;const e=Qe(),t=e?.attackChain??[];0!==t.length&&(Ee.attacking?Ee.comboWindowOpen&&Ee.attackIndex+1<t.length&&(Ee.nextAttackQueued=!0):Kn(0))}(),Ee.attacking&&function(e,t){if(Ee.vehicleId)return Ee.attacking=!1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.hitboxSpawned=!1,void(Ee.attackIndex=-1);const a=Ee.currentAttack;if(!a)return;if((Ee.stunTimer??0)>0||Ee.reloading)return Ee.attacking=!1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,void(Ee.hitboxSpawned=!1);Ee.attackElapsed+=e,!Ee.hitboxSpawned&&Ee.attackElapsed>=a.windup&&(t(a),Ee.hitboxSpawned=!0),!Ee.comboWindowOpen&&Ee.attackElapsed>=a.comboStart&&(Ee.comboWindowOpen=!0,Ee.comboWindowTimer=a.comboWindow),Ee.comboWindowOpen&&(Ee.comboWindowTimer-=e,Ee.comboWindowTimer<=0&&(Ee.comboWindowOpen=!1));const o=Qe(),n=o?.attackChain??[];if(Ee.attackElapsed>=a.windup+a.active+a.recovery){const e=Ee.attackIndex+1,t=Ee.nextAttackQueued&&e<n.length;Ee.attacking=!1,Ee.currentAttack=null,Ee.attackElapsed=0,Ee.comboWindowOpen=!1,Ee.comboWindowTimer=0,Ee.hitboxSpawned=!1,Ee.nextAttackQueued=!1,t?Kn(e):Ee.attackIndex=-1}}(e,Zn),function(e,t){Ee.activeHitboxes=Ee.activeHitboxes.filter(a=>(a.remaining-=e,a.ownerFacing=Ee.facing,a.x=Ee.x+Ee.facing*a.offsetX,a.y=Ee.y+t+a.heightOffset,a.remaining>0))}(e,C),function(){for(const e of Ee.activeHitboxes){if(He.health>0&&!e.hitTargets.has(He.id)){const t=e.x-He.x,a=e.y-(He.y+.55*He.height);Math.hypot(t,a)<=e.radius+He.radius&&(e.hitTargets.add(He.id),ua({damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}for(const t of Ne){if(t.health<=0||e.hitTargets.has(t.id))continue;const a=e.x-t.x,o=e.y-(t.y+.5*t.height);Math.hypot(a,o)<=e.radius+t.radius&&(e.hitTargets.add(t.id),ga(t,{damage:e.damage,knockback:e.knockback,launch:e.launch,facing:e.ownerFacing}))}$a(e),Qn(e)}}()):(Ee.activeHitboxes.length=0,D&&k&&ei());var B;B=Ee.x,ge.targetX=ye(B),function(e){const t=ye(ge.targetX),a=Math.min(1,6*e);ge.x+=(t-ge.x)*a,ge.x=ye(ge.x)}(e),function(e){He.flashTimer>0&&(He.flashTimer=Math.max(0,He.flashTimer-e)),He.shakeTimer>0&&(He.shakeTimer=Math.max(0,He.shakeTimer-e)),He.shakeMagnitude=Math.max(0,He.shakeMagnitude-20*e),He.health<=0&&(He.respawnTimer=Math.max(0,He.respawnTimer-e),0===He.respawnTimer&&(He.health=He.maxHealth,He.flashTimer=0,He.shakeTimer=0,He.shakeMagnitude=0))}(e),function(e){const t=de();for(const a of ro)a.detonated?a.explosionTimer-=e:(a.fuse-=e,a.vy+=Te*a.gravityFactor*e,a.x+=a.vx*e,a.y+=a.vy*e,a.y+a.radius>=w&&(a.y=w-a.radius,a.vy>0&&(a.vy=-a.vy*a.bounciness),a.vx*=.7,Math.abs(a.vy)<36&&(a.vy=0)),(a.x-a.radius<=0||a.x+a.radius>=t)&&(a.x=qt(a.x,a.radius,t-a.radius),a.vx=.45*-a.vx),a.fuse<=0&&co(a));for(let e=ro.length-1;e>=0;e-=1)ro[e].detonated&&ro[e].explosionTimer<=0&&ro.splice(e,1);!function(e){for(const t of so){t.life=Math.max(0,t.life-e);const a=1-t.life/t.duration;if(t.radius=qt(t.baseRadius+(t.maxRadius-t.baseRadius)*qt(a,0,1),t.baseRadius,t.maxRadius),t.tickTimer-=e,t.tickTimer<=0){t.tickTimer=t.tick;const e=t.radius;for(const a of Ne){if(a.health<=0)continue;const o=a.x-t.x,n=a.y+.5*a.height-t.y;Math.hypot(o,n)<=e&&(a.smokeSlowTimer=Math.max(a.smokeSlowTimer??0,t.tick+.4),a.smokeSlowStrength=Math.min(a.smokeSlowStrength??1,t.slowMultiplier))}const a=Ie(Ee.currentPose??{headRadius:16,bodyLength:34,legLength:36}),o=Ee.y+.6*a,n=Ee.x-t.x,i=o-t.y;Math.hypot(n,i)<=e&&(Ee.smokeSlowTimer=Math.max(Ee.smokeSlowTimer??0,t.tick+.4),Ee.smokeSlowStrength=Math.min(Ee.smokeSlowStrength??1,t.slowMultiplier+.1))}}for(let e=so.length-1;e>=0;e-=1)if(so[e].life<=0){const t=so.splice(e,1)[0];lo("throwable:smoke-dissipate",{id:t.id,x:t.x,y:t.y,radius:t.maxRadius??t.radius})}}(e)}(e),function(e){!function(e){for(const t of oa){t.duration-=e,t.fireTimer-=e;const a=na(t);a&&t.fireTimer<=0&&ia(t,a)}for(let e=oa.length-1;e>=0;e-=1)oa[e].duration<=0&&oa.splice(e,1)}(e),function(e){la.active&&(la.duration-=e,la.flashTimer=Math.max(0,la.flashTimer-e),la.duration<=0?fa("expired"):la.strength<=0&&(da("shield:shatter",{reason:"decayed",center:ca(),maxStrength:la.maxStrength,radius:la.radius}),fa("shatter")))}(e)}(e),function(e){!function(e){ra.cooldown>0&&(ra.cooldown=Math.max(0,ra.cooldown-e)),function(e){if(!ra.active)return;const t=ra.travelSpeed??860,a=ra.pullSpeed??740,o=(ra.retracting?a:t)*e;if(ra.retracting){ra.duration-=e;const t=ra.targetX-Ee.x,n=ra.targetY-Ee.y,i=Math.hypot(t,n);if(i>12){const o=Math.min(i,a*e);Ee.vx=t/i*o/e,Ee.vy=n/i*o/e,Ee.x+=t/i*o,Ee.y+=n/i*o}ra.tetherLength=Math.max(0,ra.tetherLength-o),(ra.duration<=0||ra.tetherLength<=0)&&sa()}else ra.tetherLength+=o,ra.tetherLength>=ra.maxLength&&(ra.tetherLength=ra.maxLength,ra.retracting=!0)}(e)}(e)}(e),function(e,t){const a=[];for(const[t,o]of qe.entries())if(ve[t]){if(o.reloading&&(o.reloadTimer=Math.max(0,o.reloadTimer-e),o.reloadTimer<=0)){if(o.capacity!==Number.POSITIVE_INFINITY){const e=o.capacity-o.magazine;if(e>0){const t=Math.min(e,o.reserve);o.magazine+=t,o.reserve-=t}}o.reloading=!1,o.reloadTimer=0,a.push(t)}if(o.spread&&o.spreadDef){const t=o.spreadDef.base??0,a=o.spreadDef.recovery??0;o.spread.current=a>0?Math.max(t,o.spread.current-a*e):Math.max(t,o.spread.current??t)}}else qe.delete(t);if(t){const e=qe.get(t);Ee.reloading=e?.reloading??!1}else Ee.reloading=!1;if("undefined"!=typeof window)for(const e of a)window.dispatchEvent(new CustomEvent("weapon:reload-finish",{detail:{weaponId:e}}))}(e,I?.id??null),function(e){const t=hn.decay??12,a=Math.max(0,1-t*e);hn.horizontalKick*=a,hn.verticalKick*=a}(e),function(e){for(const t of ta)t.life-=e,t.x+=t.vx*e,t.y+=t.vy*e,t.vy-=40*e;for(let e=ta.length-1;e>=0;e-=1)ta[e].life<=0&&ta.splice(e,1)}(e),function(e){Ca();for(let t=wa.length-1;t>=0;t-=1){const a=wa[t];if(a.ttl-=e,a.ttl<=0){wa.splice(t,1);continue}const o=qt(a.ttl/a.maxTtl,0,1);a.x+=a.vx*e,a.y+=a.vy*e,"shield"===a.type?(a.vx*=.88,a.vy*=.88,a.radius*=.96+.04*o):"smoke"===a.type?(a.vx*=.9,a.vy=.9*(a.vy??0)-24*e,a.radius*=.995+.02*o):"ember"===a.type?(a.vx*=.94,a.vy*=.94):"debris"===a.type?(a.vy+=520*e,a.vx*=.88,a.vy*=.9,a.radius*=.95):"flash"===a.type?(a.vx*=.8,a.vy*=.8,a.radius*=.9+.08*o):(a.vx*=.86,a.vy*=.86)}for(let t=ba.length-1;t>=0;t-=1){const a=ba[t];a.ttl-=e,a.ttl<=0&&ba.splice(t,1)}}(e),function(e){Za();for(const e of qa.values())e.active=!1;!function(){const e=Array.isArray(Ka)?Ka:[];for(let t=0;t<e.length;t+=1){const a=e[t]??{};_a(a.id??"env-light-"+t,a)}}(),function(){const e=Ee.facing??1,t=Ee.deadTimer<=0,a="vehicle"===Ee.controlMode,o=t?a?.65:.9:0;_a("player-flashlight",{type:"cone",x:Ee.x+34*e,y:Ee.y+28,radius:a?280:240,intensity:o,color:"#ffd591",direction:e>=0?0:Math.PI,fov:.5*Math.PI,stretch:.42,smoothing:18,flicker:.2}),Le.forEach((e,t)=>{if(!e||"defeated"===e.state)return;const a=e.facing??1;_a("squad-flashlight-"+(e.id??t),{type:"cone",x:e.x+30*a,y:e.y+26,radius:210,intensity:.6,color:"#fff0c4",direction:a>=0?0:Math.PI,fov:.45*Math.PI,stretch:.38,smoothing:20,flicker:.24})})}();const t=za();for(let e=0;e<t.length;e+=1){const a=t[e],o=a?.ambient;o&&_a(`structure-${a.id}`,{type:o.type??"point",x:a.x+(o.offsetX??0),y:a.y-(a.height??120)+(o.offsetY??-40),radius:o.radius??220,intensity:o.intensity??.8,color:o.color??"#8cffd4",smoothing:o.smoothing??10,flicker:o.flicker??.25,fov:o.fov,direction:o.direction,stretch:o.stretch??.5})}for(const[t,a]of qa.entries()){if(!a.active){qa.delete(t);continue}const o=qt(a.smoothing??12,1,60),n=qt(e*o,0,1);a.intensity+=(a.targetIntensity-a.intensity)*n,a.intensity=Ua(a.intensity),a.flicker>0&&(a.intensity=Ua(a.intensity+(Math.random()-.5)*a.flicker))}for(let t=Ga.length-1;t>=0;t-=1){const a=Ga[t];a.ttl-=e,a.ttl<=0&&Ga.splice(t,1)}}(e),function(e){cn(),dn($o,e),dn(Wo,e),dn(Ho,e),dn(Fo,e),dn(No,e)}(e),function(e){for(const t of oo){if(t.life-=e,t.vy+=Te*e*t.gravityFactor,t.x+=t.vx*e,t.y+=t.vy*e,t.lightCooldown=Math.max(0,(t.lightCooldown??0)-e),t.lightCooldown<=0&&t.life>0){const e=Math.max(90,16*t.radius);Qa({type:"point",x:t.x,y:t.y,radius:e,intensity:.4+.2*Math.random(),color:t.color??"#ffcf7a",ttl:.08,flicker:.25,decay:1.3}),t.lightCooldown=.05}if(t.y+t.radius>=w)t.life=0;else if(He.health>0&&!t.hitTargets.has(He.id)&&io(t.x,t.y,t.radius,He.x,He.y+.55*He.height,He.radius))t.hitTargets.add(He.id),ua({damage:t.damage,knockback:t.knockback,facing:t.facing}),t.life=0;else{for(const e of Ne)if(!(e.health<=0||t.hitTargets.has(e.id))&&io(t.x,t.y,t.radius,e.x,e.y+.5*e.height,e.radius)){t.hitTargets.add(e.id),ga(e,{damage:t.damage,knockback:t.knockback,launch:0,facing:t.facing}),t.life=0;break}t.life>0&&La(t)&&(t.life=0)}}for(let e=oo.length-1;e>=0;e-=1)oo[e].life<=0&&oo.splice(e,1)}(e),function(e,t){for(const a of Zt)a.life-=e,a.vy+=Te*e*.9,a.x+=a.vx*e,a.y+=a.vy*e,a.vx*=.96,a.y+a.radius>=t&&(a.y=t-a.radius,a.vy=.35*-a.vy,a.vx*=.7,Math.abs(a.vy)<20&&(a.vy=0));for(let e=Zt.length-1;e>=0;e-=1)Zt[e].life<=.05&&Zt.splice(e,1)}(e,w),function(e){for(const t of Ne)ti(t,e);for(const e of Ne)ai(e)}(e)}"undefined"!=typeof window&&(window.ServerBrowser={fetch:Ii,host:Ai,join:Ri,stop:Di,attemptHost:Ni,attemptStop:ji,attemptJoin:Yi,copyOffer:Ei,regenerateOffer:()=>Ei({forceRegenerate:!0,silent:!0}),promptOffer:Hi,promptAnswer:Fi,copyCandidates:Si,promptCandidates:Ti,syncCandidates:ki,state:bt}),we||(window.addEventListener("keydown",e=>be(!0,e)),window.addEventListener("keyup",e=>be(!1,e)),window.addEventListener("mousedown",function(e){0===e.button?(xe.attackBuffered=!0,xe.attackDown=!0,e.preventDefault()):2===e.button&&(xe.throwBuffered=!0,xe.throwDown=!0,e.preventDefault())}),window.addEventListener("mouseup",function(e){0===e.button?(xe.attackDown=!1,e.preventDefault()):2===e.button&&(xe.throwDown=!1,e.preventDefault())}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("blur",function(){xe.left=!1,xe.right=!1,xe.jump=!1,xe.down=!1,xe.roll=!1,xe.attackBuffered=!1,xe.throwBuffered=!1,xe.reloadBuffered=!1,xe.interactBuffered=!1,xe.attackDown=!1,xe.throwDown=!1,xe.squadCommandCycleBuffered=!1,xe.squadCommandSelect=null,xe.serverBrowserToggleBuffered=!1,xe.serverBrowserNavigate=0,xe.serverBrowserJoinBuffered=!1,xe.serverBrowserHostBuffered=!1,xe.serverBrowserStopHostBuffered=!1,xe.serverBrowserCopyOfferBuffered=!1,xe.serverBrowserPasteOfferBuffered=!1,xe.serverBrowserAcceptAnswerBuffered=!1,xe.serverBrowserCopyCandidatesBuffered=!1,xe.serverBrowserPasteCandidatesBuffered=!1}),we=!0),Ve||(window.addEventListener("keydown",function(e){const t=(a=e.code).startsWith("Digit")?Number.parseInt(a.slice(5),10):a.startsWith("Numpad")?Number.parseInt(a.slice(6),10):Number.NaN;var a;!Number.isNaN(t)&&t>=1&&(Ze(t-1),e.preventDefault())}),Ve=!0),tt||"undefined"==typeof window||(tt=!0,nt(),Object.keys(ot).forEach(function(e){const t=ot[e];t&&window.addEventListener(e,e=>{!function(e,t){const a=nt();if(!a)return;it();const o=performance.now(),n=e.cooldown??80,i=e;if(o-(at.get(i)??0)<n)return;at.set(i,o);const r=a.createOscillator();r.type=e.shape??"sine";const s="function"==typeof e.frequency?e.frequency(t):e.frequency;r.frequency.setValueAtTime(Math.max(40,s??440),a.currentTime);const l=a.createGain(),c=Math.max(.001,e.gain??.05),d=Math.max(.05,e.duration??.12);l.gain.setValueAtTime(c,a.currentTime),l.gain.exponentialRampToValueAtTime(1e-4,a.currentTime+d),r.connect(l),l.connect(a.destination),r.start(),r.stop(a.currentTime+d)}(t,e?.detail??{})})}),window.addEventListener("pointerdown",rt),window.addEventListener("keydown",rt)),yt(),"undefined"!=typeof window&&(window.P2P={createOffer:async function(){yt();const e=await ct.createOffer();return await ct.setLocalDescription(e),gt=JSON.stringify(e),gt},createAnswer:async function(e){yt();const t=JSON.parse(e);await ct.setRemoteDescription(new RTCSessionDescription(t));const a=await ct.createAnswer();return await ct.setLocalDescription(a),gt=JSON.stringify(a),gt},acceptRemoteDescription:async function(e){yt();const t=JSON.parse(e);await ct.setRemoteDescription(new RTCSessionDescription(t))},addRemoteCandidate:async function(e){if(!e)return;yt();const t=new RTCIceCandidate(JSON.parse(e));await ct.addIceCandidate(t)},getLocalDescription:function(){return gt},getLocalCandidates:function(){return[...mt]},getStatus:xt,close:function(){dt&&(dt.close(),dt=null),ft&&(ft.close(),ft=null),ct&&(ct.close(),ct=null),ut="disconnected"}}),le||"undefined"==typeof window||(window.addEventListener("keydown",function(e){if(e.altKey&&!e.repeat&&("Digit9"===e.code||"Digit0"===e.code)){(function(e=1){if(!Array.isArray(ee)||0===ee.length)return!1;const t=ee.indexOf(re),a=((t>=0?t:0)+e+ee.length)%ee.length;return!(!(o=ee[a])||!Z[o]||o===re||(re=o,te.pickups.length=0,function(){const e=ce();for(const t of se)try{t(e)}catch(e){"undefined"!=typeof console&&console.error&&console.error("Environment listener error",e)}"undefined"!=typeof window&&"function"==typeof window.dispatchEvent&&window.dispatchEvent(new CustomEvent("environment:changed",{detail:{environment:e,id:e?.id??re}}))}(),0));var o})("Digit9"===e.code?-1:1)&&"function"==typeof e.preventDefault&&e.preventDefault()}}),le=!0);let qi=performance.now();window.requestAnimationFrame(function e(t){const a=Math.min((t-qi)/1e3,.1);qi=t,Xi(a);const o=function(){const e=me(),t=de(),a=ye(ge.x);let o=a-e;return o=t<=p.width?Math.max(0,.5*t-e):Math.min(Math.max(0,o),t-p.width),{x:a,y:0,halfWidth:e,left:o,right:o+p.width,offsetX:o}}();!function(e){const t=ce(),a=t?.background??{},o=e?.offsetX??0,n=Array.isArray(a.gradientStops)&&a.gradientStops.length>0?a.gradientStops:[{offset:0,color:"#111a2c"},{offset:.4,color:"#182439"},{offset:.75,color:"#1f2d44"},{offset:1,color:"#232f49"}],i=x.createLinearGradient(0,0,0,x.canvas.height);for(const e of n){const t="number"==typeof e.offset?Math.min(Math.max(e.offset,0),1):0,a=e.color??"#111a2c";i.addColorStop(t,a)}x.fillStyle=i,x.fillRect(0,0,x.canvas.width,x.canvas.height);const r=Array.isArray(a.silhouettes)?a.silhouettes:[];for(const e of r){const t=Array.isArray(e.points)?e.points:[];if(!(t.length<3)){x.fillStyle=e.color??"rgba(0, 0, 0, 0.45)",x.beginPath(),x.moveTo(t[0].x-o,t[0].y);for(let e=1;e<t.length;e+=1)x.lineTo(t[e].x-o,t[e].y);x.closePath(),x.fill()}}const s=a.horizonBand;if(s){const e=s.height??120,t=s.start??w-e-30,a=x.createLinearGradient(0,t,0,t+e);a.addColorStop(0,s.topColor??"rgba(46, 86, 126, 0.25)"),a.addColorStop(1,s.bottomColor??"rgba(28, 52, 84, 0)"),x.fillStyle=a,x.fillRect(0,t,x.canvas.width,e)}if("desert"===t?.theme){const e=a.sun?.x??.72*x.canvas.width,t=a.sun?.y??.18*x.canvas.height,o=a.sun?.radius??70,n=x.createRadialGradient(e,t,0,e,t,o);n.addColorStop(0,"rgba(255, 214, 128, 0.9)"),n.addColorStop(1,"rgba(255, 214, 128, 0)"),x.fillStyle=n,x.beginPath(),x.arc(e,t,o,0,2*Math.PI),x.fill()}else if("sci-fi"===t?.theme){const e=110;x.fillStyle="#a8c2ff",x.globalAlpha=.35;for(let t=0;t<x.canvas.width;t+=e)for(let a=0;a<w-40;a+=e){const e=8*Math.sin(13.37*t+a)%18,o=6*Math.cos(7.91*a+t)%14;x.fillRect(t+e,a+o,2,2)}x.globalAlpha=1}if("jungle"===t?.theme){const e=w-140,t=x.createLinearGradient(0,e,0,w);t.addColorStop(0,"rgba(60, 120, 80, 0.18)"),t.addColorStop(1,"rgba(40, 70, 50, 0)"),x.fillStyle=t,x.fillRect(0,e,x.canvas.width,w-e)}x.fillStyle=a.groundColor??"#1b2231",x.fillRect(0,w,x.canvas.width,x.canvas.height-w)}(o),x.save(),x.translate(-o.offsetX,0),function(){!function(){const e=function(){const e=ce();return Array.isArray(e?.waterZones)?e.waterZones:[]}();for(const t of e){const e=x.createLinearGradient(t.x,t.top,t.x,t.top+t.depth);e.addColorStop(0,t.topColor??"rgba(54, 98, 144, 0.88)"),e.addColorStop(.7,t.midColor??"rgba(36, 72, 112, 0.9)"),e.addColorStop(1,t.bottomColor??"rgba(24, 50, 84, 0.95)"),x.fillStyle=e,x.fillRect(t.x,t.top,t.width,t.depth),!1!==t.highlight&&(x.fillStyle=t.highlightColor??"rgba(255, 204, 112, 0.25)",x.fillRect(t.x-10,t.top+2,t.width+20,4));const a=t.rippleColor??"rgba(255, 255, 255, 0.12)";x.strokeStyle=a,x.lineWidth=1.6;for(let e=0;e<t.width;e+=40){const a=t.top+6+3*Math.sin(.03*(e+t.top));x.beginPath(),x.moveTo(t.x+e,a),x.quadraticCurveTo(t.x+e+10,a+3,t.x+e+20,a),x.stroke()}}}();const e=fe();for(const t of e)mn(t);!function(){const e=function(){const e=ce();return Array.isArray(e?.decor)?e.decor:[]}();for(const t of e)switch(t.type){case"building":yn(t);break;case"billboard":x.save(),x.fillStyle="#1f2330",x.fillRect(t.x-t.width/2,t.y-t.height,t.width,t.height),x.fillStyle="#ffc851",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(t.text??"Ad",t.x,t.y-t.height/2),x.strokeStyle="#ffa940",x.lineWidth=3,x.strokeRect(t.x-t.width/2,t.y-t.height,t.width,t.height),x.restore();break;case"streetlight":x.save(),x.strokeStyle="#707789",x.lineWidth=4,x.beginPath(),x.moveTo(t.x,t.y+140),x.lineTo(t.x,t.y+30),x.stroke(),x.fillStyle="#ffd97a",x.beginPath(),x.arc(t.x,t.y+12,10,0,2*Math.PI),x.fill(),x.restore();break;case"hovercar":Pn(t);break;case"palm":pn(t);break;case"ruin":xn(t);break;case"vineArch":wn(t);break;case"glowPlant":bn(t);break;case"waterfall":vn(t);break;case"dune":kn(t);break;case"rockSpire":Sn(t);break;case"campfire":Tn(t);break;case"antenna":Cn(t);break;case"spire":Mn(t);break;case"holoBillboard":In(t);break;case"energyCoil":An(t)}}()}(),function(){const e=Jt(),t=xa;if(t&&0!==t.length){x.save();for(const a of t)bo(a,e);x.restore()}}(),function(){const e=Oo;if(!e||0===e.length)return;const t=Jt();x.save();for(const a of e)Lo(a,t);x.restore()}(),function(){const e=Wn(),t=Ee.vehicleCandidateId;for(const a of zt){const o=Nt[a.type];if(!o)continue;const n=e?.id===a.id,i=!n&&t===a.id,r=o.width??120,s=o.height??48,l=o.colorBody??"#2c3245",c=o.colorAccent??"#f0b239";x.save(),x.translate(a.x,a.y),x.rotate((a.tilt??0)*Math.PI/180),x.fillStyle=l,x.fillRect(-r/2,-s/2,r,s),x.fillStyle=c,x.fillRect(-r/2,-s/2-6,.6*r,8),x.restore(),(n||i)&&(x.save(),x.lineWidth=n?4:3,x.strokeStyle=n?"#8cffd4":"#ffc66d",x.setLineDash(n?[]:[8,8]),x.strokeRect(a.x-r/2-10,a.y-s/2-12,r+20,s+24),x.restore())}}(),function(){const e=ho;if(0!==e.length){x.save(),x.textAlign="center",x.font="15px 'Segoe UI', Arial, sans-serif";for(const t of e){wo(t);const e=fo[t.typeId];"descending"!==t.state&&(x.fillStyle=t.glowColor,x.globalAlpha=.9,x.fillText(e?.label??t.label??"Supply Drop",t.x,t.y-16))}x.restore()}}(),function(){const e=We();for(const t of e){const e=Ce.standing,a=e.headRadius,o=e.bodyLength,n=e.legLength,i=e.armLength;x.save(),x.strokeStyle="#ff9cf7",x.lineWidth=4;const r=t.y+a;x.beginPath(),x.arc(t.x,r,a,0,2*Math.PI),x.stroke();const s=t.y+2*a,l=s+o;x.beginPath(),x.moveTo(t.x,s),x.lineTo(t.x,l),x.stroke(),x.beginPath(),x.moveTo(t.x,s+4),x.lineTo(t.x-i,s+.8*i),x.moveTo(t.x,s+4),x.lineTo(t.x+i,s+.6*i),x.stroke();const c=Math.max(.7*i,14),d=Math.min(w,l+n),f=Math.min(w,l+.95*n);x.beginPath(),x.moveTo(t.x,l),x.lineTo(t.x-c,d),x.moveTo(t.x,l),x.lineTo(t.x+c,f),x.stroke(),x.fillStyle="#ffd6ff",x.font="13px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(t.name??t.id??"Peer",t.x,t.y-16),x.restore()}}(),function(){const e=Ln(),t=e?.command?.id??"hold",a={hold:"#8cffd4",defend:"#66b3ff",attack:"#ff9f7a",flank:"#ffdd6f"};for(const e of Le){const o=Ce.standing,n=o.headRadius,i=o.bodyLength,r=o.legLength,s=o.armLength;x.save();const l=a[t]??"#8cffd4";x.strokeStyle=l,x.lineWidth=4,x.lineCap="round";const c=e.y+n;x.beginPath(),x.arc(e.x,c,n,0,2*Math.PI),x.stroke();const d=e.y+2*n,f=d+i;x.beginPath(),x.moveTo(e.x,d),x.lineTo(e.x,f),x.stroke(),x.beginPath(),x.moveTo(e.x,d+4),x.lineTo(e.x-s,d+.8*s),x.moveTo(e.x,d+4),x.lineTo(e.x+s,d+.6*s),x.stroke();const h=Math.max(.7*s,14),u=Math.min(w,f+r),g=Math.min(w,f+.95*r);if(x.beginPath(),x.moveTo(e.x,f),x.lineTo(e.x-h,u),x.moveTo(e.x,f),x.lineTo(e.x+h,g),x.stroke(),(e.flashTimer??0)>0){const t=Math.min(1,e.flashTimer/.12);x.fillStyle=`rgba(140, 255, 212, ${t})`,x.beginPath(),x.arc(e.x+30*e.facing,d+.2*s,12,0,2*Math.PI),x.fill()}x.fillStyle=l,x.font="14px 'Segoe UI', Arial, sans-serif",x.textAlign="center",x.fillText(e.name??"Ally",e.x,e.y-12),x.restore()}}(),function(){const e=He,t=Jt(),a=e.y,o=e.shakeTimer>0?Math.sin(40*t)*e.shakeMagnitude*qt(e.shakeTimer/.4,0,1):0,n=e.health>0?o:0,i=e.health>0?e.flashTimer>0?"#ffe3af":"#9ca4b8":"#3b3f49";x.lineWidth=5,x.strokeStyle=i,x.lineCap="round";const r=e.x+n;x.beginPath(),x.arc(r,a+20,20,0,2*Math.PI),x.stroke(),x.beginPath(),x.moveTo(r,a+40),x.lineTo(r,w-20),x.stroke(),x.beginPath(),x.moveTo(r,w-20),x.lineTo(r-28,w),x.moveTo(r,w-20),x.lineTo(r+28,w),x.stroke();const s=a+48;x.beginPath(),x.moveTo(r,s),x.lineTo(r-36,s+18),x.moveTo(r,s),x.lineTo(r+36,s+18),x.stroke();const l=r-70,c=a-24;x.fillStyle="#23262d",x.fillRect(l,c,140,10);const d=e.health/e.maxHealth;x.fillStyle=e.health>0?"#5fffb5":"#44474f",x.fillRect(l,c,140*qt(d,0,1),10),x.strokeStyle="#50535b",x.strokeRect(l,c,140,10),x.fillStyle="#cfd3df",x.font="14px 'Segoe UI', Arial, sans-serif",x.textAlign="center";const f=e.health>0?`Training Dummy ${Math.round(e.health)}/${e.maxHealth}`:"Respawning...";x.fillText(f,r,c-6),x.textAlign="left"}(),function(){const e=Jt();for(const t of Ne){if(t.health<=0)continue;const a=t.shakeTimer>0?Math.sin(32*e)*t.shakeMagnitude*qt(t.shakeTimer/.4,0,1):0,o=t.x+a,n=18,i=t.stunTimer>0?"#ffd166":t.flashTimer>0?"#ff9488":"#fa5b4a";x.lineWidth=5,x.strokeStyle=i,x.lineCap="round";const r=t.y;x.beginPath(),x.arc(o,r+n,n,0,2*Math.PI),x.stroke(),x.beginPath(),x.moveTo(o,r+2*n),x.lineTo(o,r+t.height-24),x.stroke(),x.beginPath(),x.moveTo(o,r+2.4*n),x.lineTo(o-30,r+3*n),x.moveTo(o,r+2.4*n),x.lineTo(o+30,r+3*n),x.stroke(),x.beginPath(),x.moveTo(o,t.y+t.height-26),x.lineTo(o-24,t.y+t.height),x.moveTo(o,t.y+t.height-26),x.lineTo(o+24,t.y+t.height),x.stroke();const s=110,l=8,c=o-s/2,d=r-20;x.fillStyle="#230c0a",x.fillRect(c,d,s,l);const f=t.health/t.maxHealth;x.fillStyle="#ff6f61",x.fillRect(c,d,s*qt(f,0,1),l),x.strokeStyle="#5c3029",x.strokeRect(c,d,s,l)}}(),function(){if(!la.active)return;x.save();const e=qt(la.flashTimer>0?.45:.25+la.strength/Math.max(1,la.maxStrength)*.35,.15,.6);x.strokeStyle=la.color,x.lineWidth=4,x.globalAlpha=e,x.beginPath();const t=ca();x.arc(t.x,t.y,la.radius,0,2*Math.PI),x.stroke(),x.globalAlpha=.4*e,x.fillStyle=la.color,x.beginPath(),x.arc(t.x,t.y,.9*la.radius,0,2*Math.PI),x.fill(),x.restore()}(),function(){if(0!==oa.length){x.save();for(const e of oa){const t=40,a=.4*e.height,o=qt(e.duration/(e.maxDuration||1),0,1);x.fillStyle=e.baseColor,x.fillRect(e.x-.5*t,e.y+e.height-a,t,a);const n=.6*e.height;x.fillStyle=e.headColor,x.fillRect(e.x-.3*t,e.y,.6*t,n),x.fillStyle="#ffd66d",x.fillRect(e.x-.3*t,e.y-6,.6*t*o,4)}x.restore()}}(),function(){if(!ra.active)return;x.save(),x.strokeStyle=ra.color,x.lineWidth=3,x.beginPath(),x.moveTo(Ee.x,Ee.y);const e=ra.tetherLength/(ra.maxLength||1),t=Ee.x+(ra.targetX-Ee.x)*e,a=Ee.y+(ra.targetY-Ee.y)*e;x.lineTo(t,a),x.stroke(),x.restore()}(),function(){x.save();for(const e of Zt){const t=qt(e.life/e.maxLife,0,1);x.globalAlpha=.85*t,x.fillStyle=e.color,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill()}x.restore()}(),function(){if(Ee.health<=0||Ee.vehicleId)return;const e=Ee.currentPose||Ce.standing,t=Ee.currentAttack,{headRadius:a,bodyLength:o,legLength:n,armLength:i,strideMultiplier:r,armSwingAmplitude:s,legSwingAmplitude:l}=e,c=Jt(),d=Math.min(1,Math.abs(Ee.vx)/Se)*r;let f=Math.sin(8*c)*s*d;if(Ee.attacking&&t){const e=t.windup+t.active+t.recovery,a=qt(Ee.attackElapsed/e,0,1);f+=28*Math.sin(a*Math.PI)*Ee.facing}x.lineWidth=4,x.strokeStyle="#f4f7ff",x.lineCap="round";const h=Ee.y+a;x.beginPath(),x.arc(Ee.x,h,a,0,2*Math.PI),x.stroke();const u=Ee.y+2*a,g=u+o;x.beginPath(),x.moveTo(Ee.x,u),x.lineTo(Ee.x,g),x.stroke(),x.beginPath(),x.moveTo(Ee.x,u+6),x.lineTo(Ee.x-i,u+i+f),x.moveTo(Ee.x,u+6),x.lineTo(Ee.x+i,u+i-f),x.stroke();const m=Math.PI/2,y=Math.sin(8*c+m)*l*d,p=Math.max(.7*i,14),b=Math.min(w,g+n+y),v=Math.min(w,g+n-y);x.beginPath(),x.moveTo(Ee.x,g),x.lineTo(Ee.x-p,b),x.moveTo(Ee.x,g),x.lineTo(Ee.x+p,v),x.stroke(),Ee.rolling&&(x.strokeStyle="#9aa2b1",x.beginPath(),x.arc(Ee.x,g-.5*n,a+4,0,2*Math.PI),x.stroke(),x.strokeStyle="#f4f7ff")}(),function(){for(const e of Ee.activeHitboxes){const t=qt(e.remaining/e.duration,0,1);x.fillStyle=`rgba(255, 153, 102, ${.2*t})`,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.fill(),x.strokeStyle=`rgba(255, 198, 141, ${t})`,x.lineWidth=2,x.beginPath(),x.arc(e.x,e.y,e.radius,0,2*Math.PI),x.stroke()}}(),Jn(),function(){if(0!==qa.size||0!==Ga.length){x.save(),x.globalCompositeOperation="lighter",x.globalAlpha=1;for(const e of qa.values()){const t=Ua(e.intensity);t<=.01||("cone"===e.type?ao(e,t):to(e,t))}for(const e of Ga){const t=qt(e.ttl/e.maxTtl,0,1);let a=Ua(e.intensity*Math.pow(t,e.decay??1));e.flicker>0&&(a=Ua(a+(Math.random()-.5)*e.flicker)),a<=.01||("cone"===e.type?ao(e,a):to(e,a))}x.restore()}}(),function(){x.save(),x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="center";for(const e of ta){const t=qt(e.life/e.maxLife,0,1);x.fillStyle=`rgba(255, 214, 102, ${t})`,x.fillText(`-${Math.round(e.value)}`,e.x,e.y)}x.restore()}(),x.restore(),Gn(),function(){const e=bt();if(!e.visible)return;const t=420,a=.5*x.canvas.width-240,o=.5*x.canvas.height-210;x.save(),x.fillStyle="rgba(12, 16, 24, 0.82)",x.fillRect(a,o,480,t),x.strokeStyle="#6f7fa0",x.lineWidth=3,x.strokeRect(a,o,480,t),x.fillStyle="#cfe3ff",x.font="18px 'Segoe UI', Arial, sans-serif",x.textAlign="left",x.fillText("Server Browser",a+20,o+32),x.font="13px 'Segoe UI', Arial, sans-serif",x.fillStyle="#9aa9c7",x.fillText("Join: Enter  |  Navigate: [ / ]  |  Close: L",a+20,o+52),x.fillText("Toggle: L  |  Join: Enter  |  Host: H  |  Stop: U  |  Next: ] or /  |  Prev: [",a+20,o+68);let n=o+88;e.error&&(x.fillStyle="#ff8080",x.fillText(e.error,a+20,n),n+=18),e.statusMessage&&(x.fillStyle="#8cffd4",x.fillText(e.statusMessage,a+20,n),n+=18),e.joinError&&(x.fillStyle="#ff9a9a",x.fillText(e.joinError,a+20,n),n+=18),e.joinStatus&&(x.fillStyle="#cfe3ff",x.fillText(e.joinStatus,a+20,n),n+=18);const i=n+12,r=o+t-140,s=e.servers??[],l=Math.max(0,Math.floor((r-i)/34)),c=Math.min(s.length,Math.min(l,8));x.font="14px 'Segoe UI', Arial, sans-serif";for(let t=0;t<c;t+=1){const o=s[t],n=i+34*t;t===e.selectedIndex&&(x.fillStyle="rgba(108, 132, 220, 0.4)",x.fillRect(a+12,n-6,456,30)),x.fillStyle="#e4ecff",x.fillText(o.name??o.id??"Server",a+24,n+8),x.fillStyle="#9aa9c7";const r=`${o.map??"Unknown"} | ${o.players??"?"}/${o.maxPlayers??"?"} | ${o.region??"--"}`;x.fillText(r,a+24,n+22)}0===s.length&&(x.fillStyle="#a6b2cf",x.fillText("No servers available.",a+24,i+16));const d=(e,t=64)=>"string"!=typeof e?"":e.length>t?`${e.slice(0,t)}...`:e,f=e.p2p??{};let h=o+t-120;x.font="12px 'Segoe UI', Arial, sans-serif",x.fillStyle="#9aa9c7",x.fillText("P2P Handshake",a+20,h),h+=16,f.error&&(x.fillStyle="#ff8080",x.fillText(f.error,a+20,h),h+=16),e.hosting?(f.pendingOffer?(x.fillStyle="#ffd27f",x.fillText("Generating offer...",a+20,h),h+=16):f.offer?(x.fillStyle="#8cffd4",x.fillText("Offer ready and shared with joiners.",a+20,h),h+=16,x.fillStyle="#9aa9c7",x.fillText(d(f.offer),a+20,h),h+=16):(x.fillStyle="#9aa9c7",x.fillText("Preparing host offer...",a+20,h),h+=16),f.pendingAnswer&&(x.fillStyle="#ffd27f",x.fillText("Waiting for a joiner answer...",a+20,h),h+=16)):f.pendingAnswer?(x.fillStyle="#ffd27f",x.fillText("Generating answer...",a+20,h),h+=16):f.answer?(x.fillStyle="#8cffd4",x.fillText("Answer applied. Waiting for host handshake.",a+20,h),h+=16,x.fillStyle="#9aa9c7",x.fillText(d(f.answer),a+20,h),h+=16):(x.fillStyle="#9aa9c7",x.fillText("Waiting for host offer...",a+20,h),h+=16);const u=Array.isArray(f.localCandidates)?f.localCandidates:[],g=Array.isArray(f.remoteCandidates)?f.remoteCandidates:[];f.pendingCandidates&&(x.fillStyle="#ffd27f",x.fillText("Processing ICE candidates...",a+20,h),h+=16);const m="Local ICE ready: "+u.length+"  |  Remote applied: "+g.length;if(x.fillStyle="#9aa9c7",x.fillText(m,a+20,h),h+=16,u.length>0){const e="Last local: "+d(u[u.length-1],54);x.fillStyle="#6f86d0",x.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(x.fillStyle="#9aa9c7",x.fillText("Local ICE will appear shortly after offer/answer.",a+20,h),h+=16);if(g.length>0){const e="Last remote: "+d(g[g.length-1],54);x.fillStyle="#6fd0c5",x.fillText(e,a+20,h),h+=16}else f.pendingCandidates||(x.fillStyle="#9aa9c7",e.hosting?x.fillText("Press N after players send their ICE (M).",a+20,h):x.fillText("Press M to copy your ICE and send it to the host.",a+20,h),h+=16);x.restore()}(),window.requestAnimationFrame(e)})})();
//# sourceMappingURL=bundle.0067db8b97a2437b18ca.js.map